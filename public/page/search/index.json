[{"content":" è‡ªå·±åœ¨åˆæ¬¡å°è¯•çš„è¿‡ç¨‹ä¸­é‡åˆ°å¾ˆå¤šé”™è¯¯ï¼Œå®˜ç½‘ä¸Šåˆæ²¡æœ‰å¤ªå¤šç»†èŠ‚ï¼Œç½‘ä¸Šå…¶ä½™èµ„æ–™ä¹Ÿå‚å·®ä¸é½ï¼Œæ‰€ä»¥è¿™é‡ŒåŸºäºè‡ªå·±çš„ç»éªŒåšä¸€ä¸ªæ€»ç»“ï¼Œä»¥ä¸‹æ­¥éª¤ç»è¿‡è‡ªå·±å¤šæ¬¡æµ‹è¯•ï¼Œä¾›å‚è€ƒä»¥ä¾¿å°‘èµ°ä¸€äº›å¼¯è·¯ã€‚\nå®˜ç½‘ä¼ é€é—¨ï¼šğŸšªBuilding Tomcat\ngithub ä¸Šå…‹éš†æºä»£ç å¹¶åˆ‡æ¢åˆ°æŒ‡å®šç‰ˆæœ¬åˆ†æ”¯\ngit clone https://github.com/apache/tomcat.git cd tomcat \u0026amp;\u0026amp; git checkout 10.0.x å®‰è£…ant\nbrew install ant æ‰§è¡Œant ide-intellij æ„é€ IDEA project. è¿™ä¸€æ­¥ä¸»è¦æ˜¯ä¼šç”Ÿæˆä¸€ä¸ª.idea ç›®å½•, ä»¥åŠä¸‹è½½ä¸€äº›ä¾èµ–åˆ°${user.home}/tomcat-build-libsç›®å½•ã€‚\nant ide-intellij å‘½ä»¤ç»“æŸåç»“å°¾å¤„å¯çœ‹åˆ°è®©é…ç½®PATH VARIABLESã€‚\nIDEA é…ç½®PATH VARIABLES\nIDEA å®‰è£…ant æ’ä»¶\nIDEA æ‰“å¼€tomcat ç›®å½•\né€‰ä¸­æ ¹ç›®å½•tomcat ç„¶åç‚¹open\nIDEAé…ç½®Project Structure, å°†${user.home}/tomcat-build-libsæ·»åŠ åˆ°Librariesä¸‹é¢\nç‚¹å‡»â• â€”\u0026gt; Java â€”\u0026gt; æ‰¾åˆ°${user.home}/tomcat-build-libs â€”\u0026gt; å°†ä¸‹é¢çš„å­æ–‡ä»¶å¤¹å…¨é€‰\nè¿è¡Œant, ç¼–è¯‘\nant è¿è¡Œå®Œåä¼šäº§ç”Ÿä¸€ä¸ªoutputç›®å½•\noutput/ â”œâ”€â”€ build â”œâ”€â”€ classes â”œâ”€â”€ i18n â”œâ”€â”€ jdbc-pool â””â”€â”€ manifests Run configurations ä»¥åŠè®¾ç½®VM options.\næ‰¾åˆ°org.apache.catalina.startup.Bootstrap, è¿è¡Œå…¶mainæ–¹æ³•ï¼Œåœ¨run configurations ä¸­æ·»åŠ VM optionsï¼š\n-Dcatalina.home=/Users/hf/Downloads/tomcat-temp/tomcat/output/build -Dcatalina.base=/Users/hf/Downloads/tomcat-temp/tomcat/output/build å…¶ä¸­ç›®å½•åœ°å€å°±æ˜¯ç¬¬8#ä¸­output ä¸‹é¢build æ–‡ä»¶å¤¹åœ°å€, æ³¨æ„è¦æ±‚java 8 åŠä»¥ä¸Šã€‚\nè¿è¡Œorg.apache.catalina.startup.Bootstrap mainæ–¹æ³•ï¼ŒåŠæµè§ˆå™¨è®¿é—®http://localhost:8080/æµ‹è¯•ã€‚\nçœ‹åˆ°è¿™ä¸ªé¡µé¢è¯´æ˜å¯åŠ¨æˆåŠŸã€‚\n","date":"2024-03-05T11:36:36+08:00","image":"http://localhost:1313/posts/%E7%94%A8idea%E6%9C%AC%E5%9C%B0%E7%BC%96%E8%AF%91%E5%90%AF%E5%8A%A8tomcat%E6%BA%90%E7%A0%81/images/IMG_0283_hu7cde735718a1b4388ce891b20dc2d12c_12773497_120x120_fill_q75_box_smart1.JPG","permalink":"http://localhost:1313/posts/%E7%94%A8idea%E6%9C%AC%E5%9C%B0%E7%BC%96%E8%AF%91%E5%90%AF%E5%8A%A8tomcat%E6%BA%90%E7%A0%81/","title":"ç”¨IDEAæœ¬åœ°ç¼–è¯‘å¯åŠ¨tomcatæºç "},{"content":"HTTPå‹ç¼© httpå‹ç¼©é€šå¸¸æ˜¯æŒ‡æœåŠ¡å™¨å¯¹å³å°†è¦å‘é€ç»™å®¢æˆ·ç«¯çš„å“åº”è¿›è¡Œå‹ç¼©ï¼Œå†ç”±å®¢æˆ·ç«¯è¿›è¡Œè§£å‹ç¼©ï¼Œä»¥æ­¤è¾¾åˆ°å‡å°‘ä¼ è¾“çš„æ•°æ®é‡ï¼Œæå‡æ¥å£æˆ–é¡µé¢æ€§èƒ½çš„ç›®çš„ã€‚\nå¸¸è§çš„å‹ç¼©ç®—æ³•\ndeflate: åŸºäºdeflateç®—æ³• gzip: GNU zipæ ¼å¼, ç›®å‰ä½¿ç”¨æœ€ä¸ºå¹¿æ³› br: ä¸€ç§æ–°çš„å¼€æºå‹ç¼©ç®—æ³•ï¼Œä¸“ä¸ºHTTPå†…å®¹çš„ç¼–ç è€Œè®¾è®¡ \u0026hellip; ç”±æ­¤å°±äº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼ŒæœåŠ¡å™¨æ€ä¹ˆçŸ¥é“åº”è¯¥ç”¨å“ªç§å‹ç¼©ç®—æ³•è¿›è¡Œå‹ç¼©ï¼Ÿ\nå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å°±å‹ç¼©æ–¹æ¡ˆè¿›è¡Œåå•† å‹ç¼©æ–¹æ¡ˆåå•†ä¸ºä¸¤æ­¥ï¼š\nå®¢æˆ·ç«¯åœ¨å‘èµ·è¯·æ±‚çš„æ—¶å€™ç”¨Accept-Encoding è¿™ä¸ªheaderæ¥å‘Šè¯‰æœåŠ¡ç«¯è‡ªå·±æ”¯æŒå“ªäº›ç®—æ³•ï¼Œä¾‹å¦‚ï¼š\nAccept-Encoding: gzip, deflate, br æœåŠ¡ç«¯ä¼šä»å®¢æˆ·ç«¯æ”¯æŒçš„ç®—æ³•ä¸­é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªå¯¹å“åº”ä½“è¿›è¡Œå‹ç¼©ï¼Œç„¶åé€šè¿‡Content-Encoding æ¥å‘Šè¯‰å®¢æˆ·ç«¯è‡ªå·±ç”¨äº†å“ªç§ç®—æ³•æ¥å‹ç¼©ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯å†ç”¨å¯¹åº”çš„ç®—æ³•æ¥è§£å‹ç¼©ï¼Œä¾‹å¦‚ï¼š\nContent-Encoding: gzip FAQ å¦‚æœå®¢æˆ·ç«¯æ”¯æŒçš„å‹ç¼©ç®—æ³•ä½†æœåŠ¡ç«¯éƒ½ä¸æ”¯æŒé‚£æ€ä¹ˆåŠï¼Ÿ\né‚£å°±ä¸å‹ç¼©ï¼Œçˆ±å’‹å’‹ã€‚è¿™æ—¶å€™åœ¨å“åº”å¤´é‡Œå°±æ²¡æœ‰æ˜¾ç¤ºçš„Content-Encodingè¿™ä¸ªheaderäº†ï¼Œæˆ–è€…è¯´ä¼šé‡‡ç”¨å®ƒçš„é»˜è®¤å€¼identity, è¡¨æ˜æ²¡æœ‰å¯¹å“åº”ä½“è¿›è¡Œå‹ç¼©ã€‚\nå¸¸çœ‹åˆ°å“åº”å¤´é‡Œæœ‰Vary:Accept-Encoding, è¿™æ˜¯ä»€ä¹ˆï¼Ÿ\nVary é¦–éƒ¨å­—æ®µå¸¸å¸¸åœ¨è¿›è¡Œä¸»åŠ¨åå•†çš„å“åº”ä¸­å‘é€ï¼Œç”¨äºæŒ‡ç¤ºé€‰æ‹©ç®—æ³•ä¸­ä½¿ç”¨äº†è¯·æ±‚ä¿¡æ¯çš„å“ªäº›éƒ¨åˆ†ã€‚åœ¨ HTTP ä¸­ï¼Œä¸»åŠ¨åå•†æ˜¯æŒ‡æœåŠ¡å™¨æ ¹æ®å®¢æˆ·ç«¯çš„èƒ½åŠ›å’Œåå¥½ï¼Œä»¥åŠèµ„æºçš„ç‰¹æ€§ï¼Œé€‰æ‹©æœ€åˆé€‚çš„å“åº”è¿›è¡Œå‘é€ã€‚\nç®€è€Œè¨€ä¹‹ï¼Œå½“æœåŠ¡å™¨åŸºäºå®¢æˆ·ç«¯è¯·æ±‚çš„ä¸€äº›ç‰¹å®šä¿¡æ¯ï¼ˆæ¯”å¦‚ Accept-Encodingï¼‰æ¥é€‰æ‹©åˆé€‚çš„å“åº”æ—¶ï¼Œå®ƒå¯ä»¥é€šè¿‡ Vary é¦–éƒ¨å­—æ®µæ¥æ˜ç¡®è¯´æ˜ä½¿ç”¨äº†å“ªäº›è¯·æ±‚ä¿¡æ¯ã€‚è¿™å¯¹äºç¼“å­˜å’Œä»£ç†æœåŠ¡å™¨æ¥è¯´å°¤ä¸ºé‡è¦ï¼Œå› ä¸ºå®ƒä»¬å¯ä»¥æ ¹æ® Vary å­—æ®µä¸­åˆ—å‡ºçš„è¯·æ±‚å¤´éƒ¨ä¿¡æ¯æ¥åˆ¤æ–­æ˜¯å¦å¯ä»¥ä½¿ç”¨ç¼“å­˜çš„å“åº”ï¼Œæˆ–è€…æ˜¯å¦éœ€è¦é‡æ–°å‘æºæœåŠ¡å™¨è¯·æ±‚æ–°çš„å“åº”ã€‚æ›´å¤šè¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒRFC 7231 section 7.1.4\nç±»ä¼¼çš„è¿˜çœ‹åˆ°Transfer-Encoding, è¿™ä¸ªåˆæ˜¯ä»€ä¹ˆï¼Ÿ\nContent-Encoding ç”¨äºæè¿°æ¶ˆæ¯ä½“çš„å‹ç¼©æ–¹å¼ï¼Œè€Œ Transfer-Encoding åˆ™ç”¨äºæŒ‡ç¤ºæ¶ˆæ¯ä¼ è¾“æ—¶çš„ç¼–ç æ–¹å¼ï¼Œæ¯”å¦‚Transfer-Encoding:chunkedè¡¨æ˜å°†æ¶ˆæ¯è¿›è¡Œåˆ†å—ä¼ è¾“ã€‚æ¯”å¦‚Transfer-Encoding:identityè¡¨æ˜æ¶ˆæ¯ä½“çš„é•¿åº¦å·²çŸ¥ä¸”æœªè¿›è¡Œç¼–ç \nç­‰ç­‰ï¼Œåˆ†å—ä¼ è¾“æ˜¯ä»€ä¹ˆä»¥åŠä¸ºä»€ä¹ˆè¦æœ‰åˆ†å—ä¼ è¾“ï¼Ÿ\nåˆ†å—ä¼ è¾“ åˆ†å—ä¼ è¾“é¡¾åæ€ä¹‰å°±æ˜¯å°†å“åº”æ¶ˆæ¯ä½“åˆ†å¤šæ¬¡å‘é€ï¼Œä¸€æ¬¡å‘é€ä¸€éƒ¨åˆ†æ•°æ®ã€‚æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä¸ä¹‹å¯¹åº”çš„â€œä¸€æ¬¡æ€§ä¼ è¾“â€ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¬¡æ€§å‘é€æ‰€æœ‰æ•°æ®ã€‚\nHTTPåè®®æ˜¯åº”ç”¨å±‚åè®®ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¿›è¡Œäº¤äº’æ˜¯å»ºç«‹åœ¨TCPé“¾æ¥ä¹‹ä¸Šï¼Œç°åœ¨å‡è®¾æœåŠ¡ç«¯è¦å‘å®¢æˆ·ç«¯ä¼ é€æ•°æ®ï¼Œåœ¨ä¼ é€å®Œä¸€æ®µæ•°æ®åä¸‹ä¸€æ­¥å®¢æˆ·ç«¯è¯¥å¹²å˜›å‘¢ï¼Ÿ\nç«™åœ¨å®¢æˆ·ç«¯è§†è§’çš„ç¬¬ä¸€ä¸ªç–‘é—®å°±æ˜¯ï¼šè¿™ä¸ªæ•°æ®ä¼ é€å®Œäº†å—ï¼Ÿ\næ‰€ä»¥ä¸ºäº†è®©å®¢æˆ·ç«¯çŸ¥é“æ•°æ®æ˜¯å¦ä¼ é€å®Œæ¯•ï¼Œä¸€ç§æ–¹æ¡ˆå°±æ˜¯æœåŠ¡ç«¯åœ¨ä¼ é€å“åº”ä½“ä¹‹å‰è®¡ç®—æ¶ˆæ¯çš„é•¿åº¦ï¼Œç„¶åæŠŠè¿™ä¸ªé•¿åº¦é€šè¿‡Content-Length è¿™ä¸ªå“åº”å¤´å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œåœ¨å®¢æˆ·ç«¯æ”¶åˆ°ä¸€éƒ¨åˆ†æ•°æ®åå®ƒå¯ä»¥è®¡ç®—æ”¶åˆ°çš„æ•°æ®é•¿åº¦ï¼Œå¦‚æœå’ŒConent-Lengthçš„å€¼ä¸€æ ·ï¼Œé‚£å°±å¯ä»¥è®¤ä¸ºæ•°æ®ä¼ é€å®Œäº†ç„¶åå®¢æˆ·ç«¯ä¸‹ä¸€æ­¥å°±å¯ä»¥åšè‡ªå·±æƒ³åšçš„äº‹(æ¯”å¦‚å…³é—­TCPé“¾æ¥ï¼Œæˆ–è€…å‘èµ·ä¸€ä¸ªæ–°çš„è¯·æ±‚)ã€‚ è¿™å°±æ˜¯ä¸€æ¬¡æ€§ä¼ è¾“åŠContent-Length åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å‘æŒ¥çš„ä½œç”¨ã€‚å¦ä¸€ç§æ–¹æ¡ˆæ˜¯æœåŠ¡ç«¯åœ¨å‘é€å®Œæ•°æ®å°±å…³é—­TCPé“¾æ¥ï¼Œè¿™æ ·å®¢æˆ·ç«¯çœ‹åˆ°æœåŠ¡ç«¯å…³é—­äº†é“¾æ¥ï¼Œä¹Ÿå¯ä»¥çº¦å®šåªè¦ä½ å…³é—­é“¾æ¥æˆ‘å°±è®¤ä¸ºæ•°æ®ä¼ è¾“å®Œäº†ï¼Œä½†æ˜¯åŸºæœ¬ä¸Šä¸ä¼šè¿™ä¹ˆåšã€‚\nå¦‚æœContent-Length å’ŒçœŸå®é•¿åº¦ä¸ä¸€è‡´ä¼šæ€æ ·ï¼Ÿ\nå¦‚æœContent-Lengthå°äºçœŸå®é•¿åº¦ï¼Œåˆ™å®¢æˆ·ç«¯ä¼šå¯¹å†…å®¹è¿›è¡Œè£å‰ªï¼Œå¯¹å¤–è¡¨ç°å°±æ˜¯æ•°æ®ä¸å®Œæ•´ã€‚\nå¦‚æœContent-Lengthå°äºçœŸå®é•¿åº¦ï¼Œåˆ™å®¢æˆ·ç«¯è¯·æ±‚ä¼šä¸€ç›´pengding, å› ä¸ºå®ƒè®¤ä¸ºå“åº”è¿˜æ²¡æœ‰ç»“æŸã€‚\nåœ¨ç¬¬ä¸€ç§æ–¹æ¡ˆä¸­éœ€è¦æå‰è®¡ç®—æ¶ˆæ¯é•¿åº¦ï¼Œå¯¹äºæ™®é€šçš„è¾ƒå°çš„æ–‡æœ¬è¿˜å¥½è¯´ï¼Œä½†å¦‚æœæ¶ˆæ¯å¾ˆé•¿ï¼Œå¾ˆå¤§ï¼Œæ¯”å¦‚ä¸€äº›æ–‡ä»¶ï¼Œè¿™ä¸ªè®¡ç®—è¿‡ç¨‹å¾ˆè´¹æ—¶é—´æˆ–è€…ç©ºé—´ï¼Œåœ¨å®¢æˆ·ç«¯çœ‹æ¥è¿™ä¸ªè¯·æ±‚çš„å“åº”å°±å¾ˆæ…¢ã€‚æ‰€ä»¥å°±æœ‰äº†åˆ†å—ä¼ è¾“çš„åšæ³•ï¼Œä¸è®¡ç®—é•¿åº¦ï¼ŒæŠŠæ•°æ®åˆ†æˆä¸åŒçš„å°å—é€æ­¥å‘é€ã€‚\nä¾‹å¦‚ï¼š\nsocket.getOutputStream().write(\u0026#34;HTTP/1.1 200 OK\\r\\n\u0026#34;.toByteArray()) socket.getOutputStream().write(\u0026#34;Transfer-Encoding: chunked\\r\\n\u0026#34;.toByteArray()) socket.getOutputStream().write(\u0026#34;Content-Type: text/plain\\r\\n\u0026#34;.toByteArray()) socket.getOutputStream().write(\u0026#34;\\r\\n\u0026#34;.toByteArray()) socket.getOutputStream().write(\u0026#34;5\\r\\n\u0026#34;.toByteArray()) socket.getOutputStream().write(\u0026#34;123\\r\\n\\r\\n\u0026#34;.toByteArray()) socket.getOutputStream().flush() socket.getOutputStream().write(\u0026#34;2\\r\\n\u0026#34;.toByteArray()) socket.getOutputStream().write(\u0026#34;ab\\r\\n\u0026#34;.toByteArray()) socket.getOutputStream().flush() socket.getOutputStream().write(\u0026#34;0\\r\\n\u0026#34;.toByteArray()) socket.getOutputStream().write(\u0026#34;\\r\\n\u0026#34;.toByteArray()) socket.getOutputStream().write(\u0026#34;13\\r\\n\u0026#34;.toByteArray()) socket.getOutputStream().write(\u0026#34;am I ignored?\\r\\n\u0026#34;.toByteArray()) socket.getOutputStream().flush()åˆ†å—ä¼ è¾“æ–¹æ³•ï¼š éœ€è¦åœ¨å“åº”å¤´ä¸­æ·»åŠ ï¼šTransfer-Encoding: chunked å“åº”å¤´ç»“æŸéœ€è¦æ·»åŠ CRLF(\\r\\n)è¡¨ç¤ºå“åº”ä½“çš„å¼€å§‹ æ¯ä¸€ä¸ªå“åº”å—ç¬¬ä¸€è¡Œè¡¨ç¤ºè¯¥å—çš„é•¿åº¦(ç»“å°¾æ˜¯CRLF)ï¼Œç„¶åæ˜¯æ•°æ®æœ¬èº«ï¼Œé‡åˆ°CRLF,è¡¨æ˜å—ç»“æŸï¼Œè‹¥ç¬¬ä¸€è¡Œé•¿åº¦å’ŒçœŸå®æ•°æ®é•¿åº¦ä¸ä¸€è‡´é€šå¸¸å®¢æˆ·ç«¯ä¼šè§£æå¤±è´¥ æœ€åä¸€ä¸ªå—å¿…é¡»é•¿åº¦ä¸º0ï¼Œä¸åŒ…å«ä»»ä½•æ•°æ®å¹¶ä¾æ—§ä»¥CRLFç»“å°¾ã€‚ Tomcat ä¸­çš„åˆ†å—ä¼ è¾“ä¸å“åº”å‹ç¼© tomcat HTTPå‹ç¼©åŠŸèƒ½æ‰‹åŠ¨å¼€å¯æ–¹å¼å¦‚ä¸‹ï¼šåœ¨server.xmlä¸­\n\u0026lt;Connector port=\u0026#34;8080\u0026#34; protocol=\u0026#34;HTTP/1.1\u0026#34; connectionTimeout=\u0026#34;20000\u0026#34; compression=\u0026#34;on\u0026#34; \u0026lt;!-- å¼€å¯å‹ç¼© --\u0026gt; compressionMinSize=\u0026#34;10\u0026#34; \u0026lt;!-- å‹ç¼©é˜€å€¼, å½“æ¶ˆæ¯é•¿åº¦è¶…è¿‡çš„æ—¶å€™æ‰è¿›è¡Œå‹ç¼© --\u0026gt; \u0026lt;!-- å‹ç¼©ç±»å‹ --\u0026gt; compressableMimeType=\u0026#34;text/html,text/xml,text/javascript,application/javascript,text/css,text/plain,text/json\u0026#34; redirectPort=\u0026#34;8443\u0026#34;/\u0026gt; æ›´å¤šè¯¦ç»†é…ç½®æ–¹å¼å¯å‚è€ƒApache Tomcat 10 Configuration Reference\nå‹ç¼©å°±ä¼šæ›´å¥½å—ï¼Ÿä¸æ˜¯ï¼Œå‹ç¼©æ„å‘³ç€æœåŠ¡ç«¯æ›´å¤šçš„èµ„æºæ¶ˆè€—\nç”¨æ¥æµ‹è¯•çš„Servlet\nclass TestCompressionServlet : HttpServlet() { override fun doGet(request: HttpServletRequest, response: HttpServletResponse) { val stringBuilder = StringBuilder() for (i in 1 until 10000000) { stringBuilder.append(\u0026#34;Hi,\u0026#34;) } response.contentType=\u0026#34;text/html\u0026#34; response.writer.write(stringBuilder.toString()) } } è¿™é‡Œä¼šå‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œåœ¨ã€ŠTomcatæ¶æ„åŸç†è§£æã€‹ ä¸­æˆ‘ä»¬è¯´åˆ°servelt é€šè¿‡response.writer.write å†™å…¥å“åº”çš„æ—¶å€™å…¶å®æ˜¯å…ˆå†™å…¥org.apache.catalina.connector.Responseå†…éƒ¨ç»´æŠ¤çš„CharBufferä¸­ï¼Œæœ€åä¼šæŠŠCharBufferè½¬ä¸ºByteBufferä¸­ç„¶åäº¤ç»™SocketHandlerçš„writeBufferæœ€åæ‰ä¼šå†™å…¥socketä¸­ã€‚\næˆ‘ä»¬ç°åœ¨è¦å†™å…¥çš„æ˜¯ä¸€ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œè€ŒBufferå´åªæœ‰8KB, æ€ä¹ˆåŠï¼ŸTomcat æ˜¯è¿™ä¹ˆå¤„ç†çš„ï¼š\nåœ¨å†™å…¥CharBuffer åï¼Œå¦‚æœCharBufferæ»¡äº†ä¼šå°†CharBuffer ä¸­çš„æ•°æ®flush åˆ°ByteBuffer, ç„¶åæ¸…ç©ºCharBufferï¼Œæºç ä½ç½®ï¼šorg.apache.catalina.connector.OutputBuffer#write\nå‰©ä¸‹çš„æ•°æ®ç»§ç»­å†™å…¥CharBuffer, é‡å¤1çš„æ­¥éª¤\nå¦‚æœåœ¨#1ä¸­ï¼ŒByteBufferä¹Ÿæ»¡äº†ï¼Œä¼šflush æ•°æ®åˆ°org.apache.coyote.Responseä¸­å¹¶æ¸…ç©ºByteBufferï¼Œè°ƒç”¨å®ƒçš„writeæ–¹æ³•ï¼Œ æœ€ç»ˆä¼šè°ƒç”¨åˆ°Http11OutputBufferçš„doWriteæ–¹æ³•ã€‚æºç ä½ç½®ï¼šorg.apache.coyote.http11.Http11OutputBuffer#doWrite\nè¿™æ—¶å€™Http11OutputBufferå¦‚æœå‘ç°Response è¿˜æ²¡commit, ä¼šé€šè¿‡actionè°ƒç”¨Http11Processor æ¥commit responseï¼Œè¿™ä¸€æ­¥ä¼šå‡†å¤‡å“åº”çš„å“åº”è¡Œ(åŒ…æ‹¬åè®®å’ŒçŠ¶æ€ç ï¼Œä¾‹å¦‚ï¼šHTTP/1.1 200ï¼‰ä»¥åŠå“åº”å¤´, ç„¶åå°†è¿™éƒ¨åˆ†ä¿¡æ¯å†™åˆ°Http11OutputBufferçš„headerBufferä¸­ï¼Œ headerBufferçš„å¤§å°å¯è¿›è¡Œé…ç½®ï¼Œè‹¥è¶…å‡ºå¤§å°åˆ™æŠ›BufferOverflowExceptionã€‚ ç„¶åé€šè¿‡outputBuffer.commit()å°†è¿™éƒ¨åˆ†æ•°æ®å­˜åˆ°socketBufferHandlerçš„writeBufferä¸­ï¼Œå¦‚æœwriteBufferä¹Ÿæ»¡äº†åˆ™ä¼šå†™åˆ°socketä¸­ã€‚ åœ¨3#ä¸­å‡†å¤‡å“åº”å¤´çš„æ—¶å€™(æºç ä½ç½®ï¼šorg.apache.coyote.http11.Http11Processor#prepareResponse)ï¼Œå¦‚æœå¼€å¯äº†å‹ç¼©åŠŸèƒ½ï¼š\næ·»åŠ Vary: accept-encoding headerã€‚ æ ¹æ®Requestä¸­accept-encodingè¿™ä¸ªheaderä¼ è¿‡æ¥çš„å€¼åˆ¤æ–­å®¢æˆ·ç«¯æ˜¯å¦æ”¯æŒgzipï¼Œè‹¥æ”¯æŒåˆ™è®¾ç½®contentLengthä¸º-1ï¼Œ è‹¥ä¸æ”¯æŒé‚£å°±ä¸å‹ç¼©ã€‚ä¹Ÿå°±æ˜¯è¯´tomcat é»˜è®¤åªæ”¯æŒgzipå‹ç¼© å¦‚æœcontentLengthä¸ä¸º-1ï¼Œåˆ™æ·»åŠ ChunkedOutputFilterä¸ºactiveFilters å¦‚æœå‘ç°æ”¯æŒgzip, åˆ™ä¼šæ·»åŠ GzipOutputFilterä¸ºactiveFilters ç„¶åç»§ç»­å›åˆ°3#ä¸­Http11OutputBufferçš„doWrite æ–¹æ³•ï¼Œåœ¨commit response ä¹‹åä¼šè°ƒç”¨GzipOutputFilterçš„doWriteæ–¹æ³•, æ¥ç€6#ã€‚\nGZIPOutputStreamçš„doWriteæ–¹æ³•ä¼šé€šè¿‡è°ƒç”¨native æ–¹æ³•æ¥å°†æ•°æ®è¯»å–åˆ°å†…å­˜ä¸­ï¼Œç„¶åè¿›è¡Œå‹ç¼©å¹¶å­˜åˆ°GZIPOutputStreamå†…éƒ¨çš„byteæ•°ç»„bufä¸­ã€‚\nå‹ç¼©çš„é€»è¾‘ç”±JDKå°è£…çš„java.util.zip.Deflater æ¥è°ƒç”¨nativeå®ç° ä½†æ˜¯æ­¤å¤„ä¸ä¼šä¸€æœ‰æ•°æ®å°±é©¬ä¸Šè¿›è¡Œå‹ç¼©(NO_FLUSH æ¨¡å¼)ï¼Œè€Œæ˜¯æ•°æ®ç´¯è®¡åˆ°ä¸€å®šé‡ä¹‹åæ‰è¿›è¡Œå‹ç¼©, å…·ä½“å¤šå°‘æ•°æ®é‡æ‰å‹ç¼©ç”±Deflaterå†³å®š. å¦‚æœå‹ç¼©åçš„æ•°æ®ä¸€ä¸ªbuf è£…ä¸ä¸‹, å°±å°†buf ä¼ ç»™ChunkedOutputFilter(ç¬¬7#ï¼‰ï¼Œç»§ç»­å¾€bufé‡Œå¡«å……æ•°æ®ã€‚\nå½“æ‰€æœ‰ç°é˜¶æ®µå·²å‹ç¼©çš„æ•°æ®éƒ½äº¤ç»™ChunkedOutputFilteråï¼ŒGzipOutputFilter#doWriteæ–¹æ³•æ‰ç®—ç»“æŸ\npublic void write(byte[] b, int off, int len) throws IOException { ... if (!def.finished()) { def.setInput(b, off, len); while (!def.needsInput()) { deflate(); } } } æºç ä½ç½®ï¼šorg.apache.coyote.http11.filters.GzipOutputFilter#doWrite åŠjava.util.zip.Deflater#deflate(byte[], int, int, int)\nå°†åˆ°bufä¸­çš„byteä¼ ç»™ChunkedOutputFilterï¼Œè°ƒç”¨ChunkedOutputFilterçš„doWriteæ–¹æ³•ã€‚ChunkedOutputFilterä¼šæ„é€ éœ€è¦åˆ†å¼€ä¼ è¾“çš„å—ï¼Œç„¶åå°†å—å†™å…¥åˆ°socketBufferHandlerçš„writeBufferä¸­ã€‚å¦‚æœwriteBufferä¹Ÿæ»¡äº†åˆ™ä¼šå†™åˆ°socketä¸­ï¼Œå¼€å§‹åˆ†å—ä¼ è¾“ã€‚\nç»§ç»­1#ï¼Œ2#ï¼Œ5#ï¼Œ6#, 7#ç›´åˆ°servlet writeç»“æŸã€‚\nç»è¿‡å‰é¢å‡ æ­¥åè¿™ä¸ªé•¿å“åº”ä½“å¤§éƒ¨åˆ†éƒ½å·²ç»è¢«ä¼ è¾“åˆ°å®¢æˆ·ç«¯ï¼Œè¿˜æœ‰ä¸€å°éƒ¨åˆ†å¯èƒ½å­˜åœ¨CharBufferå’ŒByteBufferä¸­ï¼Œservlet çš„service æ–¹æ³•ä¹Ÿä¼šæ‰§è¡Œç»“æŸï¼Œæ¥åˆ°Adapterçš„response.finishResponse() é˜¶æ®µï¼Œæºç ä½ç½®ï¼šorg.apache.catalina.connector.Response#finishResponse\nå¦‚æœCharBufferä¸­æœ‰æ•°æ®åˆ™flushåˆ°ByteBufferï¼Œå¦‚æœByteBufferæ»¡äº†åˆ™ç»§ç»­3#ï¼Œ5#ã€‚ è°ƒç”¨doFlushæ–¹æ³•ï¼Œå†æ¬¡flush CharBuffer å’Œflush ByteBufferã€‚ é€šè¿‡Close Actionè°ƒç”¨Http11Processorçš„finishResponseæ–¹æ³•ï¼Œç„¶åè°ƒç”¨åˆ°GzipOutputFilterçš„endæ–¹æ³•ï¼Œæ ‡è®°finishä¸ºtrueã€‚ é‡‡ç”¨FINISHæ¨¡å¼ç»§ç»­å‹ç¼©ï¼Œæ­¤æ—¶ä¼šæŠŠå‰©ä¸‹æ•°æ®ç»§ç»­å‹ç¼©(å› ä¸ºæœ‰å¯èƒ½å†…å­˜ä¸­ç´¯è®¡çš„æ•°æ®é‡è¿˜æ²¡åˆ°deflaterçš„æ ‡å‡†ï¼‰ï¼Œå‹ç¼©åçš„æ•°æ®ä¾æ—§å­˜åˆ°bufä¸­å¹¶ç»§ç»­ç¬¬7#ï¼Œ8#æ­¥ã€‚æºç ä½ç½®ï¼šjava.util.zip.GZIPOutputStream#finish * ç›´åˆ°å†…å­˜ä¸­æ‰€æœ‰å“åº”æ•°æ®å‹ç¼©å¹¶å†™åˆ°bufå®Œæˆï¼Œæ ‡è®°finished ä¸ºtrueã€‚ * å¦‚æœbufæ»¡è½½çš„æƒ…å†µä¸‹ï¼Œå—ä¸­ç¬¬ä¸€è¡Œæ ‡æ˜æ•°æ®é•¿åº¦ä¼šæ˜¯512ï¼Œç”¨åå…­è¿›åˆ¶200è¡¨ç¤ºã€‚ æœ€åæŒ‰ç…§GZIP ç®—æ³•è¦æ±‚æ„é€ æ•°æ®å°¾éƒ¨ï¼Œå¹¶ç»§ç»­ä¼ é€’ç»™ChunkedOutputFilterï¼Œè‡³æ­¤å…¨éƒ¨çš„å‹ç¼©æ•°æ®éƒ½å·²å¤„ç†å®Œæˆ ä¸Šè¿°servletå¼€å¯å‹ç¼©å‰ï¼Œæµè§ˆå™¨ä¸­æ˜¾ç¤ºå“åº”å¤§å°çº¦ä¸º30MB,\nå¼€å¯å‹ç¼©åä¼ è¾“ä½“ç§¯å‡å°‘äº†1000å€ï¼\n","date":"2024-02-29T13:38:34+08:00","image":"http://localhost:1313/posts/tomcat-http-%E5%8E%8B%E7%BC%A9%E4%B8%8E%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93/images/IMG_0942_hu64891f67de11c90bd86988b705ef8032_13009892_120x120_fill_box_smart1_3.png","permalink":"http://localhost:1313/posts/tomcat-http-%E5%8E%8B%E7%BC%A9%E4%B8%8E%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93/","title":"tomcat http å‹ç¼©ä¸åˆ†å—ä¼ è¾“"},{"content":"Tomcatè‡ª1998å¹´é—®ä¸–ä»¥æ¥å› ä¸ºå…¶é«˜æ€§èƒ½ï¼Œå…è´¹ç­‰ç‰¹ç‚¹å¹¿å—Javaçˆ±å¥½è€…çš„å–œçˆ±ï¼Œä½†åœ¨Springbootç­‰å¾®æœåŠ¡æ¡†æ¶æˆä¸ºæŠ€æœ¯ä¸»æµåçš„ä»Šå¤©ï¼Œtomcatä¼¼ä¹é€æ¸\u0026quot;æ¶ˆå¤±\u0026quot;åœ¨å¤§ä¼—çš„è§†çº¿ä¸­ï¼Œä½ è¿˜åœ¨ç”¨tomcatå—ï¼Ÿæˆ‘ç›¸ä¿¡å¯¹äºå¤§éƒ¨åˆ†java web developeræ¥è¯´è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯Yes, å› ä¸ºSpringboot web starteré»˜è®¤é›†æˆçš„å°±æ˜¯tomcatã€‚\næœ¬æ–‡å°è¯•ä»\u0026quot;ä¸ºä»€ä¹ˆæµè§ˆå™¨å‘å‡ºçš„HTTPè¯·æ±‚å¯ä»¥åˆ°è¾¾æˆ‘ä»¬çš„Controller\u0026quot;è¿™ä¸€åŸºæœ¬é—®é¢˜å‡ºå‘ï¼Œç”±æµ…å…¥æ·±ï¼Œç”±ç‚¹åˆ°é¢çš„æ–¹å¼å…ˆä»æ•´ä½“çš„è§’åº¦æ¥æ¢³ç†tomcatçš„æ¶æ„åŸç†ï¼Œå†åˆ°ä»¥ä¸€ä¸ªHTTP/1.1 è¯·æ±‚ä¸ºä¾‹æ¥åˆ†ætomcatä½œä¸ºä¸€ä¸ªHTTP webæœåŠ¡å™¨å’ŒServletå®¹å™¨å®ƒæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæœ€åå›å½’è¿™ä¸ªé—®é¢˜æ¢³ç†springbootæ˜¯å¦‚ä½•ä¸tomcaté›†æˆçš„ã€‚å…¶ä¸­æ¶‰åŠå¤§é‡çš„æºç è§£æï¼Œè¯·ç•™æ„æ¶‰åŠæºç è§£æçš„éƒ¨åˆ†éƒ½æ˜¯åŸºäºtomcat 10.x æ¥è¿›è¡Œã€‚å¸Œæœ›èƒ½ç»™é‚£äº›å¯¹tomcatåŸç†æ„Ÿå…´è¶£çš„åŒå­¦æä¾›ä¸€äº›è§†è§’å’Œå‚è€ƒã€‚\nä»€ä¹ˆæ˜¯Tomcat Tomcatçš„æ ¸å¿ƒåŠŸèƒ½ tomcatæ˜¯ä¸€ä¸ª==webåº”ç”¨æœåŠ¡å™¨==å’Œ==Servletå®¹å™¨==ï¼Œå®ƒè¿˜æ˜¯ Jakarta Servletã€Jakarta Server Pagesã€Jakarta Expression Languageã€Jakarta WebSocketã€Jakarta Annotations å’Œ Jakarta Authentication è§„èŒƒçš„å¼€æºå®ç°ã€‚\nè¿™é‡Œæœ‰ä¸¤ä¸ªé‡ç‚¹ï¼Œwebåº”ç”¨æœåŠ¡å™¨å’ŒServletå®¹å™¨ã€‚åˆ†åˆ«å¯¹åº”äº†å®ƒçš„ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š\nä»€ä¹ˆæ˜¯WebæœåŠ¡å™¨, è¯´ç™½äº†ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å°†ä¸»æœºä¸Šçš„æŸä¸ªèµ„æºæ˜ å°„æˆä¸€ä¸ªURLä¾›å¤–ç•Œè®¿é—®ã€‚\nå¤„ç† Socket è¿æ¥ï¼Œè´Ÿè´£ç½‘ç»œå­—èŠ‚æµä¸ Request å’Œ Response å¯¹è±¡çš„è½¬åŒ–ã€‚ åŠ è½½å¹¶ç®¡ç† Servlet ï¼Œå¹¶å°†è¯·æ±‚äº¤ç»™Servletå¤„ç†ã€‚ ä½†webæœåŠ¡å™¨ å’Œservletå®¹å™¨ä¾æ—§æ˜¾çš„æœ‰äº›æŠ½è±¡ï¼Œä»–ä»¬åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ\nç†è§£ä»€ä¹ˆæ˜¯tomcat å°±æ˜¯ç†è§£tomcatåˆ°åº•å¸®æˆ‘ä»¬åšäº†ä»€ä¹ˆã€‚æˆ‘ä»¬åœ¨ä¸Šæ‰‹åšJava webé¡¹ç›®æ—¶å¾€å¾€éƒ½æ˜¯åŸºäºæ¡†æ¶æ¯”å¦‚springboot,æ¥ä¸“æ³¨äºä¸šåŠ¡ä»£ç å¼€å‘ï¼Œæˆ‘ä»¬çŸ¥é“æŒ‰ç…§springboot çš„è§„åˆ™æ¥å®šä¹‰ä¸€äº›controller, å°±å¯ä»¥æ¥æ”¶åˆ°ä»æµè§ˆå™¨å‘è¿‡æ¥çš„HTTPè¯·æ±‚ã€‚\nä½†æ˜¯ï¼Œ==ä¸ºä»€ä¹ˆcontrollerå¯ä»¥æ”¶åˆ°å¹¶å¤„ç†å®¢æˆ·ç«¯å‘è¿‡æ¥çš„è¯·æ±‚==?\nç­”æ¡ˆæ˜¯å› ä¸ºgradle æˆ–è€…maven ä¸­æœ‰spring-boot-starter-web è¿™ä¸ªä¾èµ–ï¼Œè€Œè¿™ä¸ªä¾èµ–é»˜è®¤å¸®æˆ‘ä»¬é›†æˆäº†Tomcatã€‚åœ¨è¿›ä¸€æ­¥ç†è§£tomcatæ˜¯æ€ä¹ˆå¸®æˆ‘æ¥æ”¶å¹¶è§£æHTTPè¯·æ±‚ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè®¾æƒ³ï¼Œå¦‚æœæ²¡æœ‰æ¡†æ¶ï¼Œç«™åœ¨tomcatå¼€å‘è€…çš„è§’åº¦æ¥æ€è€ƒæˆ‘ä»¬è¦è‡ªå·±å®ç°ä¸‹é¢è¿™æ ·çš„åŠŸèƒ½åº”è¯¥è¦æ€ä¹ˆåšã€‚\nScenario: Receive and Process HTTP Request Given the system is running When a valid HTTP request is received Then the system should successfully parse the HTTP request And extract the request path, parameters, method, and body if present And generate an appropriate HTTP response And include the correct HTTP status code indicating successful processing And include the expected response body format and data if applicable And include the appropriate HTTP headers in the response (e.g., Content-Type) ç†è§£HTTP è¯·æ±‚çš„æœ¬è´¨ HTTPè¯·æ±‚æ˜¯å®¢æˆ·ç«¯åœ¨å‘æœåŠ¡ç«¯è¯·æ±‚æŸä¸ªèµ„æºæ—¶ï¼Œå‘æœåŠ¡ç«¯å‘é€çš„ç¬¦åˆHTTPåè®®è§„èŒƒçš„æ•°æ®ï¼Œä¸‹é¢ç»™å‡ºä¸€ä¸ªå®Œæ•´çš„GET è¯·æ±‚ç¤ºä¾‹\nGET /sample HTTP/1.1 Host: www.example.com Accept: application/json æ‰‹å†™æœ€ç®€ç‰ˆTomcat å¦‚ä½•å‘èµ·HTTPè¯·æ±‚ï¼Ÿ å‘èµ·HTTPè¯·æ±‚å…¶å®å°±æ„å‘³ç€æˆ‘ä»¬è¦æŠŠè¿™éƒ¨åˆ†æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ã€‚\né‚£æˆ‘ä»¬è¦æ€ä¹ˆæŠŠè¿™éƒ¨åˆ†æ•°æ®å‘é€ç»™æœåŠ¡å™¨å‘¢ï¼Ÿè¿™å…¶å®æ¶‰åŠè®¡ç®—æœºç½‘ç»œçš„åŸºç¡€ï¼Œè®¡ç®—æœºä¹‹é—´æ˜¯å¦‚ä½•é€šä¿¡çš„ã€‚\nå‡è®¾æœ‰ä¸€ä¸ªä¸»æœºAï¼Œæœ‰ä¸€ä¸ªä¸»æœºBï¼ŒAéœ€è¦é€šè¿‡æµè§ˆå™¨å‘é€HTTPè¯·æ±‚ç»™Bçš„Java è¿›ç¨‹ã€‚é‚£ä¹ˆç»å†å¦‚ä¸‹æ­¥éª¤ï¼š\n1.HTTP æ˜¯åº”ç”¨å±‚åè®®ï¼Œåœ¨å‘é€æ•°æ®ä¹‹å‰ï¼ŒAä¸­çš„æµè§ˆå™¨éœ€è¦å’ŒBä¸­çš„Java è¿›ç¨‹å»ºç«‹ä¸€ä¸ªTCP é“¾æ¥ã€‚\né‚£æˆ‘ä»¬å¦‚ä½•å»ºç«‹TCP é“¾æ¥å‘¢ï¼Œå…¶å®è¿™éƒ¨åˆ†å·¥ä½œæ˜¯ç”±åº”ç”¨å±‚çš„åº•å±‚åº“å»å¸®æˆ‘ä»¬æ¥åšçš„ã€‚ä»¥Java ä¸ºä¾‹ï¼Œè¿™ä¸ªç±»åº“å°±å«åšSocketã€‚å®ƒä¹Ÿæ˜¯åœ¨ç½‘ç»œé€šä¿¡ä¸­çš„ä¸€ä¸ªç§æŠ½è±¡æ¦‚å¿µï¼Œä»Javaçš„è§’åº¦æ¥ç†è§£å»ºç«‹ä¸€ä¸ªTCP é“¾æ¥å…¶å®å°±æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªSocket å¯¹è±¡ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå»ºç«‹TCPé“¾æ¥ç¤ºä¾‹ï¼š\nval socket = Socket(\u0026#34;google.com\u0026#34;, 443) println(socket.isConnected) å½“ä¸Šè¿°ä»£ç è¾“å‡ºtrue å°±è¡¨æ˜å·²ç»å»ºç«‹äº†é“¾æ¥ï¼Œè¿™åº•å±‚ç”±JDK è°ƒç”¨æ“ä½œç³»ç»ŸAPI æ¥å®ç°ã€‚\n2.é“¾æ¥å»ºç«‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æµå¼çš„ä¼ è¾“æ•°æ®ï¼Œå‘èµ·HTTPè¯·æ±‚å…¶å®å°±æ˜¯å‘ä¸€ä¸ªåœ°æ–¹å»å†™ç¬¦åˆHTTPè§„èŒƒæ•°æ®ã€‚\nå‘å“ªé‡Œå†™ï¼Ÿä¾æ—§ä»¥Java ä¸ºä¾‹ï¼Œä¸Šé¢è¯´åˆ°åœ¨ç½‘ç»œä¸­çš„é€šä¿¡æˆ‘ä»¬æœ‰ä¸ªæŠ½è±¡çš„ä¸œè¥¿å«Socket, è€ŒJDK ç±»åº“å¸®æˆ‘ä»¬åšäº†åº•å±‚å®ç°ï¼Œå› æ­¤æˆ‘ä»¬å†™æ•°æ®è¯»æ•°æ®è¿˜æ˜¯é¢å‘Socketã€‚ä¸‹é¢æ˜¯å‘socket æ•°æ®çš„ç¤ºä¾‹ï¼š\n# å†™å…¥ä¸€ä¸ªå­—èŠ‚æ•°ç»„ socket.getOutputStream().write(\u0026#34;Ping!\u0026#34;.toByteArray()) #ä¹Ÿå¯ä»¥å†™å…¥å•ä¸ªå­—èŠ‚ socket.getOutputStream().write(71) è¿™é‡Œçš„byte,71æ ¹æ®å­—ç¬¦ç¼–ç å¯ä»¥è§£ææˆå¯¹åº”çš„å­—ç¬¦ï¼Œ71é€šå¸¸å¯¹åº”çš„æ˜¯å­—æ¯G, å…³äºå­—ç¬¦ç¼–ç è¯·å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡ç¬”è®°ï¼šASCIIã€Unicodeå’ŒUTF-8ä¸å­—ç¬¦ç¼–ç \n3.æˆ‘ä»¬å‘Socketå†™å…¥æ•°æ®åï¼Œå‰©ä¸‹çš„ä¹Ÿä¼šç”±jvmå’Œæ“ä½œç³»ç»Ÿå¸®æˆ‘ä»¬å¤„ç†ï¼Œé€šè¿‡é€šä¿¡ç½‘ç»œä¼ è¾“åˆ°ä¸»æœºBä¸Šã€‚\nè‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªHTTPè¯·æ±‚çš„æ—¶å€™å¹²äº†ä»€ä¹ˆï¼Œä¸åŒçš„åº”ç”¨ç¨‹åºåº•å±‚å¯¹äºSocketå¯èƒ½æœ‰ä¸åŒå®ç°, ä½†è¿™éƒ¨åˆ†åº•å±‚ç»†èŠ‚å…¶å®å¾€å¾€ä¸ç”¨æˆ‘ä»¬æ“å¿ƒï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å‘èµ·HTTPè¯·æ±‚å°±æ˜¯å‘é€äº†ä¸€æ®µç¬¦åˆHTTPåè®®è§„èŒƒçš„æ•°æ®åˆ°æœåŠ¡ç«¯ã€‚å…³äºæ›´å¤šHTTP åè®®çš„å†…å®¹è¯·å‚é˜…ç›¸å…³æ–‡æ¡£ã€‚\nå¦‚ä½•æ¥æ”¶å¹¶å¤„ç†HTTP è¯·æ±‚? ç«¯å£ç›‘å¬ ä¸Šé¢è¯´åˆ°å‘èµ·HTTP è¯·æ±‚å…¶å®å°±æ˜¯å‘é€ä¸€æ®µæ•°æ®ç»™æœåŠ¡ç«¯ï¼Œé‚£ä¸ºä»€ä¹ˆå¯ä»¥å‘é€æ•°æ®å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬åœ¨å‘é€æ•°æ®ä¹‹å‰å»ºç«‹äº†TCP é“¾æ¥ï¼Œè€ŒTCP æ˜¯ä¸€ç§é¢å‘é“¾æ¥çš„å¯é çš„åè®®ï¼Œé‚£ä¸ºä»€ä¹ˆå¯ä»¥å»ºç«‹TCPé“¾æ¥ï¼ŸSocket(\u0026quot;google.com\u0026quot;, 443) è¿™æ®µä»£ç ä¸­çš„ä¸¤ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆå«ä¹‰ï¼Ÿ\nåŸŸåä¼šè¢«DNSæœåŠ¡å™¨è§£ææˆip, ç”¨æ¥åœ¨ç½‘ç»œä¼ è¾“ä¸­æ‰¾åˆ°å¯¹åº”çš„ä¸»æœºï¼Œè€Œ443åˆ™è¡¨ç¤ºæœåŠ¡å™¨æ­£åœ¨ç›‘å¬çš„ç«¯å£ï¼Œ æ³¨æ„ä¸€ä¸ªè¿›ç¨‹å¯èƒ½ä¼šç”¨åˆ°å¤šä¸ªç«¯å£ã€‚\nä¸‹é¢æˆ‘ä»¬çœ‹æ€ä¹ˆåœ¨Java ä¸­å¼€å¯è¿™æ ·çš„ç«¯å£ç›‘å¬ã€‚\nval serverSocket = ServerSocket(8080) println(\u0026#34;Server started successfully, listening on port: 8080\u0026#34;) æˆ‘ä»¬ç”¨åˆ°äº†ServerSocketè¿™ä¸ªç±»ï¼Œå®ƒæä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œä½¿å¾—Javaåº”ç”¨ç¨‹åºèƒ½å¤Ÿç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶åœ¨è¿æ¥å»ºç«‹åè¿›è¡Œé€šä¿¡ã€‚è€Œè¿™åº•å±‚ä¹Ÿæ˜¯æœ‰JDKè°ƒç”¨æ“ä½œç³»ç»ŸAPI å®ç°ã€‚\n1.å®ƒå»ºç«‹äº†ä¸€ä¸ªä¸“é—¨ä¾¦å¬æŸç«¯å£çš„socket\n2.æ¯æ¬¡æˆåŠŸä¸å®¢æˆ·ç«¯æ¡æ‰‹å,ä¼šåˆ›å»ºä¸€ä¸ªé’ˆå¯¹å½“å‰å®¢æˆ·çš„æ–°socket\n3.åç»­ç¨‹åºé€šè¿‡è¿™ä¸ªsocketä¸å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®äº¤äº’\nè¯»å–æ•°æ®å¹¶è§£ææˆHTTP è¯·æ±‚ å†æ¬¡è¯´åˆ°å‘èµ·ä¸€ä¸ªHTTPè¯·æ±‚å°±æ˜¯å‘é€äº†ä¸€æ®µæ•°æ®ç»™æœåŠ¡å™¨ï¼Œæˆ‘ä»¬çœ‹æ€ä¹ˆæ ·è¯»å–è¿™ä»½æ•°æ®ã€‚\n# å»ºç«‹ServerSocketåè°ƒç”¨accept æ–¹æ³•æ¥æ¥æ”¶è¯·æ±‚ï¼Œåœ¨æœ‰è¯·æ±‚åˆ°æ¥ä¹‹å‰è¿™ä¸ªæ–¹æ³•ä¼šä¸€ç›´é˜»å¡ï¼Œå¹¶ä¸”ä¸ºäº†å¤„ç†å¤šæ¬¡è¯·æ±‚ï¼Œä¸€èˆ¬ä¼šå¾ªç¯è°ƒç”¨ val socket = serverSocket.accept() # ä¸Šè¿°æ–¹æ³•è¿”å›äº†Socket, è¿™å’Œæˆ‘ä»¬ä»å®¢æˆ·ç«¯å»ºç«‹é“¾æ¥æ—¶çœ‹åˆ°çš„Socket æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºè¯´äº†ï¼Œç½‘ç»œä¸Šçš„é€šä¿¡æˆ‘ä»¬éƒ½æ˜¯é¢å‘Socket val bytes = socket.getInputStream().let { val bytes = ByteArray(it.available()) it.read(bytes) bytes } println(bytes.decodeToString()) åœ¨10è¡Œè¿è¡Œå®Œåæˆ‘ä»¬å¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„è¾“å‡ºï¼š\nGET /sample HTTP/1.1 Host: www.example.com Accept: application/json è¿™æ­£æ˜¯æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯å‘èµ·çš„HTTP è¯·æ±‚ï¼\nç„¶åæˆ‘ä»¬å°±å¯ä»¥å»è§£æè¿™æ®µæ–‡æœ¬ï¼ŒåŒ…æ‹¬å»è§£æè¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´ï¼Œè¯·æ±‚ä½“ç­‰åŸºäºå­—ç¬¦ä¸²æ“ä½œå»è¿›è¡Œå…·ä½“çš„ä¸šåŠ¡å¤„ç†ã€‚\nå¦‚ä½•å“åº” å“åº”æ˜¯ç”±æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å“åº”ï¼Œå“åº”å°±æ˜¯å›ä¼ æ»¡è¶³HTTP åè®®çš„è§„èŒƒæ•°æ®ï¼ŒåŒæ ·æ˜¯é¢å¯¹socket å¯¹è±¡è¿›è¡Œï¼ŒJDK å’Œæ“ä½œç³»ç»Ÿä¼šå¸®æˆ‘ä»¬å¤„ç†åº•å±‚å’Œå‰©ä¸‹çš„äº‹ã€‚\nsocket.getOutputStream().write( (\u0026#34;HTTP/1.1 200 OK\\r\\n\u0026#34; + \u0026#34;Content-Type: text/plain\\r\\n\u0026#34; + \u0026#34;Content-Length: 25\\r\\n\u0026#34; + \u0026#34;\\r\\n\u0026#34; + \u0026#34;Hello, World and /sample!\u0026#34; ).toByteArray() ) å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¿™ä»½æ•°æ®åä¾¿å¯ä»¥æ ¹æ®æ ¹æ®HTTP åè®®è§£ææ•°æ®ç„¶åä½œå¯¹åº”å¤„ç†ã€‚\nä»¥ä¸Šå°±æ˜¯è‡ªå·±å»å®ç°è¿™ä¸ªéœ€æ±‚è¦åšçš„äº‹ï¼Œç„¶è€Œæˆ‘ä»¬å¹³æ—¶åœ¨ä½¿ç”¨springbootå¼€å‘æ—¶å‡ ä¹ä¸éœ€è¦å…³å¿ƒè¿™äº›ï¼Œå› ä¸ºé›†æˆçš„tomcatä¼šå¸®æˆ‘ä»¬å¤„ç†ï¼Œè¿™æ­£æ˜¯Tomcat çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼š\n==å¤„ç† Socket è¿æ¥ï¼Œè´Ÿè´£ç½‘ç»œå­—èŠ‚æµä¸ Request å’Œ Response å¯¹è±¡çš„è½¬åŒ–==ã€‚\næœ€ç®€ç‰ˆTomcat å°†ä»¥ä¸Šæ­¥éª¤å†ä¸²èµ·æ¥æˆ‘ä»¬å°±å¯ä»¥è‡ªå·±å»å®ç°tomcatï¼Œ æ³¨æ„ï¼ŒçœŸæ­£çš„tomcatå®ç°å’ŒåŠŸèƒ½è¦æ¯”è¿™ä¸ªå¤æ‚çš„å¤šï¼Œä½†ç†è§£è¿™éƒ¨åˆ†å†…å®¹å¯¹äºæˆ‘ä»¬ç†è§£ä»€ä¹ˆæ˜¯Tomcatå¾ˆé‡è¦ï¼Œå› ä¸ºtomcatåœ¨åšç€ç±»ä¼¼çš„äº‹æƒ…ã€‚\næµ‹è¯•å…ˆè¡Œ\n@Test fun `should successfully process valid HTTP request`() { // Given MyHttpServer(TEST_PORT).start() // When // å‘èµ·HTTP è¯·æ±‚ val socket = sendRequest() // Then assertEquals( \u0026#34;HTTP/1.1 200 OK\\r\\nContent-Type: text/plain\\r\\n\u0026#34; + \u0026#34;Content-Length: 25\\r\\n\\r\\nHello, World and /sample!\u0026#34;, decodeResponse(socket) ) } /** * 1.å»ºç«‹socketè¿æ¥ * 2.å‘socketä¸­å†™å…¥ç¬¦åˆHTTPè§„èŒƒçš„æ•°æ® * 3.è¿”å›socket */ private fun sendRequest( httpRequest: String = \u0026#34;GET /sample HTTP/1.1\\r\\n\u0026#34; + \u0026#34;Host: localhost\\r\\n\u0026#34; + \u0026#34;Accept: application/json\\r\\n\\r\\n\u0026#34; ): Socket { val socket = Socket(Constants.LOCAL_HOST, Constants.TEST_PORT) socket.getOutputStream().write(httpRequest.toByteArray(Charset.defaultCharset())) return socket } SampleHttpServerç±»\nè´Ÿè´£åˆ›å»ºServerSocketç›‘å¬ç«¯å£ æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä»Socket ä¸­è¯»å–æ•°æ®è§£ææˆRequestå¯¹è±¡ æ„å»ºResponse å¯¹è±¡å¹¶å‘Socketä¸­å†™å…¥æ•°æ® package com.fan import java.net.ServerSocket import java.net.Socket import java.net.SocketException import java.nio.charset.StandardCharsets class SampleHttpServer(private val port: Int) { private lateinit var serverSocket: ServerSocket private var isRunning = true fun start() { createServerSocket(port) println(\u0026#34;${currentThreadName()}Server started successfully, listening on port $port\u0026#34;) Thread { while (isRunning) { val clientSocket = acceptClientConnection(serverSocket) clientSocket?.let { try { handleClientRequest(clientSocket) } catch (e: Exception) { e.printStackTrace() } finally { closeSocket(clientSocket) } } } }.start() } private fun closeSocket(clientSocket: Socket) { checkIfSocketClosed(clientSocket) if (!clientSocket.isClosed) { clientSocket.close() checkIfSocketClosed(clientSocket) } } private fun checkIfSocketClosed(clientSocket: Socket) { println(\u0026#34;${currentThreadName()}client socket closed? ${clientSocket.isClosed}\u0026#34;) } private fun createServerSocket(port: Int) { this.serverSocket = ServerSocket(port) } private fun acceptClientConnection(serverSocket: ServerSocket): Socket? { try { val clientSocket = serverSocket.accept() println(\u0026#34;${currentThreadName()}Accepted client connection from: ${clientSocket.inetAddress}\u0026#34;) return clientSocket } catch (e: SocketException) { //socket maybe closed from client, ignore println(\u0026#34;${currentThreadName()} ${e.message}\u0026#34;) } return null } private fun handleClientRequest(clientSocket: Socket) { val requestBytes = readBytesFromSocketInputStream(clientSocket) println(\u0026#34;${currentThreadName()}Received bytes from client:${requestBytes.contentToString()}\u0026#34;) val httpRequest = parseBytesToHttpRequest(requestBytes) val httpResponse = buildResponse(httpRequest) sendResponseToClient(httpResponse, clientSocket) } private fun readBytesFromSocketInputStream(socket: Socket): ByteArray { return socket.getInputStream().let { val bytes = ByteArray(it.available()) it.read(bytes) bytes } } private fun parseBytesToHttpRequest(bytes: ByteArray): Request { val plainRequest = String(bytes, StandardCharsets.UTF_8) println(\u0026#34;${currentThreadName()}Received request:\\r\\n--------------\\r\\n$plainRequest\\r\\n--------------\u0026#34;) val httpMethod = extractHttpMethod(plainRequest) val uri = extractUri(plainRequest) val protocol = extractProtocol(plainRequest) return Request(httpMethod, protocol, uri) } private fun extractHttpMethod(plainRequest: String): String { return plainRequest.substring(0, plainRequest.indexOf(\u0026#34; \u0026#34;)) } private fun extractUri(plainRequest: String): String { val start = plainRequest.indexOf(\u0026#34; \u0026#34;) + 1 val end = plainRequest.indexOf(\u0026#34;HTTP\u0026#34;) - 1 return plainRequest.substring(start, end) } private fun extractProtocol(plainRequest: String): String { val start = plainRequest.indexOf(\u0026#34;HTTP\u0026#34;) + 5 val end = plainRequest.indexOf(\u0026#34;\\r\\n\u0026#34;) return plainRequest.substring(start, end) } private fun buildResponse(request: Request): Response { val body = \u0026#34;Hello, World and ${request.uri}!\u0026#34; return Response( statusLine = \u0026#34;HTTP/1.1 200 OK\u0026#34;, headers = \u0026#34;Content-Type: text/plain\\r\\nContent-Length: ${body.length}\u0026#34;, body = body ) } private fun sendResponseToClient(response: Response, socket: Socket) { val responseBytes = response.toString().toByteArray() socket.getOutputStream().write(responseBytes) println(\u0026#34;${currentThreadName()}Response sent to client.\u0026#34;) } private fun currentThreadName() = \u0026#34;[${Thread.currentThread().name}] \u0026#34; fun stop() { isRunning = false if (::serverSocket.isInitialized) { serverSocket.close() } } } Request å’Œ Response\npackage com.fan data class Request( val method: String, val protocol: String, val uri: String ) data class Response( val statusLine: String, val headers: String, val body: String ) { override fun toString(): String { return statusLine + \u0026#34;\\r\\n\u0026#34; + headers + \u0026#34;\\r\\n\\r\\n\u0026#34; + body } } æºç åœ°å€: https://github.com/woaihuangfan/how-tomcat-works.git\nè¿™æ˜¯é‡‡ç”¨å¤§éƒ¨åˆ†äººè¾ƒä¸ºç†Ÿæ‚‰BIOçš„çš„å®ç°æ–¹å¼ï¼Œè€Œä»tomcat 8.0å¼€å§‹ä¼šé»˜è®¤ä½¿ç”¨NIOçš„æ–¹å¼æ¥å¤„ç†è¯·æ±‚ï¼Œå…³äºNIOçš„demoè¯·åœ¨æºç ä¸­å¯»æ‰¾NioHttpServerã€‚\nä»€ä¹ˆæ˜¯Servlet webå¼€å‘ï¼Œæˆ‘ä»¬å…¶å®ä¸»è¦å¤„ç†ä¸‰ä»¶äº‹ï¼š\næ¥æ”¶è¯·æ±‚ï¼š ä»socket ä¸­è¯»å–æ•°æ® å¤„ç†è¯·æ±‚ï¼šå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚é’ˆå¯¹æ•°æ®åº“çš„curd å“åº”: å‘socket ä¸­å†™å…¥æ•°æ® #1å’Œ#3æ“ä½œæ˜¯åŸºç¡€æ“ä½œï¼Œå¤§å®¶éƒ½è¦å¹²è¿™äº‹ä¸”å¹²çš„æ–¹å¼åŸºæœ¬éƒ½ä¸€æ ·ï¼Œæ— éå°±æ˜¯é’ˆå¯¹socketçš„ç½‘ç»œç¼–ç¨‹ï¼Œä½†æ˜¯å¤„ç†è¯·æ±‚çš„éƒ¨åˆ†æ˜¯ä¸åŒçš„ï¼Œå› ä¸ºä¸šåŠ¡é€»è¾‘åƒå·®ä¸‡åˆ«ä¸‡åˆ«ã€‚\n#1ä¸­è¯»å–åˆ°æ•°æ®åï¼Œéœ€è¦äº¤ç»™ä¸€ä¸ªä¸œè¥¿(å¯¹è±¡)è®©2#æ¥å¤„ç†è¯·æ±‚ï¼Œè¿™ä¸ªä¸œè¥¿å¤„ç†å®Œè¯·æ±‚åè¿˜è¦ç”Ÿæˆå“åº”äº¤ç»™#3ï¼Œ æˆ‘ä»¬æŠŠè¿™ä¸ªä¸œè¥¿(å¯¹è±¡) å«Servletã€‚Servlet å°±æ˜¯#1 å’Œ#2ï¼Œ #2å’Œ#3ä¹‹é—´çš„è¿™ä¸ªä¸­é—´å±‚ã€‚\nä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜æ˜¯ï¼Œå¤„ç†è¯·æ±‚æ—¶åªèƒ½ç”¨ä¸€ä¸ªå¯¹è±¡å—ï¼Ÿå½“ç„¶ä¸æ˜¯ï¼Œæˆ‘ä»¬å¤„ç†è¯·æ±‚å¯èƒ½éœ€è¦ç”¨åˆ°å¤šä¸ªå¯¹è±¡ï¼ˆæ¯”å¦‚controllerï¼Œservice), ä½†è¿™äº›controller service å¯¹è±¡èƒ½å«servletå—ï¼Ÿã€‚\næ‰€ä»¥è¿™ä¸‰ä»¶äº‹å†å…·ä½“ä¸€ç‚¹æ€»ç»“ä¸‹å°±æ˜¯ï¼š\næ¥æ”¶è¯·æ±‚ï¼š ä»socket ä¸­è¯»å–æ•°æ®ï¼Œ ==å¹¶æŠŠæ•°æ®äº¤ç»™Servlet== å¤„ç†è¯·æ±‚ï¼šServletå¤„ç†å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚é’ˆå¯¹æ•°æ®åº“çš„curdï¼Œç„¶åç”Ÿæˆå“åº” å“åº”: è·å–Servletç”Ÿæˆçš„å“åº”å¹¶å‘socket ä¸­å†™å…¥æ•°æ® 1å’Œ3çš„æ“ä½œå¤§å®¶å¯ä»¥å…±ç”¨ï¼Œå› æ­¤å¯ä»¥æ”¾åˆ°æ¡†æ¶é‡Œï¼Œ#2éœ€è¦æˆ‘ä»¬è‡ªå·±å»å®ç°ï¼Œç°åœ¨é—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬çŸ¥é“è¦å†™Servlet å»å¤„ç†è¯·æ±‚ï¼Œä½†æ˜¯æˆ‘æ€ä¹ˆçŸ¥é“è¯¥æ€ä¹ˆå†™ï¼Ÿæ¯”å¦‚éœ€ç”¨ä»€ä¹ˆæ–¹æ³•å‘½åï¼Œå‚æ•°ç­‰ç­‰æ‰èƒ½è¢«æ¡†æ¶è°ƒç”¨åˆ°ã€‚\næœ‰åŒå­¦å¯èƒ½è¯´å–å†³äºä½ ç”¨ä»€ä¹ˆæ¡†æ¶ï¼Œ ä½†å¦‚æœæƒ³æ¢æ¡†æ¶æ€ä¹ˆåŠï¼Ÿ\nå› æ­¤æˆ‘ä»¬å°±æœ‰äº†Servletè§„èŒƒï¼Œæ¥æŒ‡å¯¼æ¡†æ¶æ€ä¹ˆå†™ï¼Œservletæ€ä¹ˆå†™ï¼Œä»¥ç¡®ä¿ä¸åŒçš„Servletå®¹å™¨ï¼ˆä¾‹å¦‚Tomcatã€Jettyç­‰ï¼‰ä¹‹é—´çš„å…¼å®¹æ€§ã€‚æ¯”å¦‚:\nè§„å®šäº†æ‰€æœ‰Servletç±»éƒ½å¿…é¡»å®ç°javax.servlet.Servlet è¿™ä¸ªæ¥å£\nå®šä¹‰äº†Servletçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¯”å¦‚è§„å®šæ¯ä¸€ä¸ªservlet éƒ½å¿…é¡»æœ‰ init()ã€service()ã€destroy()ï¼Œ\næè¿°äº†Servletå®¹å™¨çš„èŒè´£å’ŒåŠŸèƒ½ï¼Œæ¯”å¦‚å½“è¯·æ±‚æ¥äº†ä¼šè°ƒç”¨Servletå®ä¾‹çš„serviceæ–¹æ³•\nç­‰ç­‰ã€‚æ›´å¤šè¯¦ç»†çš„è§„èŒƒè¯·å‚é˜…\nâš ï¸ Servlet API çš„åŒ…åè‡ª2020å¹´12æœˆJakarta EE 9 å‘å¸ƒåå·²ç»ä» javax.servlet æ›´æ”¹ä¸º jakarta.servlet\nç›¸ä¿¡å¾ˆå¤šäººåœ¨å­¦java web æ—¶ä¸€å¼€å§‹éƒ½ä¼šå»å­¦æ€ä¹ˆå†™ä¸€ä¸ªServlet.\nè§„èŒƒã€çº¦å®šçš„æ€æƒ³éšå¤„å¯è§ï¼Œè¿™ä¸ªä¸–ç•Œä¸‡ç‰©çš„è¿è¡Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯åŸºäºè§„èŒƒè§„åˆ™ã€‚\nå†å»ç†è§£ä»€ä¹ˆæ˜¯tomcatçš„æ—¶å€™å‘ç°tomcat å…¶å®ä¹Ÿå®ç°äº†Servletè§„èŒƒï¼Œ ä¹Ÿå¯ä»¥ç†è§£ä¸ºä»€ä¹ˆè¯´Tomcat æ˜¯servlet å®¹å™¨äº†ã€‚\nå°ç»“\nServlet æ˜¯ä¸€æ®µç¨‹åº éœ€è¦ç¬¦åˆServletè§„èŒƒ å®ƒä¸»è¦ç”¨äºå¤„ç†å’Œå“åº”HTTP è¯·æ±‚ è¿è¡Œåœ¨æ”¯æŒServletè§„èŒƒçš„å®¹å™¨ä¸­ Tomcat çš„å·¥ä½œåŸç† è™½ç„¶åº”ç”¨å¤§éƒ¨åˆ†åº”ç”¨éƒ½æ˜¯åŸºäºspringbootåŠå…¶é»˜è®¤å†…åµŒçš„tomcatè¿›è¡Œå¼€å‘ï¼Œä½†æ˜¯è„±ç¦»å¤æ‚çš„springæŠŠtomcatä½œä¸ºç‹¬ç«‹éƒ¨ç½²çš„ä¸­é—´ä»¶å¯ä»¥æ›´å¥½çš„æ¥å¸®åŠ©æˆ‘ä»¬æ¥å­¦ä¹ å’Œäº†è§£tomcatã€‚\nä¸‹è½½Tomcat curl https://dlcdn.apache.org/tomcat/tomcat-10/v10.1.18/bin/apache-tomcat-10.1.18.zip -o apache-tomcat-10.1.18.zip è§£å‹åå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç›®å½•ç»“æ„ï¼š\nè‡ªå®šä¹‰ä¸€ä¸ªServlet\nä»¥ä¸‹ä»£ç ç”±kotlin å®ç°ï¼Œæ³¨æ„HttpServlet å·²ç»å®ç°äº†jakarta.servlet æ‰€ä»¥æ­¤å¤„æˆ‘ä»¬åªéœ€è¦ç»§æ‰¿HttpServletå°±è¡Œã€‚\nclass DemoServlet : HttpServlet() { override fun doGet(request: HttpServletRequest, response: HttpServletResponse) { response.writer.write(\u0026#34;Pong!\u0026#34;) } } ç¼–è¯‘ä¸Šè¿°ä»£ç ï¼Œå¾—åˆ°classæ–‡ä»¶\nç”±äºæ˜¯kotlin ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨IDEA è¿›è¡Œç¼–è¯‘ï¼Œä¹Ÿå¯ä»¥ç”¨ç¦»çº¿çš„kotlinç¼–è¯‘å™¨ï¼Œæˆ‘æ˜¯é€‰æ‹©çš„å‰è€…ã€‚\nå°†class æ–‡ä»¶æ‹·è´åˆ°tomcatæŒ‡å®šç›®å½•\nåœ¨webapp ä¸‹åˆ›å»ºä¸€ä¸ªç›®å½•å‘½åä¸ºmy-appï¼Œ å¹¶åœ¨my-appåˆ›å»ºå¦‚ä¸‹ç›®å½•ç»“æ„ï¼š\nmy-app â””â”€â”€ WEB-INF â”œâ”€â”€ classes â”‚Â â””â”€â”€ org â”‚Â â””â”€â”€ fan â”‚Â â””â”€â”€ DemoServlet.class â”œâ”€â”€ lib â”‚Â â”œâ”€â”€ annotations-13.0.jar â”‚Â â””â”€â”€ kotlin-stdlib-1.9.21.jar â””â”€â”€ web.xml web.xml çš„å†…å®¹å¦‚ä¸‹\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;web-app xmlns=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xsi:schemaLocation=\u0026#34;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd\u0026#34; version=\u0026#34;3.1\u0026#34;\u0026gt; \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;DemoServlet\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;com.fan.DemoServlet\u0026lt;/servlet-class\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;DemoServlet\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;/ping\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; \u0026lt;/web-app\u0026gt; è¿™ä¸€æ­¥å°±æ˜¯é…ç½®æ˜ å°„è§„åˆ™ï¼Œè®©ç¬¦åˆè§„åˆ™çš„è¯·æ±‚è¢«æŒ‡å®šçš„servletå¤„ç†ã€‚\né€šè¿‡binç›®å½•ä¸‹çš„è„šæœ¬å¯åŠ¨Tomcat\nchmod -R +x ./bin ./bin/startup.sh æµè§ˆå™¨è®¿é—®http://localhost:8080/my-app/ping\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åªè¦æŠŠè‡ªå·±å†™çš„Servlet æŒ‰ç…§tomcat çš„è§„åˆ™æ”¾åˆ°æŒ‡å®šç›®å½•ä¸‹ï¼Œç„¶åè¿è¡Œtomcat æˆ‘ä»¬å†™çš„Servletå°±å¯ä»¥å¤„ç†è¯·æ±‚ï¼Œä¸‹é¢è§£é‡Šä¸‹æˆ‘åˆšåˆšåˆ›å»ºçš„ç›®å½•ç»“æ„çš„ä½œç”¨ã€‚\nclasses è¿™ä¸ªç›®å½•å­˜æ”¾æˆ‘ä»¬è‡ªå·±å†™çš„Servletç¼–è¯‘åçš„å­—èŠ‚ç æ–‡ä»¶\nä»€ä¹ˆæ˜¯å­—èŠ‚ç æ–‡ä»¶ï¼Ÿé‡Œé¢å­˜çš„æ˜¯ä»€ä¹ˆï¼Ÿé•¿ä»€ä¹ˆæ ·å­ï¼Ÿ\nlib å­˜æ”¾æˆ‘ä»¬éœ€è¦ç”¨åˆ°çš„ä¾èµ–ï¼Œå› ä¸ºæˆ‘æ˜¯ç”¨kotlinç¼–å†™çš„ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°ç›¸å…³ä¾èµ–\nweb.xml å­˜æ”¾Tomcatç›¸å…³é…ç½®ï¼Œä¸Šé¢æˆ‘ä»¬åªå‘Šè¯‰äº†tomcat æŠŠURIä¸º/ping çš„è¯·æ±‚äº¤ç»™ DemoServletå¤„ç†\nè‡³æ­¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ°tomcat è‡³å°‘åšäº†å¦‚ä¸‹çš„äº‹ï¼š\nç›‘å¬ç½‘ç»œç«¯å£ æ¥å—ç½‘ç»œè¯·æ±‚ è¯»å–ç½‘ç»œæ•°æ® æ ¹æ®HTTP åè®®è§£ææ•°æ® åŠ è½½class æ–‡ä»¶åŠjar æ–‡ä»¶ è°ƒç”¨DemoServletçš„doGet æ–¹æ³• å°†å“åº”çš„å­—èŠ‚æµå†™å›ç»™æµè§ˆå™¨ è¦åšè¿™äº›äº‹è‚¯å®šä¸ä¼šåƒæˆ‘ä»¬demoç‰ˆä»£ç ä¸­é‚£ä¹ˆç®€å•ï¼Œè‚¯å®šç»è¿‡è®¾è®¡çš„ï¼Œä½†æ˜¯æ— è®ºæ€ä¹ˆè®¾è®¡ï¼Œæ¯ä¸ªæ¥å£å’Œæ¨¡å—éƒ½æœ‰å®ƒè‡ªå·±çš„èŒè´£å’Œè¦å¤„ç†çš„äº‹æƒ…ï¼Œä¸‹é¢å…ˆçœ‹çœ‹tomcat çš„æ•´ä½“æ¶æ„ã€‚\nTomcatæ¶æ„ Tomcatæ•´ä½“æ¶æ„æ˜¯ä¸€ç§åˆ†å±‚çš„ç»“æ„ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç»“è®ºå›¾(æ¥æºäºç½‘ç»œ)ï¼Œ åé¢æˆ‘åœ¨åˆ†ææºç çš„æ—¶å€™ä¼šé€æ¸æŠŠæºç å’Œè¿™ä¸ªå›¾å¯¹åº”èµ·æ¥ã€‚\nåœ¨è¿™å°èŠ‚æˆ‘ä»¬å¯ä»¥å…ˆåªå…³æ³¨Serverã€ Serviceã€Connectorã€Engineã€Hostã€Contextã€Wrapperï¼Œ è®°ä½è¿™å‡ ä¸ªç»„ä»¶åå­—åŠä»–ä»¬çš„å±‚çº§å…³ç³», å…¶ä¸­é™¤Connectoræ²¡æœ‰æŠ½è±¡å‡ºæ¥å£å¤–ï¼Œå…¶ä½™ä¹Ÿéƒ½å¯¹åº”äº†tomcatä¸­å‡ ä¸ªé¡¶çº§æ¥å£åå­—(ä¾‹å¦‚org.apache.catalina.Server), è€ŒStandardXXX æ˜¯è¿™äº›æ¥å£çš„å®ç°ã€‚\næ³¨æ„ï¼šä¸‹æ–‡è´´å‡ºçš„æºä»£ç éƒ¨åˆ†éƒ½æ˜¯ç²¾ç®€è¿‡åçš„å…³é”®ä»£ç ã€ä¸ªäººè®¤ä¸ºæ˜¯ä½œä¸ºç†è§£tomcatçš„å¿…è¯»éƒ¨åˆ†ã€‚è¿‡å®Œå¿…è¯»éƒ¨åˆ†åï¼Œè‹¥èƒ½ä¸‹è½½å…¨éƒ¨æºç é€šè¿‡debugæ¥äº†è§£æ›´å¤šç»†èŠ‚åˆ™æ›´ä½³ï¼Œå…³äºå¦‚ä½•åœ¨æœ¬åœ°ç¼–è¯‘å¹¶å¯åŠ¨tomcatæºç å¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡ï¼šå¦‚ä½•ç”¨IDEAæœ¬åœ°ç¼–è¯‘å¯åŠ¨tomcat\nStandardServer public final class StandardServer extends LifecycleMBeanBase implements Server { ... private Catalina catalina = null; /** * The set of Services associated with this Server. */ private Service services[] = new Service[0]; ... @Override public void addService(Service service) { ... synchronized (servicesLock) { Service results[] = new Service[services.length + 1]; // å°†services ä¸­çš„å€¼æ‹·è´åˆ°results System.arraycopy(services, 0, results, 0, services.length); results[services.length] = service; services = results; ... } } @Override public void addConnector(Connector connector) { synchronized (connectorsLock) { connector.setService(this); Connector results[] = new Connector[connectors.length + 1]; System.arraycopy(connectors, 0, results, 0, connectors.length); results[connectors.length] = connector; connectors = results; } ... } @Override public void setCatalina(Catalina catalina) { this.catalina = catalina; } ... } StandardService public class StandardService extends LifecycleMBeanBase implements Service { ... private Engine engine = null; /** * The \u0026lt;code\u0026gt;Server\u0026lt;/code\u0026gt; that owns this Service, if any. */ private Server server = null; /** * The set of Connectors associated with this Service. */ protected Connector connectors[] = new Connector[0]; ... @Override public void setContainer(Engine engine) { ... this.engine = engine; if (this.engine != null) { this.engine.setService(this); } ... } @Override public void setServer(Server server) { this.server = server; } @Override public void addConnector(Connector connector) { synchronized (connectorsLock) { connector.setService(this); Connector results[] = new Connector[connectors.length + 1]; System.arraycopy(connectors, 0, results, 0, connectors.length); results[connectors.length] = connector; connectors = results; } ... } ... } StandardEngine public class StandardEngine extends ContainerBase implements Engine { /** * The \u0026lt;code\u0026gt;Service\u0026lt;/code\u0026gt; that owns this Engine, if any. */ private Service service = null; ... @Override public void addChild(Container child) { // Engineçš„Child å¿…é¡»æ˜¯Host if (!(child instanceof Host)) { throw new IllegalArgumentException (sm.getString(\u0026#34;standardEngine.notHost\u0026#34;)); } // è°ƒç”¨çˆ¶ç±»ContainerBaseä¸­çš„å®ç° super.addChild(child); } ... } StandardHost public class StandardHost extends ContainerBase implements Host { ... @Override public void addChild(Container child) { // Hostçš„Childå¿…é¡»æ˜¯Context if (!(child instanceof Context)) { throw new IllegalArgumentException (sm.getString(\u0026#34;standardHost.notContext\u0026#34;)); } ... // è°ƒç”¨çˆ¶ç±»ContainerBaseä¸­çš„å®ç° super.addChild(child); } ... } StandardContext public class StandardContext extends ContainerBase implements Context, NotificationEmitter { ... @Override public void addChild(Container child) { // Global JspServlet Wrapper oldJspServlet = null; if (!(child instanceof Wrapper)) { throw new IllegalArgumentException (sm.getString(\u0026#34;standardContext.notWrapper\u0026#34;)); } ... // è°ƒç”¨çˆ¶ç±»ContainerBaseä¸­çš„å®ç° super.addChild(child); ... } ... } StandardWrapper public class StandardWrapper extends ContainerBase implements ServletConfig, Wrapper, NotificationEmitter { ... /** * Refuse to add a child Container, because Wrappers are the lowest level * of the Container hierarchy. * * @param child Child container to be added */ @Override public void addChild(Container child) { // StandardWrapperæ˜¯å±‚çº§çš„æœ€åº•å±‚ï¼Œæ‹’ç»æ·»åŠ child throw new IllegalStateException (sm.getString(\u0026#34;standardWrapper.notChild\u0026#34;)); } ... } æˆ‘ä»¬å¯ä»¥çœ‹åˆ°StandardEngineï¼ŒStandardHostï¼ŒStandardContext, StandardWrapperéƒ½ç»§æ‰¿äº†ContainerBaseä¸”éƒ½å®ç°äº†Container æ¥å£ï¼Œä»–ä»¬addChild çš„æ—¶å€™éƒ½è°ƒç”¨äº†çˆ¶ç±»æ–¹æ³•ï¼Œchild ç»´æŠ¤åœ¨çˆ¶ç±»çš„childrenå±æ€§ä¸­.\npublic abstract class ContainerBase extends LifecycleMBeanBase implements Container { ... /** * The parent Container to which this Container is a child. */ protected Container parent = null; protected final HashMap\u0026lt;String, Container\u0026gt; children = new HashMap\u0026lt;\u0026gt;(); ... @Override public void addChild(Container child) { ... addChildInternal(child); ... } private void addChildInternal(Container child) { ... synchronized(children) { if (children.get(child.getName()) != null) { throw new IllegalArgumentException( sm.getString(\u0026#34;containerBase.child.notUnique\u0026#34;, child.getName())); } child.setParent(this); // May throw IAE children.put(child.getName(), child); } ... } ... } çœ‹å®Œä»¥ä¸Šå‡ ä¸ªç±»çš„éƒ¨åˆ†æ ¸å¿ƒä»£ç å°±ä¼šç†è§£è¿™ç§åƒå¥—å¨ƒä¸€æ ·çš„åˆ†å±‚è®¾è®¡ã€‚\nä¾æ¬¡å¾€ä¸‹ï¼Œä¸€ä¸ªServer åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªService, ä¸€ä¸ªServiceåŒ…å«ä¸€ä¸ªEngineå’Œä¸€ä¸ªæˆ–å¤šä¸ªconnectorï¼Œä¸€ä¸ªEngine å¯ä»¥åŒ…å«å¤šä¸ªHost, ä¸€ä¸ªHost å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªContext, ä¸€ä¸ªContext å¯ä»¥åŒ…å«å¤šä¸ªWrapper, ä»Engineå¼€å§‹éƒ½å®ç°äº†Container æ¥å£ã€‚\nåŒ–æŠ½è±¡ä¸ºå…·ä½“\nç°åœ¨Server, service, engine ç­‰æˆ‘ä»¬ä»æŠ€æœ¯è§’åº¦ç†è§£äº†ä»–ä»¬æ˜¯ä¸€ä¸ªä¸ªçš„æ¥å£ï¼Œæˆ–è€…è¯´æŠ€æœ¯ç»„ä»¶ï¼Œä¾æ—§æ˜¯ä¸€ç§æŠ½è±¡çš„æ¦‚å¿µï¼Œé‚£å¦‚ä½•ä»ä¸šåŠ¡è§’åº¦ç†è§£ä»–ä»¬æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ\nServerå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªtomcat server å®ä¾‹; Serviceå°†ä¸€ä¸ªæˆ–å¤šä¸ªè¿æ¥å™¨ä¸ä¸€ä¸ªEngineç›¸å…³è”; Engine ç”¨æ¥ç®¡ç†å¤šä¸ªè™šæ‹Ÿä¸»æœºï¼› Host ä»£è¡¨çš„æ˜¯ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œå¯ä»¥ç»™ Tomcat é…ç½®å¤šä¸ªè™šæ‹Ÿä¸»æœºåœ°å€ï¼› Context è¡¨ç¤ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºï¼Œè€Œä¸€ä¸ªè™šæ‹Ÿä¸»æœºä¸‹å¯ä»¥éƒ¨ç½²å¤šä¸ª Web åº”ç”¨ç¨‹åº; Wrapper è¡¨ç¤ºä¸€ä¸ª Servlet, ä¸€ä¸ª Web åº”ç”¨ç¨‹åºä¸­å¯èƒ½ä¼šæœ‰å¤šä¸ª Servletï¼› å¹¶ä¸”å¯ä»¥å‘ç°ï¼Œ\nåœ¨è¿™ä¸ªå±‚çº§ç»“æ„ä¸­ï¼Œå­èŠ‚ç‚¹ä¸­ä¹Ÿç»´æŠ¤äº†çˆ¶èŠ‚ç‚¹ï¼Œå½¢æˆäº†åŒå‘é“¾è¡¨å’Œå¯¹è±¡æ ‘ã€‚\næ¯ä¸€å±‚çš„ç»„ä»¶éƒ½å®ç°äº†Lifecycleæ¥å£ã€‚\nå†çœ‹çœ‹Tomcat é…ç½®æ–‡ä»¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„æ¥ç†è§£è¿™ä¸ªå±‚æ¬¡å…³ç³»ã€‚ä»¥ä¸‹é…ç½®æ–‡ä»¶èŠ‚é€‰è‡ªé»˜è®¤çš„conf/server.xmlæ–‡ä»¶ã€‚\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;Server port=\u0026#34;8005\u0026#34; shutdown=\u0026#34;SHUTDOWN\u0026#34;\u0026gt; \u0026lt;Service name=\u0026#34;Catalina\u0026#34;\u0026gt; \u0026lt;Connector port=\u0026#34;8080\u0026#34; protocol=\u0026#34;HTTP/1.1\u0026#34; connectionTimeout=\u0026#34;20000\u0026#34; redirectPort=\u0026#34;8443\u0026#34; /\u0026gt; \u0026lt;Engine name=\u0026#34;Catalina\u0026#34; defaultHost=\u0026#34;localhost\u0026#34;\u0026gt; \u0026lt;Host name=\u0026#34;localhost\u0026#34; appBase=\u0026#34;webapps\u0026#34; unpackWARs=\u0026#34;true\u0026#34; autoDeploy=\u0026#34;true\u0026#34;\u0026gt; \u0026lt;/Host\u0026gt; \u0026lt;/Engine\u0026gt; \u0026lt;/Service\u0026gt; \u0026lt;/Server\u0026gt; åŒæ—¶å¼•å…¥ä¸¤ä¸ªé—®é¢˜ï¼Œ\nè¿™ä¸ªå¯¹è±¡æ ‘çš„æ ¹èŠ‚ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿä¸Šé¢çš„æ¯ä¸ªå¯¹è±¡æ˜¯æ€ä¹ˆå®ä¾‹åŒ–çš„ï¼Ÿ ä¸ºä»€ä¹ˆéƒ½å®ç°äº†Lifecycleæ¥å£ï¼Ÿ è¦å›ç­”è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥å…ˆæ¥äº†è§£ä¸‹Tomcat çš„å¯åŠ¨è¿‡ç¨‹ã€‚\nTomcat çš„å¯åŠ¨è¿‡ç¨‹ ![tomcat å¯åŠ¨è¿‡ç¨‹](images/tomcat å¯åŠ¨è¿‡ç¨‹.png)\nä¸Šå›¾å°±æ˜¯tomcat å¯åŠ¨çš„è¿‡ç¨‹ï¼ŒBootstrap ä¸ºtomcat çš„å¯åŠ¨ç±»ï¼Œåˆ†ä¸ºinit, load, start å¤§çš„ä¸‰æ­¥ï¼Œç„¶ååˆåˆ†åˆ«è°ƒç”¨Catalina å¯¹åº”çš„load å’Œstart æ–¹æ³•ï¼Œåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­é€æ­¥å®ä¾‹åŒ–å„ä¸ªç»„ä»¶å¹¶æ„å»ºä»¥Catalinaä¸ºæ ¹èŠ‚ç‚¹çš„å¯¹è±¡æ ‘ã€‚\nåŒæ—¶æˆ‘ä»¬å‘ç°å¯åŠ¨è¿‡ç¨‹ä¸­\u0026quot;init\u0026quot;,\u0026ldquo;start\u0026rdquo; è¿™ç±»æ–¹æ³•éšå¤„å¯è§ï¼Œè¿™ä¸éš¾ç†è§£å±‚æ¬¡æ¶æ„ä¸­æ¯ä¸ªç»„ä»¶éƒ½æœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼Œå› æ­¤ä»–ä»¬éƒ½å®ç°äº†LifeCycle æ¥å£ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£æ¥ç®¡ç†æ‰€æœ‰ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚åŒæ—¶ï¼Œç”±äºæ ‘å½¢ç»“æ„çš„å­˜åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥åšåˆ°ä¸€é”®å¯åœï¼Œæ¯”å¦‚server çš„start æ–¹æ³•ä¼šè°ƒç”¨å­èŠ‚ç‚¹çš„æ–¹æ³•ã€‚\nåŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Lifecycleä¸­è¿˜æšä¸¾äº†LifecycleStateï¼Œå„ä¸ªç»„ä»¶åœ¨ç”Ÿå‘½å‘¨æœŸä¸­çš„æ¯ä¸€ä¸ªé˜¶æ®µéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„çŠ¶æ€å’Œäº‹ä»¶ï¼ŒåŒæ—¶è¿˜æœ‰ç»´æŠ¤çš„LifecycleListenerï¼Œé€šè¿‡äº‹ä»¶ç›‘å¬çš„æœºåˆ¶å¯ä»¥å¾ˆæ–¹ä¾¿æ‰©å±•å„ä¸ªç»„ä»¶ç°æœ‰çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚\nå¸¸è§çš„LifeCycleListener\nEngineConfig HostConfig ContextConfig \u0026hellip; Tomcatä¼—å¤šç»„ä»¶ä¸­æœ‰ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼šè¿æ¥å™¨(Connector) å’Œå®¹å™¨(Container).\nConntector ç»´æŠ¤åœ¨Service å®ä¾‹ä¸­ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯è´Ÿè´£å¯¹å¤–äº¤æµï¼ŒåŒ…æ‹¬ç›‘å¬ç«¯å£ï¼Œæ¥æ”¶è¯·æ±‚ï¼Œè¯»å–å¹¶è§£æè¯·æ±‚æ•°æ®ï¼Œç„¶åäº¤ç»™Servlet å¤„ç†ï¼Œå¹¶å°†å“åº”å†™å›ç»™å®¢æˆ·ç«¯ã€‚\nContainer å…¶å®æ˜¯ä¸€ä¸ªæ¯”è¾ƒä¸šåŠ¡åŒ–çš„æè¿°ï¼Œæˆ‘ä»¬å¸¸å¬åˆ°\u0026quot;Springå®¹å™¨\u0026quot;ï¼Œ\u0026ldquo;Servletå®¹å™¨\u0026rdquo;ï¼Œé‚£åˆ°åº•ä»€ä¹ˆæ˜¯å®¹å™¨ï¼Ÿå®¹å™¨æ˜¯ç”¨æ¥è£…ä¸œè¥¿çš„ï¼Œä¸€ä¸ªæ°´æ¯ä¹Ÿæ˜¯å®¹å™¨ï¼Œè£…çš„æ˜¯æ°´ã€‚é‚£æˆ‘ä»¬tomcaté‡Œè¯´çš„å®¹å™¨ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è£…Servlet, è¿™ä¹Ÿæ˜¯å®ƒçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ â€”â€” åŠ è½½å¹¶ç®¡ç† Servlet ã€‚æˆ‘ä»¬ä¸Šé¢çœ‹æ¶æ„çš„æ—¶å€™å¯ä»¥å‘ç°Engineï¼ŒHost , Context, Wrapper éƒ½å®ç°äº†Container æ¥å£ï¼Œå› æ­¤ä»–ä»¬éƒ½å¯ä»¥ç†è§£ä¸ºå®¹å™¨ï¼Œåªä¸è¿‡æ˜¯ä¸€ç§å¥—å¨ƒå¼è®¾è®¡ã€‚\nä½†æ˜¯æˆ‘ä»¬æœ‰æ—¶å€™ä¹Ÿçœ‹åˆ°è¯´\u0026quot;Catalina æ˜¯tomcat çš„servlet å®¹å™¨\u0026quot;, è¿™ç§è¯´æ³•æ­£ç¡®å—ï¼Ÿ å…¶å®ä¹Ÿæ­£ç¡®ï¼Œå› ä¸ºcatalina ä½œä¸ºå¯¹è±¡æ ‘çš„æ ¹èŠ‚ç‚¹ç®¡ç†ç€æ•´ä¸ªä¸‹å±‚å®¹å™¨ï¼Œæ‰€ä»¥å¾€å¤§äº†æˆ‘ä»¬ä¹Ÿå¯ä»¥è¯´Catalinaæ˜¯å®¹å™¨ï¼Œå¾€å°äº†è¯´å°±åªæœ‰å®ç°äº†Containeræ¥å£çš„ç»„ä»¶æ‰æ˜¯\u0026quot;å®¹å™¨\u0026quot;ï¼Œå®¹å™¨åªæ˜¯ä¸€ç§å¤§å®¶å¸¸ç”¨çš„ç”¨æ¥æ¯”æ‹Ÿçš„è¯ï¼Œæ›´é‡è¦çš„æ˜¯æ˜ç™½å®ƒèƒŒåæƒ³è¡¨è¾¾çš„æ˜¯ä»€ä¹ˆã€‚\nè¯·æ±‚æ¥æ”¶å’Œå¤„ç† Connectorçš„èŒè´£åˆå¯ä»¥ç»†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šç½‘ç»œé€šä¿¡(EndPoint), æ ¹æ®åº”ç”¨å±‚åè®®è§£æè¯·æ±‚æ•°æ®(Processor), å°è£…ServletRequestäº¤ç»™Servlet å¤„ç†(Adaptor)ã€‚\næˆ‘ä»¬åœ¨å‰é¢demoé»˜è®¤çš„åº”ç”¨å±‚åè®®æ˜¯HTTP/1.1 ï¼Œå…¶å®tomcat è¿˜æ”¯æŒAJP, HTTP/2\nConnectorçš„åˆ›å»º åœ¨server.xml ä¸­æœ‰å¦‚ä¸‹é…ç½®ï¼Œå½“Digisterè§£æxmlæ–‡ä»¶å‘ç°è¿™ä¸ªé…ç½®æ—¶å°±ä¼šå»å®ä¾‹åŒ–Connector.\n\u0026lt;Connector port=\u0026#34;8080\u0026#34; protocol=\u0026#34;HTTP/1.1\u0026#34; connectionTimeout=\u0026#34;20000\u0026#34; redirectPort=\u0026#34;8443\u0026#34; /\u0026gt; è€Œå®ä¾‹åŒ–çš„æ“ä½œæ˜¯åœ¨å¼€å§‹è§£æxmlä¹‹å‰ç»™Digisteræ·»åŠ äº†å¯¹åº”çš„Ruleå†³å®šçš„ã€‚\n// åœ¨å¼€å§‹è§£æxmlæ–‡ä»¶ä¹‹å‰ä¼šç»™Digisteræ·»åŠ ä¸€ä¸ªRuleæ¥å‘Šè¯‰Digisteré‡åˆ°\u0026lt;Connector\u0026gt;æ ‡ç­¾æ—¶çš„å¤„ç†é€»è¾‘ digester.addRule(\u0026#34;Server/Service/Connector\u0026#34;, new ConnectorCreateRule()); ç„¶ååœ¨å®ä¾‹åŒ–Connectorçš„æ—¶å€™ä¼šæ ¹æ®æˆ‘ä»¬é…ç½®çš„åè®®åˆ›å»ºProtocolHandler, å®ƒæ˜¯Connectorä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªç»„ä»¶ï¼Œä¸‹é¢ä¼šæåˆ°ã€‚\nè€Œé’ˆå¯¹HTTP/1.1 ä¼šåˆ›å»ºHttp11NioProtocol\nå†æ¥çœ‹çœ‹è¿™ä¸ªHttp11NioProtocolï¼Œ\nåœ¨åˆ›å»ºHttp11NioProtocolçš„æ—¶å€™ä¼šä¼ å…¥ä¸€ä¸ªNioEndpoint ä½œä¸ºæ„é€ å‡½æ•°çš„å‚æ•°ï¼Œ\npublic Http11NioProtocol() { super(new NioEndpoint()); } è€ŒEndPointç»´æŠ¤åœ¨AbstractProtocolä¸­ï¼Œ\npublic abstract class AbstractProtocol\u0026lt;S\u0026gt; implements ProtocolHandler, MBeanRegistration { ... /** * Endpoint that provides low-level network I/O - must be matched to the * ProtocolHandler implementation (ProtocolHandler using NIO, requires NIO * Endpoint etc.). */ private final AbstractEndpoint\u0026lt;S,?\u0026gt; endpoint; ... } Connector åˆ›å»ºå®Œåä¼šè°ƒç”¨service#addConnector æŠŠå®ƒç»‘å®šåˆ°service, è‡³æ­¤æˆ‘ä»¬çš„çŸ¥é“äº†ï¼š\nConnector æ˜¯åœ¨è§£æxml æ—¶æ ¹æ®äº‹å…ˆæŒ‡å®šçš„Ruleåˆ›å»º Connector åŒ…å«ProtocolHandler, åœ¨å®ä¾‹åŒ–Connectoræ—¶ä¼šæ ¹æ®xml é…ç½®æ¥åˆ›å»ºProtocolHandler, HTTP/1.1 ä¼šåˆ›å»ºHttp11NioProtocol ProtocolHandlerä¸­ç»´æŠ¤ç€EndPoint ç»„ä»¶ï¼ŒHttp11NioProtocolé»˜è®¤åˆ›å»ºNioEndpoint ç›‘å¬ç½‘ç»œç«¯å£å’Œæ¥æ”¶è¿æ¥è¯·æ±‚ Acceptor Acceptor å®ç°äº†Runnable æ¥å£ï¼Œæ˜¯ç»´æŠ¤åœ¨AbstractEndpointå†…éƒ¨çš„ä¸€ä¸ªfieldè¿™ä¸ªç±»å¾ˆç®€å•ï¼Œä¸»è¦é€»è¾‘å°±æ˜¯åœ¨runæ–¹æ³•ä¸­è°ƒç”¨endpoint.serverSocketAccept()ä»¥åŠendpoint.setSocketOptions(socket)æ¥ç›‘å¬ç«¯å£å’Œæ¥æ”¶è¯·æ±‚ã€‚\nå†·çŸ¥è¯†ï¼šfield å’Œproperty çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ\nfield æ²¡æœ‰get/set æ–¹æ³•ï¼Œä¸ä¼šå¯¹å¤–æš´éœ²ï¼Œ åä¹‹propertyéœ€è¦ï¼Œæ‰€ä»¥propertyé€šå¸¸æœ‰get/set æ–¹æ³•\nAcceptor çš„åˆ›å»ºåŠå¯åŠ¨\ntomcat å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œåœ¨è°ƒç”¨catalina çš„start æ–¹æ³•åï¼Œä¼šä¾æ¬¡è°ƒç”¨server.start(), service.start()ï¼Œè€Œåœ¨service ç»„ä»¶çš„startInternalæ–¹æ³•ä¸­ä¼šè°ƒç”¨Connectors çš„startæ–¹æ³•ã€‚\npublic class StandardService extends LifecycleMBeanBase implements Service { ... @Override protected void startInternal() throws LifecycleException { ... // Start our defined Connectors second synchronized (connectorsLock) { for (Connector connector: connectors) { // If it has already failed, don\u0026#39;t try and start it if (connector.getState() != LifecycleState.FAILED) { connector.start(); } } } } ... } public class Connector extends LifecycleMBeanBase { ... /** * Coyote protocol handler. */ protected final ProtocolHandler protocolHandler; ... @Override protected void startInternal() throws LifecycleException { ... try { protocolHandler.start(); } catch (Exception e) { throw new LifecycleException( sm.getString(\u0026#34;coyoteConnector.protocolHandlerStartFailed\u0026#34;), e); } } ... } public abstract class AbstractProtocol\u0026lt;S\u0026gt; implements ProtocolHandler, MBeanRegistration { ... @Override public void start() throws Exception { ... endpoint.start(); ... } ... } æœ€ç»ˆä¼šè°ƒç”¨åˆ°EndPointçš„startInternalæ–¹æ³•\npublic class NioEndpoint extends AbstractJsseEndpoint\u0026lt;NioChannel,SocketChannel\u0026gt; { @Override public void startInternal() throws Exception { if (!running) { running = true; paused = false; ... // Start poller thread poller = new Poller(); Thread pollerThread = new Thread(poller, getName() + \u0026#34;-Poller\u0026#34;); pollerThread.setPriority(threadPriority); pollerThread.setDaemon(true); pollerThread.start(); startAcceptorThread(); } } } public abstract class AbstractEndpoint\u0026lt;S,U\u0026gt; { protected void startAcceptorThread() { acceptor = new Acceptor\u0026lt;\u0026gt;(this); String threadName = getName() + \u0026#34;-Acceptor\u0026#34;; acceptor.setThreadName(threadName); Thread t = new Thread(acceptor, threadName); t.setPriority(getAcceptorThreadPriority()); t.setDaemon(getDaemon()); t.start(); } } Acceptorçº¿ç¨‹å¯åŠ¨å\n// Acceptor ç±» @Override public void run() { ... while (!stopCalled) { socket = endpoint.serverSocketAccept(); ... if (!stopCalled \u0026amp;\u0026amp; !endpoint.isPaused()) { if (!endpoint.setSocketOptions(socket)) { endpoint.closeSocket(socket); } } else { endpoint.destroySocket(socket); } ... } .... } //NioEndpointç±» @Override protected SocketChannel serverSocketAccept() throws Exception { // serverSocketChannel æ˜¯åœ¨catalina load é˜¶æ®µé€šè¿‡åˆå§‹åŒ– // å¦‚æœè®¾ç½®äº†blocking æ‰€ä»¥æ­¤å¤„ä¼šé˜»å¡ï¼Œä¾‹å¦‚ serverSocketChannel.configureBlocking(true)ï¼Œå¦åˆ™ç«‹å³è¿”å› SocketChannel result = serverSocketChannel.accept(); ... return result; } @Override protected boolean setSocketOptions(SocketChannel socket) { NioSocketWrapper socketWrapper = null; try { // åˆ†é…NioChannel NioChannel channel = null; if (nioChannels != null) { channel = nioChannels.pop(); } if (channel == null) { SocketBufferHandler bufhandler = new SocketBufferHandler( socketProperties.getAppReadBufSize(), socketProperties.getAppWriteBufSize(), socketProperties.getDirectBuffer()); if (isSSLEnabled()) { channel = new SecureNioChannel(bufhandler, this); } else { channel = new NioChannel(bufhandler); } } //å°è£…SocketWrapper NioSocketWrapper newWrapper = new NioSocketWrapper(channel, this); channel.reset(socket, newWrapper); connections.put(socket, newWrapper); socketWrapper = newWrapper; // Set socket properties // Disable blocking, polling will be used socket.configureBlocking(false); if (getUnixDomainSocketPath() == null) { socketProperties.setProperties(socket.socket()); } socketWrapper.setReadTimeout(getConnectionTimeout()); socketWrapper.setWriteTimeout(getConnectionTimeout()); socketWrapper.setKeepAliveLeft(NioEndpoint.this.getMaxKeepAliveRequests()); // å°†socketWrapperäº¤ç»™poller poller.register(socketWrapper); return true; } catch (Throwable t) { ExceptionUtils.handleThrowable(t); try { log.error(sm.getString(\u0026#34;endpoint.socketOptionsError\u0026#34;), t); } catch (Throwable tt) { ExceptionUtils.handleThrowable(tt); } if (socketWrapper == null) { destroySocket(socket); } } // Tell to close the socket if needed return false; } // Pollerç±» public void register(final NioSocketWrapper socketWrapper) { socketWrapper.interestOps(SelectionKey.OP_READ);//this is what OP_REGISTER turns into. PollerEvent pollerEvent = createPollerEvent(socketWrapper, OP_REGISTER); addEvent(pollerEvent); } å°ç»“\nåœ¨tomcat starté˜¶æ®µä¼šåœ¨Endpoint start çš„æ—¶å€™åˆ›å»ºå”¯ä¸€ä¸€ä¸ªacceptor çº¿ç¨‹\nAcceptorçº¿ç¨‹é€šè¿‡æ­»å¾ªç¯æ¥è°ƒç”¨endpoint.serverSocketAccept() æœ€ç»ˆè°ƒç”¨serverSocketChannel.accept()æ¥æ¥å—æ–°çš„è¿æ¥ï¼Œæœ‰æ–°è¿æ¥æ—¶ä¼šè¿”å›ä¸€ä¸ªSocketChannelã€‚è¿™é‡Œå’Œæˆ‘ä»¬å‰é¢demoä»£ç ä¸­çš„å®ç°æœ‰ä¸ªä¸åŒä¹‹å¤„æ˜¯å‰é¢demoä»£ç ä¸­ç”¨çš„æ˜¯BIOæ¨¡å¼ï¼Œè€Œä»tomcat 8.0å¼€å§‹é»˜è®¤NIOï¼Œè¿™æ˜¯NIOçš„å®ç°æ–¹å¼ã€‚\nç„¶åè°ƒç”¨endpoint.setSocketOptions(socket),æ¥å°è£…SocketWrapperï¼Œå¹¶è°ƒç”¨poller.register(socketWrapper)ï¼Œåˆ›å»ºPollerEventï¼Œ å¹¶ç»´æŠ¤åœ¨Poller å†…éƒ¨çš„events åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚\næˆ‘ä»¬å†æ¥çœ‹çœ‹Poller æ˜¯åšä»€ä¹ˆçš„ã€‚\nPoller Poller çº¿ç¨‹ä¹Ÿæ˜¯åœ¨Endpoint startçš„æ—¶å€™åˆ›å»ºï¼Œå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªevents é˜Ÿåˆ—ã€‚\nevents é˜Ÿåˆ—\nevents é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œå½“acceptor æ¥æ”¶åˆ°æ–°çš„è¯·æ±‚è¿æ¥åä¼šå°è£…PollerEvent æ·»åŠ åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼Œ æ¯ä¸ªPoller Event åŒ…å«è¿™ä¸ªé“¾æ¥çš„socketWrapper, socketWrapper ä¸­åŒ…å«å¯ä»¥ç”¨æ¥è¯»å†™æ•°æ®çš„SocketChannel.\nrunæ–¹æ³•\nrunæ–¹æ³•ä¼šä¸æ–­å»éå†events é˜Ÿåˆ—ï¼Œ å¦‚æœæœ‰event å°±ä¼šä»é˜Ÿåˆ—ä¸­å–å‡ºæ¥æ¶ˆè´¹\n/** * The background thread that adds sockets to the Poller, checks the * poller for triggered events and hands the associated socket off to an * appropriate processor as events occur. */ @Override public void run() { // Loop until destroy() is called while (true) { boolean hasEvents = false; try { if (!close) { hasEvents = events(); if (wakeupCounter.getAndSet(-1) \u0026gt; 0) { // If we are here, means we have other stuff to do // Do a non blocking select keyCount = selector.selectNow(); } else { keyCount = selector.select(selectorTimeout); } wakeupCounter.set(0); } ... } catch (Throwable x) { ExceptionUtils.handleThrowable(x); log.error(sm.getString(\u0026#34;endpoint.nio.selectorLoopError\u0026#34;), x); continue; } Iterator\u0026lt;SelectionKey\u0026gt; iterator = keyCount \u0026gt; 0 ? selector.selectedKeys().iterator() : null; // Walk through the collection of ready keys and dispatch // any active event. while (iterator != null \u0026amp;\u0026amp; iterator.hasNext()) { SelectionKey sk = iterator.next(); iterator.remove(); NioSocketWrapper socketWrapper = (NioSocketWrapper) sk.attachment(); // Attachment may be null if another thread has called // cancelledKey() if (socketWrapper != null) { processKey(sk, socketWrapper); } } // Process timeouts timeout(keyCount,hasEvents); } getStopLatch().countDown(); } è§£æè¯·æ±‚æ•°æ® processKey\npollerçº¿ç¨‹ä»events é˜Ÿåˆ—ä¸­å–å‡ºäº‹ä»¶åä¼šè°ƒç”¨processKey(sk, socketWrapper) è¿›è¡Œæ¶ˆè´¹\nprotected void processKey(SelectionKey sk, NioSocketWrapper socketWrapper) { try { if (close) { cancelledKey(sk, socketWrapper); } else if (sk.isValid()) { if (sk.isReadable() || sk.isWritable()) { if (socketWrapper.getSendfileData() != null) { processSendfile(sk, socketWrapper, false); } else { unreg(sk, socketWrapper, sk.readyOps()); boolean closeSocket = false; // Read goes before write if (sk.isReadable()) { if (socketWrapper.readOperation != null) { if (!socketWrapper.readOperation.process()) { closeSocket = true; } } else if (socketWrapper.readBlocking) { synchronized (socketWrapper.readLock) { socketWrapper.readBlocking = false; socketWrapper.readLock.notify(); } } else if (!processSocket(socketWrapper, SocketEvent.OPEN_READ, true)) { closeSocket = true; } } if (!closeSocket \u0026amp;\u0026amp; sk.isWritable()) { if (socketWrapper.writeOperation != null) { if (!socketWrapper.writeOperation.process()) { closeSocket = true; } } else if (socketWrapper.writeBlocking) { synchronized (socketWrapper.writeLock) { socketWrapper.writeBlocking = false; socketWrapper.writeLock.notify(); } } else if (!processSocket(socketWrapper, SocketEvent.OPEN_WRITE, true)) { closeSocket = true; } } if (closeSocket) { cancelledKey(sk, socketWrapper); } } } } else { // Invalid key cancelledKey(sk, socketWrapper); } } catch (CancelledKeyException ckx) { cancelledKey(sk, socketWrapper); } catch (Throwable t) { ExceptionUtils.handleThrowable(t); log.error(sm.getString(\u0026#34;endpoint.nio.keyProcessingError\u0026#34;), t); } } processSocket\nprocessSocketçš„å®ç°åœ¨AbstractEndpoint ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åˆ›å»ºäº†SocketProcessorå¹¶äº¤ç»™çº¿ç¨‹æ± æ¥å¤„ç†ã€‚åˆ’é‡ç‚¹ï¼šæ¯ä¸€ä¸ªsocket éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„socketProcessoræ¥å¤„ç†ã€‚\npublic boolean processSocket(SocketWrapperBase\u0026lt;S\u0026gt; socketWrapper, SocketEvent event, boolean dispatch) { try { ... // åˆ›å»ºSocketProcessorï¼Œ SocketProcessoræ˜¯EndPoint çš„å†…éƒ¨ç±» sc = createSocketProcessor(socketWrapper, event); ... Executor executor = getExecutor(); // äº¤ç»™çº¿ç¨‹æ± æ¥å¤„ç† executor.execute(sc); ... } catch (RejectedExecutionException ree) { getLog().warn(sm.getString(\u0026#34;endpoint.executor.fail\u0026#34;, socketWrapper) , ree); return false; } catch (Throwable t) { ExceptionUtils.handleThrowable(t); // This means we got an OOM or similar creating a thread, or that // the pool and its queue are full getLog().error(sm.getString(\u0026#34;endpoint.process.fail\u0026#34;), t); return false; } return true; } SocketProcessoræ˜¯EndPoint çš„å†…éƒ¨ç±»ï¼Œæœ€ç»ˆä¼šè°ƒç”¨doRun æ–¹æ³•æ¥å¤„ç†\n@Override protected void doRun() { Poller poller = NioEndpoint.this.poller; ... // getHandler è¿”å›çš„å°±æ˜¯ConnectionHandlerï¼Œ æ˜¯AbstractProtocolçš„ä¸€ä¸ªå†…éƒ¨ç±» state = getHandler().process(socketWrapper, event); ... } è¿”å›çš„å°±æ˜¯ConnectionHandlerçš„process æ–¹æ³•ï¼Œ\n@Override public SocketState process(SocketWrapperBase\u0026lt;S\u0026gt; wrapper, SocketEvent status) { ... try { ... if (processor == null) { processor = recycledProcessors.pop(); ... } if (processor == null) { // è¿”å›Processor processor = getProtocol().createProcessor(); register(processor); ... } ... do { state = processor.process(wrapper, status); ... } while ( state == SocketState.UPGRADING); ... return state; } catch(Exception e){} // Make sure socket/processor is removed from the list of current // connections release(processor); return SocketState.CLOSED; } // AbstactHttp11Protocol ä¸­createProcessor çš„å®ç° // æ³¨æ„æ­¤å¤„ä¼ å…¥äº†ä¸€ä¸ªAdapter, å®ƒåœ¨Connectoråˆå§‹åŒ–æ—¶åˆ›å»º // adapter = new CoyoteAdapter(this); // protocolHandler.setAdapter(adapter); @Override protected Processor createProcessor() { Http11Processor processor = new Http11Processor(this, adapter); return processor; } ä»¥HTTP/1.1 ä¸ºä¾‹ï¼Œ ä¸Šè¿°ä»£ç ä¼šåˆ›å»ºHTTP11Processor æ¥å¤„ç†è¿™ä¸ªsocket\nAbstractProcessorLightçš„process æ–¹æ³•ã€‚\n@Override public SocketState process(SocketWrapperBase\u0026lt;?\u0026gt; socketWrapper, SocketEvent status) throws IOException { ... do { ... if(condition) // service æ˜¯æŠ½è±¡æ–¹æ³• state = service(socketWrapper); } ... } while (state == SocketState.ASYNC_END || dispatches != null \u0026amp;\u0026amp; state != SocketState.CLOSED); return state; } å°ç»“\næ¯ä¸€ä¸ªHttp11Processor å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ªHttp11InputBuffer å’Œä¸€ä¸ªHttp11OutputBuffer, ç”¨ä½œé’ˆå¯¹socket IO çš„ç¼“å­˜å±‚ï¼Œåœ¨å®ç°çš„service æ–¹æ³•ä¸­æ¥è§£æè¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´, ç„¶åå°†è¯·æ±‚äº¤ç»™Adapterå¤„ç†\nHttp11Processorçš„service æ–¹æ³•\n@Override public SocketState service(SocketWrapperBase\u0026lt;?\u0026gt; socketWrapper) throws IOException { .... // Parsing the request header if (!inputBuffer.parseRequestLine(keptAlive, protocol.getConnectionTimeout(), protocol.getKeepAliveTimeout())) { if (inputBuffer.getParsingRequestLinePhase() == -1) { return SocketState.UPGRADING; } else if (handleIncompleteRequestLineRead()) { break; } } // Process the Protocol component of the request line // Need to know if this is an HTTP 0.9 request before trying to // parse headers. prepareRequestProtocol(); ... //è§£æå®Œåä¼šè°ƒç”¨adaptor çš„service æ–¹æ³• getAdapter().service(request, response); } è§£æè¯·æ±‚è¡Œ è§£æè¯·æ±‚è¡Œçš„æ“ä½œåœ¨Http11InputBufferçš„parseRequestLineä¸­è¿›è¡Œï¼Œ\nparseRequestLineä¼šè°ƒç”¨ç§æœ‰æ–¹æ³•fill(boolean block) ,æ¥è¯»å–åŸå§‹çš„è¯·æ±‚æ•°æ®ï¼Œåœ¨è¿™é‡Œå®ƒå°±æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚\nfillæ–¹æ³•ä¸­é€šè¿‡nRead = socketWrapper.read(block, byteBuffer); ä¼šå°†socket ä¸­çš„è¾“å…¥æµè¯»å–åˆ°Http11InputBufferä¸­çš„byteBufferä¸­\nè·³è¿‡ç©ºè¡Œ\nè§£æè¯·æ±‚æ–¹æ³•ï¼š ä»ç¬¬ä¸€ä¸ªå­—ç¬¦(Token)å¼€å§‹è¯»ï¼Œè¯»åˆ°ç©ºç™½(\u0026rsquo; \u0026lsquo;) æˆ–tab(\u0026rsquo;\\t\u0026rsquo;) ç»“æŸï¼Œ è¿™ä¸€æ­¥ç»“æŸåå¯ä»¥å¾—åˆ°GETï¼Œ ç„¶åé€šè¿‡request.method().setBytes(byteBuffer.array(), parsingRequestLineStart,pos - parsingRequestLineStart) æ¥ä¿å­˜è¯·æ±‚æ–¹æ³•ï¼Œæ³¨æ„æ­¤å¤„ä¿å­˜çš„æ˜¯æºç å…¨éƒ¨çš„å­—èŠ‚æ•°ç»„ï¼Œä»¥åŠGETåœ¨æ•°ç»„ä¸­å¯¹åº”çš„èµ·å§‹ä½ç½®ã€‚\næ­¤å¤„çš„requestæ˜¯org.apache.coyote.Request, åœ¨Http11Processorå®ä¾‹åŒ–çš„æ—¶å€™æ„å»º, ç»´æŠ¤åœ¨AbstractProcessor ä¸­\nè§£æURI: ç»§ç»­å¾€ä¸‹è¯»å­—ç¬¦ï¼Œç›´åˆ°ç©ºç™½æˆ–æ¢è¡Œï¼Œä¾‹å¦‚è¿™ä¸€æ­¥ä¼šå¾—åˆ° /my-app/ping ç„¶åç±»ä¼¼çš„é€šè¿‡request.requestURI().setBytes(byteBuffer.array(), parsingRequestLineStart,end - parsingRequestLineStart) å°†è¿™éƒ¨åˆ†ä¿¡æ¯ä¿å­˜åœ¨requestä¸­ï¼Œè®°å½•URIåœ¨æ•°ç»„ä¸­èµ·å§‹ä½ç½®ã€‚\nè§£æåè®®ï¼šç»§ç»­å¾€ä¸‹è¯»å­—ç¬¦ï¼Œç›´åˆ°ç©ºç™½æˆ–æ¢è¡Œï¼Œé€šè¿‡request.protocol().setBytes(byteBuffer.array(), parsingRequestLineStart,end - parsingRequestLineStart) å°†è¯·æ±‚æ‰€ç”¨çš„åè®®ä¾‹å¦‚HTTPä¿å­˜åœ¨requestä¸­ï¼Œè®°å½•åè®®åœ¨æ•°ç»„ä¸­èµ·å§‹ä½ç½®ã€‚\nrequestä¸­çš„è¯·æ±‚åè®®ï¼Œæ–¹æ³•ï¼ŒURLç­‰æ¯ä¸€ä¸ªä¿¡æ¯éƒ½ç”¨MessageBytes ç±»å‹çš„å˜é‡æ¥å­˜å‚¨ï¼ŒMessageBytes å†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªByteChunk å­—èŠ‚å—ï¼Œä¸Šé¢è§£æå‡ºæ¥çš„è¯·æ±‚è¡Œä¿¡æ¯éƒ½ä¼šå˜æˆbytechunk åŠMessageByteå­˜å‚¨åˆ°requestä¸­ã€‚\nè§£æè¯·æ±‚å¤´ è§£æè¯·æ±‚å¤´é€šè¿‡inputBuffer.parseHeaders() æ¥è¿›è¡Œï¼Œä¹Ÿæ˜¯æŒ‰ç…§HTTPåè®®æ¥è¿›è¡Œå­—ç¬¦çš„æ“ä½œåˆ¤æ–­è§£æå‡ºheaders, ç„¶åå­˜å‚¨åœ¨request ä¸­ã€‚\nå¤„ç†è¯·æ±‚ Adapterçš„åˆ›å»º\n//Adapter æ˜¯åœ¨connectoråˆå§‹åŒ–çš„æ—¶å€™åˆ›å»ºçš„ @Override protected void initInternal() throws LifecycleException { ... // Initialize adapter adapter = new CoyoteAdapter(this); protocolHandler.setAdapter(adapter); ... try { protocolHandler.init(); } catch (Exception e) { throw new LifecycleException( sm.getString(\u0026#34;coyoteConnector.protocolHandlerInitializationFailed\u0026#34;), e); } } CoyoteAdapterçš„service æ–¹æ³•ï¼Œ\n@Override public void service(org.apache.coyote.Request req, org.apache.coyote.Response res) throws Exception { ... if (request == null) { // æ­¤å¤„åˆ›å»ºçš„æ˜¯org.apache.catalina.connector.Request request = connector.createRequest(); request.setCoyoteRequest(req); response = connector.createResponse(); response.setCoyoteResponse(res); // Link objects request.setResponse(response); response.setRequest(request); // Set as notes req.setNote(ADAPTER_NOTES, request); res.setNote(ADAPTER_NOTES, response); // Set query string encoding req.getParameters().setQueryStringCharset(connector.getURICharset()); } ... try { // Parse and set Catalina and configuration specific // request parameters postParseSuccess = postParseRequest(req, request, res, response); if (postParseSuccess) { ... // Calling the container connector.getService().getContainer().getPipeline().getFirst().invoke( request, response); } if (request.isAsync()) { ... } else { request.finishRequest(); response.finishResponse(); } } catch (IOException e) { // Ignore } finally { ... } } æ³¨æ„æ­¤å¤„çš„ä¸€ä¸ªæ¯”è¾ƒé•¿çš„é“¾å¼è°ƒç”¨ï¼Œconnector.getService().getContainer().getPipeline().getFirst().invoke(request, response),æ­¤å¤„æ¶‰åŠå¦ä¸¤ä¸ªè®¾è®¡ï¼ŒPipeline å’ŒValve ï¼Œåé¢è¡¥å……ã€‚\nè€Œé»˜è®¤æƒ…å†µä¸‹è¿™é‡Œä¼šæ‰§è¡ŒStandardEngineValveçš„invokeæ–¹æ³•\n@Override public final void invoke(Request request, Response response) throws IOException, ServletException { // Select the Host to be used for this Request Host host = request.getHost(); ... // Ask this Host to process this request host.getPipeline().getFirst().invoke(request, response); } ç„¶åEngineä¾æ—§é€šè¿‡ç±»ä¼¼çš„Pipeline åšæ³•æŠŠè¯·æ±‚äº¤ç»™Hostå¤„ç†ï¼Œé‚£ä¹ˆä¾æ¬¡ç±»æ¨ï¼Œä¸€å®šä¼šæ‰§è¡Œåˆ°StandardHostValveçš„invoke æ–¹æ³• ä¸­å»ï¼Œç„¶åStandardContextValve -\u0026gt; StandardWrapperValve, å‰é¢è¯´åˆ°Wrapperç›¸å½“äºServlet, æˆ‘ä»¬çœ‹çœ‹StandardWrapperValveä¸­çš„å®ç°ï¼Œ\n@Override public final void invoke(Request request, Response response) throws IOException, ServletException { ... Servlet servlet = null; ... servlet = wrapper.allocate(); ... // Create the filter chain for this request // å¤§åé¼é¼çš„Tomcat Filter æ¥å£ ApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet); ... filterChain.doFilter(request.getRequest(), response.getResponse()); ... } è¿™é‡Œå…³é”®æ­¥éª¤çœ‹åˆ° filterChain.doFilter(request.getRequest(), response.getResponse());å°±ç»“æŸäº†ï¼Œå†æ¥çœ‹ApplicationFilterChainçš„doFilteræ–¹æ³•ï¼Œ\n@Override public void doFilter(ServletRequest request, ServletResponse response) throws IOException, ServletException { if( Globals.IS_SECURITY_ENABLED ) { ... } else { internalDoFilter(request,response); } } private void internalDoFilter(ServletRequest request,ServletResponse response) throws IOException, ServletException { // Call the next filter if there is one if (pos \u0026lt; n) { ApplicationFilterConfig filterConfig = filters[pos++]; try { Filter filter = filterConfig.getFilter(); ... if( Globals.IS_SECURITY_ENABLED ) { ... } else { // è¿è¡Œtomcat è¿‡æ»¤å™¨ filter.doFilter(request, response, this); } } catch (Exception){ ... } return; } // We fell off the end of the chain -- call the servlet instance try { ... servlet.service(request, response); ... } catch (Exception){ ... } } å¯ä»¥çœ‹åˆ°ç»ˆäºåœ¨ApplicationFilterChainä¸­è°ƒç”¨äº†servlet.service(request, response) !!!!!\nå°ç»“ Connector ä¸­æœ‰ä¸€ä¸ªå±æ€§å«protocolHandlerï¼Œ connectorè¿è¡Œstartæ–¹æ³•å, ä¼šè¿è¡ŒprotocolHandler.start()\nprotocolHandlerç»§æ‰¿AbstractProtocol, AbstractProtocolä¸­æœ‰ä¸ªå±æ€§å«endpointï¼Œ ä¼šåœ¨prorocolHandlerå®ä¾‹åŒ–çš„æ—¶å€™å®ä¾‹åŒ–EndPoint\nAbstractProtocolçš„startæ–¹æ³•ï¼Œä¼šæ‰§è¡Œendpointçš„startæ–¹æ³•\nendpoint start æ–¹æ³•ä¸­ä¼šåˆ†åˆ«å¼€å¯ä¸¤ä¸ªçº¿ç¨‹(ä»¥ä¸‹åŸºäºNioEndPointç±»çš„åˆ†æ)\nPoller çº¿ç¨‹ï¼Œ ç”¨æ¥æ¶ˆè´¹å’Œå¤„ç†è¯·æ±‚ï¼Œ Poller æ˜¯NioEndPointçš„å†…éƒ¨ç±» Acceptorçº¿ç¨‹ï¼Œç”¨æ¥ç›‘å¬ç«¯å£å’Œæ¥æ”¶socketé“¾æ¥ Acceptorçº¿ç¨‹run æ–¹æ³•\nåœ¨å¾ªç¯ä¼šè°ƒç”¨endpoint çš„serverSocketAcceptæ–¹æ³•æ¥æœ€ç»ˆæ‰§è¡ŒServerSocketChannel.accpet()æ–¹æ³•ï¼Œè¯·æ±‚åˆ°æ¥åä¼šè¿”å›ä¸€ä¸ªSocketChannel ä¼šè°ƒç”¨endpoint.setSocketOptions(socket)æ–¹æ³•æ¥å°è£…sockerwrapper, å¹¶å‘Polleræ³¨å†ŒsocketWrapper æ³¨å†ŒsocketWrapperçš„æ—¶å€™ä¼šåˆ›å»ºPollerEvent å¹¶ç»´æŠ¤åœ¨Pollerå†…éƒ¨çš„eventsé˜Ÿåˆ—ä¸­ Pollerçº¿ç¨‹run æ–¹æ³•\nå¾ªç¯ä¸­ä¸æ–­éå†eventsé˜Ÿåˆ—ï¼Œå¦‚æœæœ‰äº‹ä»¶åˆ™å–å‡ºsocketå¤„ç†ï¼Œæœ‰ä¸ªæ ¸å¿ƒæ–¹æ³•æ˜¯è°ƒç”¨AbstractEndpointçš„processSocketæ–¹æ³• AbstractEndpointçš„processSocketä¸­ä¼šåˆ›å»ºSocketProcessorçº¿ç¨‹å¹¶äº¤ç»™çº¿ç¨‹æ± å»è¿è¡Œï¼ŒSocketProcessoræ˜¯EndPoint å­ç±»ä¸­çš„å†…éƒ¨ç±» SocketProcessorçº¿ç¨‹doRun æ–¹æ³•(run æ–¹æ³•ç”±çˆ¶ç±»è¦†å†™ç„¶åè°ƒç”¨å­ç±»çš„doRunæ–¹æ³•)\nè°ƒç”¨ConnectionHandler çš„process æ–¹æ³•ï¼ŒConnectionHandleræ˜¯AbstractProtocolçš„å†…éƒ¨ç±» ConnectionHandler process æ–¹æ³•ä¸­ä¼šè°ƒç”¨Processoræ–¹æ³•processæ–¹æ³•æ¥å¤„ç†ï¼Œä¾‹å¦‚Http11Processor Http11Processorç»§æ‰¿AbstractProcessorLightï¼ŒAbstractProcessorLightä¼šè°ƒç”¨å­ç±»çš„serviceæ–¹æ³• ç„¶åHttp11Processorä¼šè§£æè¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´ï¼Œåšä¸€äº›é¢„å¤„ç†æ„å»ºcoyoteçš„Request å’ŒResponseï¼Œç„¶åé€šè¿‡è°ƒç”¨getAdapter().service(request, response)å°†è¯·æ±‚äº¤ç»™Adapterå¤„ç† Adapterçš„service æ–¹æ³•\næ„å»ºorg.apache.catalina.connector.Request å’Œorg.apache.catalina.connector.Responseï¼Œä»–ä»¬å®ç°äº†HttpServletRequestå’ŒHttpServletResponse, æ‰€ä»¥è¿™é‡Œæœ¬è´¨ä¸Šæ˜¯æ„å»ºServletRequest å’ŒServletResponse\nç„¶åé€šè¿‡Pipeline å°†è¯·æ±‚äº¤ç»™å®¹å™¨å¤„ç†, connector.getService().getContainer().getPipeline().getFirst().invoke(request,response)\né¦–å…ˆä¼šè°ƒç”¨StandardEngineValveçš„invokeæ–¹æ³•ï¼Œç„¶åä¾æ¬¡è°ƒç”¨StandardHostValveã€StandardContextValveã€StandardWrapperValve\nStandardWrapperValveçš„invoke ä¸­ä¼šè·å–servlet, ç„¶ååˆ›å»ºApplicationFilterChainï¼Œè°ƒç”¨filterChain.doFilteræ–¹æ³•\nç„¶åæ‰§è¡Œtomcat çš„è¿‡æ»¤å™¨é“¾ï¼Œæœ€ç»ˆæ‰§è¡Œservlet.service(request, response)æ–¹æ³•\nè¿˜æœ‰ä¸€äº›ç–‘é—®ï¼Œæ¯”å¦‚ï¼š\nServlet æ˜¯ä»€ä¹ˆæ—¶å€™è¢«åŠ è½½çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä»€ä¹ˆæ—¶å€™ç»“æŸçš„ï¼Ÿ å¤„ç†è¯·æ±‚çš„servletæ˜¯å¦‚ä½•è¢«å®šä½åˆ°çš„ï¼Ÿ Servlet å¤„ç†å®Œè¯·æ±‚åtomcatå¦‚ä½•å°†è¿”å›æ•°æ®å“åº”ç»™å®¢æˆ·ç«¯ï¼Ÿ Servlet å’Œè¯·æ±‚çš„Mapping ä¸€ä¸ªè¯·æ±‚çš„æ ¼å¼å…¶å®åŒ…æ‹¬ip,port, path, é‚£ä¹ˆæ˜ å°„åˆ°tomcat ç»“æ„ä¸Šæ¥å…¶å®å°±æ˜¯è¦æ‰¾åˆ°å¯¹åº”çš„Host, Context, Wrapper(serlvelt).\næˆ‘ä»¬åœ¨StandardEngineValve çš„invoke æ–¹æ³•ä¸­å‘ç°å®ƒæ˜¯ç›´æ¥é€šè¿‡Host host = request.getHost(); æ¥å®šä½åˆ°hostçš„ï¼Œhostç»´æŠ¤åœ¨org.apache.catalina.connector.Requestå†…éƒ¨çš„MappingDataä¸­ï¼Œè€Œè¿™ä¸ªMappingDataè¿˜åŒ…å«Context, Wrapperç­‰ä¿¡æ¯ï¼Œ è¯´æ˜è¿™ä¸ªmapping å·¥ä½œå‘ç”Ÿåœ¨connector æŠŠè¯·æ±‚äº¤ç»™å®¹å™¨å¤„ç†ä¹‹å‰ï¼Œ æ‰€ä»¥éœ€è¦å…³æ³¨MappingDataæ˜¯å¦‚ä½•åˆ›å»ºçš„ã€‚\nHttp11Processor äº¤ç»™Adapterçš„æ˜¯org.apache.coyote.Request, org.apache.catalina.connector.Requestæ˜¯åœ¨Adapterçš„service æ–¹æ³•ä¸­åˆæ¬¡æ„å»ºçš„ã€‚\nåœ¨Adapterçš„postParseRequest æ–¹æ³•ä¸­æœ‰æ®µå…³é”®ä»£ç ï¼š\nconnector.getService().getMapper().map(serverName, decodedURI, version, request.getMappingData()) Mapper æ˜¯Serviceçš„ç»„ä»¶ï¼Œåœ¨service startçš„æ—¶å€™ä¼šstart mapperListenerï¼Œ ç„¶åé€šè¿‡registerHost(host) å°†host å°è£…ä¸ºMappedHostæ·»åŠ åˆ°Mapper å†…éƒ¨ç»´æŠ¤çš„hosts æ•°ç»„ä¸­ï¼Œ åŒæ—¶MappedHostå†…éƒ¨ç»´æŠ¤äº†ContextListï¼ŒContextList å†…éƒ¨ç»´æŠ¤MappedContextï¼ŒMappedContextå†…éƒ¨ç»´æŠ¤ContextVersionï¼ŒContextVersionå†…éƒ¨ç»´æŠ¤MappedWrapperï¼Œ ç”±æ­¤åˆæ„å»ºäº†ä¸€å¥—å±‚çº§å…³ç³»ã€‚\nMappingDataå°±æ˜¯åœ¨è¿™é‡Œåˆå§‹åŒ–çš„ã€‚é€šè¿‡æŸ¥æ‰¾Mapper å†…éƒ¨ç»´æŠ¤çš„hostså®šä½åˆ°Host åå°±å¯ä»¥å†å®šä½Context, æœ€ç»ˆå®šä½åˆ°wrapper. åœ¨å¤„ç†è¯·æ±‚çš„æ—¶å€™ç›´æ¥å°±å¯ä»¥é€šè¿‡request.getHost()ã€request.getContext();ã€request.getWrapper();æ‰¾åˆ°å¯¹åº”çš„å®¹å™¨ç»„ä»¶çš„pipelineå»å¤„ç†è¯·æ±‚ã€‚\n/** * å‚æ•°ç¤ºä¾‹ï¼š map(\u0026#34;localhost\u0026#34;,\u0026#34;/my-app/ping\u0026#34;, null, mappingData) */ public void map(MessageBytes host, MessageBytes uri, String version, MappingData mappingData) throws IOException { if (host.isNull()) { String defaultHostName = this.defaultHostName; if (defaultHostName == null) { return; } host.getCharChunk().append(defaultHostName); } host.toChars(); uri.toChars(); internalMap(host.getCharChunk(), uri.getCharChunk(), version, mappingData); } // é‡ç‚¹æ˜¯è¿™ä¸ªinternalMapæ–¹æ³• private final void internalMap(CharChunk host, CharChunk uri, String version, MappingData mappingData) throws IOException { ... // Virtual host mapping MappedHost[] hosts = this.hosts; MappedHost mappedHost = exactFindIgnoreCase(hosts, host); mappingData.host = mappedHost.object; ... // Context mapping ContextList contextList = mappedHost.contextList; MappedContext[] contexts = contextList.contexts; int pos = find(contexts, uri); ... ContextVersion contextVersion = null; ContextVersion[] contextVersions = context.versions; final int versionCount = contextVersions.length; if (versionCount \u0026gt; 1) { Context[] contextObjects = new Context[contextVersions.length]; for (int i = 0; i \u0026lt; contextObjects.length; i++) { contextObjects[i] = contextVersions[i].object; } mappingData.contexts = contextObjects; if (version != null) { contextVersion = exactFind(contextVersions, version); } } if (contextVersion == null) { // Return the latest version // The versions array is known to contain at least one element contextVersion = contextVersions[versionCount - 1]; } mappingData.context = contextVersion.object; mappingData.contextSlashCount = contextVersion.slashCount; // Wrapper mapping if (!contextVersion.isPaused()) { internalMapWrapper(contextVersion, uri, mappingData); } } å“åº”è¿‡ç¨‹ åœ¨æœ€ç®€tomcatä¸€èŠ‚ä¸­æˆ‘ä»¬çŸ¥é“å…¶å®å“åº”å°±æ˜¯å‘socketå¯¹è±¡çš„outputStreamä¸­å†™å…¥æ•°æ®ï¼Œè€Œtomcatå°†è¯·æ±‚äº¤ç»™servletå¤„ç†æ—¶æ˜¯å°†å°è£…å¥½çš„ServletRequest å’Œ ServletResponseçš„éƒ½äº¤ç»™äº†servletçš„ã€‚\nservlet.service(request, response); çœ‹ä¸‹é¢è¿™ä¸ªç®€å•çš„Servlet, ä»¥è¿™ä¸ªservletä¸ºä¾‹æˆ‘ä»¬çœ‹çœ‹HTTPå“åº”æ˜¯æ€ä¹ˆè¿›è¡Œçš„\npublic class SampleServlet extends HttpServlet { @Override protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException { response.getWriter().write(\u0026#34;Pong!\u0026#34;); } } é€šè¿‡response.getWriter().write(\u0026quot;Pong!\u0026quot;); æ¥å“åº”ï¼Œå“åº”å®Œåæˆ‘ä»¬å°±å¯ä»¥åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°\u0026quot;Pong!\u0026quot;.\nâ€‹\nå¯ä»¥çœ‹åˆ°å†™å…¥å“åº”æ—¶ä¼šå…ˆå†™å…¥ç¼“å­˜ä¸­ï¼Œæœ€åç»Ÿä¸€å°†ç¼“å­˜æ•°æ®åˆ·æ–°åˆ°socketä¸­ã€‚\nPipeline å’Œ Valve pipeline æ˜¯ContainerBase æŠ½è±¡ç±»ä¸­çš„ä¸€ä¸ªå±æ€§, å…·ä½“å®ä¾‹åŒ–äº†ä¸€ä¸ªStandardPipelineï¼Œå¹¶é€šè¿‡Container æ¥å£æš´éœ²äº†getPipelineæ–¹æ³•ï¼Œæ‰€ä»¥Engine, Context, Host, Wrapperç­‰ç»„ä»¶éƒ½ä¼šæœ‰è¿™ä¸ªå±æ€§ã€‚è€Œpipelineä¸­ç»´æŠ¤çš„æ˜¯ä¸€ç³»åˆ—çš„Valveã€‚\nPipeline public interface Pipeline extends Contained { public Valve getBasic(); public void setBasic(Valve valve); public void addValve(Valve valve); public Valve[] getValves(); public void removeValve(Valve valve); public Valve getFirst(); public boolean isAsyncSupported(); public void findNonAsyncValves(Set\u0026lt;String\u0026gt; result); } Valve Valveæ˜¯ä¸€ä¸ªç±»ä¼¼å•å‘é“¾è¡¨çš„ç»“æ„ï¼Œå¯ä»¥é€šè¿‡getNext æ‰¾åˆ°ä¸‹ä¸€ä¸ªValve, å¹¶ä¸”æœ‰ä¸€ä¸ªæ ¸å¿ƒæ–¹æ³•invoke(Request request, Response response)\npublic interface Valve { public Valve getNext(); public void setNext(Valve valve); public void backgroundProcess(); public void invoke(Request request, Response response) throws IOException, ServletException; public boolean isAsyncSupported(); } è¿™æ—¶å€™å†æ¥å›é¡¾connector.getService().getContainer().getPipeline().getFirst().invoke(request,response)è¿™æ®µAdapterçš„service æ–¹æ³•å°†è¯·æ±‚äº¤ç»™å®¹å™¨å¤„ç†çš„ä»£ç ï¼Œå°±èƒ½æ˜ç™½äº†.\npublic class StandardPipeline extends LifecycleBase implements Pipeline { ... //è°ƒç”¨getFirst çš„æ—¶å€™ï¼Œå¦‚æœæœ‰firstå°±è¿”å›å¦åˆ™è¿”å›basic @Override public Valve getFirst() { if (first != null) { return first; } return basic; } ... } Valveæ˜¯æ€ä¹ˆæ·»åŠ çš„ StandardEngine\nStandardHost\næ„é€ å‡½æ•°ä¸­ä¹Ÿæ˜¯é»˜è®¤è®¾ç½®äº†ä¸€ä¸ªbasic valve, æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡web.xml æ¥é…ç½®ï¼Œè¿™å…¶å®æ˜¯tomcat ç•™ç»™æˆ‘ä»¬çš„æ‰©å±•ç‚¹ã€‚\né‚£å¯¹äºHostè€Œè¨€è¿™ä¸¤ä¸ªvalveçš„é¡ºåºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\né¦–å…ˆè‚¯å®šæ˜¯æ‰§è¡ŒHostç»„ä»¶çš„æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥ä¼šå…ˆè®¾ç½®basic valve, ç„¶åè§£æåˆ°\u0026lt;Valve\u0026gt; æ ‡ç­¾ä¼šæ ¹æ®é…ç½®çš„digister SetNextRule æ¥è°ƒç”¨addValve.\n@Override public void addValve(Valve valve) { ... if (first == null) { first = valve; valve.setNext(basic); } else { Valve current = first; while (current != null) { if (current.getNext() == basic) { current.setNext(valve); valve.setNext(basic); break; } current = current.getNext(); } } ... } å¯ä»¥çœ‹åˆ°å¦‚æœpipeline ä¸­firstä¸ºnull, åˆ™server.xml ä¸­é…ç½®çš„ç¬¬ä¸€ä¸ªvalveå°±æ˜¯first, å¦‚æœfirstä¸ä¸ºç©ºï¼Œå°±æŠŠè¿™ä¸ªvalve ä½œä¸ºfirst çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ basic æ°¸è¿œæ˜¯é“¾è¡¨ä¸­æœ€åä¸€ä¸ªèŠ‚ç‚¹ã€‚\nStandardContext\nStandardWrapper\nå°ç»“\nEngine/Host/Context/Wrapper ç»„ä»¶åœ¨åˆå§‹åŒ–çš„æ„é€ æ–¹æ³•ä¸­ä¼šè®¾ç½®basic valve æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶çš„æ–¹å¼æ·»åŠ å…¶ä»–valve, æ·»åŠ çš„ç¬¬ä¸€ä¸ªvalve ä¼šä½œä¸ºfirst value, ä¾æ¬¡æ„å»ºä¸€ä¸ªé“¾è¡¨ï¼Œbasic valveä¼šä½œä¸ºé“¾è¡¨ä¸Šæœ€åä¸€ä¸ªèŠ‚ç‚¹ Valve ä»€ä¹ˆæ—¶å€™ä¼šè¿è¡Œ è¯·æ±‚åˆ°è¾¾å®¹å™¨ä¹‹å‰ä¼šç”±Adapterçš„service æ–¹æ³•å°†è¯·æ±‚äº¤ç»™å®¹å™¨ï¼Œå…³é”®æ–¹æ³•æ˜¯connector.getService().getContainer().getPipeline().getFirst().invoke(request,response) æ­¤æ—¶ä¼šè°ƒç”¨Engine çš„first valveçš„invoke æ–¹æ³•, å¦‚æœæ²¡æœ‰first åˆ™è°ƒç”¨ basic value. å½“æŸä¸€å±‚å®¹å™¨çš„pipeline ä¸­æœ‰å¤šä¸ªvalveæ—¶ï¼Œåœ¨ä¸€ä¸ªvalveæ‰§è¡Œçš„æœ€åä¼šé€šè¿‡getNext().invoke(request, response);è°ƒç”¨ä¸‹ä¸€ä¸ªValve, ç›´åˆ°æœ€åè°ƒç”¨åˆ°basic valve basic valveæ˜¯valve é“¾ä¸­æœ€åä¸€ä¸ªèŠ‚ç‚¹(æœ€åæ‰§è¡Œï¼‰ï¼Œè¿™æ—¶ä¸Šå±‚å®¹å™¨åˆä¼šè°ƒç”¨ä¸‹ä¸€å±‚å®¹å™¨çš„pipeline ä¸­çš„valve çš„invoke æ–¹æ³•ï¼Œä¾æ¬¡ç±»æ¨ Tomcatçš„ç±»åŠ è½½æœºåˆ¶ åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬æåˆ°æœ€åtomcatä¼šå°†è¯·æ±‚äº¤ç»™servletæ¥å¤„ç†ï¼Œä½†servletæ˜¯ä»€ä¹ˆæ—¶å€™è¢«åŠ è½½å’Œåˆå§‹åŒ–çš„å‘¢ï¼Ÿ\nå¯èƒ½æœ€å¿«æƒ³åˆ°çš„æ˜¯åˆ©ç”¨ç±»åŠ è½½å™¨å»åŠ è½½webapp å„ä¸ªåº”ç”¨ä¸‹é¢çš„classes æ–‡ä»¶ï¼ŒæŠŠä»–ä»¬å˜æˆå¯æ‰§è¡Œçš„å¯¹è±¡ï¼Œä½†æ˜¯å€˜è‹¥ä¸åŒçš„åº”ç”¨ä¸‹é¢å‡å¦‚éƒ½æœ‰ä¸€ä¸ªMyApp ç±»ï¼Œç±»åç›¸åŒä½†æ˜¯å®ç°ä¸åŒï¼Œtomcatæœ¬èº«æ˜¯ä¸€ä¸ªjavaè¿›ç¨‹ï¼Œæ ¹æ®Jdkçš„åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå¦‚æœä¸åšå¤„ç†å½“å°è¯•å»åŠ è½½ç¬¬äºŒä¸ªMyApp çš„æ—¶å€™ä¼šå¤ç”¨ä¹‹å‰å·²ç»åŠ è½½å¥½çš„MyApp(ä¸ºä»€ä¹ˆ?), ä»è€Œå¯¼è‡´è¡Œä¸ºå’Œé¢„æœŸçš„ä¸ä¸€è‡´ï¼Œæ‰€ä»¥tomcat ä¸ºäº†éš”ç¦»å„ä¸ªåº”ç”¨ï¼Œä¼šæ‰“ç ´è¿™ä¸ªåŒäº²å§”æ´¾æ¨¡å‹ã€‚\nJDKç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾æ¨¡å‹ ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨ï¼Ÿ è¯´ç™½äº†ï¼Œæˆ‘ä»¬å†™çš„ä»£ç æ˜¯å­˜åœ¨ä»¥java ä¸ºåç¼€çš„æ–‡ä»¶ä¸­ï¼Œç„¶åJDKé€šè¿‡ç¼–è¯‘å™¨å°†java æ–‡ä»¶ç¼–è¯‘æˆclassæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å­—èŠ‚ç æ–‡ä»¶ï¼Œä½†å­—èŠ‚ç æ˜¯ä¸€ç§ä¸èƒ½ç”±ç¡¬ä»¶ç›´æ¥æ‰§è¡Œçš„ä¸­é—´ä»£ç ï¼Œåªèƒ½è¢«JVMè£…è½½å¹¶è§£é‡Šæ‰§è¡Œï¼Œç„¶åç±»åŠ è½½å™¨çš„ä½œç”¨å°±æ˜¯æŠŠè¿™äº›è¿™äº›å­—èŠ‚ç åŠ è½½åˆ°å†…å­˜ä¸­å¹¶åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„Classå¯¹è±¡ï¼Œ æœ€åç”±æ‰§è¡Œå™¨æŠŠå®ƒç¿»è¯‘æˆæœºå™¨ç ç„¶åäº¤ç»™æœºå™¨æ‰§è¡Œã€‚\nJavaè™šæ‹Ÿæœºå®šä¹‰äº†ä¸‰ç§ç±»åŠ è½½å™¨ï¼š\nå¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆBootstrap Class Loaderï¼‰ï¼š é€šå¸¸ç”±æœ¬åœ°ä»£ç å®ç°ï¼Œä¹Ÿç§°ä¸ºæ ¹ç±»åŠ è½½å™¨ï¼Œå®ƒè´Ÿè´£åŠ è½½%JAVA_HOME%/libè·¯å¾„ä¸‹Javaè™šæ‹Ÿæœºçš„æ ¸å¿ƒç±»åº“ æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtension Class Loaderï¼‰ï¼šå®ƒæ˜¯ç”¨æ¥åŠ è½½Javaæ‰©å±•ç±»åº“çš„ç±»åŠ è½½å™¨ã€‚æ‰©å±•ç±»åº“åŒ…æ‹¬javaxå’Œjava.utilç­‰åŒ…ï¼Œå®ƒä»¬ä½äºjre/lib/extç›®å½•ä¸‹ åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ï¼ˆApplication Class Loaderï¼‰ï¼šä¹Ÿç§°ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œå®ƒè´Ÿè´£åŠ è½½%CLASSPATH%è·¯å¾„ä¸‹åº”ç”¨ç¨‹åºçš„ç±»ã€‚ æˆ‘ä»¬åœ¨å¯åŠ¨javaè¿›ç¨‹çš„æ—¶å€™é€šå¸¸éœ€è¦ä¼ é€’ä¸€ä¸ªclasspath å‚æ•°ï¼Œä¾‹å¦‚é€šè¿‡IDEA æºç å¯åŠ¨tomcatæ—¶å¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼š\n/Users/hf/Documents/developer/jdk/zulu21.30.15-ca-jdk21.0.1-macosx_aarch64/bin/java -agentlib:jdwp=transport=dt_socket,address=127.0.0.1:64807,suspend=y,server=n -Dcatalina.home=/Users/hf/IdeaProjects/tomcat/output/build/ -Dcatalina.base=/Users/hf/IdeaProjects/tomcat/output/build/ -javaagent:/Users/hf/Library/Caches/JetBrains/IntelliJIdea2024.1/captureAgent/debugger-agent.jar -Dfile.encoding=UTF-8 -Dsun.stdout.encoding=UTF-8 -Dsun.stderr.encoding=UTF-8 -classpath /Users/hf/IdeaProjects/tomcat/.idea/output/production/tomcat:/opt/homebrew/Cellar/ant/1.10.14/libexec/lib/ant.jar ... org.apache.catalina.startup.Bootstrap å¯ä»¥çœ‹åˆ°ä¼ é€’äº†classpathå‚æ•°ï¼Œä¸ä¼ é€’åˆ™é»˜è®¤å½“å‰ç›®å½•ã€‚æˆ‘ä»¬è‡ªå·±å†™çš„javaä»£ç é€šå¸¸ç”±App class loader æ¥åŠ è½½ã€‚\ntry { Class\u0026lt;?\u0026gt; loadedClass = ClassLoader.getSystemClassLoader().loadClass(\u0026#34;org.apache.catalina.startup.MyClass\u0026#34;); MyClass object = (MyClass) loadedClass.getDeclaredConstructor().newInstance(); object.hi(); } catch (ClassNotFoundException | NoSuchMethodException | InstantiationException | IllegalAccessException | InvocationTargetException e) { throw new RuntimeException(e); } ... class MyClass { public void hi() { System.out.println(\u0026#34;Hello, class loader!\u0026#34;); } } è‡ªå®šä¹‰ç±»åŠ è½½å™¨ è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å¿…é¡»ç»§æ‰¿java.lang.ClassLoader, å¹¶è¦†å†™findClassæ–¹æ³•ï¼ŒfindClass æ–¹æ³•ä¼šè¢«loadClassè°ƒç”¨ï¼Œä¸‹é¢æ˜¯Classloaderç±»ä¸­loadClass æ–¹æ³•\nprotected Class\u0026lt;?\u0026gt; loadClass(String name, boolean resolve) throws ClassNotFoundException { synchronized (getClassLoadingLock(name)) { // First, check if the class has already been loaded Class\u0026lt;?\u0026gt; c = findLoadedClass(name); if (c == null) { long t0 = System.nanoTime(); try { if (parent != null) { c = parent.loadClass(name, false); } else { c = findBootstrapClassOrNull(name); } } catch (ClassNotFoundException e) { // ClassNotFoundException thrown if class not found // from the non-null parent class loader } if (c == null) { // If still not found, then invoke findClass in order // to find the class. long t1 = System.nanoTime(); c = findClass(name); // this is the defining class loader; record the stats PerfCounter.getParentDelegationTime().addTime(t1 - t0); PerfCounter.getFindClassTime().addElapsedTimeFrom(t1); PerfCounter.getFindClasses().increment(); } } if (resolve) { resolveClass(c); } return c; } } å¯ä»¥çœ‹åˆ°åŸºæœ¬æµç¨‹å°±æ˜¯:\næŸ¥çœ‹æŸä¸ªç±»æ˜¯å¦å·²ç»è¢«åŠ è½½ï¼Œä¼šé€šè¿‡è°ƒç”¨native æ–¹æ³•findLoadedClass0ï¼Œå¦‚æœå·²ç»åŠ è½½å°±è¿”å› å¦‚æœæ²¡è¢«åŠ è½½å°±å…ˆå°è¯•ç”¨çˆ¶ç±»åŠ è½½å™¨(Extention class loader)åŠ è½½ çˆ¶ç±»åŠ è½½å™¨è¿˜åŠ è½½ä¸åˆ°çš„è¯å°±ä¼šè°ƒç”¨findClassæ–¹æ³• è¿™å’Œæˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„åŒäº²å§”æ´¾æ¨¡å‹çš„æ€æƒ³æ˜¯ä¸€æ ·çš„ï¼Œä¸‹é¢ç»™å‡ºä¸€ä¸ªfindClass çš„å†™æ³•ç¤ºä¾‹ï¼š\n@Override protected Class\u0026lt;?\u0026gt; findClass(String name) throws ClassNotFoundException { // class æ–‡ä»¶å¯ä»¥æ”¾åˆ°ä»»ä½•ç›®å½• try (FileInputStream fileInputStream = new FileInputStream( new File(\u0026#34;/Users/hf/IdeaProjects/tomcat/MyClass.class\u0026#34;))) { byte[] bytes = fileInputStream.readAllBytes(); return defineClass(name, bytes, 0, bytes.length); } catch (IOException e) { throw new RuntimeException(e); } } // æµ‹è¯• @Test public void testClassLoader() { try { MyClassLoader myClassLoader = new MyClassLoader(); Class\u0026lt;?\u0026gt; loadedClass = myClassLoader.loadClass(\u0026#34;MyClass\u0026#34;); Object object = loadedClass.getDeclaredConstructor().newInstance(); Method method = loadedClass.getMethod(\u0026#34;hi\u0026#34;); method.invoke(object,null); } catch (ClassNotFoundException | NoSuchMethodException | InstantiationException | IllegalAccessException | InvocationTargetException e) { throw new RuntimeException(e); } } Tomcatçš„ç±»åŠ è½½å™¨ Tomcat æ‹¥æœ‰ä¸åŒçš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä»¥å®ç°å¯¹å„ç§èµ„æºåº“çš„æ§åˆ¶ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒTomcat ä¸»è¦ç”¨ç±»åŠ è½½å™¨è§£å†³ä»¥ä¸‹ 4 ä¸ªé—®é¢˜ã€‚\nå„ä¸ªWebåº”ç”¨ä¹‹é—´å„è‡ªä½¿ç”¨çš„Javaç±»åº“è¦äº’ç›¸éš”ç¦» \u0026mdash; WebappClassLoaderã€‚\nå„ä¸ªWebåº”ç”¨ä¹‹é—´å¯ä»¥æä¾›å…±äº«çš„Javaç±»åº“ \u0026mdash; SharedClassLoaderã€‚\nTomcatæœ¬èº«çš„ç±»å’ŒWebåº”ç”¨çš„ç±»è¦äº’ç›¸éš”ç¦» \u0026mdash; CatalinaClassLoaderã€‚\nWebappClassLoaderBaseçš„startæ–¹æ³•çš„æºä»£ç ä¸­å¹¶æ²¡æœ‰çœ‹åˆ°æˆ‘ä»¬ä»¥ä¸ºçš„findClass æˆ–loadClass æ“ä½œï¼Œé‚£åŠ è½½servletæ˜¯ä»€ä¹ˆæ—¶å€™è¿›è¡Œçš„ï¼Ÿ\n// WebappClassLoaderBaseçš„startæ–¹æ³• @Override public void start() throws LifecycleException { state = LifecycleState.STARTING_PREP; WebResource[] classesResources = resources.getResources(\u0026#34;/WEB-INF/classes\u0026#34;); for (WebResource classes : classesResources) { if (classes.isDirectory() \u0026amp;\u0026amp; classes.canRead()) { localRepositories.add(classes.getURL()); } } WebResource[] jars = resources.listResources(\u0026#34;/WEB-INF/lib\u0026#34;); for (WebResource jar : jars) { if (jar.getName().endsWith(\u0026#34;.jar\u0026#34;) \u0026amp;\u0026amp; jar.isFile() \u0026amp;\u0026amp; jar.canRead()) { localRepositories.add(jar.getURL()); jarModificationTimes.put( jar.getName(), Long.valueOf(jar.getLastModified())); } } state = LifecycleState.STARTED; } ç­”æ¡ˆæ˜¯æœ‰ä¸¤æ¬¡ã€‚\nç¬¬ä¸€æ¬¡é€šè¿‡LifeCycleEventå¤„ç†æ³¨è§£æ—¶åŠ è½½çš„ã€‚\nStandardContext#startInternal -\u0026gt; fireLifecycleEvent(Lifecycle.CONFIGURE_START_EVENT, null) -\u0026gt; ContextConfig#lifecycleEvent -\u0026gt; configureStart -\u0026gt; applicationAnnotationsConfig -\u0026gt; WebAnnotationSet.loadApplicationAnnotations(context) -\u0026gt; WebAnnotationSet#loadApplicationServletAnnotations -\u0026gt; Introspection.loadClass(context, wrapper.getServletClass()) -\u0026gt; cl.loadClass(className)\nç¬¬äºŒæ¬¡æ˜¯è¯·æ±‚åˆ°æ¥æ—¶å»å°è¯•åŠ è½½å¹¶å®ä¾‹åŒ–Servlet, ç¬¬ä¸€æ¬¡å¦‚æœå·²ç»åŠ è½½äº†classåˆ™ä¼šå¤ç”¨ã€‚\nStandardWrapper#invoke -\u0026gt; StandardWrapper#allocate -\u0026gt; StandardWrapper#loadServlet -\u0026gt; InstanceManager.newInstance(servletClass) -\u0026gt; DefaultInstanceManager#newInstance -\u0026gt; classLoader.loadClass(className)\nTomcat æ˜¯å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹çš„ï¼Ÿ äº†è§£è¿™ä¸ªé—®é¢˜éœ€è¦çœ‹WebappClassLoaderBaseçš„æºç ï¼Œé‡ç‚¹æ˜¯findClass æ–¹æ³•å’ŒloadClass æ–¹æ³•\nloadClass\n@Override public Class\u0026lt;?\u0026gt; loadClass(String name, boolean resolve) throws ClassNotFoundException { synchronized (JreCompat.isGraalAvailable() ? this : getClassLoadingLock(name)) { .. Class\u0026lt;?\u0026gt; clazz = null; ... // (0) Check our previously loaded local class cacheï¼Œæ£€æŸ¥tomcatè‡ªå·±çš„ç¼“å­˜ clazz = findLoadedClass0(name); if (clazz != null) { ... return clazz; } // (0.1) Check our previously loaded class cache, æ£€æŸ¥jvmçš„ç¼“å­˜ clazz = JreCompat.isGraalAvailable() ? null : findLoadedClass(name); if (clazz != null) { ... return clazz; } // (0.2) Try loading the class with the bootstrap class loader, to prevent // the webapp from overriding Java SE classes. This implements // SRV.10.7.2ï¼Œ é˜²æ­¢è¦†ç›–ç³»ç»Ÿçš„æ ¸å¿ƒç±» String resourceName = binaryNameToPath(name, false); ClassLoader javaseLoader = getJavaseClassLoader(); boolean tryLoadingFromJavaseLoader; .... if (tryLoadingFromJavaseLoader) { clazz = javaseLoader.loadClass(name); if (clazz != null) { ... return clazz; } } // (0.5) Permission to access this class when using a SecurityManager ... boolean delegateLoad = delegate || filter(name, true); // (1) Delegate to our parent if requested, å¦‚æœé…ç½®äº†ç”¨çˆ¶åŠ è½½å™¨åŠ è½½å°±ç”¨çˆ¶åŠ è½½å™¨ï¼Œé»˜è®¤false if (delegateLoad) { ... clazz = Class.forName(name, false, parent); if (clazz != null) { .. return clazz; } } // (2) Search local repositories if (log.isDebugEnabled()) { log.debug(\u0026#34; Searching local repositories\u0026#34;); } try { clazz = findClass(name); if (clazz != null) { ... return clazz; } } catch (ClassNotFoundException e) { // Ignore } // (3) Delegate to parent unconditionally, å¦‚æœä¸ä½¿ç”¨çˆ¶åŠ è½½å™¨ï¼Œä½†è‡ªå·±åˆæ²¡æœ‰æ‰¾åˆ°å°±è¿˜æ˜¯ç”¨çˆ¶åŠ è½½å™¨æ‰¾ä¸€é if (!delegateLoad) { ... clazz = Class.forName(name, false, parent); if (clazz != null) { ... return clazz; } ... } } throw new ClassNotFoundException(name); } findClass\n@Override public Class\u0026lt;?\u0026gt; findClass(String name) throws ClassNotFoundException { ... // (1) Permission to define this class when using a SecurityManager .. // Ask our superclass to locate this class, if possible // (throws ClassNotFoundException if it is not found) Class\u0026lt;?\u0026gt; clazz = null; try { ... try { if (securityManager != null) { ... } else { clazz = findClassInternal(name); } } catch(AccessControlException ace) { ... } catch (RuntimeException e) { ... } if ((clazz == null) \u0026amp;\u0026amp; hasExternalRepositories) { try { clazz = super.findClass(name); } catch(AccessControlException ace) { ... } catch (RuntimeException e) { ... } } if (clazz == null) { throw new ClassNotFoundException(name); } } catch (ClassNotFoundException e) { throw e; } // Return the class we have located ... return clazz; } findClassInternal\nprotected Class\u0026lt;?\u0026gt; findClassInternal(String name) { ... String path = binaryNameToPath(name, true); ResourceEntry entry = resourceEntries.get(path); ... Class\u0026lt;?\u0026gt; clazz = entry.loadedClass; if (clazz != null) { return clazz; } synchronized (JreCompat.isGraalAvailable() ? this : getClassLoadingLock(name)) { clazz = entry.loadedClass; ... byte[] binaryContent = resource.getContent(); ... try { // è°ƒç”¨jdkçš„APIå»åŠ è½½ç±» clazz = defineClass(name, binaryContent, 0, binaryContent.length, new CodeSource(codeBase, certificates)); } catch (UnsupportedClassVersionError ucve) { ... } entry.loadedClass = clazz; } return clazz; } å°ç»“\nå…ˆåœ¨æœ¬åœ°tomcatç¼“å­˜ä¸­æŸ¥æ‰¾è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œå¦‚æœåŠ è½½è¿‡å°±è¿”å›ç¼“å­˜ä¸­çš„ã€‚ å¦‚æœæœ¬åœ°ç¼“å­˜æ²¡æœ‰å°±å»JVMä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œæœ‰å°±è¿”å›ã€‚ å¦‚æœç¼“å­˜é‡Œéƒ½æ²¡æœ‰ï¼Œå§”æ‰˜ç»™ bootstrap class loaderå»åŠ è½½ï¼Œé˜²æ­¢è¦†ç›–ç³»ç»Ÿçš„æ ¸å¿ƒç±»åº“ã€‚ å¦‚æœè¿˜æ²¡åŠ è½½åˆ°è¯´æ˜ä¸æ ¸å¿ƒåº“ä¸­æ²¡æœ‰è¿™ä¸ªç±»ï¼Œé‚£å°±WebappClassLoaderBaseè‡ªå·±å»åŠ è½½ï¼Œè°ƒç”¨findClassæ–¹æ³•ã€‚ findClass ä¸­æœ€ç»ˆä¼šé€šè¿‡è°ƒç”¨findClassInternalæ¥åŠ è½½ï¼Œæ‰¾ä¸åˆ°ä¼šå†æ¬¡å¸¸ç”¨ç”¨çˆ¶ç±»åŠ è½½å™¨æ¥åŠ è½½ã€‚ findClassInternalä¼˜å…ˆä»resourceEntriesç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œæ‰¾åˆ°åˆ™è¿”å›ã€‚ æ‰¾ä¸åˆ°åˆ™æœ€ç»ˆé€šè¿‡class çš„binaryContentå’Œè°ƒç”¨JDK çš„API defineClass æ¥åŠ è½½ã€‚ ç»è¿‡ä»¥ä¸Šåˆ†ææˆ‘ä»¬å¯ä»¥ä»ä¸€ä¸ªHTTPè¯·æ±‚å‡ºå‘åˆæ­¥äº†è§£åˆ°Tomcatæ•´ä½“çš„æ¶æ„è®¾è®¡ï¼Œä»¥åŠæ¥æ”¶è¯·æ±‚ã€è§£æè¯·æ±‚ï¼ŒåŠ è½½è¿è¡Œservlet, åˆ°ç”Ÿæˆå“åº”çš„å…¨æµç¨‹ï¼Œä½†æ˜¯tomcat ç»è¿‡äºŒåå¹´ä½™å¹´çš„å‘å±•ï¼Œæ‰€è¦å¤„ç†çš„ä¸šåŠ¡åœºæ™¯è¿œä¸æ­¢è¿™äº›ï¼Œæœ‰å¾ˆå¤šå…¶ä»–çš„è®¾è®¡å’Œå®ç°å€¼å¾—æˆ‘ä»¬å»è¿›ä¸€æ­¥æ¢ç´¢ï¼Œæ¯”å¦‚ï¼š\ntomcatä¸­å…³äºé•¿é“¾æ¥çš„å¤„ç† åˆ†å—ä¼ è¾“ tomcatæ˜¯å¦‚ä½•å¯¹å“åº”è¿›è¡Œå‹ç¼©çš„(ä¾‹å¦‚gzip)ï¼Ÿ \u0026hellip; è¿™å‡ ä¸ªé—®é¢˜æš‚æ—¶ä¸ä½œä¸ºè¿™æ¬¡çš„æ•…äº‹ä¸»çº¿ï¼Œå¯¹å“åº”å‹ç¼©å’Œåˆ†å—ä¼ è¾“æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡ï¼štomcat http å‹ç¼©ä¸åˆ†å—ä¼ è¾“åŸç†\nä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œç«™åœ¨å¼€å‘è€…çš„è§’åº¦è€ƒè™‘åˆ°æˆ‘ä»¬åŸºäºspringbootå¼€å‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ç‚¹æ²¡æœ‰ææ¸…æ¥šï¼Œtomcat æ˜¯å¦‚ä½•ä¸Springbootè”ç³»åœ¨ä¸€èµ·çš„å‘¢ï¼Ÿ\nTomcat å’ŒSpringboot ä»¥è¿™ä¸ªç®€å•çš„springbootåº”ç”¨(Springboot 3.2.3, æ³¨æ„è€ç‰ˆæœ¬ä¼šç•¥å¾®æœ‰æ‰€ä¸åŒï¼Œä½†å¤§åŒå°å¼‚)ä¸ºä¾‹,\ngradle\n... implementation(\u0026#34;org.springframework.boot:spring-boot-starter-web\u0026#34;) ... è¿™ä¸ªä¾èµ–é‡Œå¼•å…¥äº†spring-boot-starter-tomcatä¾èµ–,\nå› ä¸ºç”¨äº†api æ‰€ä»¥åœ¨æˆ‘ä»¬çš„springbootåº”ç”¨ä¸­å¯ä»¥è®¿é—®åˆ°spring-boot-starter-tomcatä¾èµ–\nspring-boot-starter-tomcat\nå¼•å…¥äº†tomcat-embed-core ä¾èµ–,\nè€Œtomcat-embed-coreä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€ç»ˆä¼šç”¨åˆ°çš„ä¸€ä¸ªæ ¸å¿ƒçš„tomcatçš„jarä¾èµ–ã€‚è€Œåœ¨è¿™ä¸ªjaråŒ…é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°tomcat çš„æºç ã€‚\nPingContoller\n@RestController @RequestMapping(\u0026#34;/ping\u0026#34;) class PingController { @GetMapping fun ping(): String { return \u0026#34;Pong!\u0026#34; } } Springbootåº”ç”¨å¯åŠ¨å…¥å£ä¹Ÿæ˜¯ä¸€ä¸ªMainæ–¹æ³•ï¼Œè¯¦ç»†çš„Springbootå¯åŠ¨è¿‡ç¨‹ä¸åœ¨æœ¬æ–‡çš„èŒƒå›´å†…ï¼Œæ­¤å¤„ç›´æ¥è·³åˆ°tomcatå¯åŠ¨çš„ä»£ç ã€‚\nSpringApplication#run â€”\u0026gt; SpringApplication#refreshContext â€”\u0026gt; ServletWebServerApplicationContext#onRefresh â€”\u0026gt; ServletWebServerApplicationContext#createWebServer\nprivate void createWebServer() { WebServer webServer = this.webServer; ServletContext servletContext = getServletContext(); if (webServer == null \u0026amp;\u0026amp; servletContext == null) { StartupStep createWebServer = getApplicationStartup().start(\u0026#34;spring.boot.webserver.create\u0026#34;); ServletWebServerFactory factory = getWebServerFactory(); createWebServer.tag(\u0026#34;factory\u0026#34;, factory.getClass().toString()); this.webServer = factory.getWebServer(getSelfInitializer()); ... } else if (servletContext != null) { ... } initPropertySources(); } ä¸Šè¿°ä»£ç ç¬¬6è¡ŒgetWebServerFactory(); è¿”å›çš„æ˜¯TomcatServletWebServerFactory\nä¸ºä»€ä¹ˆæ˜¯Tomcatè€Œä¸æ˜¯Jettyï¼Ÿ\nå› ä¸ºåœ¨ServletWebServerFactoryAutoConfiguration è‡ªåŠ¨è£…é…ç±»ä¸­é€šè¿‡@Import å¯¼å…¥äº†ServletWebServerFactoryConfigurationç±»ä¸‹é¢çš„å‡ ä¸ªé…ç½®ï¼Œ\nè€Œåœ¨ServletWebServerFactoryConfigurationä¸­ï¼Œé€šè¿‡ConditionalOnClass æ³¨è§£ä¼šé»˜è®¤åŠ è½½TomcatServletWebServerFactoryã€‚\nweb starter é»˜è®¤é›†æˆtomcat, å¯ä»¥å‘ç°Jettyçš„ä¸¤ä¸ªç±»é»˜è®¤æƒ…å†µä¸‹æ‰¾ä¸åˆ°ã€‚\nä¸‹é¢å†çœ‹factory#getWebServerçš„å®ç°\n@Override public WebServer getWebServer(ServletContextInitializer... initializers) { if (this.disableMBeanRegistry) { Registry.disableRegistry(); } Tomcat tomcat = new Tomcat(); File baseDir = (this.baseDirectory != null) ? this.baseDirectory : createTempDir(\u0026#34;tomcat\u0026#34;); tomcat.setBaseDir(baseDir.getAbsolutePath()); for (LifecycleListener listener : this.serverLifecycleListeners) { tomcat.getServer().addLifecycleListener(listener); } Connector connector = new Connector(this.protocol); connector.setThrowOnFailure(true); //åˆ›å»ºserver, service, å¹¶å®Œæˆconnector å’Œ serviceçš„ç»‘å®š tomcat.getService().addConnector(connector); customizeConnector(connector); tomcat.setConnector(connector); tomcat.getHost().setAutoDeploy(false); // è¿™ä¸€æ­¥ä¼šæ ¹æ®æˆ‘ä»¬application.yml é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®å¯¹tomcat serveråšå®šåˆ¶åŒ–çš„é…ç½®ã€‚ configureEngine(tomcat.getEngine()); for (Connector additionalConnector : this.additionalTomcatConnectors) { tomcat.getService().addConnector(additionalConnector); } prepareContext(tomcat.getHost(), initializers); return getTomcatWebServer(tomcat); } è¿™æ—¶é™¤äº†Tomcat ç±»å¤–ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Connector, Service, Hostï¼ŒProtocolç­‰ç†Ÿæ‚‰çš„å­—çœ¼ã€‚\nConnectorçš„åˆ›å»º\nConnector connector = new Connector(this.protocol); Serverå’ŒServiceçš„åˆ›å»º\nåœ¨tomcat.getService()å®ç°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ–°å»ºäº†StandardServerå’ŒStandardServiceå¹¶å®ç°äº†åŒå‘ç»‘å®šã€‚\npublic Service getService() { return getServer().findServices()[0]; } public Server getServer() { if (server != null) { return server; } System.setProperty(\u0026#34;catalina.useNaming\u0026#34;, \u0026#34;false\u0026#34;); // ç†Ÿæ‚‰çš„StandardServer server = new StandardServer(); initBaseDir(); // Set configuration source ConfigFileLoader.setSource(new CatalinaBaseConfigurationSource(new File(basedir), null)); server.setPort(-1); // ç†Ÿæ‚‰çš„StandardService Service service = new StandardService(); service.setName(\u0026#34;Tomcat\u0026#34;); server.addService(service); return server; } Engineå’ŒHostçš„åˆ›å»º\nåœ¨tomcat.getHost()çš„å®ç°ä¸­ï¼Œåˆ›å»ºäº†StandardEngineå’ŒStandardHostï¼Œå¹¶å®Œæˆäº†Engine, Host, Service ä¹‹é—´çš„ç»‘å®š\npublic Host getHost() { Engine engine = getEngine(); if (engine.findChildren().length \u0026gt; 0) { return (Host) engine.findChildren()[0]; } Host host = new StandardHost(); host.setName(hostname); getEngine().addChild(host); return host; } public Engine getEngine() { Service service = getServer().findServices()[0]; if (service.getContainer() != null) { return service.getContainer(); } Engine engine = new StandardEngine(); engine.setName(\u0026#34;Tomcat\u0026#34;); engine.setDefaultHost(hostname); engine.setRealm(createDefaultRealm()); service.setContainer(engine); return engine; } è‡³æ­¤, è¿˜å·®ä¸€ä¸ªWrapperå°±å®Œæˆäº†ä»¥Tomcatä¸ºæ ¹èŠ‚ç‚¹çš„è¿™ä¸ªå±‚çº§å…³ç³»çš„æ„å»ºã€‚ Wrapper æ˜¯åœ¨\nTomcatçš„å¯åŠ¨\nåœ¨getWebServeræœ€åä¸€æ­¥getTomcatWebServer(tomcat)ä¸­,\n// TomcatServletWebServerFactory#getTomcatWebServer protected TomcatWebServer getTomcatWebServer(Tomcat tomcat) { return new TomcatWebServer(tomcat, getPort() \u0026gt;= 0, getShutdown()); } //TomcatWebServer#TomcatWebServer public TomcatWebServer(Tomcat tomcat, boolean autoStart, Shutdown shutdown) { Assert.notNull(tomcat, \u0026#34;Tomcat Server must not be null\u0026#34;); this.tomcat = tomcat; this.autoStart = autoStart; this.gracefulShutdown = (shutdown == Shutdown.GRACEFUL) ? new GracefulShutdown(tomcat) : null; initialize(); } // TomcatWebServer#initialize private void initialize() throws WebServerException { ... this.tomcat.start(); ... } // Tomcat#start public void start() throws LifecycleException { getServer(); server.start(); } åœ¨server.start() è¿™ä¸€æ­¥å¼€å§‹ä¹‹åå°±æ˜¯æˆ‘ä»¬å‰é¢åˆ†æè¿‡çš„tomcatçš„å¯åŠ¨æµç¨‹ã€‚\nServlet çš„åŠ è½½\næˆ‘ä»¬çŸ¥é“Springboot æ¡†æ¶å°±åŒ…å«spring mvc, æ‰€æœ‰è¯·æ±‚åœ¨åˆ°è¾¾tomcatåï¼Œä¼šäº¤ç»™DispathcerServlet æ¥å¤„ç†ï¼ŒDispatcherServlet ä¼šå†è¿›ä¸€æ­¥å¯¹è¯·æ±‚è¿›è¡Œåˆ†å‘ï¼Œäº¤ç»™å„è‡ªhandler/controlleræ¥å¤„ç†ã€‚\né‚£è¿™ä¸ªDispatcherServletæ˜¯ä»€ä¹ˆæ—¶å€™åŠ è½½çš„ï¼Ÿ\nDispatcherServletçš„å®ä¾‹åŒ–\nåœ¨spring å®¹å™¨æ„å»ºDispatcherServletRegistrationBeançš„æ—¶å€™ä¼šå‘ç°å®ƒä¾èµ–DispatcherServletï¼Œ è¿™æ—¶å€™å°±ä¼šå»å®ä¾‹åŒ–DispatcherServletã€‚\nWrapper çš„åˆ›å»ºä»¥åŠServlet å’Œwrapper çš„ç»‘å®š\nåœ¨StandaradContext#startInternal ä¸­æœ‰ä¸€æ®µä»£ç ï¼š\nprivate Map\u0026lt;ServletContainerInitializer,Set\u0026lt;Class\u0026lt;?\u0026gt;\u0026gt;\u0026gt; initializers = new LinkedHashMap\u0026lt;\u0026gt;(); ... for (Map.Entry\u0026lt;ServletContainerInitializer,Set\u0026lt;Class\u0026lt;?\u0026gt;\u0026gt;\u0026gt; entry : initializers.entrySet()) { try { entry.getKey().onStartup(entry.getValue(), getServletContext()); } catch (ServletException e) { log.error(sm.getString(\u0026#34;standardContext.sciFail\u0026#34;), e); ok = false; break; } } ServletContainerInitializeræ˜¯Servlet 3.0 æ–°å¢çš„ä¸€ä¸ªæ¥å£ï¼Œä¸»è¦ç”¨äºåœ¨å®¹å™¨å¯åŠ¨é˜¶æ®µé€šè¿‡ç¼–ç¨‹é£æ ¼æ³¨å†ŒFilter, Servletä»¥åŠListenerï¼Œä»¥å–ä»£é€šè¿‡web.xmlé…ç½®æ³¨å†Œã€‚å®¹å™¨å¯åŠ¨é˜¶æ®µä¾æ®java spiè·å–åˆ°æ‰€æœ‰ServletContainerInitializerçš„å®ç°ç±»ï¼Œç„¶åæ‰§è¡Œå…¶onStartupæ–¹æ³•.\nå…¶ä¸­å°±æœ‰ä¸€ä¸ªspringå®ç°çš„TomcatStarter\nè€ŒTomcatStarter åˆä¼šæ‰§è¡Œå†…éƒ¨ç»´æŠ¤çš„initializersçš„onStartupæ–¹æ³•\nfor (ServletContextInitializer initializer : this.initializers) { initializer.onStartup(servletContext); } è¿™ä¸ªå†…éƒ¨ç»´æŠ¤çš„initializersæ˜¯é€šè¿‡å¦‚ä¸‹æ–¹å¼æ·»åŠ ï¼š\nthis.webServer = factory.getWebServer(getSelfInitializer()); â€”\u0026gt;TomcatServletWebServerFactory#getWebServer â€”\u0026gt;TomcatServletWebServerFactory#prepareContext â€”\u0026gt;TomcatServletWebServerFactory#configureContext â€”\u0026gt;new TomcatStarter(initializers)\nå…¶ä¸­getSelfInitializerè¿”å›çš„æ˜¯ä¸€ä¸ªLambaè¡¨è¾¾å¼ï¼š\nprivate org.springframework.boot.web.servlet.ServletContextInitializer getSelfInitializer() { return this::selfInitialize; } private void selfInitialize(ServletContext servletContext) throws ServletException { prepareWebApplicationContext(servletContext); registerApplicationScope(servletContext); WebApplicationContextUtils.registerEnvironmentBeans(getBeanFactory(), servletContext); for (ServletContextInitializer beans : getServletContextInitializerBeans()) { beans.onStartup(servletContext); } } æ‰€ä»¥æœ€ç»ˆä¼šæ‰§è¡Œåˆ°ServletContextInitializerBeans çš„onStartupæ–¹æ³•ï¼Œ\nå…¶ä¸­å°±æœ‰ä¸€ä¸ªDispatcherServletRegistrationBean, ç„¶åé€šè¿‡ä»¥ä¸‹è°ƒç”¨é“¾\nbeans.onStartup(servletContext) â€”\u0026gt; DispatcherServletRegistrationBean#onStartup â€”\u0026gt; DynamicRegistrationBean#register â€”\u0026gt; ServletRegistrationBean#addRegistration â€”\u0026gt; ApplicationContextFacade#addServlet â€”\u0026gt; ApplicationContext#addServlet â€”\u0026gt; org.apache.catalina.core.ApplicationContext#addServlet\nåœ¨ApplicationContext#addServletä¸­å¯ä»¥çœ‹åˆ°ä¼šåˆ›å»ºwrapper,å¹¶ç»‘å®šStandardContext å’Œwrapper ï¼Œè‹¥servlet ä¸ä¸ºç©ºåˆ™ä¼šé€šè¿‡wrapper.setServlet(servlet);æ¥ç»‘å®šservlet å’Œ wrapper.\nè‹¥servlet ä¸ºç©ºï¼Œåˆ™åªä¼šsetServletClassï¼Œä¸”loadClass , å®ä¾‹åŒ–äº¤ç»™åé¢çš„æ­¥éª¤è¿›è¡Œã€‚\nprivate ServletRegistration.Dynamic addServlet(String servletName, String servletClass, Servlet servlet, Map\u0026lt;String,String\u0026gt; initParams) throws IllegalStateException { ... Wrapper wrapper = (Wrapper) context.findChild(servletName); // Assume a \u0026#39;complete\u0026#39; ServletRegistration is one that has a class and // a name if (wrapper == null) { wrapper = context.createWrapper(); wrapper.setName(servletName); context.addChild(wrapper); } else { if (wrapper.getName() != null \u0026amp;\u0026amp; wrapper.getServletClass() != null) { if (wrapper.isOverridable()) { wrapper.setOverridable(false); } else { return null; } } } ServletSecurity annotation = null; if (servlet == null) { wrapper.setServletClass(servletClass); Class\u0026lt;?\u0026gt; clazz = Introspection.loadClass(context, servletClass); if (clazz != null) { annotation = clazz.getAnnotation(ServletSecurity.class); } } else { wrapper.setServletClass(servlet.getClass().getName()); wrapper.setServlet(servlet); if (context.wasCreatedDynamicServlet(servlet)) { annotation = servlet.getClass().getAnnotation(ServletSecurity.class); } } if (initParams != null) { for (Map.Entry\u0026lt;String,String\u0026gt; initParam : initParams.entrySet()) { wrapper.addInitParameter(initParam.getKey(), initParam.getValue()); } } ServletRegistration.Dynamic registration = new ApplicationServletRegistration(wrapper, context); if (annotation != null) { registration.setServletSecurity(new ServletSecurityElement(annotation)); } return registration; } è‡³æ­¤ï¼Œwrapper ä¹Ÿå°±åˆ›å»ºå®Œæˆï¼Œå¹¶åœ¨tomcat å¯åŠ¨çš„æ—¶å€™å°±ä¼šå®ä¾‹åŒ–å‡ºäº†Servletã€‚å’Œå‰é¢åˆ†æçš„tomcat æ¶æ„å®Œç¾è¡”æ¥ï¼Œè‡³äºè¯·æ±‚åˆ°è¾¾DispatcherServletåæ€ä¹ˆåˆ†å‘äº¤ç»™controllerï¼Œé‚£å°±æ˜¯å¦ä¸€ä¸ªtopicäº†ã€‚\nå¤ä¹ å›é¡¾ï¼šè¿™é‡Œè¯´çš„wrapperæŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ\n","date":"2024-01-10T11:28:33+08:00","image":"http://localhost:1313/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/IMG_1890_hufea3e9ca65cfbc42e503dcb755cb462c_15847402_120x120_fill_box_smart1_3.png","permalink":"http://localhost:1313/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/","title":"tomcatæ¶æ„åŸç†è§£æ"},{"content":"åœ¨è®¨è®ºè¿™ä¸ªé—®é¢˜ä¹‹å‰å…ˆæŠ›å‡ºä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬éƒ½çŸ¥é“è®¡ç®—æœºå†…éƒ¨éƒ½æ˜¯äºŒè¿›åˆ¶ï¼Œé‚£ä¹ˆç»™å®šä¸€äº›æ–‡æœ¬å­—ç¬¦ä¸²æ¯”å¦‚è‹±æ–‡å•è¯Good, æˆ‘ä»¬æ˜¯æ€ä¹ˆçŸ¥é“è¦æŠŠå®ƒè½¬åŒ–ä¸ºæ€æ ·çš„äºŒè¿›åˆ¶çš„ï¼Ÿ\nè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯å­—ç¬¦ç¼–ç ã€‚\n1.ä»€ä¹ˆæ˜¯å­—ç¬¦ç¼–ç  å­—ç¬¦ç¼–ç ç”¨æ¥å°†äººç±»å¯è¯»çš„å­—ç¬¦æ¯”å¦‚è‹±æ–‡å­—æ¯æ•°å­—ä»¥åŠä¸€äº›ç¬¦å·æ˜ å°„æˆä¸€ä¸ªæ•°å€¼ï¼Œè¿™ä¸ªæ•°å€¼ç§°ä¸ºç ä½ï¼Œç„¶åé€šè¿‡ä¸€å®šè§„åˆ™ç”¨äºŒè¿›åˆ¶æ¥è¡¨ç¤ºè¿™ä¸ªæ•°å€¼ï¼Œå®ƒæœ¬è´¨ä¸Šæ˜¯äººä¸ºè®¾è®¡çš„ä¸€ç§è§„åˆ™æˆ–è€…ç†è§£ä¸ºä¸€ç§æ˜ å°„å…³ç³»ã€‚ç†è§£ä»€ä¹ˆæ˜¯å­—ç¬¦ç¼–ç å¾ˆé‡è¦ï¼Œå®ƒæœ‰ä¸¤ä¸ªå¾ˆé‡è¦çš„æ ¸å¿ƒåŠŸèƒ½ï¼š\nå°†å­—ç¬¦æ ¹æ®è§„åˆ™æ˜ å°„æˆå”¯ä¸€æ•°å€¼å¹¶è½¬åŒ–ä¸ºå¯¹åº”çš„äºŒè¿›åˆ¶ å°†äºŒè¿›åˆ¶æ•°æ®æ ¹æ®ç¼–ç è§„åˆ™ç¿»è¯‘æˆäººç±»å¯è¯»çš„å­—ç¬¦ è¿™ä¹Ÿæ˜¯è®¡ç®—æœºä¸–ç•Œä¸­çš„ä¸€ç§åŸºæœ¬çš„æ€æƒ³æ–¹æ³•è®ºï¼Œç±»ä¼¼çš„ï¼ŒéŸ³è§†é¢‘å­˜å‚¨åœ¨è®¡ç®—æœºä¸­ä¹Ÿéƒ½æœ‰ç›¸åº”çš„éŸ³è§†é¢‘ç¼–ç ç®—æ³•å°†å…¶è½¬åŒ–ä¸ºäºŒè¿›åˆ¶\n2.æœ‰å“ªäº›å­—ç¬¦ç¼–ç  ä¸åŒåœ°åŒºæ–‡åŒ–ä¸­çš„å­—ç¬¦é›†(æ•°é‡å’Œç§ç±»å·®å¼‚), ä»–ä»¬é€šå¸¸æœ‰è‡ªå·±å¯¹åº”çš„å­—ç¬¦ç¼–ç æ ‡å‡†ï¼Œå†åŠ ä¸Šä¸€äº›å‚å•†è‡ªå®šä¹‰çš„æ ‡å‡†ï¼Œä»¥åŠæŠ€æœ¯è¿­ä»£è¿‡ç¨‹ä¸­çš„æ–°éœ€æ±‚ï¼Œä¼˜åŒ–ç­‰åŸå› å¯¼è‡´å­—ç¬¦ç¼–ç æœ‰å¾ˆå¤šç§ï¼Œæ­¤å¤„åªåˆ—ä¸¾ä¸€äº›å¸¸è§çš„ã€‚\nASCII: æœ€æ—©çš„å­—ç¬¦ç¼–ç  Unicode: ä¸€ä¸ªå…¨çƒæ€§çš„å­—ç¬¦ç¼–ç æ ‡å‡†ï¼Œä¸ºä¸–ç•Œä¸Šå‡ ä¹æ‰€æœ‰çš„å­—ç¬¦æä¾›äº†å”¯ä¸€çš„ç¼–å· UTF-8: UTF-8æ˜¯Unicode çš„ä¸€ç§å®ç°æ–¹å¼ ISO-8859ç³»åˆ—: ISO-8859-1: æ¶µç›–äº†è¥¿æ¬§åœ°åŒºæœ€å¸¸ç”¨çš„å­—ç¬¦ ISO-8859-2: è®¾è®¡ç”¨äºä¸­æ¬§åœ°åŒºï¼Œæ¶µç›–äº†ä¸€äº›ä¸­æ¬§å›½å®¶çš„å­—ç¬¦éœ€æ±‚ ISO-8859-3: ä¸»è¦è®¾è®¡ç”¨äºæ”¯æŒå—æ¬§ã€å—ä¸œæ¬§å’Œä¸€äº›å…¶ä»–åœ°åŒºçš„è¯­è¨€ \u0026hellip; GBK: ä¸»è¦ç”¨äºç®€ä½“ä¸­æ–‡ Big5: ç”¨äºç¹ä½“ä¸­æ–‡ \u0026hellip; 3.ä¸ºä»€ä¹ˆæœ‰æ—¶å€™æˆ‘ä»¬æ‰“å¼€æ–‡ä»¶ä¼šçœ‹åˆ°ä¹±ç ï¼Ÿ æˆ‘ä»¬çŸ¥é“åŒä¸€ä¸ªå­—ç¬¦åœ¨ä¸åŒçš„å­—ç¬¦ç¼–ç ä¸‹å¯èƒ½ä¼šè¢«è½¬åŒ–æˆä¸åŒçš„äºŒè¿›åˆ¶ï¼ŒåŒä¸€ä¸ªäºŒè¿›åˆ¶åœ¨ä¸åŒå­—ç¬¦ç¼–ç ä¸‹å¯èƒ½ä¼šè¢«è§£é‡Šæˆä¸åŒçš„ç¬¦å·ã€‚å½“é€‰ç”¨çš„è¿™ä¸ªå­—ç¬¦ç¼–ç ä¸­ä¸åŒ…å«è¯¥äºŒè¿›åˆ¶å¯¹åº”çš„å­—ç¬¦æ—¶æˆ‘ä»¬å°±çœ‹åˆ°äº†ä¹±ç ç°è±¡ã€‚å› æ­¤å½“æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬å°±å¿…é¡»çŸ¥é“å®ƒçš„ç¼–ç æ–¹å¼ã€‚\n4. ASCIIï¼ˆAmerican Standard Code for Information Interchangeï¼‰ ASCIIæ˜¯ä¸€ç§æœ€æ—©çš„å­—ç¬¦ç¼–ç æ ‡å‡†ï¼Œå®ƒäº20ä¸–çºª60å¹´ä»£åˆç”±ç¾å›½å‘å¸ƒï¼Œè§„å®šäº†è‹±è¯­å’ŒäºŒè¿›åˆ¶ä½ä¹‹é—´çš„å…³ç³»ã€‚å®ƒè§„å®šäº†128ç§å­—ç¬¦ï¼Œå…·ä½“æœ‰å“ª128ç§å¯æŸ¥è¯¢å¯¹åº”çš„è¡¨æ ¼èµ„æ–™ï¼Œæ¯”å¦‚å­—æ¯Aå¯¹åº”çš„äºŒè¿›åˆ¶æ˜¯0100 0001ã€‚\nä½†æ˜¯å¾ˆæ˜æ˜¾ï¼ŒåŒºåŒºåªæœ‰128ç§å¯¹äºå…¶ä»–è¯­è¨€çš„å­—ç¬¦åˆ™ä¸è¶³å¤Ÿï¼Œæ¯”å¦‚å…‰å¸¸ç”¨æ±‰å­—å°±æœ‰å‡ åƒä¸ªï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆå¤„ç†æ±‰å­—å‘¢ï¼Ÿ\nèªæ˜çš„åŒå­¦å¯èƒ½æƒ³åˆ°äº†ä¸Šé¢æåˆ°çš„GBKå’ŒBig5æ˜¯ç”¨æ¥å¤„ç†ç®€ç¹ä½“ä¸­æ–‡çš„ï¼Œé‚£ä¹ˆå‡å¦‚ä¸€æ®µæ–‡æœ¬ä¸­æ—¢åŒ…å«ä¸­æ–‡åˆåŒ…å«ä¸€äº›ç‰¹æ®Šçš„æ‹‰ä¸å­—æ¯å‘¢ï¼Ÿæ­¤æ—¶åº”è¯¥ç”¨ä»€ä¹ˆå­—ç¬¦ç¼–ç æ¥å­˜å‚¨å’Œæ‰“å¼€è¿™ä¸ªæ–‡æœ¬æ–‡ä»¶å‘¢ï¼Ÿ\né¢å¯¹å¤šå…ƒçš„æ–‡åŒ–ç¯å¢ƒï¼Œå¦‚æœèƒ½æœ‰ä¸€ç§å­—ç¬¦ç¼–ç èƒ½åŒ…å«ä¸–ç•Œä¸Šæ‰€æœ‰çš„å­—ç¬¦æ˜¯ä¸æ˜¯ä¼šæ›´åŠ æ–¹ä¾¿ã€‚äºæ˜¯ï¼ŒUnicodeåº”è¿è€Œç”Ÿã€‚\n5. Unicode Unicodeæ—¨åœ¨æ¶µç›–å…¨çƒèŒƒå›´å†…çš„æ‰€æœ‰è¯­è¨€å’Œå­—ç¬¦ã€‚å®ƒè§„å®šäº†æ¯ä¸€ä¸ªå­—ç¬¦æ‰€å¯¹åº”çš„æ•°å­—ï¼Œæ¯”å¦‚ä¸­æ–‡â€œå—¨â€ å¯¹åº”çš„äºŒè¿›åˆ¶æ˜¯101010111101000ï¼Œä½†æ˜¯unicode å´å¹¶æ²¡æœ‰è§„å®šæ€ä¹ˆå­˜å‚¨ï¼Œå‡å¦‚æˆ‘ä»¬ç›´æ¥é«˜ä½è¡¥0æŠŠ101010111101000å­˜åˆ°è®¡ç®—æœºä¸­ï¼Œé‚£è¯»å–çš„æ—¶å€™æ€ä¹ˆè§£é‡Šå‘¢ï¼Ÿè®¡ç®—æœºæ€ä¹ˆçŸ¥é“è¿™16ä½äºŒè¿›åˆ¶(2å­—èŠ‚ï¼‰æ˜¯è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦è¿˜æ˜¯ä¸¤ä¸ªå­—ç¬¦ï¼Ÿ\né‚£ä¸ºä»€ä¹ˆunicode ä¸è§„å®šå°±2ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦å‘¢ å› ä¸ºåœ¨unicodeä¸­ä¸€ä¸ªå­—ç¬¦å¯èƒ½éœ€è¦å ç”¨1ï½nå­—èŠ‚ä¸ç­‰ï¼Œä¸ºäº†é€‚é…æ‰€æœ‰å­—ç¬¦ï¼Œå°±å¿…é¡»è§„å®šn(n\u0026gt;1)å­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œé‚£å¯¹äºé‚£äº›æ˜æ˜ä¸€ä¸ªå­—èŠ‚å°±å¯ä»¥è¡¨ç¤ºçš„å­—ç¬¦ï¼Œå´éè¦ç”¨nå­—èŠ‚æ¥è¡¨ç¤ºï¼Œé€ æˆäº†ç©ºé—´çš„æµªè´¹ã€‚\né‡ç‚¹ï¼šUnicode åªè§„å®šäº†å­—ç¬¦å’Œæ•°å­—çš„æ˜ å°„å…³ç³»ï¼Œä½†å´æ²¡æœ‰è§„å®šè¿™äº›æ•°å­—æ€ä¹ˆå­˜å‚¨ï¼Œå½“æˆ‘ä»¬æŠŠæŸä¸ªå­—ç¬¦å¯¹åº”çš„æ•°å­—ç†è§£ä¸ºè¿™ä¸ªå­—ç¬¦å¯¹åº”çš„unicodeæ—¶ï¼Œunicode å¹¶æ²¡æœ‰å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªunicode è¯¥å¦‚ä½•å­˜å‚¨åˆ°è®¡ç®—æœºä¸­ã€‚\n6.UTF-8ï¼ˆUnicode Transformation Formatï¼‰ ç”±äºUnicode æ²¡æœ‰è§„å®šå­˜å‚¨æ–¹å¼ï¼Œå¯¼è‡´unicode æœ‰å¤šç§å®ç°æ–¹å¼, å…¶ä¸­UTF-8æ˜¯å…¶ä¸­ä¸€ç§æœ€å¸¸è§çš„å®ç°æ–¹å¼ã€‚\nUTF-8æ˜¯ä¸€ç§é’ˆå¯¹Unicodeè®¾è®¡çš„å¯å˜é•¿åº¦å­—ç¬¦ç¼–ç æ–¹æ¡ˆã€‚å¯¹äºå¸¸ç”¨çš„è‹±æ–‡å­—æ¯å’Œç¬¦å·ï¼Œå…¶ç¼–ç ä¸ASCIIå…¼å®¹ï¼Œå®ƒä½¿ç”¨8ä½äºŒè¿›åˆ¶æ•°ï¼ˆ1å­—èŠ‚ï¼‰æ¥è¡¨ç¤ºã€‚ä½†å¯¹äºé‚£äº›ä¸å±äºASCIIå­—ç¬¦é›†çš„Unicodeå­—ç¬¦ï¼ŒUTF-8é‡‡ç”¨äº†ä¸åŒçš„ç¼–ç æ–¹å¼ã€‚\nå…¶ç¼–ç è§„åˆ™ï¼š\n1ï¼‰å¯¹äºå•å­—èŠ‚çš„ç¬¦å·ï¼Œå­—èŠ‚çš„ç¬¬ä¸€ä½è®¾ä¸º0ï¼Œåé¢7ä½ä¸ºè¿™ä¸ªç¬¦å·çš„ Unicode ç ã€‚å› æ­¤å¯¹äºè‹±è¯­å­—æ¯ï¼ŒUTF-8 ç¼–ç å’Œ ASCII ç æ˜¯ç›¸åŒçš„ã€‚\n2ï¼‰å¯¹äºnå­—èŠ‚çš„ç¬¦å·ï¼ˆn \u0026gt; 1ï¼‰ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚çš„å‰nä½éƒ½è®¾ä¸º1ï¼Œç¬¬n + 1ä½è®¾ä¸º0ï¼Œåé¢å­—èŠ‚çš„å‰ä¸¤ä½ä¸€å¾‹è®¾ä¸º10ã€‚å‰©ä¸‹çš„æ²¡æœ‰æåŠçš„äºŒè¿›åˆ¶ä½ï¼Œä»ä½ä½å¼€å§‹é€æ¸è¡¥å…¨ä¸ºè¿™ä¸ªç¬¦å·çš„ Unicode ç ï¼Œé«˜ä½ä¸è¶³çš„è¡¥0ã€‚\nå­—ç¬¦ Unicode unicode äºŒè¿›åˆ¶ UTF-8ç¼–ç æ–¹å¼ è¯´æ˜ A U+0041 01000001 01000001 å¯¹äºå•å­—èŠ‚çš„ç¬¦å·ï¼Œå­—èŠ‚çš„ç¬¬ä¸€ä½è®¾ä¸º0 Ã© U+00E9 11101001 11000011 10101001 n=2 ä¸­ U+4e2d 100111000101101 11100100 10111000 10101101 n=3 ğŸ˜„ U+1F601 11111011000000100 11110000 10011111 10011000 10000001 n=4 ä½ æ²¡çœ‹é”™ï¼Œunicode ä¹Ÿå¯ä»¥è¡¨ç¤ºè¡¨æƒ…åŒ…ç¬¦å·ã€‚å¯¹äºæ›´è¯¦ç»†çš„UTF-8ç¼–ç è§„åˆ™å¯å‚é˜…ç›¸å…³æ–‡æ¡£ã€‚\næ€»ç»“ å­—ç¬¦ç¼–ç ç”¨æ¥è§„å®šå­—ç¬¦å’Œæ•°å€¼(ç ä½ï¼‰ä¹‹é—´ï¼Œä»¥åŠç ä½å’Œè®¡ç®—æœºäºŒè¿›åˆ¶ä¹‹é—´çš„ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œä¸åŒçš„å­—ç¬¦ç¼–ç è¿™ä¸ªæ˜ å°„å…³ç³»ä¸åŒ ASCIIæ˜¯ä¸€ç§æœ€æ—©çš„å­—ç¬¦ç¼–ç æ ‡å‡†ç”¨æ¥å¤„ç†è‹±æ–‡åŠå¸¸è§æ ‡ç‚¹ç­‰128ç§å­—ç¬¦ï¼Œè€ŒUnicode åŒ…å«æ›´å¤šçš„å­—ç¬¦é›†ï¼Œæ—¨åœ¨ä¸ºä¸–ç•Œä¸Šå‡ ä¹æ‰€æœ‰çš„å­—ç¬¦æä¾›ä¸€ä¸ªå”¯ä¸€çš„æ•°å€¼æ ‡è¯†ï¼Œä»¥ä¾¿åœ¨ä¸åŒçš„è®¡ç®—æœºç³»ç»Ÿå’Œåº”ç”¨ç¨‹åºä¸­è¿›è¡Œä¸€è‡´çš„æ–‡æœ¬å¤„ç†ï¼Œå› æ­¤ASCIIå­—ç¬¦é›†æ˜¯Unicodeå­—ç¬¦é›†çš„ä¸€ä¸ªå­é›†ã€‚ Unicode å¹¶ä¸è§„å®šç ä½çš„å­˜å‚¨æ–¹å¼ï¼Œå®ƒçš„å­˜å‚¨å’Œè¡¨ç°æ–¹å¼å–å†³äºå…·ä½“çš„ç¼–ç æ–¹æ¡ˆï¼Œå…¶ä¸­æœ€å¸¸è§çš„æ˜¯UTF-8, æ­¤å¤–è¿˜æœ‰UTF-16, UTF-32ç­‰ã€‚UTF-8æ˜¯unicode çš„ä¸€ç§å…·ä½“å®ç°ã€‚ ","date":"2024-01-02T14:38:04+08:00","image":"http://localhost:1313/posts/ascii-unicode-and-charset/images/birds_hu5d1795c6e08ed878cbfdb3775942dd39_211231_120x120_fill_box_smart1_3.png","permalink":"http://localhost:1313/posts/ascii-unicode-and-charset/","title":"ASCIIã€Unicodeå’ŒUTF-8ä¸å­—ç¬¦ç¼–ç "},{"content":"Hello world and hello hugo.\n","date":"2023-11-05T14:16:30+08:00","image":"http://localhost:1313/posts/hello-hugo/images/blue_sky_hu1b20aecede543d83af89b7e5ec0a8a40_246301_120x120_fill_box_smart1_3.png","permalink":"http://localhost:1313/posts/hello-hugo/","title":"Hello Hugo"}]