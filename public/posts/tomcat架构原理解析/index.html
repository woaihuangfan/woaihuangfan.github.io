<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Tomcatè‡ª1998å¹´é—®ä¸–ä»¥æ¥å› ä¸ºå…¶é«˜æ€§èƒ½ï¼Œå…è´¹ç­‰ç‰¹ç‚¹å¹¿å—Javaçˆ±å¥½è€…çš„å–œçˆ±ï¼Œä½†åœ¨Springbootç­‰å¾®æœåŠ¡æ¡†æ¶æˆä¸ºæŠ€æœ¯ä¸»æµåçš„ä»Šå¤©ï¼Œtomcatä¼¼ä¹é€æ¸&amp;quot;æ¶ˆå¤±&amp;quot;åœ¨å¤§ä¼—çš„è§†çº¿ä¸­ï¼Œä½ è¿˜åœ¨ç”¨tomcatå—ï¼Ÿæˆ‘ç›¸ä¿¡å¯¹äºå¤§éƒ¨åˆ†java web developeræ¥è¯´è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯Yes, å› ä¸ºSpringboot web starteré»˜è®¤é›†æˆçš„å°±æ˜¯tomcatã€‚
æœ¬æ–‡å°è¯•ä»&amp;quot;ä¸ºä»€ä¹ˆæµè§ˆå™¨å‘å‡ºçš„HTTPè¯·æ±‚å¯ä»¥åˆ°è¾¾æˆ‘ä»¬çš„Controller&amp;quot;è¿™ä¸€åŸºæœ¬é—®é¢˜å‡ºå‘ï¼Œç”±æµ…å…¥æ·±ï¼Œç”±ç‚¹åˆ°é¢çš„æ–¹å¼å…ˆä»æ•´ä½“çš„è§’åº¦æ¥æ¢³ç†tomcatçš„æ¶æ„åŸç†ï¼Œå†åˆ°ä»¥ä¸€ä¸ªHTTP/1.1 è¯·æ±‚ä¸ºä¾‹æ¥åˆ†ætomcatä½œä¸ºä¸€ä¸ªHTTP webæœåŠ¡å™¨å’ŒServletå®¹å™¨å®ƒæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæœ€åå›å½’è¿™ä¸ªé—®é¢˜æ¢³ç†springbootæ˜¯å¦‚ä½•ä¸tomcaté›†æˆçš„ã€‚å…¶ä¸­æ¶‰åŠå¤§é‡çš„æºç è§£æï¼Œè¯·ç•™æ„æ¶‰åŠæºç è§£æçš„éƒ¨åˆ†éƒ½æ˜¯åŸºäºtomcat 10.x æ¥è¿›è¡Œã€‚å¸Œæœ›èƒ½ç»™é‚£äº›å¯¹tomcatåŸç†æ„Ÿå…´è¶£çš„åŒå­¦æä¾›ä¸€äº›è§†è§’å’Œå‚è€ƒã€‚
'>
<title>tomcatæ¶æ„åŸç†è§£æ</title>

<link rel='canonical' href='http://localhost:1313/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/'>

<link rel="stylesheet" href="/scss/style.min.876ff6cde480707ded0466265c1f084444129bedc60fe81e5f83398e4410d786.css"><meta property='og:title' content='tomcatæ¶æ„åŸç†è§£æ'>
<meta property='og:description' content='Tomcatè‡ª1998å¹´é—®ä¸–ä»¥æ¥å› ä¸ºå…¶é«˜æ€§èƒ½ï¼Œå…è´¹ç­‰ç‰¹ç‚¹å¹¿å—Javaçˆ±å¥½è€…çš„å–œçˆ±ï¼Œä½†åœ¨Springbootç­‰å¾®æœåŠ¡æ¡†æ¶æˆä¸ºæŠ€æœ¯ä¸»æµåçš„ä»Šå¤©ï¼Œtomcatä¼¼ä¹é€æ¸&amp;quot;æ¶ˆå¤±&amp;quot;åœ¨å¤§ä¼—çš„è§†çº¿ä¸­ï¼Œä½ è¿˜åœ¨ç”¨tomcatå—ï¼Ÿæˆ‘ç›¸ä¿¡å¯¹äºå¤§éƒ¨åˆ†java web developeræ¥è¯´è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯Yes, å› ä¸ºSpringboot web starteré»˜è®¤é›†æˆçš„å°±æ˜¯tomcatã€‚
æœ¬æ–‡å°è¯•ä»&amp;quot;ä¸ºä»€ä¹ˆæµè§ˆå™¨å‘å‡ºçš„HTTPè¯·æ±‚å¯ä»¥åˆ°è¾¾æˆ‘ä»¬çš„Controller&amp;quot;è¿™ä¸€åŸºæœ¬é—®é¢˜å‡ºå‘ï¼Œç”±æµ…å…¥æ·±ï¼Œç”±ç‚¹åˆ°é¢çš„æ–¹å¼å…ˆä»æ•´ä½“çš„è§’åº¦æ¥æ¢³ç†tomcatçš„æ¶æ„åŸç†ï¼Œå†åˆ°ä»¥ä¸€ä¸ªHTTP/1.1 è¯·æ±‚ä¸ºä¾‹æ¥åˆ†ætomcatä½œä¸ºä¸€ä¸ªHTTP webæœåŠ¡å™¨å’ŒServletå®¹å™¨å®ƒæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæœ€åå›å½’è¿™ä¸ªé—®é¢˜æ¢³ç†springbootæ˜¯å¦‚ä½•ä¸tomcaté›†æˆçš„ã€‚å…¶ä¸­æ¶‰åŠå¤§é‡çš„æºç è§£æï¼Œè¯·ç•™æ„æ¶‰åŠæºç è§£æçš„éƒ¨åˆ†éƒ½æ˜¯åŸºäºtomcat 10.x æ¥è¿›è¡Œã€‚å¸Œæœ›èƒ½ç»™é‚£äº›å¯¹tomcatåŸç†æ„Ÿå…´è¶£çš„åŒå­¦æä¾›ä¸€äº›è§†è§’å’Œå‚è€ƒã€‚
'>
<meta property='og:url' content='http://localhost:1313/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/'>
<meta property='og:site_name' content='æ¸…éœ²æ™¨æµ, æ–°æ¡åˆå¼•'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:published_time' content='2024-01-10T11:28:33&#43;08:00'/><meta property='article:modified_time' content='2024-01-10T11:28:33&#43;08:00'/><meta property='og:image' content='http://localhost:1313/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/IMG_1890.png' />
<meta name="twitter:title" content="tomcatæ¶æ„åŸç†è§£æ">
<meta name="twitter:description" content="Tomcatè‡ª1998å¹´é—®ä¸–ä»¥æ¥å› ä¸ºå…¶é«˜æ€§èƒ½ï¼Œå…è´¹ç­‰ç‰¹ç‚¹å¹¿å—Javaçˆ±å¥½è€…çš„å–œçˆ±ï¼Œä½†åœ¨Springbootç­‰å¾®æœåŠ¡æ¡†æ¶æˆä¸ºæŠ€æœ¯ä¸»æµåçš„ä»Šå¤©ï¼Œtomcatä¼¼ä¹é€æ¸&amp;quot;æ¶ˆå¤±&amp;quot;åœ¨å¤§ä¼—çš„è§†çº¿ä¸­ï¼Œä½ è¿˜åœ¨ç”¨tomcatå—ï¼Ÿæˆ‘ç›¸ä¿¡å¯¹äºå¤§éƒ¨åˆ†java web developeræ¥è¯´è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯Yes, å› ä¸ºSpringboot web starteré»˜è®¤é›†æˆçš„å°±æ˜¯tomcatã€‚
æœ¬æ–‡å°è¯•ä»&amp;quot;ä¸ºä»€ä¹ˆæµè§ˆå™¨å‘å‡ºçš„HTTPè¯·æ±‚å¯ä»¥åˆ°è¾¾æˆ‘ä»¬çš„Controller&amp;quot;è¿™ä¸€åŸºæœ¬é—®é¢˜å‡ºå‘ï¼Œç”±æµ…å…¥æ·±ï¼Œç”±ç‚¹åˆ°é¢çš„æ–¹å¼å…ˆä»æ•´ä½“çš„è§’åº¦æ¥æ¢³ç†tomcatçš„æ¶æ„åŸç†ï¼Œå†åˆ°ä»¥ä¸€ä¸ªHTTP/1.1 è¯·æ±‚ä¸ºä¾‹æ¥åˆ†ætomcatä½œä¸ºä¸€ä¸ªHTTP webæœåŠ¡å™¨å’ŒServletå®¹å™¨å®ƒæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæœ€åå›å½’è¿™ä¸ªé—®é¢˜æ¢³ç†springbootæ˜¯å¦‚ä½•ä¸tomcaté›†æˆçš„ã€‚å…¶ä¸­æ¶‰åŠå¤§é‡çš„æºç è§£æï¼Œè¯·ç•™æ„æ¶‰åŠæºç è§£æçš„éƒ¨åˆ†éƒ½æ˜¯åŸºäºtomcat 10.x æ¥è¿›è¡Œã€‚å¸Œæœ›èƒ½ç»™é‚£äº›å¯¹tomcatåŸç†æ„Ÿå…´è¶£çš„åŒå­¦æä¾›ä¸€äº›è§†è§’å’Œå‚è€ƒã€‚
"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='http://localhost:1313/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/IMG_1890.png' />
    <link rel="shortcut icon" href="/favicon.svg" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu13ebfac54b51a4b7ee52e30ffb590fe7_360247_300x0_resize_box_3.png" width="300"
                            height="400" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸš</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">æ¸…éœ²æ™¨æµ, æ–°æ¡åˆå¼•</a></h1>
            <h2 class="site-description">The only way of humans have figured out of getting somewhere is to leave something behind.</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li  class='current' >
            <a href='/posts/' >
                
                
                
                    <svg t="1709175193721" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2392"
     width="200" height="200">
    <path d="M811.008 860.672H308.736c-30.72 0-55.296-27.648-55.296-61.44v-675.84c0-33.792 24.576-61.44 55.296-61.44h330.752c8.704 0 15.36 6.656 15.36 15.36s-6.656 15.36-15.36 15.36H308.736c-13.312 0-24.576 13.824-24.576 30.72v675.84c0 16.896 11.264 30.72 24.576 30.72h502.272c13.312 0 24.576-13.824 24.576-30.72V305.664L691.2 136.192c-5.632-6.656-4.608-16.384 1.536-21.504 6.656-5.632 16.384-4.608 21.504 1.536l147.968 173.568c2.56 2.56 3.584 6.144 3.584 9.728V798.72c0.512 34.304-24.064 61.952-54.784 61.952z"
          p-id="2393"></path>
    <path d="M715.264 964.608H212.992c-30.72 0-55.296-27.648-55.296-61.44v-675.84c0-8.704 6.656-15.36 15.36-15.36s15.36 6.656 15.36 15.36v675.84c0 16.896 11.264 30.72 24.576 30.72h502.272c8.704 0 15.36 6.656 15.36 15.36s-6.656 15.36-15.36 15.36z"
          p-id="2394"></path>
    <path d="M734.208 522.752H369.664c-8.704 0-15.36-6.656-15.36-15.36s6.656-15.36 15.36-15.36h364.544c8.704 0 15.36 6.656 15.36 15.36s-6.656 15.36-15.36 15.36zM734.208 603.648H369.664c-8.704 0-15.36-6.656-15.36-15.36s6.656-15.36 15.36-15.36h364.544c8.704 0 15.36 6.656 15.36 15.36s-6.656 15.36-15.36 15.36zM648.192 685.056H369.664c-8.704 0-15.36-6.656-15.36-15.36s6.656-15.36 15.36-15.36h278.528c8.704 0 15.36 6.656 15.36 15.36s-6.656 15.36-15.36 15.36zM586.752 441.344H369.664c-8.704 0-15.36-6.656-15.36-15.36s6.656-15.36 15.36-15.36h217.088c8.704 0 15.36 6.656 15.36 15.36s-6.656 15.36-15.36 15.36zM791.04 315.392h-151.552c-8.704 0-15.36-6.656-15.36-15.36V77.312c0-8.704 6.656-15.36 15.36-15.36s15.36 6.656 15.36 15.36v207.36h136.192c8.704 0 15.36 6.656 15.36 15.36s-6.656 15.36-15.36 15.36z"
          p-id="2395"></path>
</svg>
                
                <span>Posts</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/page/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">

            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">



        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#tomcatçš„æ ¸å¿ƒåŠŸèƒ½">Tomcatçš„æ ¸å¿ƒåŠŸèƒ½</a></li>
    <li><a href="#ç†è§£http-è¯·æ±‚çš„æœ¬è´¨">ç†è§£HTTP è¯·æ±‚çš„æœ¬è´¨</a></li>
    <li><a href="#æ‰‹å†™æœ€ç®€ç‰ˆtomcat">æ‰‹å†™æœ€ç®€ç‰ˆTomcat</a>
      <ul>
        <li><a href="#å¦‚ä½•å‘èµ·httpè¯·æ±‚">å¦‚ä½•å‘èµ·HTTPè¯·æ±‚ï¼Ÿ</a></li>
        <li><a href="#å¦‚ä½•æ¥æ”¶å¹¶å¤„ç†http-è¯·æ±‚">å¦‚ä½•æ¥æ”¶å¹¶å¤„ç†HTTP è¯·æ±‚?</a></li>
      </ul>
    </li>
    <li><a href="#ä»€ä¹ˆæ˜¯servlet">ä»€ä¹ˆæ˜¯Servlet</a></li>
  </ul>

  <ul>
    <li><a href="#tomcatæ¶æ„">Tomcatæ¶æ„</a>
      <ul>
        <li><a href="#tomcat-çš„å¯åŠ¨è¿‡ç¨‹">Tomcat çš„å¯åŠ¨è¿‡ç¨‹</a></li>
      </ul>
    </li>
    <li><a href="#è¯·æ±‚æ¥æ”¶å’Œå¤„ç†">è¯·æ±‚æ¥æ”¶å’Œå¤„ç†</a>
      <ul>
        <li><a href="#connectorçš„åˆ›å»º">Connectorçš„åˆ›å»º</a></li>
        <li><a href="#ç›‘å¬ç½‘ç»œç«¯å£å’Œæ¥æ”¶è¿æ¥è¯·æ±‚">ç›‘å¬ç½‘ç»œç«¯å£å’Œæ¥æ”¶è¿æ¥è¯·æ±‚</a></li>
        <li><a href="#è§£æè¯·æ±‚æ•°æ®">è§£æè¯·æ±‚æ•°æ®</a></li>
        <li><a href="#å¤„ç†è¯·æ±‚">å¤„ç†è¯·æ±‚</a></li>
        <li><a href="#å°ç»“">å°ç»“</a></li>
      </ul>
    </li>
    <li><a href="#servlet-å’Œè¯·æ±‚çš„mapping">Servlet å’Œè¯·æ±‚çš„Mapping</a></li>
    <li><a href="#å“åº”è¿‡ç¨‹">å“åº”è¿‡ç¨‹</a></li>
    <li><a href="#pipeline-å’Œ-valve">Pipeline å’Œ Valve</a>
      <ul>
        <li><a href="#pipeline">Pipeline</a></li>
        <li><a href="#valve">Valve</a></li>
        <li><a href="#valveæ˜¯æ€ä¹ˆæ·»åŠ çš„">Valveæ˜¯æ€ä¹ˆæ·»åŠ çš„</a></li>
        <li><a href="#valve-ä»€ä¹ˆæ—¶å€™ä¼šè¿è¡Œ">Valve ä»€ä¹ˆæ—¶å€™ä¼šè¿è¡Œ</a></li>
      </ul>
    </li>
    <li><a href="#tomcatçš„ç±»åŠ è½½æœºåˆ¶">Tomcatçš„ç±»åŠ è½½æœºåˆ¶</a>
      <ul>
        <li><a href="#jdkç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾æ¨¡å‹">JDKç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾æ¨¡å‹</a></li>
        <li><a href="#tomcatçš„ç±»åŠ è½½å™¨">Tomcatçš„ç±»åŠ è½½å™¨</a></li>
        <li><a href="#tomcat-æ˜¯å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹çš„">Tomcat æ˜¯å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹çš„ï¼Ÿ</a></li>
      </ul>
    </li>
    <li><a href="#tomcat-å’Œspringboot">Tomcat å’ŒSpringboot</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">
                <img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/IMG_1890_hufea3e9ca65cfbc42e503dcb755cb462c_15847402_800x0_resize_box_3.png"
                        srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/IMG_1890_hufea3e9ca65cfbc42e503dcb755cb462c_15847402_800x0_resize_box_3.png 800w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/IMG_1890_hufea3e9ca65cfbc42e503dcb755cb462c_15847402_1600x0_resize_box_3.png 1600w"
                        width="800" 
                        height="450" 
                        loading="lazy"
                        alt="Featured image of post tomcatæ¶æ„åŸç†è§£æ" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/tomcat/" style="background-color: #2a9d8f; color: #fff;">
                tomcat
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">tomcatæ¶æ„åŸç†è§£æ</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 10, 2024</time>
            </div>
        

        
            <div>
                <svg t="1709719417939" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3290" width="200" height="200"><path d="M851.123506 952.605578V656.828685h71.394422v367.171315H1.52988V99.952191h469.163347v71.394423H72.924303v781.258964h778.199203zM922.007968 0.50996v272.318725h-71.394422V0.50996z" fill="#666666" p-id="3291"></path><path d="M750.151394 100.972112h272.318726v71.394422H750.151394z" fill="#666666" p-id="3292"></path><path d="M430.97753 618.252239c7.366884-7.595347 14.733769-11.39251 25.783586-18.988876 7.365865-7.595347 14.732749-11.39251 22.098613-18.988877 7.366884-3.797163 14.733769-11.39251 22.099634-18.987857 7.366884-7.595347 11.049817-15.190693 14.733768-22.786039 3.681912-7.596367 7.365865-18.988876 7.365865-34.17957 0-11.39251-3.682932-22.78604-7.365865-30.382406-3.683952-11.39251-11.049817-18.987857-18.416701-22.78502-7.366884-7.596367-14.732749-11.39353-25.783585-15.191714-11.048797-3.797163-18.415681-7.595347-29.465498-7.595346-14.732749 0-25.782566 3.798183-36.832383 7.595346-11.049817 3.798183-22.099633 11.39251-29.465498 22.78604-7.366884 7.595347-14.733769 18.988876-18.416701 30.382407-3.682932 11.39251-3.682932 15.190693-3.682932 30.381386h47.882199v-11.39251c0-7.596367 3.682932-11.39353 7.365864-18.988876 3.683952-3.798183 7.366884-11.39353 11.049817-15.191713 3.683952-3.797163 11.049817-3.797163 18.416701-3.797164 11.049817 0 18.415681 3.797163 25.783586 11.39251 7.365865 7.596367 11.048797 15.191713 11.048797 26.584223 0 7.595347 0 15.190693-3.682932 18.988877-3.683952 11.39251-11.049817 15.190693-14.733769 18.988876l-14.732749 15.190693c-7.365865 3.797163-14.732749 7.595347-18.415682 11.39251-11.049817 7.595347-22.099633 11.39353-29.465498 18.988877-11.050837 7.595347-18.416701 15.190693-25.783585 26.584223-7.366884 7.595347-11.049817 18.988876-14.732749 30.381386-3.683952 11.39251-7.366884 22.78604-7.366885 37.977753h176.796048v-45.573099H416.244781c3.682932-11.39251 7.366884-18.988876 14.732749-22.78604zM305.812908 690.972558V436.525896h-47.883219c0 7.595347-3.681912 18.988876-7.365864 26.584224l-14.733769 15.190693c-7.365865 3.797163-14.732749 7.595347-22.098614 7.595346-7.366884 0-11.049817 3.798183-18.416701 0v41.774917h62.614948v159.503299h47.882199v3.798183zM692.419825 690.972558c11.049817-3.798183 22.099633-7.595347 29.465498-15.190693 7.366884-7.595347 14.733769-15.190693 18.416701-26.584224 3.682932-11.39251 3.682932-22.78604 3.682932-37.976733 0-15.190693 0-22.78706-7.365864-34.179569-7.366884-11.39251-18.416701-15.190693-33.149451-18.988877 11.049817-3.797163 18.416701-11.39251 25.783586-18.988876 7.365865-7.595347 7.365865-18.987857 7.365865-30.381387 0-11.39251-3.682932-22.78604-7.366885-30.381386-3.682932-7.595347-11.049817-15.190693-18.415681-22.78604-7.366884-7.595347-14.733769-11.39251-25.783586-15.190693C674.004143 436.525896 666.637259 436.525896 655.587442 436.525896s-22.099633 3.798183-33.14945 7.595347c-11.049817 3.798183-18.416701 11.39251-25.783586 18.988877-7.365865 7.595347-14.731729 15.190693-18.415681 26.584223-3.682932 11.39251-7.365865 26.583203-7.365864 37.976733h47.882199c0-11.39251 3.682932-26.584223 7.365864-34.17957 7.366884-7.595347 14.733769-11.39251 29.465498-11.39251 7.367904 0 18.416701 3.797163 22.100654 7.595347 7.365865 3.797163 11.049817 15.190693 11.049816 22.78502 0 7.596367 0 11.39353-3.683952 15.191713l-11.049816 11.39251c-3.681912 3.798183-11.048797 3.798183-18.415682 3.798183h-18.416701v34.17957h22.099634c7.366884 0 11.049817 0 18.416701 3.797163 7.365865 3.798183 11.049817 7.595347 14.732749 11.39353 3.682932 3.798183 3.682932 11.39251 3.682932 22.78604 0 11.39251-3.681912 22.78604-11.049817 30.382406-7.365865 7.595347-18.415681 11.39251-29.465498 11.39251-7.366884 0-14.732749 0-18.416701-3.797163-3.682932-3.798183-11.049817-7.595347-14.732749-11.39353-3.682932-3.798183-7.366884-11.39251-7.366884-15.190693-3.681912-7.595347-3.681912-15.190693-3.681913-22.78604H563.505976c0 15.190693 0 30.381386 7.366885 41.774916 3.681912 11.39251 11.049817 18.987857 18.415681 26.583203 7.366884 7.595347 18.416701 15.190693 29.465498 18.988877 11.050837 3.798183 25.783586 3.798183 36.833402 3.798183 14.732749-3.798183 25.783586 0 36.832383-3.798183z" fill="#666666" p-id="3293"></path></svg>
                <time class="article-time--reading">
                    5270 words
                </time>

                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    25 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>Tomcatè‡ª1998å¹´é—®ä¸–ä»¥æ¥å› ä¸ºå…¶é«˜æ€§èƒ½ï¼Œå…è´¹ç­‰ç‰¹ç‚¹å¹¿å—Javaçˆ±å¥½è€…çš„å–œçˆ±ï¼Œä½†åœ¨Springbootç­‰å¾®æœåŠ¡æ¡†æ¶æˆä¸ºæŠ€æœ¯ä¸»æµåçš„ä»Šå¤©ï¼Œtomcatä¼¼ä¹é€æ¸&quot;æ¶ˆå¤±&quot;åœ¨å¤§ä¼—çš„è§†çº¿ä¸­ï¼Œä½ è¿˜åœ¨ç”¨tomcatå—ï¼Ÿæˆ‘ç›¸ä¿¡å¯¹äºå¤§éƒ¨åˆ†java web developeræ¥è¯´è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯Yes, å› ä¸ºSpringboot web starteré»˜è®¤é›†æˆçš„å°±æ˜¯tomcatã€‚</p>
<p>æœ¬æ–‡å°è¯•ä»&quot;ä¸ºä»€ä¹ˆæµè§ˆå™¨å‘å‡ºçš„HTTPè¯·æ±‚å¯ä»¥åˆ°è¾¾æˆ‘ä»¬çš„Controller&quot;è¿™ä¸€åŸºæœ¬é—®é¢˜å‡ºå‘ï¼Œç”±æµ…å…¥æ·±ï¼Œç”±ç‚¹åˆ°é¢çš„æ–¹å¼å…ˆä»æ•´ä½“çš„è§’åº¦æ¥æ¢³ç†tomcatçš„æ¶æ„åŸç†ï¼Œå†åˆ°ä»¥ä¸€ä¸ªHTTP/1.1 è¯·æ±‚ä¸ºä¾‹æ¥åˆ†ætomcatä½œä¸ºä¸€ä¸ªHTTP webæœåŠ¡å™¨å’ŒServletå®¹å™¨å®ƒæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæœ€åå›å½’è¿™ä¸ªé—®é¢˜æ¢³ç†springbootæ˜¯å¦‚ä½•ä¸tomcaté›†æˆçš„ã€‚å…¶ä¸­æ¶‰åŠå¤§é‡çš„æºç è§£æï¼Œè¯·ç•™æ„æ¶‰åŠæºç è§£æçš„éƒ¨åˆ†éƒ½æ˜¯åŸºäº<strong>tomcat 10.x</strong> æ¥è¿›è¡Œã€‚å¸Œæœ›èƒ½ç»™é‚£äº›å¯¹tomcatåŸç†æ„Ÿå…´è¶£çš„åŒå­¦æä¾›ä¸€äº›è§†è§’å’Œå‚è€ƒã€‚</p>
<h1 id="ä»€ä¹ˆæ˜¯tomcat">ä»€ä¹ˆæ˜¯Tomcat</h1>
<h2 id="tomcatçš„æ ¸å¿ƒåŠŸèƒ½">Tomcatçš„æ ¸å¿ƒåŠŸèƒ½</h2>
<p><strong>tomcatæ˜¯ä¸€ä¸ª==webåº”ç”¨æœåŠ¡å™¨==å’Œ==Servletå®¹å™¨==ï¼Œå®ƒè¿˜æ˜¯ Jakarta Servletã€Jakarta Server Pagesã€Jakarta Expression Languageã€Jakarta WebSocketã€Jakarta Annotations å’Œ Jakarta Authentication è§„èŒƒçš„å¼€æºå®ç°</strong>ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªé‡ç‚¹ï¼Œwebåº”ç”¨æœåŠ¡å™¨å’ŒServletå®¹å™¨ã€‚åˆ†åˆ«å¯¹åº”äº†å®ƒçš„ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š</p>
<blockquote>
<p>ä»€ä¹ˆæ˜¯WebæœåŠ¡å™¨, è¯´ç™½äº†ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å°†ä¸»æœºä¸Šçš„æŸä¸ªèµ„æºæ˜ å°„æˆä¸€ä¸ªURLä¾›å¤–ç•Œè®¿é—®ã€‚</p>
</blockquote>
<ul>
<li>å¤„ç† <code>Socket</code> è¿æ¥ï¼Œè´Ÿè´£ç½‘ç»œå­—èŠ‚æµä¸ <code>Request</code> å’Œ <code>Response</code> å¯¹è±¡çš„è½¬åŒ–ã€‚</li>
<li>åŠ è½½å¹¶ç®¡ç† <code>Servlet</code> ï¼Œå¹¶å°†è¯·æ±‚äº¤ç»™Servletå¤„ç†ã€‚</li>
</ul>
<p>ä½†<code>webæœåŠ¡å™¨</code> å’Œ<code>servletå®¹å™¨</code>ä¾æ—§æ˜¾çš„æœ‰äº›æŠ½è±¡ï¼Œä»–ä»¬åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ç†è§£ä»€ä¹ˆæ˜¯tomcat å°±æ˜¯ç†è§£tomcatåˆ°åº•å¸®æˆ‘ä»¬åšäº†ä»€ä¹ˆã€‚æˆ‘ä»¬åœ¨ä¸Šæ‰‹åšJava webé¡¹ç›®æ—¶å¾€å¾€éƒ½æ˜¯åŸºäºæ¡†æ¶æ¯”å¦‚springboot,æ¥ä¸“æ³¨äºä¸šåŠ¡ä»£ç å¼€å‘ï¼Œæˆ‘ä»¬çŸ¥é“æŒ‰ç…§springboot çš„è§„åˆ™æ¥å®šä¹‰ä¸€äº›controller, å°±å¯ä»¥æ¥æ”¶åˆ°ä»æµè§ˆå™¨å‘è¿‡æ¥çš„HTTPè¯·æ±‚ã€‚</p>
<p>ä½†æ˜¯ï¼Œ==<strong>ä¸ºä»€ä¹ˆcontrollerå¯ä»¥æ”¶åˆ°å¹¶å¤„ç†å®¢æˆ·ç«¯å‘è¿‡æ¥çš„è¯·æ±‚</strong>==?</p>
<p>ç­”æ¡ˆæ˜¯å› ä¸ºgradle æˆ–è€…maven ä¸­æœ‰<code>spring-boot-starter-web</code> è¿™ä¸ªä¾èµ–ï¼Œè€Œè¿™ä¸ªä¾èµ–é»˜è®¤å¸®æˆ‘ä»¬é›†æˆäº†Tomcatã€‚åœ¨è¿›ä¸€æ­¥ç†è§£tomcatæ˜¯æ€ä¹ˆå¸®æˆ‘æ¥æ”¶å¹¶è§£æHTTPè¯·æ±‚ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè®¾æƒ³ï¼Œå¦‚æœæ²¡æœ‰æ¡†æ¶ï¼Œç«™åœ¨tomcatå¼€å‘è€…çš„è§’åº¦æ¥æ€è€ƒæˆ‘ä»¬è¦è‡ªå·±å®ç°ä¸‹é¢è¿™æ ·çš„åŠŸèƒ½åº”è¯¥è¦æ€ä¹ˆåšã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gherkin" data-lang="gherkin"><span class="line"><span class="cl"><span class="k">Scenario:</span><span class="nf"> Receive and Process HTTP Request
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">
</span></span></span><span class="line"><span class="cl"><span class="k">Given </span><span class="nf">the system is running
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">When </span><span class="nf">a valid HTTP request is received
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">Then </span><span class="nf">the system should successfully parse the HTTP request
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">And </span><span class="nf">extract the request path, parameters, method, and body if present
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">And </span><span class="nf">generate an appropriate HTTP response
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">And </span><span class="nf">include the correct HTTP status code indicating successful processing
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">And </span><span class="nf">include the expected response body format and data if applicable
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">And </span><span class="nf">include the appropriate HTTP headers in the response (e.g., Content-Type)
</span></span></span></code></pre></div><h2 id="ç†è§£http-è¯·æ±‚çš„æœ¬è´¨">ç†è§£HTTP è¯·æ±‚çš„æœ¬è´¨</h2>
<p>HTTPè¯·æ±‚æ˜¯å®¢æˆ·ç«¯åœ¨å‘æœåŠ¡ç«¯è¯·æ±‚æŸä¸ªèµ„æºæ—¶ï¼Œå‘æœåŠ¡ç«¯å‘é€çš„ç¬¦åˆHTTPåè®®è§„èŒƒçš„æ•°æ®ï¼Œä¸‹é¢ç»™å‡ºä¸€ä¸ªå®Œæ•´çš„GET è¯·æ±‚ç¤ºä¾‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">GET /sample HTTP/1.1 
</span></span><span class="line"><span class="cl">Host: www.example.com
</span></span><span class="line"><span class="cl">Accept: application/json
</span></span></code></pre></div><h2 id="æ‰‹å†™æœ€ç®€ç‰ˆtomcat">æ‰‹å†™æœ€ç®€ç‰ˆTomcat</h2>
<h3 id="å¦‚ä½•å‘èµ·httpè¯·æ±‚">å¦‚ä½•å‘èµ·HTTPè¯·æ±‚ï¼Ÿ</h3>
<p>å‘èµ·HTTPè¯·æ±‚å…¶å®å°±æ„å‘³ç€æˆ‘ä»¬è¦æŠŠè¿™éƒ¨åˆ†æ•°æ®å‘é€ç»™æœåŠ¡ç«¯ã€‚</p>
<p>é‚£æˆ‘ä»¬è¦æ€ä¹ˆæŠŠè¿™éƒ¨åˆ†æ•°æ®å‘é€ç»™æœåŠ¡å™¨å‘¢ï¼Ÿè¿™å…¶å®æ¶‰åŠè®¡ç®—æœºç½‘ç»œçš„åŸºç¡€ï¼Œè®¡ç®—æœºä¹‹é—´æ˜¯å¦‚ä½•é€šä¿¡çš„ã€‚</p>
<p>å‡è®¾æœ‰ä¸€ä¸ªä¸»æœºAï¼Œæœ‰ä¸€ä¸ªä¸»æœºBï¼ŒAéœ€è¦é€šè¿‡æµè§ˆå™¨å‘é€HTTPè¯·æ±‚ç»™Bçš„Java è¿›ç¨‹ã€‚é‚£ä¹ˆç»å†å¦‚ä¸‹æ­¥éª¤ï¼š</p>
<p>1.<strong>HTTP æ˜¯åº”ç”¨å±‚åè®®ï¼Œåœ¨å‘é€æ•°æ®ä¹‹å‰ï¼ŒAä¸­çš„æµè§ˆå™¨éœ€è¦å’ŒBä¸­çš„Java è¿›ç¨‹å»ºç«‹ä¸€ä¸ªTCP é“¾æ¥ã€‚</strong></p>
<p>é‚£æˆ‘ä»¬å¦‚ä½•å»ºç«‹TCP é“¾æ¥å‘¢ï¼Œå…¶å®è¿™éƒ¨åˆ†å·¥ä½œæ˜¯ç”±åº”ç”¨å±‚çš„åº•å±‚åº“å»å¸®æˆ‘ä»¬æ¥åšçš„ã€‚ä»¥Java ä¸ºä¾‹ï¼Œè¿™ä¸ªç±»åº“å°±å«åšSocketã€‚å®ƒä¹Ÿæ˜¯åœ¨ç½‘ç»œé€šä¿¡ä¸­çš„ä¸€ä¸ªç§æŠ½è±¡æ¦‚å¿µï¼Œä»Javaçš„è§’åº¦æ¥ç†è§£å»ºç«‹ä¸€ä¸ªTCP é“¾æ¥å…¶å®å°±æ˜¯ç”Ÿæˆäº†ä¸€ä¸ªSocket å¯¹è±¡ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå»ºç«‹TCPé“¾æ¥ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">val</span> <span class="py">socket</span> <span class="p">=</span> <span class="n">Socket</span><span class="p">(</span><span class="s2">&#34;google.com&#34;</span><span class="p">,</span> <span class="m">443</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">println</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">isConnected</span><span class="p">)</span>
</span></span></code></pre></div><p>å½“ä¸Šè¿°ä»£ç è¾“å‡º<code>true</code> å°±è¡¨æ˜å·²ç»å»ºç«‹äº†é“¾æ¥ï¼Œè¿™åº•å±‚ç”±JDK è°ƒç”¨æ“ä½œç³»ç»ŸAPI æ¥å®ç°ã€‚</p>
<p>2.<strong>é“¾æ¥å»ºç«‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æµå¼çš„ä¼ è¾“æ•°æ®ï¼Œå‘èµ·HTTPè¯·æ±‚å…¶å®å°±æ˜¯å‘ä¸€ä¸ªåœ°æ–¹å»å†™ç¬¦åˆHTTPè§„èŒƒæ•°æ®</strong>ã€‚</p>
<p>å‘å“ªé‡Œå†™ï¼Ÿä¾æ—§ä»¥Java ä¸ºä¾‹ï¼Œä¸Šé¢è¯´åˆ°åœ¨ç½‘ç»œä¸­çš„é€šä¿¡æˆ‘ä»¬æœ‰ä¸ªæŠ½è±¡çš„ä¸œè¥¿å«Socket, è€ŒJDK ç±»åº“å¸®æˆ‘ä»¬åšäº†åº•å±‚å®ç°ï¼Œå› æ­¤æˆ‘ä»¬å†™æ•°æ®è¯»æ•°æ®è¿˜æ˜¯é¢å‘Socketã€‚ä¸‹é¢æ˜¯å‘socket æ•°æ®çš„ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="err">#</span> <span class="n">å†™å…¥ä¸€ä¸ªå­—èŠ‚æ•°ç»„</span>
</span></span><span class="line"><span class="cl"><span class="n">socket</span><span class="p">.</span><span class="n">getOutputStream</span><span class="p">().</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;Ping!&#34;</span><span class="p">.</span><span class="n">toByteArray</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="err">#</span><span class="n">ä¹Ÿå¯ä»¥å†™å…¥å•ä¸ªå­—èŠ‚</span>
</span></span><span class="line"><span class="cl"><span class="n">socket</span><span class="p">.</span><span class="n">getOutputStream</span><span class="p">().</span><span class="n">write</span><span class="p">(</span><span class="m">71</span><span class="p">)</span>
</span></span></code></pre></div><blockquote>
<p>è¿™é‡Œçš„byte,71æ ¹æ®å­—ç¬¦ç¼–ç å¯ä»¥è§£ææˆå¯¹åº”çš„å­—ç¬¦ï¼Œ71é€šå¸¸å¯¹åº”çš„æ˜¯å­—æ¯G,  å…³äºå­—ç¬¦ç¼–ç è¯·å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡ç¬”è®°ï¼š<a class="link" href="https://woaihuangfan.github.io/posts/ascii-unicode-and-charset/"  target="_blank" rel="noopener"
    >ASCIIã€Unicodeå’ŒUTF-8ä¸å­—ç¬¦ç¼–ç </a></p>
</blockquote>
<p>3.<strong>æˆ‘ä»¬å‘Socketå†™å…¥æ•°æ®åï¼Œå‰©ä¸‹çš„ä¹Ÿä¼šç”±jvmå’Œæ“ä½œç³»ç»Ÿå¸®æˆ‘ä»¬å¤„ç†ï¼Œé€šè¿‡é€šä¿¡ç½‘ç»œä¼ è¾“åˆ°ä¸»æœºBä¸Š</strong>ã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†å®¢æˆ·ç«¯å‘èµ·ä¸€ä¸ªHTTPè¯·æ±‚çš„æ—¶å€™å¹²äº†ä»€ä¹ˆï¼Œä¸åŒçš„åº”ç”¨ç¨‹åºåº•å±‚å¯¹äºSocketå¯èƒ½æœ‰ä¸åŒå®ç°, ä½†è¿™éƒ¨åˆ†åº•å±‚ç»†èŠ‚å…¶å®å¾€å¾€ä¸ç”¨æˆ‘ä»¬æ“å¿ƒï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“å‘èµ·HTTPè¯·æ±‚å°±æ˜¯å‘é€äº†ä¸€æ®µç¬¦åˆHTTPåè®®è§„èŒƒçš„æ•°æ®åˆ°æœåŠ¡ç«¯ã€‚å…³äºæ›´å¤šHTTP åè®®çš„å†…å®¹è¯·å‚é˜…ç›¸å…³æ–‡æ¡£ã€‚</p>
<h3 id="å¦‚ä½•æ¥æ”¶å¹¶å¤„ç†http-è¯·æ±‚">å¦‚ä½•æ¥æ”¶å¹¶å¤„ç†HTTP è¯·æ±‚?</h3>
<h4 id="ç«¯å£ç›‘å¬">ç«¯å£ç›‘å¬</h4>
<p>ä¸Šé¢è¯´åˆ°å‘èµ·HTTP è¯·æ±‚å…¶å®å°±æ˜¯å‘é€ä¸€æ®µæ•°æ®ç»™æœåŠ¡ç«¯ï¼Œé‚£ä¸ºä»€ä¹ˆå¯ä»¥å‘é€æ•°æ®å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬åœ¨å‘é€æ•°æ®ä¹‹å‰å»ºç«‹äº†TCP é“¾æ¥ï¼Œè€ŒTCP æ˜¯ä¸€ç§é¢å‘é“¾æ¥çš„å¯é çš„åè®®ï¼Œé‚£ä¸ºä»€ä¹ˆå¯ä»¥å»ºç«‹TCPé“¾æ¥ï¼Ÿ<code>Socket(&quot;google.com&quot;, 443)</code> è¿™æ®µä»£ç ä¸­çš„ä¸¤ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆå«ä¹‰ï¼Ÿ</p>
<p>åŸŸåä¼šè¢«DNSæœåŠ¡å™¨è§£ææˆip, ç”¨æ¥åœ¨ç½‘ç»œä¼ è¾“ä¸­æ‰¾åˆ°å¯¹åº”çš„ä¸»æœºï¼Œè€Œ443åˆ™è¡¨ç¤ºæœåŠ¡å™¨æ­£åœ¨ç›‘å¬çš„ç«¯å£ï¼Œ æ³¨æ„ä¸€ä¸ªè¿›ç¨‹å¯èƒ½ä¼šç”¨åˆ°å¤šä¸ªç«¯å£ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬çœ‹æ€ä¹ˆåœ¨Java ä¸­å¼€å¯è¿™æ ·çš„ç«¯å£ç›‘å¬ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">val</span> <span class="py">serverSocket</span> <span class="p">=</span> <span class="n">ServerSocket</span><span class="p">(</span><span class="m">8080</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">println</span><span class="p">(</span><span class="s2">&#34;Server started successfully, listening on port: 8080&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>æˆ‘ä»¬ç”¨åˆ°äº†<code>ServerSocket</code>è¿™ä¸ªç±»ï¼Œå®ƒæä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œä½¿å¾—Javaåº”ç”¨ç¨‹åºèƒ½å¤Ÿç›‘å¬å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶åœ¨è¿æ¥å»ºç«‹åè¿›è¡Œé€šä¿¡ã€‚è€Œè¿™åº•å±‚ä¹Ÿæ˜¯æœ‰JDKè°ƒç”¨æ“ä½œç³»ç»ŸAPI å®ç°ã€‚</p>
<p>1.å®ƒå»ºç«‹äº†ä¸€ä¸ªä¸“é—¨ä¾¦å¬æŸç«¯å£çš„socket</p>
<p>2.æ¯æ¬¡æˆåŠŸä¸å®¢æˆ·ç«¯æ¡æ‰‹å,ä¼šåˆ›å»ºä¸€ä¸ªé’ˆå¯¹å½“å‰å®¢æˆ·çš„æ–°socket</p>
<p>3.åç»­ç¨‹åºé€šè¿‡è¿™ä¸ªsocketä¸å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®äº¤äº’</p>
<h4 id="è¯»å–æ•°æ®å¹¶è§£ææˆhttp-è¯·æ±‚">è¯»å–æ•°æ®å¹¶è§£ææˆHTTP è¯·æ±‚</h4>
<p>å†æ¬¡è¯´åˆ°å‘èµ·ä¸€ä¸ªHTTPè¯·æ±‚å°±æ˜¯å‘é€äº†ä¸€æ®µæ•°æ®ç»™æœåŠ¡å™¨ï¼Œæˆ‘ä»¬çœ‹æ€ä¹ˆæ ·è¯»å–è¿™ä»½æ•°æ®ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="err">#</span> <span class="n">å»ºç«‹ServerSocketåè°ƒç”¨accept</span> <span class="n">æ–¹æ³•æ¥æ¥æ”¶è¯·æ±‚</span><span class="err">ï¼Œ</span><span class="n">åœ¨æœ‰è¯·æ±‚åˆ°æ¥ä¹‹å‰è¿™ä¸ªæ–¹æ³•ä¼šä¸€ç›´é˜»å¡</span><span class="err">ï¼Œ</span><span class="n">å¹¶ä¸”ä¸ºäº†å¤„ç†å¤šæ¬¡è¯·æ±‚</span><span class="err">ï¼Œ</span><span class="n">ä¸€èˆ¬ä¼šå¾ªç¯è°ƒç”¨</span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">socket</span> <span class="p">=</span> <span class="n">serverSocket</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="n">ä¸Šè¿°æ–¹æ³•è¿”å›äº†Socket</span><span class="p">,</span> <span class="n">è¿™å’Œæˆ‘ä»¬ä»å®¢æˆ·ç«¯å»ºç«‹é“¾æ¥æ—¶çœ‹åˆ°çš„Socket</span> <span class="n">æ˜¯ä¸€æ ·çš„</span><span class="err">ï¼Œ</span><span class="n">å› ä¸ºè¯´äº†</span><span class="err">ï¼Œ</span><span class="n">ç½‘ç»œä¸Šçš„é€šä¿¡æˆ‘ä»¬éƒ½æ˜¯é¢å‘Socket</span>
</span></span><span class="line"><span class="cl"><span class="k">val</span> <span class="py">bytes</span> <span class="p">=</span> <span class="n">socket</span><span class="p">.</span><span class="n">getInputStream</span><span class="p">().</span><span class="n">let</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">bytes</span> <span class="p">=</span> <span class="n">ByteArray</span><span class="p">(</span><span class="k">it</span><span class="p">.</span><span class="n">available</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">it</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">bytes</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">println</span><span class="p">(</span><span class="n">bytes</span><span class="p">.</span><span class="n">decodeToString</span><span class="p">())</span>
</span></span></code></pre></div><p>åœ¨10è¡Œè¿è¡Œå®Œåæˆ‘ä»¬å¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„è¾“å‡ºï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">GET /sample HTTP/1.1 
</span></span><span class="line"><span class="cl">Host: www.example.com
</span></span><span class="line"><span class="cl">Accept: application/json
</span></span></code></pre></div><p>è¿™æ­£æ˜¯æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯å‘èµ·çš„HTTP è¯·æ±‚ï¼</p>
<p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥å»è§£æè¿™æ®µæ–‡æœ¬ï¼ŒåŒ…æ‹¬å»è§£æè¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´ï¼Œè¯·æ±‚ä½“ç­‰åŸºäºå­—ç¬¦ä¸²æ“ä½œå»è¿›è¡Œå…·ä½“çš„ä¸šåŠ¡å¤„ç†ã€‚</p>
<h4 id="å¦‚ä½•å“åº”">å¦‚ä½•å“åº”</h4>
<p>å“åº”æ˜¯ç”±æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å“åº”ï¼Œå“åº”å°±æ˜¯å›ä¼ æ»¡è¶³HTTP åè®®çš„è§„èŒƒæ•°æ®ï¼ŒåŒæ ·æ˜¯é¢å¯¹socket å¯¹è±¡è¿›è¡Œï¼ŒJDK å’Œæ“ä½œç³»ç»Ÿä¼šå¸®æˆ‘ä»¬å¤„ç†åº•å±‚å’Œå‰©ä¸‹çš„äº‹ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">socket</span><span class="p">.</span><span class="n">getOutputStream</span><span class="p">().</span><span class="n">write</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="s2">&#34;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s2">&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Content-Type: text/plain</span><span class="se">\r\n</span><span class="s2">&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Content-Length: 25</span><span class="se">\r\n</span><span class="s2">&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span> <span class="p">+</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Hello, World and /sample!&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">).</span><span class="n">toByteArray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¿™ä»½æ•°æ®åä¾¿å¯ä»¥æ ¹æ®æ ¹æ®HTTP åè®®è§£ææ•°æ®ç„¶åä½œå¯¹åº”å¤„ç†ã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯è‡ªå·±å»å®ç°è¿™ä¸ªéœ€æ±‚è¦åšçš„äº‹ï¼Œç„¶è€Œæˆ‘ä»¬å¹³æ—¶åœ¨ä½¿ç”¨springbootå¼€å‘æ—¶å‡ ä¹ä¸éœ€è¦å…³å¿ƒè¿™äº›ï¼Œå› ä¸ºé›†æˆçš„tomcatä¼šå¸®æˆ‘ä»¬å¤„ç†ï¼Œè¿™æ­£æ˜¯Tomcat çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼š</p>
<p>==<strong>å¤„ç† <code>Socket</code> è¿æ¥ï¼Œè´Ÿè´£ç½‘ç»œå­—èŠ‚æµä¸ <code>Request</code> å’Œ <code>Response</code> å¯¹è±¡çš„è½¬åŒ–</strong>==ã€‚</p>
<h4 id="æœ€ç®€ç‰ˆtomcat">æœ€ç®€ç‰ˆ<strong>Tomcat</strong></h4>
<p>å°†ä»¥ä¸Šæ­¥éª¤å†ä¸²èµ·æ¥æˆ‘ä»¬å°±å¯ä»¥è‡ªå·±å»å®ç°tomcatï¼Œ æ³¨æ„ï¼ŒçœŸæ­£çš„tomcatå®ç°å’ŒåŠŸèƒ½è¦æ¯”è¿™ä¸ªå¤æ‚çš„å¤šï¼Œä½†ç†è§£è¿™éƒ¨åˆ†å†…å®¹å¯¹äºæˆ‘ä»¬ç†è§£ä»€ä¹ˆæ˜¯Tomcatå¾ˆé‡è¦ï¼Œå› ä¸º<strong>tomcatåœ¨åšç€ç±»ä¼¼çš„äº‹æƒ…</strong>ã€‚</p>
<p><strong>æµ‹è¯•å…ˆè¡Œ</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`should successfully process valid HTTP request`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Given
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">MyHttpServer</span><span class="p">(</span><span class="n">TEST_PORT</span><span class="p">).</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// When
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å‘èµ·HTTP è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">val</span> <span class="py">socket</span> <span class="p">=</span> <span class="n">sendRequest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Then
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">assertEquals</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s2">Content-Type: text/plain</span><span class="se">\r\n</span><span class="s2">&#34;</span> <span class="p">+</span> <span class="s2">&#34;Content-Length: 25</span><span class="se">\r\n\r\n</span><span class="s2">Hello, World and /sample!&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">decodeResponse</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1.å»ºç«‹socketè¿æ¥
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2.å‘socketä¸­å†™å…¥ç¬¦åˆHTTPè§„èŒƒçš„æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 3.è¿”å›socket
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">sendRequest</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">httpRequest</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s2">&#34;GET /sample HTTP/1.1</span><span class="se">\r\n</span><span class="s2">&#34;</span> <span class="p">+</span> <span class="s2">&#34;Host: localhost</span><span class="se">\r\n</span><span class="s2">&#34;</span> <span class="p">+</span> <span class="s2">&#34;Accept: application/json</span><span class="se">\r\n\r\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">):</span> <span class="n">Socket</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">socket</span> <span class="p">=</span> <span class="n">Socket</span><span class="p">(</span><span class="nc">Constants</span><span class="p">.</span><span class="n">LOCAL_HOST</span><span class="p">,</span> <span class="nc">Constants</span><span class="p">.</span><span class="n">TEST_PORT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">socket</span><span class="p">.</span><span class="n">getOutputStream</span><span class="p">().</span><span class="n">write</span><span class="p">(</span><span class="n">httpRequest</span><span class="p">.</span><span class="n">toByteArray</span><span class="p">(</span><span class="nc">Charset</span><span class="p">.</span><span class="n">defaultCharset</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">socket</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>SampleHttpServerç±»</strong></p>
<ul>
<li>è´Ÿè´£åˆ›å»ºServerSocketç›‘å¬ç«¯å£</li>
<li>æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä»Socket ä¸­è¯»å–æ•°æ®è§£ææˆRequestå¯¹è±¡</li>
<li>æ„å»ºResponse å¯¹è±¡å¹¶å‘Socketä¸­å†™å…¥æ•°æ®</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">package</span> <span class="nn">com.fan</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">java.net.ServerSocket</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">java.net.Socket</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">java.net.SocketException</span>
</span></span><span class="line"><span class="cl"><span class="k">import</span> <span class="nn">java.nio.charset.StandardCharsets</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SampleHttpServer</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">port</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">lateinit</span> <span class="k">var</span> <span class="py">serverSocket</span><span class="p">:</span> <span class="n">ServerSocket</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">var</span> <span class="py">isRunning</span> <span class="p">=</span> <span class="k">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">createServerSocket</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">${currentThreadName()}</span><span class="s2">Server started successfully, listening on port </span><span class="si">$port</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">val</span> <span class="py">clientSocket</span> <span class="p">=</span> <span class="n">acceptClientConnection</span><span class="p">(</span><span class="n">serverSocket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">clientSocket</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">handleClientRequest</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">closeSocket</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">closeSocket</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">:</span> <span class="n">Socket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">checkIfSocketClosed</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="n">clientSocket</span><span class="p">.</span><span class="n">isClosed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">clientSocket</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">checkIfSocketClosed</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">checkIfSocketClosed</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">:</span> <span class="n">Socket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">${currentThreadName()}</span><span class="s2">client socket closed? </span><span class="si">${clientSocket.isClosed}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">createServerSocket</span><span class="p">(</span><span class="n">port</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="n">serverSocket</span> <span class="p">=</span> <span class="n">ServerSocket</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">acceptClientConnection</span><span class="p">(</span><span class="n">serverSocket</span><span class="p">:</span> <span class="n">ServerSocket</span><span class="p">):</span> <span class="n">Socket</span><span class="p">?</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">clientSocket</span> <span class="p">=</span> <span class="n">serverSocket</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">${currentThreadName()}</span><span class="s2">Accepted client connection from: </span><span class="si">${clientSocket.inetAddress}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">clientSocket</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">SocketException</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//socket maybe closed from client, ignore
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">${currentThreadName()}</span><span class="s2"> </span><span class="si">${e.message}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">null</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">handleClientRequest</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">:</span> <span class="n">Socket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">requestBytes</span> <span class="p">=</span> <span class="n">readBytesFromSocketInputStream</span><span class="p">(</span><span class="n">clientSocket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">${currentThreadName()}</span><span class="s2">Received bytes from client:</span><span class="si">${requestBytes.contentToString()}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">httpRequest</span> <span class="p">=</span> <span class="n">parseBytesToHttpRequest</span><span class="p">(</span><span class="n">requestBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">httpResponse</span> <span class="p">=</span> <span class="n">buildResponse</span><span class="p">(</span><span class="n">httpRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sendResponseToClient</span><span class="p">(</span><span class="n">httpResponse</span><span class="p">,</span> <span class="n">clientSocket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">readBytesFromSocketInputStream</span><span class="p">(</span><span class="n">socket</span><span class="p">:</span> <span class="n">Socket</span><span class="p">):</span> <span class="n">ByteArray</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">socket</span><span class="p">.</span><span class="n">getInputStream</span><span class="p">().</span><span class="n">let</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">bytes</span> <span class="p">=</span> <span class="n">ByteArray</span><span class="p">(</span><span class="k">it</span><span class="p">.</span><span class="n">available</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="k">it</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">bytes</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">parseBytesToHttpRequest</span><span class="p">(</span><span class="n">bytes</span><span class="p">:</span> <span class="n">ByteArray</span><span class="p">):</span> <span class="n">Request</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">plainRequest</span> <span class="p">=</span> <span class="n">String</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span> <span class="nc">StandardCharsets</span><span class="p">.</span><span class="n">UTF_8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">${currentThreadName()}</span><span class="s2">Received request:</span><span class="se">\r\n</span><span class="s2">--------------</span><span class="se">\r\n</span><span class="si">$plainRequest</span><span class="se">\r\n</span><span class="s2">--------------&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">httpMethod</span> <span class="p">=</span> <span class="n">extractHttpMethod</span><span class="p">(</span><span class="n">plainRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">uri</span> <span class="p">=</span> <span class="n">extractUri</span><span class="p">(</span><span class="n">plainRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">protocol</span> <span class="p">=</span> <span class="n">extractProtocol</span><span class="p">(</span><span class="n">plainRequest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Request</span><span class="p">(</span><span class="n">httpMethod</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">uri</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">extractHttpMethod</span><span class="p">(</span><span class="n">plainRequest</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">String</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">plainRequest</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="n">plainRequest</span><span class="p">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">extractUri</span><span class="p">(</span><span class="n">plainRequest</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">String</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">start</span> <span class="p">=</span> <span class="n">plainRequest</span><span class="p">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">)</span> <span class="p">+</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">end</span> <span class="p">=</span> <span class="n">plainRequest</span><span class="p">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s2">&#34;HTTP&#34;</span><span class="p">)</span> <span class="p">-</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">plainRequest</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">extractProtocol</span><span class="p">(</span><span class="n">plainRequest</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">String</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">start</span> <span class="p">=</span> <span class="n">plainRequest</span><span class="p">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s2">&#34;HTTP&#34;</span><span class="p">)</span> <span class="p">+</span> <span class="m">5</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">end</span> <span class="p">=</span> <span class="n">plainRequest</span><span class="p">.</span><span class="n">indexOf</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">plainRequest</span><span class="p">.</span><span class="n">substring</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">buildResponse</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span> <span class="n">Response</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">body</span> <span class="p">=</span> <span class="s2">&#34;Hello, World and </span><span class="si">${request.uri}</span><span class="s2">!&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">statusLine</span> <span class="p">=</span> <span class="s2">&#34;HTTP/1.1 200 OK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">headers</span> <span class="p">=</span> <span class="s2">&#34;Content-Type: text/plain</span><span class="se">\r\n</span><span class="s2">Content-Length: </span><span class="si">${body.length}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">body</span> <span class="p">=</span> <span class="n">body</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">sendResponseToClient</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span> <span class="n">socket</span><span class="p">:</span> <span class="n">Socket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">responseBytes</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">toString</span><span class="p">().</span><span class="n">toByteArray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">socket</span><span class="p">.</span><span class="n">getOutputStream</span><span class="p">().</span><span class="n">write</span><span class="p">(</span><span class="n">responseBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">${currentThreadName()}</span><span class="s2">Response sent to client.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">fun</span> <span class="nf">currentThreadName</span><span class="p">()</span> <span class="p">=</span> <span class="s2">&#34;[</span><span class="si">${Thread.currentThread().name}</span><span class="s2">] &#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">stop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">isRunning</span> <span class="p">=</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">::</span><span class="n">serverSocket</span><span class="p">.</span><span class="n">isInitialized</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">serverSocket</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><strong>Request å’Œ Response</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">package</span> <span class="nn">com.fan</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">data</span> <span class="k">class</span> <span class="nc">Request</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">method</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">protocol</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">uri</span><span class="p">:</span> <span class="n">String</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">data</span> <span class="k">class</span> <span class="nc">Response</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">statusLine</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">headers</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">body</span><span class="p">:</span> <span class="n">String</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">fun</span> <span class="nf">toString</span><span class="p">():</span> <span class="n">String</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">statusLine</span> <span class="p">+</span> <span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span> <span class="p">+</span> <span class="n">headers</span> <span class="p">+</span> <span class="s2">&#34;</span><span class="se">\r\n\r\n</span><span class="s2">&#34;</span> <span class="p">+</span> <span class="n">body</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>æºç åœ°å€: <a class="link" href="https://github.com/woaihuangfan/how-tomcat-works.git"  target="_blank" rel="noopener"
    >https://github.com/woaihuangfan/how-tomcat-works.git</a></p>
</blockquote>
<p>è¿™æ˜¯é‡‡ç”¨å¤§éƒ¨åˆ†äººè¾ƒä¸ºç†Ÿæ‚‰BIOçš„çš„å®ç°æ–¹å¼ï¼Œè€Œä»tomcat 8.0å¼€å§‹ä¼šé»˜è®¤ä½¿ç”¨NIOçš„æ–¹å¼æ¥å¤„ç†è¯·æ±‚ï¼Œå…³äºNIOçš„demoè¯·åœ¨æºç ä¸­å¯»æ‰¾<code>NioHttpServer</code>ã€‚</p>
<h2 id="ä»€ä¹ˆæ˜¯servlet">ä»€ä¹ˆæ˜¯Servlet</h2>
<p>webå¼€å‘ï¼Œæˆ‘ä»¬å…¶å®ä¸»è¦å¤„ç†ä¸‰ä»¶äº‹ï¼š</p>
<ol>
<li>æ¥æ”¶è¯·æ±‚ï¼š ä»socket ä¸­è¯»å–æ•°æ®</li>
<li>å¤„ç†è¯·æ±‚ï¼šå…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚é’ˆå¯¹æ•°æ®åº“çš„curd</li>
<li>å“åº”: å‘socket ä¸­å†™å…¥æ•°æ®</li>
</ol>
<p>#1å’Œ#3æ“ä½œæ˜¯åŸºç¡€æ“ä½œï¼Œå¤§å®¶éƒ½è¦å¹²è¿™äº‹ä¸”å¹²çš„æ–¹å¼åŸºæœ¬éƒ½ä¸€æ ·ï¼Œæ— éå°±æ˜¯é’ˆå¯¹socketçš„ç½‘ç»œç¼–ç¨‹ï¼Œä½†æ˜¯å¤„ç†è¯·æ±‚çš„éƒ¨åˆ†æ˜¯ä¸åŒçš„ï¼Œå› ä¸ºä¸šåŠ¡é€»è¾‘åƒå·®ä¸‡åˆ«ä¸‡åˆ«ã€‚</p>
<p>#1ä¸­è¯»å–åˆ°æ•°æ®åï¼Œéœ€è¦äº¤ç»™ä¸€ä¸ªä¸œè¥¿(å¯¹è±¡)è®©2#æ¥å¤„ç†è¯·æ±‚ï¼Œè¿™ä¸ªä¸œè¥¿å¤„ç†å®Œè¯·æ±‚åè¿˜è¦ç”Ÿæˆå“åº”äº¤ç»™#3ï¼Œ æˆ‘ä»¬æŠŠè¿™ä¸ªä¸œè¥¿(å¯¹è±¡) å«<strong>Servlet</strong>ã€‚Servlet å°±æ˜¯#1 å’Œ#2ï¼Œ #2å’Œ#3ä¹‹é—´çš„è¿™ä¸ªä¸­é—´å±‚ã€‚</p>
<blockquote>
<p>ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜æ˜¯ï¼Œå¤„ç†è¯·æ±‚æ—¶åªèƒ½ç”¨ä¸€ä¸ªå¯¹è±¡å—ï¼Ÿå½“ç„¶ä¸æ˜¯ï¼Œæˆ‘ä»¬å¤„ç†è¯·æ±‚å¯èƒ½éœ€è¦ç”¨åˆ°å¤šä¸ªå¯¹è±¡ï¼ˆæ¯”å¦‚controllerï¼Œservice),  ä½†è¿™äº›controller service å¯¹è±¡èƒ½å«servletå—ï¼Ÿã€‚</p>
</blockquote>
<p>æ‰€ä»¥è¿™ä¸‰ä»¶äº‹å†å…·ä½“ä¸€ç‚¹æ€»ç»“ä¸‹å°±æ˜¯ï¼š</p>
<ol>
<li>æ¥æ”¶è¯·æ±‚ï¼š ä»socket ä¸­è¯»å–æ•°æ®ï¼Œ ==å¹¶æŠŠæ•°æ®äº¤ç»™Servlet==</li>
<li>å¤„ç†è¯·æ±‚ï¼šServletå¤„ç†å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚é’ˆå¯¹æ•°æ®åº“çš„curdï¼Œç„¶åç”Ÿæˆå“åº”</li>
<li>å“åº”: è·å–Servletç”Ÿæˆçš„å“åº”å¹¶å‘socket ä¸­å†™å…¥æ•°æ®</li>
</ol>
<p>1å’Œ3çš„æ“ä½œå¤§å®¶å¯ä»¥å…±ç”¨ï¼Œå› æ­¤å¯ä»¥æ”¾åˆ°æ¡†æ¶é‡Œï¼Œ#2éœ€è¦æˆ‘ä»¬è‡ªå·±å»å®ç°ï¼Œç°åœ¨é—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬çŸ¥é“è¦å†™Servlet å»å¤„ç†è¯·æ±‚ï¼Œä½†æ˜¯æˆ‘æ€ä¹ˆçŸ¥é“è¯¥æ€ä¹ˆå†™ï¼Ÿæ¯”å¦‚éœ€ç”¨ä»€ä¹ˆæ–¹æ³•å‘½åï¼Œå‚æ•°ç­‰ç­‰æ‰èƒ½è¢«æ¡†æ¶è°ƒç”¨åˆ°ã€‚</p>
<p>æœ‰åŒå­¦å¯èƒ½è¯´å–å†³äºä½ ç”¨ä»€ä¹ˆæ¡†æ¶ï¼Œ ä½†å¦‚æœæƒ³æ¢æ¡†æ¶æ€ä¹ˆåŠï¼Ÿ</p>
<p>å› æ­¤æˆ‘ä»¬å°±æœ‰äº†<strong>Servletè§„èŒƒ</strong>ï¼Œæ¥æŒ‡å¯¼æ¡†æ¶æ€ä¹ˆå†™ï¼Œservletæ€ä¹ˆå†™ï¼Œä»¥ç¡®ä¿ä¸åŒçš„Servletå®¹å™¨ï¼ˆä¾‹å¦‚Tomcatã€Jettyç­‰ï¼‰ä¹‹é—´çš„å…¼å®¹æ€§ã€‚æ¯”å¦‚:</p>
<ol>
<li>
<p>è§„å®šäº†æ‰€æœ‰Servletç±»éƒ½å¿…é¡»å®ç°<code>javax.servlet.Servlet </code> è¿™ä¸ªæ¥å£</p>
</li>
<li>
<p>å®šä¹‰äº†Servletçš„ç”Ÿå‘½å‘¨æœŸï¼Œæ¯”å¦‚è§„å®šæ¯ä¸€ä¸ªservlet éƒ½å¿…é¡»æœ‰ <code>init()</code>ã€<code>service()</code>ã€<code>destroy()</code>ï¼Œ</p>
</li>
<li>
<p>æè¿°äº†Servletå®¹å™¨çš„èŒè´£å’ŒåŠŸèƒ½ï¼Œæ¯”å¦‚å½“è¯·æ±‚æ¥äº†ä¼šè°ƒç”¨Servletå®ä¾‹çš„serviceæ–¹æ³•</p>
</li>
<li>
<p>ç­‰ç­‰ã€‚æ›´å¤šè¯¦ç»†çš„è§„èŒƒè¯·å‚é˜…</p>
</li>
</ol>
<blockquote>
<p>âš ï¸ Servlet API çš„åŒ…åè‡ª2020å¹´12æœˆJakarta EE 9 å‘å¸ƒåå·²ç»ä» <code>javax.servlet</code> æ›´æ”¹ä¸º <code>jakarta.servlet</code></p>
</blockquote>
<p>ç›¸ä¿¡å¾ˆå¤šäººåœ¨å­¦java web æ—¶ä¸€å¼€å§‹éƒ½ä¼šå»å­¦æ€ä¹ˆå†™ä¸€ä¸ªServlet.</p>
<blockquote>
<p>è§„èŒƒã€çº¦å®šçš„æ€æƒ³éšå¤„å¯è§ï¼Œè¿™ä¸ªä¸–ç•Œä¸‡ç‰©çš„è¿è¡Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯åŸºäºè§„èŒƒè§„åˆ™ã€‚</p>
</blockquote>
<p>å†å»ç†è§£ä»€ä¹ˆæ˜¯tomcatçš„æ—¶å€™å‘ç°<strong>tomcat å…¶å®ä¹Ÿå®ç°äº†Servletè§„èŒƒ</strong>ï¼Œ ä¹Ÿå¯ä»¥ç†è§£ä¸ºä»€ä¹ˆè¯´<strong>Tomcat æ˜¯servlet å®¹å™¨</strong>äº†ã€‚</p>
<p><strong>å°ç»“</strong></p>
<ul>
<li>Servlet æ˜¯ä¸€æ®µç¨‹åº</li>
<li>éœ€è¦ç¬¦åˆServletè§„èŒƒ</li>
<li>å®ƒä¸»è¦ç”¨äºå¤„ç†å’Œå“åº”HTTP è¯·æ±‚</li>
<li>è¿è¡Œåœ¨æ”¯æŒServletè§„èŒƒçš„å®¹å™¨ä¸­</li>
</ul>
<h1 id="tomcat-çš„å·¥ä½œåŸç†">Tomcat çš„å·¥ä½œåŸç†</h1>
<p>è™½ç„¶åº”ç”¨å¤§éƒ¨åˆ†åº”ç”¨éƒ½æ˜¯åŸºäºspringbootåŠå…¶é»˜è®¤å†…åµŒçš„tomcatè¿›è¡Œå¼€å‘ï¼Œä½†æ˜¯è„±ç¦»å¤æ‚çš„springæŠŠtomcatä½œä¸ºç‹¬ç«‹éƒ¨ç½²çš„ä¸­é—´ä»¶å¯ä»¥æ›´å¥½çš„æ¥å¸®åŠ©æˆ‘ä»¬æ¥å­¦ä¹ å’Œäº†è§£tomcatã€‚</p>
<ol>
<li><strong>ä¸‹è½½Tomcat</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl https://dlcdn.apache.org/tomcat/tomcat-10/v10.1.18/bin/apache-tomcat-10.1.18.zip -o apache-tomcat-10.1.18.zip
</span></span></code></pre></div><p>è§£å‹åå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç›®å½•ç»“æ„ï¼š</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240129141653195.png"
	width="1004"
	height="698"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240129141653195_hu893c53693a6eb646ab8692361570f6ec_90149_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240129141653195_hu893c53693a6eb646ab8692361570f6ec_90149_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240129141653195"
	
	
		class="gallery-image" 
		data-flex-grow="143"
		data-flex-basis="345px"
	
></p>
<ol start="2">
<li>
<p><strong>è‡ªå®šä¹‰ä¸€ä¸ªServlet</strong></p>
<p>ä»¥ä¸‹ä»£ç ç”±kotlin å®ç°ï¼Œæ³¨æ„<code>HttpServlet</code> å·²ç»å®ç°äº†<code>jakarta.servlet</code> æ‰€ä»¥æ­¤å¤„æˆ‘ä»¬åªéœ€è¦ç»§æ‰¿HttpServletå°±è¡Œã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DemoServlet</span> <span class="p">:</span> <span class="n">HttpServlet</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">fun</span> <span class="nf">doGet</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">HttpServletRequest</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">HttpServletResponse</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&#34;Pong!&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></li>
<li>
<p><strong>ç¼–è¯‘ä¸Šè¿°ä»£ç ï¼Œå¾—åˆ°classæ–‡ä»¶</strong></p>
<p>ç”±äºæ˜¯kotlin ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨IDEA è¿›è¡Œç¼–è¯‘ï¼Œä¹Ÿå¯ä»¥ç”¨ç¦»çº¿çš„kotlinç¼–è¯‘å™¨ï¼Œæˆ‘æ˜¯é€‰æ‹©çš„å‰è€…ã€‚</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240130095816052.png"
	width="880"
	height="398"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240130095816052_hu57af22a11690458aff1c99c2409794e4_31071_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240130095816052_hu57af22a11690458aff1c99c2409794e4_31071_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240130095816052"
	
	
		class="gallery-image" 
		data-flex-grow="221"
		data-flex-basis="530px"
	
></p>
</li>
<li>
<p><strong>å°†class æ–‡ä»¶æ‹·è´åˆ°tomcatæŒ‡å®šç›®å½•</strong></p>
<ul>
<li>
<p>åœ¨<code>webapp</code> ä¸‹åˆ›å»ºä¸€ä¸ªç›®å½•å‘½åä¸ºmy-appï¼Œ å¹¶åœ¨my-appåˆ›å»ºå¦‚ä¸‹ç›®å½•ç»“æ„ï¼š</p>
<pre tabindex="0"><code>my-app
â””â”€â”€ WEB-INF
    â”œâ”€â”€ classes
    â”‚Â Â  â””â”€â”€ org
    â”‚Â Â      â””â”€â”€ fan
    â”‚Â Â          â””â”€â”€ DemoServlet.class
    â”œâ”€â”€ lib
    â”‚Â Â  â”œâ”€â”€ annotations-13.0.jar
    â”‚Â Â  â””â”€â”€ kotlin-stdlib-1.9.21.jar
    â””â”€â”€ web.xml
</code></pre></li>
<li>
<p><code>web.xml</code> çš„å†…å®¹å¦‚ä¸‹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">&#34;http://xmlns.jcp.org/xml/ns/javaee&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="na">version=</span><span class="s">&#34;3.1&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;servlet&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;servlet-name&gt;</span>DemoServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;servlet-class&gt;</span>com.fan.DemoServlet<span class="nt">&lt;/servlet-class&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/servlet&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;servlet-mapping&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;servlet-name&gt;</span>DemoServlet<span class="nt">&lt;/servlet-name&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;url-pattern&gt;</span>/ping<span class="nt">&lt;/url-pattern&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/servlet-mapping&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/web-app&gt;</span>
</span></span></code></pre></div><p>è¿™ä¸€æ­¥å°±æ˜¯é…ç½®æ˜ å°„è§„åˆ™ï¼Œè®©ç¬¦åˆè§„åˆ™çš„è¯·æ±‚è¢«æŒ‡å®šçš„servletå¤„ç†ã€‚</p>
</li>
</ul>
</li>
<li>
<p><strong>é€šè¿‡binç›®å½•ä¸‹çš„è„šæœ¬å¯åŠ¨Tomcat</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chmod -R +x ./bin
</span></span><span class="line"><span class="cl">./bin/startup.sh
</span></span></code></pre></div></li>
<li>
<p><strong>æµè§ˆå™¨è®¿é—®http://localhost:8080/my-app/ping</strong></p>
</li>
</ol>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240130101103677.png"
	width="1224"
	height="298"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240130101103677_hu7c1340e8489d2ab0356109a8c4e59784_25768_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240130101103677_hu7c1340e8489d2ab0356109a8c4e59784_25768_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240130101103677"
	
	
		class="gallery-image" 
		data-flex-grow="410"
		data-flex-basis="985px"
	
></p>
<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åªè¦æŠŠè‡ªå·±å†™çš„Servlet æŒ‰ç…§tomcat çš„è§„åˆ™æ”¾åˆ°æŒ‡å®šç›®å½•ä¸‹ï¼Œç„¶åè¿è¡Œtomcat æˆ‘ä»¬å†™çš„Servletå°±å¯ä»¥å¤„ç†è¯·æ±‚ï¼Œä¸‹é¢è§£é‡Šä¸‹æˆ‘åˆšåˆšåˆ›å»ºçš„ç›®å½•ç»“æ„çš„ä½œç”¨ã€‚</p>
<ul>
<li>
<p><code>classes</code> è¿™ä¸ªç›®å½•å­˜æ”¾æˆ‘ä»¬è‡ªå·±å†™çš„Servletç¼–è¯‘åçš„å­—èŠ‚ç æ–‡ä»¶</p>
<blockquote>
<p>ä»€ä¹ˆæ˜¯å­—èŠ‚ç æ–‡ä»¶ï¼Ÿé‡Œé¢å­˜çš„æ˜¯ä»€ä¹ˆï¼Ÿé•¿ä»€ä¹ˆæ ·å­ï¼Ÿ</p>
</blockquote>
</li>
<li>
<p><code>lib</code> å­˜æ”¾æˆ‘ä»¬éœ€è¦ç”¨åˆ°çš„ä¾èµ–ï¼Œå› ä¸ºæˆ‘æ˜¯ç”¨kotlinç¼–å†™çš„ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°ç›¸å…³ä¾èµ–</p>
</li>
<li>
<p><code>web.xml</code> å­˜æ”¾Tomcatç›¸å…³é…ç½®ï¼Œä¸Šé¢æˆ‘ä»¬åªå‘Šè¯‰äº†tomcat æŠŠURIä¸º<code>/ping</code> çš„è¯·æ±‚äº¤ç»™ DemoServletå¤„ç†</p>
</li>
</ul>
<p>è‡³æ­¤æˆ‘ä»¬å¯ä»¥çœ‹åˆ°tomcat è‡³å°‘åšäº†å¦‚ä¸‹çš„äº‹ï¼š</p>
<ul>
<li>ç›‘å¬ç½‘ç»œç«¯å£</li>
<li>æ¥å—ç½‘ç»œè¯·æ±‚</li>
<li>è¯»å–ç½‘ç»œæ•°æ®</li>
<li>æ ¹æ®HTTP åè®®è§£ææ•°æ®</li>
<li>åŠ è½½class æ–‡ä»¶åŠjar æ–‡ä»¶</li>
<li>è°ƒç”¨DemoServletçš„doGet æ–¹æ³•</li>
<li>å°†å“åº”çš„å­—èŠ‚æµå†™å›ç»™æµè§ˆå™¨</li>
</ul>
<p>è¦åšè¿™äº›äº‹è‚¯å®šä¸ä¼šåƒæˆ‘ä»¬demoç‰ˆä»£ç ä¸­é‚£ä¹ˆç®€å•ï¼Œè‚¯å®šç»è¿‡è®¾è®¡çš„ï¼Œä½†æ˜¯æ— è®ºæ€ä¹ˆè®¾è®¡ï¼Œæ¯ä¸ªæ¥å£å’Œæ¨¡å—éƒ½æœ‰å®ƒè‡ªå·±çš„èŒè´£å’Œè¦å¤„ç†çš„äº‹æƒ…ï¼Œä¸‹é¢å…ˆçœ‹çœ‹tomcat çš„æ•´ä½“æ¶æ„ã€‚</p>
<h2 id="tomcatæ¶æ„">Tomcatæ¶æ„</h2>
<p>Tomcatæ•´ä½“æ¶æ„æ˜¯ä¸€ç§åˆ†å±‚çš„ç»“æ„ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸ªç»“è®ºå›¾(æ¥æºäºç½‘ç»œ)ï¼Œ åé¢æˆ‘åœ¨åˆ†ææºç çš„æ—¶å€™ä¼šé€æ¸æŠŠæºç å’Œè¿™ä¸ªå›¾å¯¹åº”èµ·æ¥ã€‚</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/1775037-20200701215156409-51289451.png"
	width="1000"
	height="967"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/1775037-20200701215156409-51289451_huda31b2cae9d94bf59e6c1cb8d4e760b9_510228_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/1775037-20200701215156409-51289451_huda31b2cae9d94bf59e6c1cb8d4e760b9_510228_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="Tomcatæ¶æ„ï¼Œæ¥æºäºç½‘ç»œï¼Œä¾µåˆ "
	
	
		class="gallery-image" 
		data-flex-grow="103"
		data-flex-basis="248px"
	
></p>
<p>åœ¨è¿™å°èŠ‚æˆ‘ä»¬å¯ä»¥å…ˆåªå…³æ³¨<code>Server</code>ã€ <code>Service</code>ã€<code>Connector</code>ã€<code>Engine</code>ã€<code>Host</code>ã€<code>Context</code>ã€<code>Wrapper</code>ï¼Œ è®°ä½è¿™å‡ ä¸ªç»„ä»¶åå­—åŠä»–ä»¬çš„å±‚çº§å…³ç³»,  å…¶ä¸­é™¤Connectoræ²¡æœ‰æŠ½è±¡å‡ºæ¥å£å¤–ï¼Œå…¶ä½™ä¹Ÿéƒ½å¯¹åº”äº†tomcatä¸­å‡ ä¸ªé¡¶çº§æ¥å£åå­—(ä¾‹å¦‚<code>org.apache.catalina.Server</code>), è€Œ<code>StandardXXX</code> æ˜¯è¿™äº›æ¥å£çš„å®ç°ã€‚</p>
<p>æ³¨æ„ï¼š<strong>ä¸‹æ–‡è´´å‡ºçš„æºä»£ç éƒ¨åˆ†éƒ½æ˜¯ç²¾ç®€è¿‡åçš„å…³é”®ä»£ç ã€ä¸ªäººè®¤ä¸ºæ˜¯ä½œä¸ºç†è§£tomcatçš„å¿…è¯»éƒ¨åˆ†</strong>ã€‚è¿‡å®Œå¿…è¯»éƒ¨åˆ†åï¼Œè‹¥èƒ½ä¸‹è½½å…¨éƒ¨æºç é€šè¿‡debugæ¥äº†è§£æ›´å¤šç»†èŠ‚åˆ™æ›´ä½³ï¼Œå…³äºå¦‚ä½•åœ¨æœ¬åœ°ç¼–è¯‘å¹¶å¯åŠ¨tomcatæºç å¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡ï¼š<a class="link" href="https://woaihuangfan.github.io/posts/%E7%94%A8idea%E6%9C%AC%E5%9C%B0%E7%BC%96%E8%AF%91%E5%90%AF%E5%8A%A8tomcat%E6%BA%90%E7%A0%81/"  target="_blank" rel="noopener"
    >å¦‚ä½•ç”¨IDEAæœ¬åœ°ç¼–è¯‘å¯åŠ¨tomcat</a></p>
<ul>
<li><strong>StandardServer</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StandardServer</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">LifecycleMBeanBase</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Catalina</span><span class="w"> </span><span class="n">catalina</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * The set of Services associated with this Server.
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">services</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Service</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addService</span><span class="p">(</span><span class="n">Service</span><span class="w"> </span><span class="n">service</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">servicesLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Service</span><span class="w"> </span><span class="n">results</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Service</span><span class="o">[</span><span class="n">services</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// å°†services ä¸­çš„å€¼æ‹·è´åˆ°results</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">services</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">services</span><span class="p">.</span><span class="na">length</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">results</span><span class="o">[</span><span class="n">services</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">service</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">services</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addConnector</span><span class="p">(</span><span class="n">Connector</span><span class="w"> </span><span class="n">connector</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">connectorsLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">connector</span><span class="p">.</span><span class="na">setService</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Connector</span><span class="w"> </span><span class="n">results</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Connector</span><span class="o">[</span><span class="n">connectors</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">connectors</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">connectors</span><span class="p">.</span><span class="na">length</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">results</span><span class="o">[</span><span class="n">connectors</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connector</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">connectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setCatalina</span><span class="p">(</span><span class="n">Catalina</span><span class="w"> </span><span class="n">catalina</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">catalina</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">catalina</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li><strong>StandardService</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StandardService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">LifecycleMBeanBase</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Engine</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The &lt;code&gt;Server&lt;/code&gt; that owns this Service, if any.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The set of Connectors associated with this Service.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">Connector</span><span class="w"> </span><span class="n">connectors</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Connector</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setContainer</span><span class="p">(</span><span class="n">Engine</span><span class="w"> </span><span class="n">engine</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">engine</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">engine</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">engine</span><span class="p">.</span><span class="na">setService</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setServer</span><span class="p">(</span><span class="n">Server</span><span class="w"> </span><span class="n">server</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">server</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addConnector</span><span class="p">(</span><span class="n">Connector</span><span class="w"> </span><span class="n">connector</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">connectorsLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">connector</span><span class="p">.</span><span class="na">setService</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Connector</span><span class="w"> </span><span class="n">results</span><span class="o">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Connector</span><span class="o">[</span><span class="n">connectors</span><span class="p">.</span><span class="na">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">System</span><span class="p">.</span><span class="na">arraycopy</span><span class="p">(</span><span class="n">connectors</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">connectors</span><span class="p">.</span><span class="na">length</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">results</span><span class="o">[</span><span class="n">connectors</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connector</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">connectors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">results</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span></code></pre></div><ul>
<li><strong>StandardEngine</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StandardEngine</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ContainerBase</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Engine</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The &lt;code&gt;Service&lt;/code&gt; that owns this Engine, if any.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addChild</span><span class="p">(</span><span class="n">Container</span><span class="w"> </span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Engineçš„Child å¿…é¡»æ˜¯Host</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">child</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Host</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;standardEngine.notHost&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è°ƒç”¨çˆ¶ç±»ContainerBaseä¸­çš„å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">addChild</span><span class="p">(</span><span class="n">child</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span></code></pre></div><ul>
<li>StandardHost</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StandardHost</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ContainerBase</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addChild</span><span class="p">(</span><span class="n">Container</span><span class="w"> </span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Hostçš„Childå¿…é¡»æ˜¯Context</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">child</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Context</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;standardHost.notContext&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è°ƒç”¨çˆ¶ç±»ContainerBaseä¸­çš„å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">addChild</span><span class="p">(</span><span class="n">child</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span></code></pre></div><ul>
<li><strong>StandardContext</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StandardContext</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ContainerBase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">Context</span><span class="p">,</span><span class="w"> </span><span class="n">NotificationEmitter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addChild</span><span class="p">(</span><span class="n">Container</span><span class="w"> </span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Global JspServlet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Wrapper</span><span class="w"> </span><span class="n">oldJspServlet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">child</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">Wrapper</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;standardContext.notWrapper&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// è°ƒç”¨çˆ¶ç±»ContainerBaseä¸­çš„å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">.</span><span class="na">addChild</span><span class="p">(</span><span class="n">child</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span></code></pre></div><ul>
<li><strong>StandardWrapper</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StandardWrapper</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ContainerBase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">implements</span><span class="w"> </span><span class="n">ServletConfig</span><span class="p">,</span><span class="w"> </span><span class="n">Wrapper</span><span class="p">,</span><span class="w"> </span><span class="n">NotificationEmitter</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * Refuse to add a child Container, because Wrappers are the lowest level
</span></span></span><span class="line"><span class="cl"><span class="cm">   * of the Container hierarchy.
</span></span></span><span class="line"><span class="cl"><span class="cm">   *
</span></span></span><span class="line"><span class="cl"><span class="cm">   * @param child Child container to be added
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addChild</span><span class="p">(</span><span class="n">Container</span><span class="w"> </span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		  </span><span class="c1">// StandardWrapperæ˜¯å±‚çº§çš„æœ€åº•å±‚ï¼Œæ‹’ç»æ·»åŠ child</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;standardWrapper.notChild&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°StandardEngineï¼ŒStandardHostï¼ŒStandardContext, StandardWrapperéƒ½ç»§æ‰¿äº†ContainerBaseä¸”éƒ½å®ç°äº†<code>Container</code> æ¥å£ï¼Œä»–ä»¬addChild çš„æ—¶å€™éƒ½è°ƒç”¨äº†çˆ¶ç±»æ–¹æ³•ï¼Œchild ç»´æŠ¤åœ¨çˆ¶ç±»çš„childrenå±æ€§ä¸­.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ContainerBase</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">LifecycleMBeanBase</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Container</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">    * The parent Container to which this Container is a child.
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">protected</span><span class="w"> </span><span class="n">Container</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="kd">protected</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Container</span><span class="o">&gt;</span><span class="w"> </span><span class="n">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addChild</span><span class="p">(</span><span class="n">Container</span><span class="w"> </span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">addChildInternal</span><span class="p">(</span><span class="n">child</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addChildInternal</span><span class="p">(</span><span class="n">Container</span><span class="w"> </span><span class="n">child</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="p">(</span><span class="n">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">children</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="na">getName</span><span class="p">())</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;containerBase.child.notUnique&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">.</span><span class="na">getName</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">child</span><span class="p">.</span><span class="na">setParent</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w">  </span><span class="c1">// May throw IAE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">children</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">child</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span><span class="w"> </span><span class="n">child</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>çœ‹å®Œä»¥ä¸Šå‡ ä¸ªç±»çš„éƒ¨åˆ†æ ¸å¿ƒä»£ç å°±ä¼šç†è§£è¿™ç§åƒå¥—å¨ƒä¸€æ ·çš„åˆ†å±‚è®¾è®¡ã€‚</p>
<p>ä¾æ¬¡å¾€ä¸‹ï¼Œä¸€ä¸ªServer åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªService, ä¸€ä¸ªServiceåŒ…å«ä¸€ä¸ªEngineå’Œä¸€ä¸ªæˆ–å¤šä¸ªconnectorï¼Œä¸€ä¸ªEngine å¯ä»¥åŒ…å«å¤šä¸ªHost, ä¸€ä¸ªHost å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªContext, ä¸€ä¸ªContext å¯ä»¥åŒ…å«å¤šä¸ªWrapper, ä»Engineå¼€å§‹éƒ½å®ç°äº†<code>Container</code> æ¥å£ã€‚</p>
<p><strong>åŒ–æŠ½è±¡ä¸ºå…·ä½“</strong></p>
<p>ç°åœ¨Server, service, engine ç­‰æˆ‘ä»¬ä»æŠ€æœ¯è§’åº¦ç†è§£äº†ä»–ä»¬æ˜¯ä¸€ä¸ªä¸ªçš„æ¥å£ï¼Œæˆ–è€…è¯´æŠ€æœ¯ç»„ä»¶ï¼Œä¾æ—§æ˜¯ä¸€ç§æŠ½è±¡çš„æ¦‚å¿µï¼Œé‚£å¦‚ä½•ä»ä¸šåŠ¡è§’åº¦ç†è§£ä»–ä»¬æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ</p>
<ul>
<li>Serverå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªtomcat server å®ä¾‹;</li>
<li>Serviceå°†ä¸€ä¸ªæˆ–å¤šä¸ªè¿æ¥å™¨ä¸ä¸€ä¸ªEngineç›¸å…³è”;</li>
<li>Engine ç”¨æ¥ç®¡ç†å¤šä¸ªè™šæ‹Ÿä¸»æœºï¼›</li>
<li>Host ä»£è¡¨çš„æ˜¯ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œå¯ä»¥ç»™ Tomcat é…ç½®å¤šä¸ªè™šæ‹Ÿä¸»æœºåœ°å€ï¼›</li>
<li>Context è¡¨ç¤ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºï¼Œè€Œä¸€ä¸ªè™šæ‹Ÿä¸»æœºä¸‹å¯ä»¥éƒ¨ç½²å¤šä¸ª Web åº”ç”¨ç¨‹åº;</li>
<li>Wrapper è¡¨ç¤ºä¸€ä¸ª Servlet, ä¸€ä¸ª Web åº”ç”¨ç¨‹åºä¸­å¯èƒ½ä¼šæœ‰å¤šä¸ª Servletï¼›</li>
</ul>
<p>å¹¶ä¸”å¯ä»¥å‘ç°ï¼Œ</p>
<ol>
<li>
<p>åœ¨è¿™ä¸ªå±‚çº§ç»“æ„ä¸­ï¼Œå­èŠ‚ç‚¹ä¸­ä¹Ÿç»´æŠ¤äº†çˆ¶èŠ‚ç‚¹ï¼Œå½¢æˆäº†åŒå‘é“¾è¡¨å’Œå¯¹è±¡æ ‘ã€‚</p>
</li>
<li>
<p>æ¯ä¸€å±‚çš„ç»„ä»¶éƒ½å®ç°äº†<code>Lifecycle</code>æ¥å£ã€‚</p>
</li>
</ol>
<p>å†çœ‹çœ‹Tomcat é…ç½®æ–‡ä»¶å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„æ¥ç†è§£è¿™ä¸ªå±‚æ¬¡å…³ç³»ã€‚ä»¥ä¸‹é…ç½®æ–‡ä»¶èŠ‚é€‰è‡ªé»˜è®¤çš„<code>conf/server.xml</code>æ–‡ä»¶ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;Server</span> <span class="na">port=</span><span class="s">&#34;8005&#34;</span> <span class="na">shutdown=</span><span class="s">&#34;SHUTDOWN&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Service</span> <span class="na">name=</span><span class="s">&#34;Catalina&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">&#34;8080&#34;</span> <span class="na">protocol=</span><span class="s">&#34;HTTP/1.1&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="na">connectionTimeout=</span><span class="s">&#34;20000&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="na">redirectPort=</span><span class="s">&#34;8443&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Engine</span> <span class="na">name=</span><span class="s">&#34;Catalina&#34;</span> <span class="na">defaultHost=</span><span class="s">&#34;localhost&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;Host</span> <span class="na">name=</span><span class="s">&#34;localhost&#34;</span>  <span class="na">appBase=</span><span class="s">&#34;webapps&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="na">unpackWARs=</span><span class="s">&#34;true&#34;</span> <span class="na">autoDeploy=</span><span class="s">&#34;true&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/Host&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Engine&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/Service&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Server&gt;</span>
</span></span></code></pre></div><p>åŒæ—¶å¼•å…¥ä¸¤ä¸ªé—®é¢˜ï¼Œ</p>
<ul>
<li>è¿™ä¸ªå¯¹è±¡æ ‘çš„æ ¹èŠ‚ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿä¸Šé¢çš„æ¯ä¸ªå¯¹è±¡æ˜¯æ€ä¹ˆå®ä¾‹åŒ–çš„ï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆéƒ½å®ç°äº†<code>Lifecycle</code>æ¥å£ï¼Ÿ</li>
</ul>
<p>è¦å›ç­”è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥å…ˆæ¥äº†è§£ä¸‹Tomcat çš„å¯åŠ¨è¿‡ç¨‹ã€‚</p>
<h3 id="tomcat-çš„å¯åŠ¨è¿‡ç¨‹">Tomcat çš„å¯åŠ¨è¿‡ç¨‹</h3>
<p>![tomcat å¯åŠ¨è¿‡ç¨‹](images/tomcat å¯åŠ¨è¿‡ç¨‹.png)</p>
<p>ä¸Šå›¾å°±æ˜¯tomcat å¯åŠ¨çš„è¿‡ç¨‹ï¼Œ<code>Bootstrap</code> ä¸ºtomcat çš„å¯åŠ¨ç±»ï¼Œåˆ†ä¸ºinit, load, start å¤§çš„ä¸‰æ­¥ï¼Œç„¶ååˆåˆ†åˆ«è°ƒç”¨Catalina å¯¹åº”çš„load å’Œstart æ–¹æ³•ï¼Œåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­é€æ­¥å®ä¾‹åŒ–å„ä¸ªç»„ä»¶å¹¶æ„å»ºä»¥Catalinaä¸ºæ ¹èŠ‚ç‚¹çš„å¯¹è±¡æ ‘ã€‚</p>
<p>åŒæ—¶æˆ‘ä»¬å‘ç°å¯åŠ¨è¿‡ç¨‹ä¸­&quot;init&quot;,&ldquo;start&rdquo; è¿™ç±»æ–¹æ³•éšå¤„å¯è§ï¼Œè¿™ä¸éš¾ç†è§£å±‚æ¬¡æ¶æ„ä¸­æ¯ä¸ªç»„ä»¶éƒ½æœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸï¼Œå› æ­¤ä»–ä»¬éƒ½å®ç°äº†LifeCycle æ¥å£ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£æ¥ç®¡ç†æ‰€æœ‰ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸã€‚åŒæ—¶ï¼Œç”±äºæ ‘å½¢ç»“æ„çš„å­˜åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥åšåˆ°ä¸€é”®å¯åœï¼Œæ¯”å¦‚server çš„start æ–¹æ³•ä¼šè°ƒç”¨å­èŠ‚ç‚¹çš„æ–¹æ³•ã€‚</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240223104628734.png"
	width="772"
	height="740"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240223104628734_hu118df191dceeedf93298eacd573438fb_82279_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240223104628734_hu118df191dceeedf93298eacd573438fb_82279_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240223104628734"
	
	
		class="gallery-image" 
		data-flex-grow="104"
		data-flex-basis="250px"
	
></p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Lifecycleä¸­è¿˜æšä¸¾äº†LifecycleStateï¼Œå„ä¸ªç»„ä»¶åœ¨ç”Ÿå‘½å‘¨æœŸä¸­çš„æ¯ä¸€ä¸ªé˜¶æ®µéƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„çŠ¶æ€å’Œäº‹ä»¶ï¼ŒåŒæ—¶è¿˜æœ‰ç»´æŠ¤çš„LifecycleListenerï¼Œé€šè¿‡äº‹ä»¶ç›‘å¬çš„æœºåˆ¶å¯ä»¥å¾ˆæ–¹ä¾¿æ‰©å±•å„ä¸ªç»„ä»¶ç°æœ‰çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€‚</p>
<p><strong>å¸¸è§çš„LifeCycleListener</strong></p>
<ul>
<li>EngineConfig</li>
<li>HostConfig</li>
<li>ContextConfig</li>
<li>&hellip;</li>
</ul>
<p><strong>Tomcatä¼—å¤šç»„ä»¶ä¸­æœ‰ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼šè¿æ¥å™¨(<code>Connector</code>) å’Œå®¹å™¨(<code>Container</code>).</strong></p>
<p><code>Conntector</code> ç»´æŠ¤åœ¨Service å®ä¾‹ä¸­ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯è´Ÿè´£å¯¹å¤–äº¤æµï¼ŒåŒ…æ‹¬ç›‘å¬ç«¯å£ï¼Œæ¥æ”¶è¯·æ±‚ï¼Œè¯»å–å¹¶è§£æè¯·æ±‚æ•°æ®ï¼Œç„¶åäº¤ç»™Servlet å¤„ç†ï¼Œå¹¶å°†å“åº”å†™å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<p><code>Container</code> å…¶å®æ˜¯ä¸€ä¸ªæ¯”è¾ƒä¸šåŠ¡åŒ–çš„æè¿°ï¼Œæˆ‘ä»¬å¸¸å¬åˆ°&quot;Springå®¹å™¨&quot;ï¼Œ&ldquo;Servletå®¹å™¨&rdquo;ï¼Œé‚£åˆ°åº•ä»€ä¹ˆæ˜¯å®¹å™¨ï¼Ÿå®¹å™¨æ˜¯ç”¨æ¥è£…ä¸œè¥¿çš„ï¼Œä¸€ä¸ªæ°´æ¯ä¹Ÿæ˜¯å®¹å™¨ï¼Œè£…çš„æ˜¯æ°´ã€‚é‚£æˆ‘ä»¬tomcaté‡Œè¯´çš„å®¹å™¨ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è£…Servlet, è¿™ä¹Ÿæ˜¯å®ƒçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ â€”â€” åŠ è½½å¹¶ç®¡ç† <code>Servlet</code> ã€‚æˆ‘ä»¬ä¸Šé¢çœ‹æ¶æ„çš„æ—¶å€™å¯ä»¥å‘ç°Engineï¼ŒHost , Context, Wrapper éƒ½å®ç°äº†Container æ¥å£ï¼Œå› æ­¤ä»–ä»¬éƒ½å¯ä»¥ç†è§£ä¸ºå®¹å™¨ï¼Œåªä¸è¿‡æ˜¯ä¸€ç§å¥—å¨ƒå¼è®¾è®¡ã€‚</p>
<blockquote>
<p>ä½†æ˜¯æˆ‘ä»¬æœ‰æ—¶å€™ä¹Ÿçœ‹åˆ°è¯´&quot;Catalina æ˜¯tomcat çš„servlet å®¹å™¨&quot;, è¿™ç§è¯´æ³•æ­£ç¡®å—ï¼Ÿ å…¶å®ä¹Ÿæ­£ç¡®ï¼Œå› ä¸ºcatalina ä½œä¸ºå¯¹è±¡æ ‘çš„æ ¹èŠ‚ç‚¹ç®¡ç†ç€æ•´ä¸ªä¸‹å±‚å®¹å™¨ï¼Œæ‰€ä»¥å¾€å¤§äº†æˆ‘ä»¬ä¹Ÿå¯ä»¥è¯´Catalinaæ˜¯å®¹å™¨ï¼Œå¾€å°äº†è¯´å°±åªæœ‰å®ç°äº†Containeræ¥å£çš„ç»„ä»¶æ‰æ˜¯&quot;å®¹å™¨&quot;ï¼Œå®¹å™¨åªæ˜¯ä¸€ç§å¤§å®¶å¸¸ç”¨çš„ç”¨æ¥æ¯”æ‹Ÿçš„è¯ï¼Œæ›´é‡è¦çš„æ˜¯æ˜ç™½å®ƒèƒŒåæƒ³è¡¨è¾¾çš„æ˜¯ä»€ä¹ˆã€‚</p>
</blockquote>
<h2 id="è¯·æ±‚æ¥æ”¶å’Œå¤„ç†">è¯·æ±‚æ¥æ”¶å’Œå¤„ç†</h2>
<p>Connectorçš„èŒè´£åˆå¯ä»¥ç»†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼šç½‘ç»œé€šä¿¡(EndPoint), æ ¹æ®åº”ç”¨å±‚åè®®è§£æè¯·æ±‚æ•°æ®(Processor), å°è£…ServletRequestäº¤ç»™Servlet å¤„ç†(Adaptor)ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬åœ¨å‰é¢demoé»˜è®¤çš„åº”ç”¨å±‚åè®®æ˜¯HTTP/1.1 ï¼Œå…¶å®tomcat è¿˜æ”¯æŒAJP, HTTP/2</p>
</blockquote>
<h3 id="connectorçš„åˆ›å»º">Connectorçš„åˆ›å»º</h3>
<p>åœ¨<code>server.xml</code> ä¸­æœ‰å¦‚ä¸‹é…ç½®ï¼Œå½“Digisterè§£æxmlæ–‡ä»¶å‘ç°è¿™ä¸ªé…ç½®æ—¶å°±ä¼šå»å®ä¾‹åŒ–Connector.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"> <span class="nt">&lt;Connector</span> <span class="na">port=</span><span class="s">&#34;8080&#34;</span> <span class="na">protocol=</span><span class="s">&#34;HTTP/1.1&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="na">connectionTimeout=</span><span class="s">&#34;20000&#34;</span>
</span></span><span class="line"><span class="cl">               <span class="na">redirectPort=</span><span class="s">&#34;8443&#34;</span> <span class="nt">/&gt;</span>
</span></span></code></pre></div><p>è€Œå®ä¾‹åŒ–çš„æ“ä½œæ˜¯åœ¨å¼€å§‹è§£æxmlä¹‹å‰ç»™Digisteræ·»åŠ äº†å¯¹åº”çš„Ruleå†³å®šçš„ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// åœ¨å¼€å§‹è§£æxmlæ–‡ä»¶ä¹‹å‰ä¼šç»™Digisteræ·»åŠ ä¸€ä¸ªRuleæ¥å‘Šè¯‰Digisteré‡åˆ°&lt;Connector&gt;æ ‡ç­¾æ—¶çš„å¤„ç†é€»è¾‘</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">digester</span><span class="p">.</span><span class="na">addRule</span><span class="p">(</span><span class="s">&#34;Server/Service/Connector&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ConnectorCreateRule</span><span class="p">());</span><span class="w">
</span></span></span></code></pre></div><p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240206143632546.png"
	width="2302"
	height="1212"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240206143632546_hu027ec3b996561359d184cefe463055f5_381110_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240206143632546_hu027ec3b996561359d184cefe463055f5_381110_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="h"
	
	
		class="gallery-image" 
		data-flex-grow="189"
		data-flex-basis="455px"
	
></p>
<p>ç„¶ååœ¨å®ä¾‹åŒ–Connectorçš„æ—¶å€™ä¼šæ ¹æ®æˆ‘ä»¬é…ç½®çš„åè®®åˆ›å»º<code>ProtocolHandler</code>,  å®ƒæ˜¯Connectorä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªç»„ä»¶ï¼Œä¸‹é¢ä¼šæåˆ°ã€‚</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240206143921781.png"
	width="2552"
	height="1052"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240206143921781_hu5ff1a2667acb02c665d7c7252cc1f2eb_264557_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240206143921781_hu5ff1a2667acb02c665d7c7252cc1f2eb_264557_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240206143921781"
	
	
		class="gallery-image" 
		data-flex-grow="242"
		data-flex-basis="582px"
	
></p>
<p>è€Œé’ˆå¯¹<code>HTTP/1.1</code> ä¼šåˆ›å»º<code>Http11NioProtocol</code></p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240206144411379.png"
	width="2240"
	height="1318"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240206144411379_hu8ea8f2ab531821870351b2cac25448a9_388875_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240206144411379_hu8ea8f2ab531821870351b2cac25448a9_388875_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240206144411379"
	
	
		class="gallery-image" 
		data-flex-grow="169"
		data-flex-basis="407px"
	
></p>
<p>å†æ¥çœ‹çœ‹è¿™ä¸ªHttp11NioProtocolï¼Œ</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/20200407174647.png"
	width="1438"
	height="856"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/20200407174647_hua4d1234e1ee57c0f613448715feabe27_168769_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/20200407174647_hua4d1234e1ee57c0f613448715feabe27_168769_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="åº”ç”¨å±‚åè®®æŠ½è±¡"
	
	
		class="gallery-image" 
		data-flex-grow="167"
		data-flex-basis="403px"
	
></p>
<p>åœ¨åˆ›å»ºHttp11NioProtocolçš„æ—¶å€™ä¼šä¼ å…¥ä¸€ä¸ªNioEndpoint ä½œä¸ºæ„é€ å‡½æ•°çš„å‚æ•°ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="nf">Http11NioProtocol</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">super</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">NioEndpoint</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è€ŒEndPointç»´æŠ¤åœ¨<code>AbstractProtocol</code>ä¸­ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractProtocol</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ProtocolHandler</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">MBeanRegistration</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Endpoint that provides low-level network I/O - must be matched to the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ProtocolHandler implementation (ProtocolHandler using NIO, requires NIO
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Endpoint etc.).
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AbstractEndpoint</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span><span class="o">?&gt;</span><span class="w"> </span><span class="n">endpoint</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Connector åˆ›å»ºå®Œåä¼šè°ƒç”¨service#addConnector æŠŠå®ƒç»‘å®šåˆ°service, è‡³æ­¤æˆ‘ä»¬çš„çŸ¥é“äº†ï¼š</p>
<ol>
<li>Connector æ˜¯åœ¨è§£æxml æ—¶æ ¹æ®äº‹å…ˆæŒ‡å®šçš„Ruleåˆ›å»º</li>
<li>Connector åŒ…å«ProtocolHandler, åœ¨å®ä¾‹åŒ–Connectoræ—¶ä¼šæ ¹æ®xml é…ç½®æ¥åˆ›å»ºProtocolHandler, HTTP/1.1 ä¼šåˆ›å»ºHttp11NioProtocol</li>
<li>ProtocolHandlerä¸­ç»´æŠ¤ç€EndPoint ç»„ä»¶ï¼ŒHttp11NioProtocolé»˜è®¤åˆ›å»ºNioEndpoint</li>
</ol>
<h3 id="ç›‘å¬ç½‘ç»œç«¯å£å’Œæ¥æ”¶è¿æ¥è¯·æ±‚">ç›‘å¬ç½‘ç»œç«¯å£å’Œæ¥æ”¶è¿æ¥è¯·æ±‚</h3>
<h4 id="acceptor">Acceptor</h4>
<p>Acceptor å®ç°äº†Runnable æ¥å£ï¼Œæ˜¯ç»´æŠ¤åœ¨AbstractEndpointå†…éƒ¨çš„ä¸€ä¸ªfieldè¿™ä¸ªç±»å¾ˆç®€å•ï¼Œä¸»è¦é€»è¾‘å°±æ˜¯åœ¨runæ–¹æ³•ä¸­è°ƒç”¨<code>endpoint.serverSocketAccept()</code>ä»¥åŠ<code>endpoint.setSocketOptions(socket)</code>æ¥ç›‘å¬ç«¯å£å’Œæ¥æ”¶è¯·æ±‚ã€‚</p>
<blockquote>
<p><strong>å†·çŸ¥è¯†ï¼šfield å’Œproperty çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<p>field æ²¡æœ‰get/set æ–¹æ³•ï¼Œä¸ä¼šå¯¹å¤–æš´éœ²ï¼Œ åä¹‹propertyéœ€è¦ï¼Œæ‰€ä»¥propertyé€šå¸¸æœ‰get/set æ–¹æ³•</p>
</blockquote>
<p><strong>Acceptor çš„åˆ›å»ºåŠå¯åŠ¨</strong></p>
<p>tomcat å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œåœ¨è°ƒç”¨catalina çš„start æ–¹æ³•åï¼Œä¼šä¾æ¬¡è°ƒç”¨server.start(), service.start()ï¼Œè€Œåœ¨service ç»„ä»¶çš„<code>startInternal</code>æ–¹æ³•ä¸­ä¼šè°ƒç”¨Connectors çš„startæ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StandardService</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">LifecycleMBeanBase</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">startInternal</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">LifecycleException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Start our defined Connectors second</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">connectorsLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Connector</span><span class="w"> </span><span class="n">connector</span><span class="p">:</span><span class="w"> </span><span class="n">connectors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// If it has already failed, don&#39;t try and start it</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">connector</span><span class="p">.</span><span class="na">getState</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">LifecycleState</span><span class="p">.</span><span class="na">FAILED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">connector</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Connector</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">LifecycleMBeanBase</span><span class="w">  </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">      * Coyote protocol handler.
</span></span></span><span class="line"><span class="cl"><span class="cm">      */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ProtocolHandler</span><span class="w"> </span><span class="n">protocolHandler</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">startInternal</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">LifecycleException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">protocolHandler</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LifecycleException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;coyoteConnector.protocolHandlerStartFailed&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractProtocol</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ProtocolHandler</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">MBeanRegistration</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">endpoint</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æœ€ç»ˆä¼šè°ƒç”¨åˆ°EndPointçš„startInternalæ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">NioEndpoint</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">AbstractJsseEndpoint</span><span class="o">&lt;</span><span class="n">NioChannel</span><span class="p">,</span><span class="n">SocketChannel</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">startInternal</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">running</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">running</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">paused</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Start poller thread</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">poller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Poller</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Thread</span><span class="w"> </span><span class="n">pollerThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">poller</span><span class="p">,</span><span class="w"> </span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;-Poller&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">pollerThread</span><span class="p">.</span><span class="na">setPriority</span><span class="p">(</span><span class="n">threadPriority</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">pollerThread</span><span class="p">.</span><span class="na">setDaemon</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">pollerThread</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">startAcceptorThread</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AbstractEndpoint</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span><span class="n">U</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">startAcceptorThread</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">acceptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Acceptor</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">threadName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;-Acceptor&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">acceptor</span><span class="p">.</span><span class="na">setThreadName</span><span class="p">(</span><span class="n">threadName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Thread</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Thread</span><span class="p">(</span><span class="n">acceptor</span><span class="p">,</span><span class="w"> </span><span class="n">threadName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">t</span><span class="p">.</span><span class="na">setPriority</span><span class="p">(</span><span class="n">getAcceptorThreadPriority</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">t</span><span class="p">.</span><span class="na">setDaemon</span><span class="p">(</span><span class="n">getDaemon</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">t</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span></code></pre></div><p>Acceptorçº¿ç¨‹å¯åŠ¨å</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// Acceptor ç±»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">stopCalled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">endpoint</span><span class="p">.</span><span class="na">serverSocketAccept</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">stopCalled</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">endpoint</span><span class="p">.</span><span class="na">isPaused</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">endpoint</span><span class="p">.</span><span class="na">setSocketOptions</span><span class="p">(</span><span class="n">socket</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">endpoint</span><span class="p">.</span><span class="na">closeSocket</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">endpoint</span><span class="p">.</span><span class="na">destroySocket</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//NioEndpointç±»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">protected</span><span class="w"> </span><span class="n">SocketChannel</span><span class="w"> </span><span class="nf">serverSocketAccept</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// serverSocketChannel æ˜¯åœ¨catalina load é˜¶æ®µé€šè¿‡åˆå§‹åŒ–</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// å¦‚æœè®¾ç½®äº†blocking æ‰€ä»¥æ­¤å¤„ä¼šé˜»å¡ï¼Œä¾‹å¦‚ serverSocketChannel.configureBlocking(true)ï¼Œå¦åˆ™ç«‹å³è¿”å›</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SocketChannel</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serverSocketChannel</span><span class="p">.</span><span class="na">accept</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">protected</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">setSocketOptions</span><span class="p">(</span><span class="n">SocketChannel</span><span class="w"> </span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">NioSocketWrapper</span><span class="w"> </span><span class="n">socketWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// åˆ†é…NioChannel</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">NioChannel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nioChannels</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nioChannels</span><span class="p">.</span><span class="na">pop</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">channel</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">SocketBufferHandler</span><span class="w"> </span><span class="n">bufhandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SocketBufferHandler</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">socketProperties</span><span class="p">.</span><span class="na">getAppReadBufSize</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">socketProperties</span><span class="p">.</span><span class="na">getAppWriteBufSize</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">socketProperties</span><span class="p">.</span><span class="na">getDirectBuffer</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isSSLEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SecureNioChannel</span><span class="p">(</span><span class="n">bufhandler</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NioChannel</span><span class="p">(</span><span class="n">bufhandler</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//å°è£…SocketWrapper</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">NioSocketWrapper</span><span class="w"> </span><span class="n">newWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">NioSocketWrapper</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">channel</span><span class="p">.</span><span class="na">reset</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">newWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">connections</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">newWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">socketWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newWrapper</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Set socket properties</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Disable blocking, polling will be used</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">socket</span><span class="p">.</span><span class="na">configureBlocking</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getUnixDomainSocketPath</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">socketProperties</span><span class="p">.</span><span class="na">setProperties</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="na">socket</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">setReadTimeout</span><span class="p">(</span><span class="n">getConnectionTimeout</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">setWriteTimeout</span><span class="p">(</span><span class="n">getConnectionTimeout</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">setKeepAliveLeft</span><span class="p">(</span><span class="n">NioEndpoint</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">getMaxKeepAliveRequests</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// å°†socketWrapperäº¤ç»™poller</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">poller</span><span class="p">.</span><span class="na">register</span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ExceptionUtils</span><span class="p">.</span><span class="na">handleThrowable</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;endpoint.socketOptionsError&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">tt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ExceptionUtils</span><span class="p">.</span><span class="na">handleThrowable</span><span class="p">(</span><span class="n">tt</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">socketWrapper</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">destroySocket</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Tell to close the socket if needed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Pollerç±»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">NioSocketWrapper</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">interestOps</span><span class="p">(</span><span class="n">SelectionKey</span><span class="p">.</span><span class="na">OP_READ</span><span class="p">);</span><span class="c1">//this is what OP_REGISTER turns into.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">PollerEvent</span><span class="w"> </span><span class="n">pollerEvent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createPollerEvent</span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">,</span><span class="w"> </span><span class="n">OP_REGISTER</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">addEvent</span><span class="p">(</span><span class="n">pollerEvent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>å°ç»“</strong></p>
<ol>
<li>
<p>åœ¨tomcat starté˜¶æ®µä¼šåœ¨Endpoint start çš„æ—¶å€™åˆ›å»ºå”¯ä¸€ä¸€ä¸ªacceptor çº¿ç¨‹</p>
</li>
<li>
<p>Acceptorçº¿ç¨‹é€šè¿‡æ­»å¾ªç¯æ¥è°ƒç”¨<code>endpoint.serverSocketAccept()</code> æœ€ç»ˆè°ƒç”¨serverSocketChannel.accept()æ¥æ¥å—æ–°çš„è¿æ¥ï¼Œæœ‰æ–°è¿æ¥æ—¶ä¼šè¿”å›ä¸€ä¸ªSocketChannelã€‚è¿™é‡Œå’Œæˆ‘ä»¬å‰é¢demoä»£ç ä¸­çš„å®ç°æœ‰ä¸ªä¸åŒä¹‹å¤„æ˜¯å‰é¢demoä»£ç ä¸­ç”¨çš„æ˜¯BIOæ¨¡å¼ï¼Œè€Œä»tomcat 8.0å¼€å§‹é»˜è®¤NIOï¼Œè¿™æ˜¯NIOçš„å®ç°æ–¹å¼ã€‚</p>
</li>
<li>
<p>ç„¶åè°ƒç”¨<code>endpoint.setSocketOptions(socket)</code>,æ¥å°è£…SocketWrapperï¼Œå¹¶è°ƒç”¨poller.register(socketWrapper)ï¼Œåˆ›å»ºPollerEventï¼Œ å¹¶ç»´æŠ¤åœ¨Poller å†…éƒ¨çš„events åŒæ­¥é˜Ÿåˆ—ä¸­ã€‚</p>
</li>
</ol>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹Poller æ˜¯åšä»€ä¹ˆçš„ã€‚</p>
<h4 id="poller">Poller</h4>
<p>Poller çº¿ç¨‹ä¹Ÿæ˜¯åœ¨Endpoint startçš„æ—¶å€™åˆ›å»ºï¼Œå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªevents é˜Ÿåˆ—ã€‚</p>
<p><strong>events é˜Ÿåˆ—</strong></p>
<p>events é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œå½“acceptor æ¥æ”¶åˆ°æ–°çš„è¯·æ±‚è¿æ¥åä¼šå°è£…PollerEvent æ·»åŠ åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­ï¼Œ æ¯ä¸ªPoller Event åŒ…å«è¿™ä¸ªé“¾æ¥çš„socketWrapper, socketWrapper ä¸­åŒ…å«å¯ä»¥ç”¨æ¥è¯»å†™æ•°æ®çš„SocketChannel.</p>
<p><strong>runæ–¹æ³•</strong></p>
<p>runæ–¹æ³•ä¼šä¸æ–­å»éå†events é˜Ÿåˆ—ï¼Œ å¦‚æœæœ‰event å°±ä¼šä»é˜Ÿåˆ—ä¸­å–å‡ºæ¥æ¶ˆè´¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">   </span><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * The background thread that adds sockets to the Poller, checks the
</span></span></span><span class="line"><span class="cl"><span class="cm">     * poller for triggered events and hands the associated socket off to an
</span></span></span><span class="line"><span class="cl"><span class="cm">     * appropriate processor as events occur.
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Loop until destroy() is called</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">hasEvents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">close</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">hasEvents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">events</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wakeupCounter</span><span class="p">.</span><span class="na">getAndSet</span><span class="p">(</span><span class="o">-</span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="c1">// If we are here, means we have other stuff to do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="c1">// Do a non blocking select</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">keyCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selector</span><span class="p">.</span><span class="na">selectNow</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">keyCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selector</span><span class="p">.</span><span class="na">select</span><span class="p">(</span><span class="n">selectorTimeout</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">wakeupCounter</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">ExceptionUtils</span><span class="p">.</span><span class="na">handleThrowable</span><span class="p">(</span><span class="n">x</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;endpoint.nio.selectorLoopError&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">continue</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span><span class="w"> </span><span class="n">iterator</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">keyCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">selector</span><span class="p">.</span><span class="na">selectedKeys</span><span class="p">().</span><span class="na">iterator</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Walk through the collection of ready keys and dispatch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// any active event.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">iterator</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">iterator</span><span class="p">.</span><span class="na">hasNext</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">SelectionKey</span><span class="w"> </span><span class="n">sk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iterator</span><span class="p">.</span><span class="na">next</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">iterator</span><span class="p">.</span><span class="na">remove</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">NioSocketWrapper</span><span class="w"> </span><span class="n">socketWrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">NioSocketWrapper</span><span class="p">)</span><span class="w"> </span><span class="n">sk</span><span class="p">.</span><span class="na">attachment</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// Attachment may be null if another thread has called</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="c1">// cancelledKey()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">socketWrapper</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">processKey</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Process timeouts</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">timeout</span><span class="p">(</span><span class="n">keyCount</span><span class="p">,</span><span class="n">hasEvents</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">getStopLatch</span><span class="p">().</span><span class="na">countDown</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="è§£æè¯·æ±‚æ•°æ®">è§£æè¯·æ±‚æ•°æ®</h3>
<p><strong>processKey</strong></p>
<p>pollerçº¿ç¨‹ä»events é˜Ÿåˆ—ä¸­å–å‡ºäº‹ä»¶åä¼šè°ƒç”¨<code>processKey(sk, socketWrapper)</code> è¿›è¡Œæ¶ˆè´¹</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w"> </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processKey</span><span class="p">(</span><span class="n">SelectionKey</span><span class="w"> </span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">NioSocketWrapper</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">close</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">cancelledKey</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sk</span><span class="p">.</span><span class="na">isValid</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sk</span><span class="p">.</span><span class="na">isReadable</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">sk</span><span class="p">.</span><span class="na">isWritable</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">getSendfileData</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">processSendfile</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">unreg</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">,</span><span class="w"> </span><span class="n">sk</span><span class="p">.</span><span class="na">readyOps</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">closeSocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// Read goes before write</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sk</span><span class="p">.</span><span class="na">isReadable</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">readOperation</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">readOperation</span><span class="p">.</span><span class="na">process</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">closeSocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">readBlocking</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">readLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">readBlocking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">readLock</span><span class="p">.</span><span class="na">notify</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">processSocket</span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">,</span><span class="w"> </span><span class="n">SocketEvent</span><span class="p">.</span><span class="na">OPEN_READ</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">closeSocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">closeSocket</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sk</span><span class="p">.</span><span class="na">isWritable</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">writeOperation</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">writeOperation</span><span class="p">.</span><span class="na">process</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">closeSocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">writeBlocking</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">writeLock</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">writeBlocking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                </span><span class="n">socketWrapper</span><span class="p">.</span><span class="na">writeLock</span><span class="p">.</span><span class="na">notify</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">processSocket</span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">,</span><span class="w"> </span><span class="n">SocketEvent</span><span class="p">.</span><span class="na">OPEN_WRITE</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="n">closeSocket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">closeSocket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">cancelledKey</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Invalid key</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">cancelledKey</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">CancelledKeyException</span><span class="w"> </span><span class="n">ckx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">cancelledKey</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ExceptionUtils</span><span class="p">.</span><span class="na">handleThrowable</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;endpoint.nio.keyProcessingError&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>processSocket</strong></p>
<p>processSocketçš„å®ç°åœ¨<code>AbstractEndpoint</code> ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åˆ›å»ºäº†SocketProcessorå¹¶äº¤ç»™çº¿ç¨‹æ± æ¥å¤„ç†ã€‚åˆ’é‡ç‚¹ï¼šæ¯ä¸€ä¸ªsocket éƒ½ä¼šæœ‰ä¸€ä¸ªå¯¹åº”çš„socketProcessoræ¥å¤„ç†ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">processSocket</span><span class="p">(</span><span class="n">SocketWrapperBase</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">SocketEvent</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">dispatch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// åˆ›å»ºSocketProcessorï¼Œ SocketProcessoræ˜¯EndPoint çš„å†…éƒ¨ç±»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">sc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createSocketProcessor</span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Executor</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getExecutor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// äº¤ç»™çº¿ç¨‹æ± æ¥å¤„ç†</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">executor</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RejectedExecutionException</span><span class="w"> </span><span class="n">ree</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">getLog</span><span class="p">().</span><span class="na">warn</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;endpoint.executor.fail&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">ree</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ExceptionUtils</span><span class="p">.</span><span class="na">handleThrowable</span><span class="p">(</span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// This means we got an OOM or similar creating a thread, or that</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// the pool and its queue are full</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">getLog</span><span class="p">().</span><span class="na">error</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;endpoint.process.fail&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>SocketProcessoræ˜¯EndPoint çš„å†…éƒ¨ç±»ï¼Œæœ€ç»ˆä¼šè°ƒç”¨<code>doRun</code> æ–¹æ³•æ¥å¤„ç†</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doRun</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Poller</span><span class="w"> </span><span class="n">poller</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NioEndpoint</span><span class="p">.</span><span class="na">this</span><span class="p">.</span><span class="na">poller</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// getHandler è¿”å›çš„å°±æ˜¯ConnectionHandlerï¼Œ æ˜¯AbstractProtocolçš„ä¸€ä¸ªå†…éƒ¨ç±»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getHandler</span><span class="p">().</span><span class="na">process</span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">,</span><span class="w"> </span><span class="n">event</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿”å›çš„å°±æ˜¯ConnectionHandlerçš„process æ–¹æ³•ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">SocketState</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">SocketWrapperBase</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="w"> </span><span class="n">wrapper</span><span class="p">,</span><span class="w"> </span><span class="n">SocketEvent</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">processor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recycledProcessors</span><span class="p">.</span><span class="na">pop</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">processor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// è¿”å›Processor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getProtocol</span><span class="p">().</span><span class="na">createProcessor</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">register</span><span class="p">(</span><span class="n">processor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">processor</span><span class="p">.</span><span class="na">process</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SocketState</span><span class="p">.</span><span class="na">UPGRADING</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">){}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Make sure socket/processor is removed from the list of current</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// connections</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">release</span><span class="p">(</span><span class="n">processor</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SocketState</span><span class="p">.</span><span class="na">CLOSED</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// AbstactHttp11Protocol ä¸­createProcessor çš„å®ç°</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// æ³¨æ„æ­¤å¤„ä¼ å…¥äº†ä¸€ä¸ªAdapter, å®ƒåœ¨Connectoråˆå§‹åŒ–æ—¶åˆ›å»º</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//  adapter = new CoyoteAdapter(this);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//  protocolHandler.setAdapter(adapter);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">protected</span><span class="w"> </span><span class="n">Processor</span><span class="w"> </span><span class="nf">createProcessor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Http11Processor</span><span class="w"> </span><span class="n">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Http11Processor</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">adapter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">processor</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ä»¥HTTP/1.1 ä¸ºä¾‹ï¼Œ ä¸Šè¿°ä»£ç ä¼šåˆ›å»ºHTTP11Processor æ¥å¤„ç†è¿™ä¸ªsocket</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/Http11Processor.png"
	width="555"
	height="489"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/Http11Processor_huf45ff0efba7988c54fb1b4b26837a903_18989_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/Http11Processor_huf45ff0efba7988c54fb1b4b26837a903_18989_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="Http11Processor"
	
	
		class="gallery-image" 
		data-flex-grow="113"
		data-flex-basis="272px"
	
></p>
<p>AbstractProcessorLightçš„process æ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">SocketState</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">SocketWrapperBase</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">,</span><span class="w"> </span><span class="n">SocketEvent</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// service æ˜¯æŠ½è±¡æ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">service</span><span class="p">(</span><span class="n">socketWrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SocketState</span><span class="p">.</span><span class="n">ASYNC_END</span><span class="w"> </span><span class="o">||</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">dispatches</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SocketState</span><span class="p">.</span><span class="na">CLOSED</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">state</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>å°ç»“</strong></p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/poller-and-Adapter.png"
	width="1593"
	height="419"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/poller-and-Adapter_hu47e696a7d929ac791f98710d72cae244_49737_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/poller-and-Adapter_hu47e696a7d929ac791f98710d72cae244_49737_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="polleråˆ°Adapter"
	
	
		class="gallery-image" 
		data-flex-grow="380"
		data-flex-basis="912px"
	
></p>
<p>æ¯ä¸€ä¸ªHttp11Processor å†…éƒ¨ä¼šç»´æŠ¤ä¸€ä¸ª<code>Http11InputBuffer</code> å’Œä¸€ä¸ª<code>Http11OutputBuffer</code>, ç”¨ä½œé’ˆå¯¹socket IO çš„ç¼“å­˜å±‚ï¼Œåœ¨å®ç°çš„service æ–¹æ³•ä¸­æ¥è§£æè¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´, ç„¶åå°†è¯·æ±‚äº¤ç»™<code>Adapter</code>å¤„ç†</p>
<p>Http11Processorçš„service æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">SocketState</span><span class="w"> </span><span class="nf">service</span><span class="p">(</span><span class="n">SocketWrapperBase</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">socketWrapper</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Parsing the request header</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">inputBuffer</span><span class="p">.</span><span class="na">parseRequestLine</span><span class="p">(</span><span class="n">keptAlive</span><span class="p">,</span><span class="w"> </span><span class="n">protocol</span><span class="p">.</span><span class="na">getConnectionTimeout</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">protocol</span><span class="p">.</span><span class="na">getKeepAliveTimeout</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">inputBuffer</span><span class="p">.</span><span class="na">getParsingRequestLinePhase</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">SocketState</span><span class="p">.</span><span class="na">UPGRADING</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">handleIncompleteRequestLineRead</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Process the Protocol component of the request line</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Need to know if this is an HTTP 0.9 request before trying to</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// parse headers.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">prepareRequestProtocol</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//è§£æå®Œåä¼šè°ƒç”¨adaptor çš„service æ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">getAdapter</span><span class="p">().</span><span class="na">service</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h4 id="è§£æè¯·æ±‚è¡Œ">è§£æè¯·æ±‚è¡Œ</h4>
<p>è§£æè¯·æ±‚è¡Œçš„æ“ä½œåœ¨Http11InputBufferçš„parseRequestLineä¸­è¿›è¡Œï¼Œ</p>
<ol>
<li>
<p>parseRequestLineä¼šè°ƒç”¨ç§æœ‰æ–¹æ³•<code>fill(boolean block) </code>,æ¥è¯»å–åŸå§‹çš„è¯·æ±‚æ•°æ®ï¼Œåœ¨è¿™é‡Œå®ƒå°±æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚</p>
<p>fillæ–¹æ³•ä¸­é€šè¿‡<code>nRead = socketWrapper.read(block, byteBuffer);</code> ä¼šå°†socket ä¸­çš„è¾“å…¥æµè¯»å–åˆ°Http11InputBufferä¸­çš„byteBufferä¸­</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240223154318886.png"
	width="3748"
	height="1494"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240223154318886_hu422a27446ff72e8453b218dd177bc600_887899_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240223154318886_hu422a27446ff72e8453b218dd177bc600_887899_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240223154318886"
	
	
		class="gallery-image" 
		data-flex-grow="250"
		data-flex-basis="602px"
	
></p>
</li>
<li>
<p>è·³è¿‡ç©ºè¡Œ</p>
</li>
<li>
<p>è§£æè¯·æ±‚æ–¹æ³•ï¼š ä»ç¬¬ä¸€ä¸ªå­—ç¬¦(Token)å¼€å§‹è¯»ï¼Œè¯»åˆ°ç©ºç™½(&rsquo; &lsquo;) æˆ–tab(&rsquo;\t&rsquo;) ç»“æŸï¼Œ è¿™ä¸€æ­¥ç»“æŸåå¯ä»¥å¾—åˆ°<code>GET</code>ï¼Œ ç„¶åé€šè¿‡<code>request.method().setBytes(byteBuffer.array(), parsingRequestLineStart,pos - parsingRequestLineStart)</code> æ¥ä¿å­˜è¯·æ±‚æ–¹æ³•ï¼Œæ³¨æ„æ­¤å¤„ä¿å­˜çš„æ˜¯æºç å…¨éƒ¨çš„å­—èŠ‚æ•°ç»„ï¼Œä»¥åŠGETåœ¨æ•°ç»„ä¸­å¯¹åº”çš„èµ·å§‹ä½ç½®ã€‚</p>
<blockquote>
<p>æ­¤å¤„çš„requestæ˜¯org.apache.coyote.Request, åœ¨Http11Processorå®ä¾‹åŒ–çš„æ—¶å€™æ„å»º, ç»´æŠ¤åœ¨<code>AbstractProcessor</code> ä¸­</p>
</blockquote>
</li>
<li>
<p>è§£æURI: ç»§ç»­å¾€ä¸‹è¯»å­—ç¬¦ï¼Œç›´åˆ°ç©ºç™½æˆ–æ¢è¡Œï¼Œä¾‹å¦‚è¿™ä¸€æ­¥ä¼šå¾—åˆ° <code>/my-app/ping</code> ç„¶åç±»ä¼¼çš„é€šè¿‡<code>request.requestURI().setBytes(byteBuffer.array(), parsingRequestLineStart,end - parsingRequestLineStart)</code> å°†è¿™éƒ¨åˆ†ä¿¡æ¯ä¿å­˜åœ¨requestä¸­ï¼Œè®°å½•URIåœ¨æ•°ç»„ä¸­èµ·å§‹ä½ç½®ã€‚</p>
</li>
<li>
<p>è§£æåè®®ï¼šç»§ç»­å¾€ä¸‹è¯»å­—ç¬¦ï¼Œç›´åˆ°ç©ºç™½æˆ–æ¢è¡Œï¼Œé€šè¿‡<code>request.protocol().setBytes(byteBuffer.array(), parsingRequestLineStart,end - parsingRequestLineStart)</code> å°†è¯·æ±‚æ‰€ç”¨çš„åè®®ä¾‹å¦‚HTTPä¿å­˜åœ¨requestä¸­ï¼Œè®°å½•åè®®åœ¨æ•°ç»„ä¸­èµ·å§‹ä½ç½®ã€‚</p>
</li>
</ol>
<p>requestä¸­çš„è¯·æ±‚åè®®ï¼Œæ–¹æ³•ï¼ŒURLç­‰æ¯ä¸€ä¸ªä¿¡æ¯éƒ½ç”¨<code>MessageBytes</code> ç±»å‹çš„å˜é‡æ¥å­˜å‚¨ï¼ŒMessageBytes å†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ª<code>ByteChunk</code> å­—èŠ‚å—ï¼Œä¸Šé¢è§£æå‡ºæ¥çš„è¯·æ±‚è¡Œä¿¡æ¯éƒ½ä¼šå˜æˆbytechunk åŠMessageByteå­˜å‚¨åˆ°requestä¸­ã€‚</p>
<h4 id="è§£æè¯·æ±‚å¤´">è§£æè¯·æ±‚å¤´</h4>
<p>è§£æè¯·æ±‚å¤´é€šè¿‡<code>inputBuffer.parseHeaders()</code> æ¥è¿›è¡Œï¼Œä¹Ÿæ˜¯æŒ‰ç…§HTTPåè®®æ¥è¿›è¡Œå­—ç¬¦çš„æ“ä½œåˆ¤æ–­è§£æå‡ºheaders, ç„¶åå­˜å‚¨åœ¨request ä¸­ã€‚</p>
<h3 id="å¤„ç†è¯·æ±‚">å¤„ç†è¯·æ±‚</h3>
<p>Adapterçš„åˆ›å»º</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//Adapter æ˜¯åœ¨connectoråˆå§‹åŒ–çš„æ—¶å€™åˆ›å»ºçš„</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initInternal</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">LifecycleException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Initialize adapter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">adapter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CoyoteAdapter</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">protocolHandler</span><span class="p">.</span><span class="na">setAdapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">protocolHandler</span><span class="p">.</span><span class="na">init</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LifecycleException</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;coyoteConnector.protocolHandlerInitializationFailed&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>CoyoteAdapterçš„service æ–¹æ³•ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">service</span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">coyote</span><span class="p">.</span><span class="na">Request</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">coyote</span><span class="p">.</span><span class="na">Response</span><span class="w"> </span><span class="n">res</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// æ­¤å¤„åˆ›å»ºçš„æ˜¯org.apache.catalina.connector.Request</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connector</span><span class="p">.</span><span class="na">createRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">request</span><span class="p">.</span><span class="na">setCoyoteRequest</span><span class="p">(</span><span class="n">req</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connector</span><span class="p">.</span><span class="na">createResponse</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">response</span><span class="p">.</span><span class="na">setCoyoteResponse</span><span class="p">(</span><span class="n">res</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// Link objects</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">request</span><span class="p">.</span><span class="na">setResponse</span><span class="p">(</span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">response</span><span class="p">.</span><span class="na">setRequest</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// Set as notes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">req</span><span class="p">.</span><span class="na">setNote</span><span class="p">(</span><span class="n">ADAPTER_NOTES</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">res</span><span class="p">.</span><span class="na">setNote</span><span class="p">(</span><span class="n">ADAPTER_NOTES</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="c1">// Set query string encoding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">req</span><span class="p">.</span><span class="na">getParameters</span><span class="p">().</span><span class="na">setQueryStringCharset</span><span class="p">(</span><span class="n">connector</span><span class="p">.</span><span class="na">getURICharset</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Parse and set Catalina and configuration specific</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// request parameters</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">postParseSuccess</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">postParseRequest</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">postParseSuccess</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Calling the container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">connector</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">getContainer</span><span class="p">().</span><span class="na">getPipeline</span><span class="p">().</span><span class="na">getFirst</span><span class="p">().</span><span class="na">invoke</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">isAsync</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">request</span><span class="p">.</span><span class="na">finishRequest</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">response</span><span class="p">.</span><span class="na">finishResponse</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Ignore</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æ³¨æ„æ­¤å¤„çš„ä¸€ä¸ªæ¯”è¾ƒé•¿çš„é“¾å¼è°ƒç”¨ï¼Œ<code>connector.getService().getContainer().getPipeline().getFirst().invoke(request, response)</code>,æ­¤å¤„æ¶‰åŠå¦ä¸¤ä¸ªè®¾è®¡ï¼Œ<code>Pipeline</code> å’Œ<code>Valve</code> ï¼Œåé¢è¡¥å……ã€‚</p>
<p>è€Œé»˜è®¤æƒ…å†µä¸‹è¿™é‡Œä¼šæ‰§è¡Œ<code>StandardEngineValve</code>çš„invokeæ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Select the Host to be used for this Request</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Host</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getHost</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Ask this Host to process this request</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">host</span><span class="p">.</span><span class="na">getPipeline</span><span class="p">().</span><span class="na">getFirst</span><span class="p">().</span><span class="na">invoke</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç„¶åEngineä¾æ—§é€šè¿‡ç±»ä¼¼çš„Pipeline åšæ³•æŠŠè¯·æ±‚äº¤ç»™Hostå¤„ç†ï¼Œé‚£ä¹ˆä¾æ¬¡ç±»æ¨ï¼Œä¸€å®šä¼šæ‰§è¡Œåˆ°<code>StandardHostValve</code>çš„invoke æ–¹æ³• ä¸­å»ï¼Œç„¶åStandardContextValve -&gt; StandardWrapperValve, å‰é¢è¯´åˆ°Wrapperç›¸å½“äºServlet, æˆ‘ä»¬çœ‹çœ‹StandardWrapperValveä¸­çš„å®ç°ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Servlet</span><span class="w"> </span><span class="n">servlet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">servlet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wrapper</span><span class="p">.</span><span class="na">allocate</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Create the filter chain for this request</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// å¤§åé¼é¼çš„Tomcat Filter æ¥å£</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ApplicationFilterChain</span><span class="w"> </span><span class="n">filterChain</span><span class="w"> </span><span class="o">=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">ApplicationFilterFactory</span><span class="p">.</span><span class="na">createFilterChain</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">wrapper</span><span class="p">,</span><span class="w"> </span><span class="n">servlet</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">filterChain</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="na">getRequest</span><span class="p">(),</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">getResponse</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™é‡Œå…³é”®æ­¥éª¤çœ‹åˆ° filterChain.doFilter(request.getRequest(), response.getResponse());å°±ç»“æŸäº†ï¼Œå†æ¥çœ‹<code>ApplicationFilterChain</code>çš„doFilteræ–¹æ³•ï¼Œ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doFilter</span><span class="p">(</span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">ServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">Globals</span><span class="p">.</span><span class="na">IS_SECURITY_ENABLED</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">internalDoFilter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">internalDoFilter</span><span class="p">(</span><span class="n">ServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="n">ServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// Call the next filter if there is one</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ApplicationFilterConfig</span><span class="w"> </span><span class="n">filterConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filters</span><span class="o">[</span><span class="n">pos</span><span class="o">++]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">Filter</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filterConfig</span><span class="p">.</span><span class="na">getFilter</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">Globals</span><span class="p">.</span><span class="na">IS_SECURITY_ENABLED</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="c1">// è¿è¡Œtomcat è¿‡æ»¤å™¨</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">filter</span><span class="p">.</span><span class="na">doFilter</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// We fell off the end of the chain -- call the servlet instance</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">servlet</span><span class="p">.</span><span class="na">service</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="p">){</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ç»ˆäºåœ¨ApplicationFilterChainä¸­è°ƒç”¨äº†<code>servlet.service(request, response)</code> !!!!!</p>
<h3 id="å°ç»“">å°ç»“</h3>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/tomcat%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B.png"
	width="1742"
	height="440"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/tomcat%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B_hue5cbee21db16f225f329ffd1c2d09bd6_65882_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/tomcat%E8%AF%B7%E6%B1%82%E8%BF%87%E7%A8%8B_hue5cbee21db16f225f329ffd1c2d09bd6_65882_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="tomcatè¯·æ±‚è¿‡ç¨‹"
	
	
		class="gallery-image" 
		data-flex-grow="395"
		data-flex-basis="950px"
	
></p>
<ol>
<li>
<p>Connector ä¸­æœ‰ä¸€ä¸ªå±æ€§å«protocolHandlerï¼Œ connectorè¿è¡Œstartæ–¹æ³•å, ä¼šè¿è¡Œ<code>protocolHandler.start()</code></p>
</li>
<li>
<p>protocolHandlerç»§æ‰¿<code>AbstractProtocol</code>, AbstractProtocolä¸­æœ‰ä¸ªå±æ€§å«endpointï¼Œ ä¼šåœ¨prorocolHandlerå®ä¾‹åŒ–çš„æ—¶å€™å®ä¾‹åŒ–EndPoint</p>
</li>
<li>
<p>AbstractProtocolçš„startæ–¹æ³•ï¼Œä¼šæ‰§è¡Œendpointçš„startæ–¹æ³•</p>
</li>
<li>
<p>endpoint start æ–¹æ³•ä¸­ä¼šåˆ†åˆ«å¼€å¯ä¸¤ä¸ªçº¿ç¨‹(ä»¥ä¸‹åŸºäº<code>NioEndPoint</code>ç±»çš„åˆ†æ)</p>
<ul>
<li>Poller çº¿ç¨‹ï¼Œ ç”¨æ¥æ¶ˆè´¹å’Œå¤„ç†è¯·æ±‚ï¼Œ Poller æ˜¯NioEndPointçš„å†…éƒ¨ç±»</li>
<li>Acceptorçº¿ç¨‹ï¼Œç”¨æ¥ç›‘å¬ç«¯å£å’Œæ¥æ”¶socketé“¾æ¥</li>
</ul>
</li>
<li>
<p>Acceptorçº¿ç¨‹run æ–¹æ³•</p>
<ul>
<li>åœ¨å¾ªç¯ä¼šè°ƒç”¨endpoint çš„serverSocketAcceptæ–¹æ³•æ¥æœ€ç»ˆæ‰§è¡ŒServerSocketChannel.accpet()æ–¹æ³•ï¼Œè¯·æ±‚åˆ°æ¥åä¼šè¿”å›ä¸€ä¸ªSocketChannel</li>
<li>ä¼šè°ƒç”¨<code>endpoint.setSocketOptions(socket)</code>æ–¹æ³•æ¥å°è£…sockerwrapper, å¹¶å‘Polleræ³¨å†ŒsocketWrapper</li>
<li>æ³¨å†ŒsocketWrapperçš„æ—¶å€™ä¼šåˆ›å»º<code>PollerEvent</code> å¹¶ç»´æŠ¤åœ¨Pollerå†…éƒ¨çš„eventsé˜Ÿåˆ—ä¸­</li>
</ul>
</li>
<li>
<p>Pollerçº¿ç¨‹run æ–¹æ³•</p>
<ul>
<li>å¾ªç¯ä¸­ä¸æ–­éå†eventsé˜Ÿåˆ—ï¼Œå¦‚æœæœ‰äº‹ä»¶åˆ™å–å‡ºsocketå¤„ç†ï¼Œæœ‰ä¸ªæ ¸å¿ƒæ–¹æ³•æ˜¯è°ƒç”¨AbstractEndpointçš„processSocketæ–¹æ³•</li>
<li>AbstractEndpointçš„processSocketä¸­ä¼šåˆ›å»ºSocketProcessorçº¿ç¨‹å¹¶äº¤ç»™çº¿ç¨‹æ± å»è¿è¡Œï¼ŒSocketProcessoræ˜¯EndPoint å­ç±»ä¸­çš„å†…éƒ¨ç±»</li>
</ul>
</li>
<li>
<p>SocketProcessorçº¿ç¨‹doRun æ–¹æ³•(run æ–¹æ³•ç”±çˆ¶ç±»è¦†å†™ç„¶åè°ƒç”¨å­ç±»çš„doRunæ–¹æ³•)</p>
<ul>
<li>è°ƒç”¨ConnectionHandler çš„process æ–¹æ³•ï¼ŒConnectionHandleræ˜¯AbstractProtocolçš„å†…éƒ¨ç±»</li>
<li>ConnectionHandler process æ–¹æ³•ä¸­ä¼šè°ƒç”¨Processoræ–¹æ³•processæ–¹æ³•æ¥å¤„ç†ï¼Œä¾‹å¦‚Http11Processor</li>
<li>Http11Processorç»§æ‰¿AbstractProcessorLightï¼ŒAbstractProcessorLightä¼šè°ƒç”¨å­ç±»çš„serviceæ–¹æ³•</li>
<li>ç„¶åHttp11Processorä¼šè§£æè¯·æ±‚è¡Œï¼Œè¯·æ±‚å¤´ï¼Œåšä¸€äº›é¢„å¤„ç†æ„å»ºcoyoteçš„Request å’ŒResponseï¼Œç„¶åé€šè¿‡è°ƒç”¨getAdapter().service(request, response)å°†è¯·æ±‚äº¤ç»™Adapterå¤„ç†</li>
</ul>
</li>
<li>
<p>Adapterçš„service æ–¹æ³•</p>
<ul>
<li>
<p>æ„å»ºorg.apache.catalina.connector.Request å’Œorg.apache.catalina.connector.Responseï¼Œä»–ä»¬å®ç°äº†HttpServletRequestå’ŒHttpServletResponse, æ‰€ä»¥è¿™é‡Œæœ¬è´¨ä¸Šæ˜¯æ„å»ºServletRequest å’ŒServletResponse</p>
</li>
<li>
<p>ç„¶åé€šè¿‡Pipeline å°†è¯·æ±‚äº¤ç»™å®¹å™¨å¤„ç†, <code>connector.getService().getContainer().getPipeline().getFirst().invoke(request,response)</code></p>
</li>
<li>
<p>é¦–å…ˆä¼šè°ƒç”¨StandardEngineValveçš„invokeæ–¹æ³•ï¼Œç„¶åä¾æ¬¡è°ƒç”¨StandardHostValveã€StandardContextValveã€StandardWrapperValve</p>
</li>
<li>
<p>StandardWrapperValveçš„invoke ä¸­ä¼šè·å–servlet, ç„¶ååˆ›å»ºApplicationFilterChainï¼Œè°ƒç”¨filterChain.doFilteræ–¹æ³•</p>
</li>
<li>
<p>ç„¶åæ‰§è¡Œtomcat çš„è¿‡æ»¤å™¨é“¾ï¼Œæœ€ç»ˆæ‰§è¡Œservlet.service(request, response)æ–¹æ³•</p>
</li>
</ul>
</li>
</ol>
<p>è¿˜æœ‰ä¸€äº›ç–‘é—®ï¼Œæ¯”å¦‚ï¼š</p>
<ol>
<li>Servlet æ˜¯ä»€ä¹ˆæ—¶å€™è¢«åŠ è½½çš„ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä»€ä¹ˆæ—¶å€™ç»“æŸçš„ï¼Ÿ</li>
<li>å¤„ç†è¯·æ±‚çš„servletæ˜¯å¦‚ä½•è¢«å®šä½åˆ°çš„ï¼Ÿ</li>
<li>Servlet å¤„ç†å®Œè¯·æ±‚åtomcatå¦‚ä½•å°†è¿”å›æ•°æ®å“åº”ç»™å®¢æˆ·ç«¯ï¼Ÿ</li>
</ol>
<h2 id="servlet-å’Œè¯·æ±‚çš„mapping">Servlet å’Œè¯·æ±‚çš„Mapping</h2>
<p>ä¸€ä¸ªè¯·æ±‚çš„æ ¼å¼å…¶å®åŒ…æ‹¬ip,port, path, é‚£ä¹ˆæ˜ å°„åˆ°tomcat ç»“æ„ä¸Šæ¥å…¶å®å°±æ˜¯è¦æ‰¾åˆ°å¯¹åº”çš„Host, Context, Wrapper(serlvelt).</p>
<p>æˆ‘ä»¬åœ¨<code>StandardEngineValve</code> çš„invoke æ–¹æ³•ä¸­å‘ç°å®ƒæ˜¯ç›´æ¥é€šè¿‡<code>Host host = request.getHost();</code> æ¥å®šä½åˆ°hostçš„ï¼Œhostç»´æŠ¤åœ¨<code>org.apache.catalina.connector.Request</code>å†…éƒ¨çš„MappingDataä¸­ï¼Œè€Œè¿™ä¸ªMappingDataè¿˜åŒ…å«Context, Wrapperç­‰ä¿¡æ¯ï¼Œ è¯´æ˜è¿™ä¸ªmapping å·¥ä½œå‘ç”Ÿåœ¨connector æŠŠè¯·æ±‚äº¤ç»™å®¹å™¨å¤„ç†ä¹‹å‰ï¼Œ æ‰€ä»¥éœ€è¦å…³æ³¨MappingDataæ˜¯å¦‚ä½•åˆ›å»ºçš„ã€‚</p>
<p><code>Http11Processor</code> äº¤ç»™Adapterçš„æ˜¯<code>org.apache.coyote.Request</code>,  <code>org.apache.catalina.connector.Request</code>æ˜¯åœ¨Adapterçš„service æ–¹æ³•ä¸­åˆæ¬¡æ„å»ºçš„ã€‚</p>
<p>åœ¨Adapterçš„<code>postParseRequest</code> æ–¹æ³•ä¸­æœ‰æ®µå…³é”®ä»£ç ï¼š</p>
<pre tabindex="0"><code>connector.getService().getMapper().map(serverName, decodedURI,
        version, request.getMappingData())
    
</code></pre><p>Mapper æ˜¯Serviceçš„ç»„ä»¶ï¼Œåœ¨service startçš„æ—¶å€™ä¼šstart mapperListenerï¼Œ ç„¶åé€šè¿‡<code>registerHost(host)</code> å°†host å°è£…ä¸ºMappedHostæ·»åŠ åˆ°Mapper å†…éƒ¨ç»´æŠ¤çš„<code>hosts</code> æ•°ç»„ä¸­ï¼Œ åŒæ—¶MappedHostå†…éƒ¨ç»´æŠ¤äº†ContextListï¼ŒContextList å†…éƒ¨ç»´æŠ¤MappedContextï¼ŒMappedContextå†…éƒ¨ç»´æŠ¤ContextVersionï¼ŒContextVersionå†…éƒ¨ç»´æŠ¤MappedWrapperï¼Œ ç”±æ­¤åˆæ„å»ºäº†ä¸€å¥—å±‚çº§å…³ç³»ã€‚</p>
<p>MappingDataå°±æ˜¯åœ¨è¿™é‡Œåˆå§‹åŒ–çš„ã€‚é€šè¿‡æŸ¥æ‰¾Mapper å†…éƒ¨ç»´æŠ¤çš„<code>hosts</code>å®šä½åˆ°Host åå°±å¯ä»¥å†å®šä½Context,  æœ€ç»ˆå®šä½åˆ°wrapper. åœ¨å¤„ç†è¯·æ±‚çš„æ—¶å€™ç›´æ¥å°±å¯ä»¥é€šè¿‡<code>request.getHost()</code>ã€<code>request.getContext();</code>ã€<code>request.getWrapper();</code>æ‰¾åˆ°å¯¹åº”çš„å®¹å™¨ç»„ä»¶çš„pipelineå»å¤„ç†è¯·æ±‚ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å‚æ•°ç¤ºä¾‹ï¼š map(&#34;localhost&#34;,&#34;/my-app/ping&#34;, null, mappingData)
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">map</span><span class="p">(</span><span class="n">MessageBytes</span><span class="w"> </span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">MessageBytes</span><span class="w"> </span><span class="n">uri</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">version</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">MappingData</span><span class="w"> </span><span class="n">mappingData</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">host</span><span class="p">.</span><span class="na">isNull</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">defaultHostName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">defaultHostName</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">defaultHostName</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">host</span><span class="p">.</span><span class="na">getCharChunk</span><span class="p">().</span><span class="na">append</span><span class="p">(</span><span class="n">defaultHostName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">host</span><span class="p">.</span><span class="na">toChars</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">uri</span><span class="p">.</span><span class="na">toChars</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">internalMap</span><span class="p">(</span><span class="n">host</span><span class="p">.</span><span class="na">getCharChunk</span><span class="p">(),</span><span class="w"> </span><span class="n">uri</span><span class="p">.</span><span class="na">getCharChunk</span><span class="p">(),</span><span class="w"> </span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="n">mappingData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// é‡ç‚¹æ˜¯è¿™ä¸ªinternalMapæ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">internalMap</span><span class="p">(</span><span class="n">CharChunk</span><span class="w"> </span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">CharChunk</span><span class="w"> </span><span class="n">uri</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">version</span><span class="p">,</span><span class="w"> </span><span class="n">MappingData</span><span class="w"> </span><span class="n">mappingData</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Virtual host mapping</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MappedHost</span><span class="o">[]</span><span class="w"> </span><span class="n">hosts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">hosts</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MappedHost</span><span class="w"> </span><span class="n">mappedHost</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exactFindIgnoreCase</span><span class="p">(</span><span class="n">hosts</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mappingData</span><span class="p">.</span><span class="na">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mappedHost</span><span class="p">.</span><span class="na">object</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Context mapping</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ContextList</span><span class="w"> </span><span class="n">contextList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mappedHost</span><span class="p">.</span><span class="na">contextList</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MappedContext</span><span class="o">[]</span><span class="w"> </span><span class="n">contexts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contextList</span><span class="p">.</span><span class="na">contexts</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="n">contexts</span><span class="p">,</span><span class="w"> </span><span class="n">uri</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ContextVersion</span><span class="w"> </span><span class="n">contextVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ContextVersion</span><span class="o">[]</span><span class="w"> </span><span class="n">contextVersions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">versions</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">versionCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contextVersions</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">versionCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Context</span><span class="o">[]</span><span class="w"> </span><span class="n">contextObjects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Context</span><span class="o">[</span><span class="n">contextVersions</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">contextObjects</span><span class="p">.</span><span class="na">length</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">contextObjects</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contextVersions</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">.</span><span class="na">object</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">mappingData</span><span class="p">.</span><span class="na">contexts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contextObjects</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">contextVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exactFind</span><span class="p">(</span><span class="n">contextVersions</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">contextVersion</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Return the latest version</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// The versions array is known to contain at least one element</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">contextVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contextVersions</span><span class="o">[</span><span class="n">versionCount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">1</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mappingData</span><span class="p">.</span><span class="na">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contextVersion</span><span class="p">.</span><span class="na">object</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mappingData</span><span class="p">.</span><span class="na">contextSlashCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">contextVersion</span><span class="p">.</span><span class="na">slashCount</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Wrapper mapping</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">contextVersion</span><span class="p">.</span><span class="na">isPaused</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">internalMapWrapper</span><span class="p">(</span><span class="n">contextVersion</span><span class="p">,</span><span class="w"> </span><span class="n">uri</span><span class="p">,</span><span class="w"> </span><span class="n">mappingData</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="å“åº”è¿‡ç¨‹">å“åº”è¿‡ç¨‹</h2>
<p>åœ¨æœ€ç®€tomcatä¸€èŠ‚ä¸­æˆ‘ä»¬çŸ¥é“å…¶å®å“åº”å°±æ˜¯å‘socketå¯¹è±¡çš„outputStreamä¸­å†™å…¥æ•°æ®ï¼Œè€Œtomcatå°†è¯·æ±‚äº¤ç»™servletå¤„ç†æ—¶æ˜¯å°†å°è£…å¥½çš„ServletRequest å’Œ ServletResponseçš„éƒ½äº¤ç»™äº†servletçš„ã€‚</p>
<blockquote>
<pre tabindex="0"><code>servlet.service(request, response);
</code></pre></blockquote>
<p>çœ‹ä¸‹é¢è¿™ä¸ªç®€å•çš„Servlet, ä»¥è¿™ä¸ªservletä¸ºä¾‹æˆ‘ä»¬çœ‹çœ‹HTTPå“åº”æ˜¯æ€ä¹ˆè¿›è¡Œçš„</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SampleServlet</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">HttpServlet</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doGet</span><span class="p">(</span><span class="n">HttpServletRequest</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">HttpServletResponse</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="p">,</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">response</span><span class="p">.</span><span class="na">getWriter</span><span class="p">().</span><span class="na">write</span><span class="p">(</span><span class="s">&#34;Pong!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>é€šè¿‡<code>response.getWriter().write(&quot;Pong!&quot;);</code> æ¥å“åº”ï¼Œå“åº”å®Œåæˆ‘ä»¬å°±å¯ä»¥åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°&quot;Pong!&quot;.</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/tomcat%E5%93%8D%E5%BA%94.png"
	width="2919"
	height="742"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/tomcat%E5%93%8D%E5%BA%94_hud89dadefebfab05ab03ccab5bcabede2_204672_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/tomcat%E5%93%8D%E5%BA%94_hud89dadefebfab05ab03ccab5bcabede2_204672_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="tomcatå“åº”"
	
	
		class="gallery-image" 
		data-flex-grow="393"
		data-flex-basis="944px"
	
></p>
<p>â€‹</p>
<p>å¯ä»¥çœ‹åˆ°å†™å…¥å“åº”æ—¶ä¼šå…ˆå†™å…¥ç¼“å­˜ä¸­ï¼Œæœ€åç»Ÿä¸€å°†ç¼“å­˜æ•°æ®åˆ·æ–°åˆ°socketä¸­ã€‚</p>
<h2 id="pipeline-å’Œ-valve">Pipeline å’Œ Valve</h2>
<p><code>pipeline</code> æ˜¯<code>ContainerBase</code> æŠ½è±¡ç±»ä¸­çš„ä¸€ä¸ªå±æ€§, å…·ä½“å®ä¾‹åŒ–äº†ä¸€ä¸ªStandardPipelineï¼Œå¹¶é€šè¿‡<code>Container</code> æ¥å£æš´éœ²äº†getPipelineæ–¹æ³•ï¼Œæ‰€ä»¥Engine, Context, Host, Wrapperç­‰ç»„ä»¶éƒ½ä¼šæœ‰è¿™ä¸ªå±æ€§ã€‚è€Œpipelineä¸­ç»´æŠ¤çš„æ˜¯ä¸€ç³»åˆ—çš„Valveã€‚</p>
<h3 id="pipeline">Pipeline</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Pipeline</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Contained</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Valve</span><span class="w"> </span><span class="nf">getBasic</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setBasic</span><span class="p">(</span><span class="n">Valve</span><span class="w"> </span><span class="n">valve</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addValve</span><span class="p">(</span><span class="n">Valve</span><span class="w"> </span><span class="n">valve</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Valve</span><span class="o">[]</span><span class="w"> </span><span class="nf">getValves</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">removeValve</span><span class="p">(</span><span class="n">Valve</span><span class="w"> </span><span class="n">valve</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Valve</span><span class="w"> </span><span class="nf">getFirst</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAsyncSupported</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">findNonAsyncValves</span><span class="p">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">result</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="valve">Valve</h3>
<p>Valveæ˜¯ä¸€ä¸ªç±»ä¼¼å•å‘é“¾è¡¨çš„ç»“æ„ï¼Œå¯ä»¥é€šè¿‡<code>getNext</code> æ‰¾åˆ°ä¸‹ä¸€ä¸ªValve, å¹¶ä¸”æœ‰ä¸€ä¸ªæ ¸å¿ƒæ–¹æ³•<code>invoke(Request request, Response response)</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Valve</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Valve</span><span class="w"> </span><span class="nf">getNext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setNext</span><span class="p">(</span><span class="n">Valve</span><span class="w"> </span><span class="n">valve</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">backgroundProcess</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="n">Request</span><span class="w"> </span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="p">,</span><span class="w"> </span><span class="n">ServletException</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAsyncSupported</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>è¿™æ—¶å€™å†æ¥å›é¡¾<code>connector.getService().getContainer().getPipeline().getFirst().invoke(request,response)</code>è¿™æ®µAdapterçš„service æ–¹æ³•å°†è¯·æ±‚äº¤ç»™å®¹å™¨å¤„ç†çš„ä»£ç ï¼Œå°±èƒ½æ˜ç™½äº†.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">StandardPipeline</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">LifecycleBase</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Pipeline</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">//è°ƒç”¨getFirst çš„æ—¶å€™ï¼Œå¦‚æœæœ‰firstå°±è¿”å›å¦åˆ™è¿”å›basic  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">Valve</span><span class="w"> </span><span class="nf">getFirst</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">first</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">basic</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="valveæ˜¯æ€ä¹ˆæ·»åŠ çš„">Valveæ˜¯æ€ä¹ˆæ·»åŠ çš„</h3>
<ul>
<li>
<p>StandardEngine</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219111936769.png"
	width="1908"
	height="640"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219111936769_hu0cd360a6832c9cfa5182b22003297a28_152461_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219111936769_hu0cd360a6832c9cfa5182b22003297a28_152461_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240219111936769"
	
	
		class="gallery-image" 
		data-flex-grow="298"
		data-flex-basis="715px"
	
></p>
</li>
<li>
<p>StandardHost</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219112157125.png"
	width="1256"
	height="332"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219112157125_hu361a2aa321ef98f0e22eebba95804047_37319_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219112157125_hu361a2aa321ef98f0e22eebba95804047_37319_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240219112157125"
	
	
		class="gallery-image" 
		data-flex-grow="378"
		data-flex-basis="907px"
	
></p>
<p>æ„é€ å‡½æ•°ä¸­ä¹Ÿæ˜¯é»˜è®¤è®¾ç½®äº†ä¸€ä¸ªbasic valve,  æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡web.xml æ¥é…ç½®ï¼Œè¿™å…¶å®æ˜¯tomcat ç•™ç»™æˆ‘ä»¬çš„æ‰©å±•ç‚¹ã€‚</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219112739302.png"
	width="2494"
	height="978"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219112739302_hu545b2ec9a3dfb5640dd0177a4056ff40_222474_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219112739302_hu545b2ec9a3dfb5640dd0177a4056ff40_222474_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240219112739302"
	
	
		class="gallery-image" 
		data-flex-grow="255"
		data-flex-basis="612px"
	
></p>
<p>é‚£å¯¹äºHostè€Œè¨€è¿™ä¸¤ä¸ªvalveçš„é¡ºåºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>é¦–å…ˆè‚¯å®šæ˜¯æ‰§è¡ŒHostç»„ä»¶çš„æ„é€ å‡½æ•°ï¼Œæ‰€ä»¥ä¼šå…ˆè®¾ç½®basic valve, ç„¶åè§£æåˆ°<code>&lt;Valve&gt;</code> æ ‡ç­¾ä¼šæ ¹æ®é…ç½®çš„digister <code>SetNextRule</code> æ¥è°ƒç”¨addValve.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addValve</span><span class="p">(</span><span class="n">Valve</span><span class="w"> </span><span class="n">valve</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">first</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valve</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">valve</span><span class="p">.</span><span class="na">setNext</span><span class="p">(</span><span class="n">basic</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Valve</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="na">getNext</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">basic</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">current</span><span class="p">.</span><span class="na">setNext</span><span class="p">(</span><span class="n">valve</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">valve</span><span class="p">.</span><span class="na">setNext</span><span class="p">(</span><span class="n">basic</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="na">getNext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°å¦‚æœpipeline ä¸­firstä¸ºnull, åˆ™server.xml ä¸­é…ç½®çš„ç¬¬ä¸€ä¸ªvalveå°±æ˜¯first, å¦‚æœfirstä¸ä¸ºç©ºï¼Œå°±æŠŠè¿™ä¸ªvalve ä½œä¸ºfirst çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œ basic æ°¸è¿œæ˜¯é“¾è¡¨ä¸­æœ€åä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
</li>
<li>
<p>StandardContext</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219113136664.png"
	width="1646"
	height="540"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219113136664_hu0bd6e7ef73cab5d280aba3302b37e837_116255_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219113136664_hu0bd6e7ef73cab5d280aba3302b37e837_116255_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240219113136664"
	
	
		class="gallery-image" 
		data-flex-grow="304"
		data-flex-basis="731px"
	
></p>
</li>
<li>
<p>StandardWrapper</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219113212734.png"
	width="1812"
	height="370"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219113212734_hu62c2f15c36ae95875203524bbd56512a_68035_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240219113212734_hu62c2f15c36ae95875203524bbd56512a_68035_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240219113212734"
	
	
		class="gallery-image" 
		data-flex-grow="489"
		data-flex-basis="1175px"
	
></p>
</li>
</ul>
<p><strong>å°ç»“</strong></p>
<ol>
<li>Engine/Host/Context/Wrapper ç»„ä»¶åœ¨åˆå§‹åŒ–çš„æ„é€ æ–¹æ³•ä¸­ä¼šè®¾ç½®basic valve</li>
<li>æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶çš„æ–¹å¼æ·»åŠ å…¶ä»–valve, æ·»åŠ çš„ç¬¬ä¸€ä¸ªvalve ä¼šä½œä¸ºfirst value, ä¾æ¬¡æ„å»ºä¸€ä¸ªé“¾è¡¨ï¼Œbasic valveä¼šä½œä¸ºé“¾è¡¨ä¸Šæœ€åä¸€ä¸ªèŠ‚ç‚¹</li>
</ol>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/Pipeline-and-Valve.png"
	width="1111"
	height="297"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/Pipeline-and-Valve_hu70302cdf17f08567660ed68195d87643_45580_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/Pipeline-and-Valve_hu70302cdf17f08567660ed68195d87643_45580_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="Pipeline å’ŒValve"
	
	
		class="gallery-image" 
		data-flex-grow="374"
		data-flex-basis="897px"
	
></p>
<h3 id="valve-ä»€ä¹ˆæ—¶å€™ä¼šè¿è¡Œ">Valve ä»€ä¹ˆæ—¶å€™ä¼šè¿è¡Œ</h3>
<ol>
<li>è¯·æ±‚åˆ°è¾¾å®¹å™¨ä¹‹å‰ä¼šç”±Adapterçš„service æ–¹æ³•å°†è¯·æ±‚äº¤ç»™å®¹å™¨ï¼Œå…³é”®æ–¹æ³•æ˜¯<code>connector.getService().getContainer().getPipeline().getFirst().invoke(request,response)</code></li>
<li>æ­¤æ—¶ä¼šè°ƒç”¨Engine çš„first valveçš„invoke æ–¹æ³•, å¦‚æœæ²¡æœ‰first åˆ™è°ƒç”¨ basic value.</li>
<li>å½“æŸä¸€å±‚å®¹å™¨çš„pipeline ä¸­æœ‰å¤šä¸ªvalveæ—¶ï¼Œåœ¨ä¸€ä¸ªvalveæ‰§è¡Œçš„æœ€åä¼šé€šè¿‡<code>getNext().invoke(request, response);</code>è°ƒç”¨ä¸‹ä¸€ä¸ªValve, ç›´åˆ°æœ€åè°ƒç”¨åˆ°basic valve</li>
<li>basic valveæ˜¯valve é“¾ä¸­æœ€åä¸€ä¸ªèŠ‚ç‚¹(æœ€åæ‰§è¡Œï¼‰ï¼Œè¿™æ—¶ä¸Šå±‚å®¹å™¨åˆä¼šè°ƒç”¨ä¸‹ä¸€å±‚å®¹å™¨çš„pipeline ä¸­çš„valve çš„invoke æ–¹æ³•ï¼Œä¾æ¬¡ç±»æ¨</li>
</ol>
<h2 id="tomcatçš„ç±»åŠ è½½æœºåˆ¶">Tomcatçš„ç±»åŠ è½½æœºåˆ¶</h2>
<p>åœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬æåˆ°æœ€åtomcatä¼šå°†è¯·æ±‚äº¤ç»™servletæ¥å¤„ç†ï¼Œä½†servletæ˜¯ä»€ä¹ˆæ—¶å€™è¢«åŠ è½½å’Œåˆå§‹åŒ–çš„å‘¢ï¼Ÿ</p>
<p>å¯èƒ½æœ€å¿«æƒ³åˆ°çš„æ˜¯åˆ©ç”¨ç±»åŠ è½½å™¨å»åŠ è½½webapp å„ä¸ªåº”ç”¨ä¸‹é¢çš„classes æ–‡ä»¶ï¼ŒæŠŠä»–ä»¬å˜æˆå¯æ‰§è¡Œçš„å¯¹è±¡ï¼Œä½†æ˜¯å€˜è‹¥ä¸åŒçš„åº”ç”¨ä¸‹é¢å‡å¦‚éƒ½æœ‰ä¸€ä¸ª<code>MyApp</code> ç±»ï¼Œç±»åç›¸åŒä½†æ˜¯å®ç°ä¸åŒï¼Œtomcatæœ¬èº«æ˜¯ä¸€ä¸ªjavaè¿›ç¨‹ï¼Œæ ¹æ®Jdkçš„åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå¦‚æœä¸åšå¤„ç†å½“å°è¯•å»åŠ è½½ç¬¬äºŒä¸ªMyApp çš„æ—¶å€™ä¼šå¤ç”¨ä¹‹å‰å·²ç»åŠ è½½å¥½çš„MyApp(ä¸ºä»€ä¹ˆ?), ä»è€Œå¯¼è‡´è¡Œä¸ºå’Œé¢„æœŸçš„ä¸ä¸€è‡´ï¼Œæ‰€ä»¥tomcat ä¸ºäº†éš”ç¦»å„ä¸ªåº”ç”¨ï¼Œä¼šæ‰“ç ´è¿™ä¸ªåŒäº²å§”æ´¾æ¨¡å‹ã€‚</p>
<h3 id="jdkç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾æ¨¡å‹">JDKç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾æ¨¡å‹</h3>
<h4 id="ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨">ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨ï¼Ÿ</h4>
<p>è¯´ç™½äº†ï¼Œæˆ‘ä»¬å†™çš„ä»£ç æ˜¯å­˜åœ¨ä»¥<code>java</code> ä¸ºåç¼€çš„æ–‡ä»¶ä¸­ï¼Œç„¶åJDKé€šè¿‡ç¼–è¯‘å™¨å°†java æ–‡ä»¶ç¼–è¯‘æˆclassæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯å­—èŠ‚ç æ–‡ä»¶ï¼Œä½†å­—èŠ‚ç æ˜¯ä¸€ç§ä¸èƒ½ç”±ç¡¬ä»¶ç›´æ¥æ‰§è¡Œçš„ä¸­é—´ä»£ç ï¼Œåªèƒ½è¢«JVMè£…è½½å¹¶è§£é‡Šæ‰§è¡Œï¼Œç„¶åç±»åŠ è½½å™¨çš„ä½œç”¨å°±æ˜¯æŠŠè¿™äº›è¿™äº›å­—èŠ‚ç åŠ è½½åˆ°å†…å­˜ä¸­å¹¶åœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¯¥ç±»çš„Classå¯¹è±¡ï¼Œ æœ€åç”±æ‰§è¡Œå™¨æŠŠå®ƒç¿»è¯‘æˆæœºå™¨ç ç„¶åäº¤ç»™æœºå™¨æ‰§è¡Œã€‚</p>
<p>Javaè™šæ‹Ÿæœºå®šä¹‰äº†ä¸‰ç§ç±»åŠ è½½å™¨ï¼š</p>
<ul>
<li><strong>å¯åŠ¨ç±»åŠ è½½å™¨</strong>ï¼ˆBootstrap Class Loaderï¼‰ï¼š é€šå¸¸ç”±æœ¬åœ°ä»£ç å®ç°ï¼Œä¹Ÿç§°ä¸ºæ ¹ç±»åŠ è½½å™¨ï¼Œå®ƒè´Ÿè´£åŠ è½½%JAVA_HOME%/libè·¯å¾„ä¸‹Javaè™šæ‹Ÿæœºçš„æ ¸å¿ƒç±»åº“</li>
<li><strong>æ‰©å±•ç±»åŠ è½½å™¨</strong>ï¼ˆExtension Class Loaderï¼‰ï¼šå®ƒæ˜¯ç”¨æ¥åŠ è½½Javaæ‰©å±•ç±»åº“çš„ç±»åŠ è½½å™¨ã€‚æ‰©å±•ç±»åº“åŒ…æ‹¬<code>javax</code>å’Œ<code>java.util</code>ç­‰åŒ…ï¼Œå®ƒä»¬ä½äº<code>jre/lib/ext</code>ç›®å½•ä¸‹</li>
<li><strong>åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨</strong>ï¼ˆApplication Class Loaderï¼‰ï¼šä¹Ÿç§°ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œå®ƒè´Ÿè´£åŠ è½½%CLASSPATH%è·¯å¾„ä¸‹åº”ç”¨ç¨‹åºçš„ç±»ã€‚</li>
</ul>
<p>æˆ‘ä»¬åœ¨å¯åŠ¨javaè¿›ç¨‹çš„æ—¶å€™é€šå¸¸éœ€è¦ä¼ é€’ä¸€ä¸ª<code>classpath</code> å‚æ•°ï¼Œä¾‹å¦‚é€šè¿‡IDEA æºç å¯åŠ¨tomcatæ—¶å¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°å¯åŠ¨å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/Users/hf/Documents/developer/jdk/zulu21.30.15-ca-jdk21.0.1-macosx_aarch64/bin/java -agentlib:jdwp<span class="o">=</span><span class="nv">transport</span><span class="o">=</span>dt_socket,address<span class="o">=</span>127.0.0.1:64807,suspend<span class="o">=</span>y,server<span class="o">=</span>n 
</span></span><span class="line"><span class="cl">-Dcatalina.home<span class="o">=</span>/Users/hf/IdeaProjects/tomcat/output/build/ 
</span></span><span class="line"><span class="cl">-Dcatalina.base<span class="o">=</span>/Users/hf/IdeaProjects/tomcat/output/build/ 
</span></span><span class="line"><span class="cl">-javaagent:/Users/hf/Library/Caches/JetBrains/IntelliJIdea2024.1/captureAgent/debugger-agent.jar 
</span></span><span class="line"><span class="cl">-Dfile.encoding<span class="o">=</span>UTF-8 -Dsun.stdout.encoding<span class="o">=</span>UTF-8 
</span></span><span class="line"><span class="cl">-Dsun.stderr.encoding<span class="o">=</span>UTF-8 
</span></span><span class="line"><span class="cl">-classpath /Users/hf/IdeaProjects/tomcat/.idea/output/production/tomcat:/opt/homebrew/Cellar/ant/1.10.14/libexec/lib/ant.jar ...
</span></span><span class="line"><span class="cl">org.apache.catalina.startup.Bootstrap
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ä¼ é€’äº†classpathå‚æ•°ï¼Œä¸ä¼ é€’åˆ™é»˜è®¤å½“å‰ç›®å½•ã€‚æˆ‘ä»¬è‡ªå·±å†™çš„javaä»£ç é€šå¸¸ç”±App class loader æ¥åŠ è½½ã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">loadedClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ClassLoader</span><span class="p">.</span><span class="na">getSystemClassLoader</span><span class="p">().</span><span class="na">loadClass</span><span class="p">(</span><span class="s">&#34;org.apache.catalina.startup.MyClass&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">MyClass</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">MyClass</span><span class="p">)</span><span class="w"> </span><span class="n">loadedClass</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">().</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">object</span><span class="p">.</span><span class="na">hi</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">NoSuchMethodException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InstantiationException</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InvocationTargetException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">class</span> <span class="nc">MyClass</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">hi</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&#34;Hello, class loader!&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">  
</span></span></span></code></pre></div><h4 id="è‡ªå®šä¹‰ç±»åŠ è½½å™¨">è‡ªå®šä¹‰ç±»åŠ è½½å™¨</h4>
<p>è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å¿…é¡»ç»§æ‰¿<code>java.lang.ClassLoader</code>, å¹¶è¦†å†™<code>findClass</code>æ–¹æ³•ï¼ŒfindClass æ–¹æ³•ä¼šè¢«loadClassè°ƒç”¨ï¼Œä¸‹é¢æ˜¯Classloaderç±»ä¸­loadClass æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">loadClass</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">resolve</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">getClassLoadingLock</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// First, check if the class has already been loaded</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findLoadedClass</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="kt">long</span><span class="w"> </span><span class="n">t0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parent</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="p">.</span><span class="na">loadClass</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findBootstrapClassOrNull</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// ClassNotFoundException thrown if class not found</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// from the non-null parent class loader</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// If still not found, then invoke findClass in order</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// to find the class.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="kt">long</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">nanoTime</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findClass</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="c1">// this is the defining class loader; record the stats</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">PerfCounter</span><span class="p">.</span><span class="na">getParentDelegationTime</span><span class="p">().</span><span class="na">addTime</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">PerfCounter</span><span class="p">.</span><span class="na">getFindClassTime</span><span class="p">().</span><span class="na">addElapsedTimeFrom</span><span class="p">(</span><span class="n">t1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">PerfCounter</span><span class="p">.</span><span class="na">getFindClasses</span><span class="p">().</span><span class="na">increment</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">resolveClass</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°åŸºæœ¬æµç¨‹å°±æ˜¯:</p>
<ol>
<li>æŸ¥çœ‹æŸä¸ªç±»æ˜¯å¦å·²ç»è¢«åŠ è½½ï¼Œä¼šé€šè¿‡è°ƒç”¨native æ–¹æ³•findLoadedClass0ï¼Œå¦‚æœå·²ç»åŠ è½½å°±è¿”å›</li>
<li>å¦‚æœæ²¡è¢«åŠ è½½å°±å…ˆå°è¯•ç”¨çˆ¶ç±»åŠ è½½å™¨(Extention class loader)åŠ è½½</li>
<li>çˆ¶ç±»åŠ è½½å™¨è¿˜åŠ è½½ä¸åˆ°çš„è¯å°±ä¼šè°ƒç”¨findClassæ–¹æ³•</li>
</ol>
<p>è¿™å’Œæˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„åŒäº²å§”æ´¾æ¨¡å‹çš„æ€æƒ³æ˜¯ä¸€æ ·çš„ï¼Œä¸‹é¢ç»™å‡ºä¸€ä¸ªfindClass çš„å†™æ³•ç¤ºä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">protected</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">findClass</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// class æ–‡ä»¶å¯ä»¥æ”¾åˆ°ä»»ä½•ç›®å½•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fileInputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="s">&#34;/Users/hf/IdeaProjects/tomcat/MyClass.class&#34;</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fileInputStream</span><span class="p">.</span><span class="na">readAllBytes</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">defineClass</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">bytes</span><span class="p">.</span><span class="na">length</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// æµ‹è¯•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testClassLoader</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">MyClassLoader</span><span class="w"> </span><span class="n">myClassLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">loadedClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myClassLoader</span><span class="p">.</span><span class="na">loadClass</span><span class="p">(</span><span class="s">&#34;MyClass&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadedClass</span><span class="p">.</span><span class="na">getDeclaredConstructor</span><span class="p">().</span><span class="na">newInstance</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadedClass</span><span class="p">.</span><span class="na">getMethod</span><span class="p">(</span><span class="s">&#34;hi&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">NoSuchMethodException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InstantiationException</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="n">IllegalAccessException</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">InvocationTargetException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h3 id="tomcatçš„ç±»åŠ è½½å™¨">Tomcatçš„ç±»åŠ è½½å™¨</h3>
<p>Tomcat æ‹¥æœ‰ä¸åŒçš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä»¥å®ç°å¯¹å„ç§èµ„æºåº“çš„æ§åˆ¶ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒTomcat ä¸»è¦ç”¨ç±»åŠ è½½å™¨è§£å†³ä»¥ä¸‹ 4 ä¸ªé—®é¢˜ã€‚</p>
<ul>
<li>
<p>å„ä¸ªWebåº”ç”¨ä¹‹é—´å„è‡ªä½¿ç”¨çš„Javaç±»åº“è¦<strong>äº’ç›¸éš”ç¦»</strong> &mdash; WebappClassLoaderã€‚</p>
</li>
<li>
<p>å„ä¸ªWebåº”ç”¨ä¹‹é—´å¯ä»¥<strong>æä¾›å…±äº«</strong>çš„Javaç±»åº“ &mdash; SharedClassLoaderã€‚</p>
</li>
<li>
<p>Tomcatæœ¬èº«çš„ç±»å’ŒWebåº”ç”¨çš„ç±»è¦<strong>äº’ç›¸éš”ç¦»</strong> &mdash; CatalinaClassLoaderã€‚</p>
</li>
</ul>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/Tomcat%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8.png"
	width="1123"
	height="759"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/Tomcat%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8_hu4d6539e87a4b9aabb92808e52e832412_102792_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/Tomcat%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8_hu4d6539e87a4b9aabb92808e52e832412_102792_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="Tomcat ç±»åŠ è½½å™¨"
	
	
		class="gallery-image" 
		data-flex-grow="147"
		data-flex-basis="355px"
	
></p>
<p>WebappClassLoaderBaseçš„startæ–¹æ³•çš„æºä»£ç ä¸­å¹¶æ²¡æœ‰çœ‹åˆ°æˆ‘ä»¬ä»¥ä¸ºçš„<code>findClass</code> æˆ–<code>loadClass</code> æ“ä½œï¼Œé‚£åŠ è½½servletæ˜¯ä»€ä¹ˆæ—¶å€™è¿›è¡Œçš„ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// WebappClassLoaderBaseçš„startæ–¹æ³•</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">LifecycleException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LifecycleState</span><span class="p">.</span><span class="na">STARTING_PREP</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">WebResource</span><span class="o">[]</span><span class="w"> </span><span class="n">classesResources</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resources</span><span class="p">.</span><span class="na">getResources</span><span class="p">(</span><span class="s">&#34;/WEB-INF/classes&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">WebResource</span><span class="w"> </span><span class="n">classes</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">classesResources</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">classes</span><span class="p">.</span><span class="na">isDirectory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">classes</span><span class="p">.</span><span class="na">canRead</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">localRepositories</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">classes</span><span class="p">.</span><span class="na">getURL</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">WebResource</span><span class="o">[]</span><span class="w"> </span><span class="n">jars</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resources</span><span class="p">.</span><span class="na">listResources</span><span class="p">(</span><span class="s">&#34;/WEB-INF/lib&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">WebResource</span><span class="w"> </span><span class="n">jar</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">jars</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">jar</span><span class="p">.</span><span class="na">getName</span><span class="p">().</span><span class="na">endsWith</span><span class="p">(</span><span class="s">&#34;.jar&#34;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">jar</span><span class="p">.</span><span class="na">isFile</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">jar</span><span class="p">.</span><span class="na">canRead</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">localRepositories</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">jar</span><span class="p">.</span><span class="na">getURL</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">jarModificationTimes</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">jar</span><span class="p">.</span><span class="na">getName</span><span class="p">(),</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">jar</span><span class="p">.</span><span class="na">getLastModified</span><span class="p">()));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LifecycleState</span><span class="p">.</span><span class="na">STARTED</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ç­”æ¡ˆæ˜¯æœ‰ä¸¤æ¬¡ã€‚</p>
<p>ç¬¬ä¸€æ¬¡é€šè¿‡LifeCycleEventå¤„ç†æ³¨è§£æ—¶åŠ è½½çš„ã€‚</p>
<p><code>StandardContext#startInternal</code> -&gt; <code>fireLifecycleEvent(Lifecycle.CONFIGURE_START_EVENT, null)</code> -&gt; <code>ContextConfig#lifecycleEvent</code> -&gt; <code>configureStart</code> -&gt; <code>applicationAnnotationsConfig</code> -&gt; <code>WebAnnotationSet.loadApplicationAnnotations(context)</code> -&gt; <code>WebAnnotationSet#loadApplicationServletAnnotations</code> -&gt; <code>Introspection.loadClass(context, wrapper.getServletClass())</code> -&gt; <code>cl.loadClass(className)</code></p>
<p>ç¬¬äºŒæ¬¡æ˜¯è¯·æ±‚åˆ°æ¥æ—¶å»å°è¯•åŠ è½½å¹¶å®ä¾‹åŒ–Servlet, ç¬¬ä¸€æ¬¡å¦‚æœå·²ç»åŠ è½½äº†classåˆ™ä¼šå¤ç”¨ã€‚</p>
<p><code>StandardWrapper#invoke</code> -&gt; <code>StandardWrapper#allocate</code> -&gt; <code>StandardWrapper#loadServlet</code> -&gt; <code>InstanceManager.newInstance(servletClass)</code> -&gt; <code>DefaultInstanceManager#newInstance</code> -&gt; <code>classLoader.loadClass(className)</code></p>
<h3 id="tomcat-æ˜¯å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹çš„">Tomcat æ˜¯å¦‚ä½•æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹çš„ï¼Ÿ</h3>
<p>äº†è§£è¿™ä¸ªé—®é¢˜éœ€è¦çœ‹WebappClassLoaderBaseçš„æºç ï¼Œé‡ç‚¹æ˜¯findClass æ–¹æ³•å’ŒloadClass æ–¹æ³•</p>
<p><strong>loadClass</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">loadClass</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">resolve</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">JreCompat</span><span class="p">.</span><span class="na">isGraalAvailable</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">getClassLoadingLock</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">..</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// (0) Check our previously loaded local class cacheï¼Œæ£€æŸ¥tomcatè‡ªå·±çš„ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findLoadedClass0</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// (0.1) Check our previously loaded class cache, æ£€æŸ¥jvmçš„ç¼“å­˜</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JreCompat</span><span class="p">.</span><span class="na">isGraalAvailable</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">findLoadedClass</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// (0.2) Try loading the class with the bootstrap class loader, to prevent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//       the webapp from overriding Java SE classes. This implements</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">//       SRV.10.7.2ï¼Œ é˜²æ­¢è¦†ç›–ç³»ç»Ÿçš„æ ¸å¿ƒç±»</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">resourceName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryNameToPath</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ClassLoader</span><span class="w"> </span><span class="n">javaseLoader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getJavaseClassLoader</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">tryLoadingFromJavaseLoader</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">....</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tryLoadingFromJavaseLoader</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">javaseLoader</span><span class="p">.</span><span class="na">loadClass</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// (0.5) Permission to access this class when using a SecurityManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">delegateLoad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delegate</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// (1) Delegate to our parent if requested, å¦‚æœé…ç½®äº†ç”¨çˆ¶åŠ è½½å™¨åŠ è½½å°±ç”¨çˆ¶åŠ è½½å™¨ï¼Œé»˜è®¤false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">delegateLoad</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">..</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// (2) Search local repositories</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">log</span><span class="p">.</span><span class="na">isDebugEnabled</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&#34;  Searching local repositories&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findClass</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// Ignore</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// (3) Delegate to parent unconditionally, å¦‚æœä¸ä½¿ç”¨çˆ¶åŠ è½½å™¨ï¼Œä½†è‡ªå·±åˆæ²¡æœ‰æ‰¾åˆ°å°±è¿˜æ˜¯ç”¨çˆ¶åŠ è½½å™¨æ‰¾ä¸€é</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">delegateLoad</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">						</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Class</span><span class="p">.</span><span class="na">forName</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>findClass</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">findClass</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// (1) Permission to define this class when using a SecurityManager</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">..</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Ask our superclass to locate this class, if possible</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// (throws ClassNotFoundException if it is not found)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">securityManager</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findClassInternal</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="p">(</span><span class="n">AccessControlException</span><span class="w"> </span><span class="n">ace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">hasExternalRepositories</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">findClass</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="p">(</span><span class="n">AccessControlException</span><span class="w"> </span><span class="n">ace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">RuntimeException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassNotFoundException</span><span class="p">(</span><span class="n">name</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ClassNotFoundException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="n">e</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Return the class we have located</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>findClassInternal</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">protected</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">findClassInternal</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binaryNameToPath</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ResourceEntry</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resourceEntries</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">path</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">loadedClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">synchronized</span><span class="w"> </span><span class="p">(</span><span class="n">JreCompat</span><span class="p">.</span><span class="na">isGraalAvailable</span><span class="p">()</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">getClassLoadingLock</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="na">loadedClass</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       	</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">binaryContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resource</span><span class="p">.</span><span class="na">getContent</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="c1">// è°ƒç”¨jdkçš„APIå»åŠ è½½ç±» </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">defineClass</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">binaryContent</span><span class="p">,</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="n">binaryContent</span><span class="p">.</span><span class="na">length</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CodeSource</span><span class="p">(</span><span class="n">codeBase</span><span class="p">,</span><span class="w"> </span><span class="n">certificates</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">UnsupportedClassVersionError</span><span class="w"> </span><span class="n">ucve</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entry</span><span class="p">.</span><span class="na">loadedClass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">clazz</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>å°ç»“</strong></p>
<ul>
<li>å…ˆåœ¨æœ¬åœ°tomcatç¼“å­˜ä¸­æŸ¥æ‰¾è¯¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œå¦‚æœåŠ è½½è¿‡å°±è¿”å›ç¼“å­˜ä¸­çš„ã€‚</li>
<li>å¦‚æœæœ¬åœ°ç¼“å­˜æ²¡æœ‰å°±å»JVMä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œæœ‰å°±è¿”å›ã€‚</li>
<li>å¦‚æœç¼“å­˜é‡Œéƒ½æ²¡æœ‰ï¼Œå§”æ‰˜ç»™ bootstrap class loaderå»åŠ è½½ï¼Œé˜²æ­¢è¦†ç›–ç³»ç»Ÿçš„æ ¸å¿ƒç±»åº“ã€‚</li>
<li>å¦‚æœè¿˜æ²¡åŠ è½½åˆ°è¯´æ˜ä¸æ ¸å¿ƒåº“ä¸­æ²¡æœ‰è¿™ä¸ªç±»ï¼Œé‚£å°±WebappClassLoaderBaseè‡ªå·±å»åŠ è½½ï¼Œè°ƒç”¨findClassæ–¹æ³•ã€‚</li>
<li>findClass ä¸­æœ€ç»ˆä¼šé€šè¿‡è°ƒç”¨findClassInternalæ¥åŠ è½½ï¼Œæ‰¾ä¸åˆ°ä¼šå†æ¬¡å¸¸ç”¨ç”¨çˆ¶ç±»åŠ è½½å™¨æ¥åŠ è½½ã€‚</li>
<li>findClassInternalä¼˜å…ˆä»resourceEntriesç¼“å­˜ä¸­æŸ¥æ‰¾ï¼Œæ‰¾åˆ°åˆ™è¿”å›ã€‚</li>
<li>æ‰¾ä¸åˆ°åˆ™æœ€ç»ˆé€šè¿‡class çš„binaryContentå’Œè°ƒç”¨JDK çš„API <code>defineClass</code> æ¥åŠ è½½ã€‚</li>
</ul>
<p><strong>ç»è¿‡ä»¥ä¸Šåˆ†ææˆ‘ä»¬å¯ä»¥ä»ä¸€ä¸ªHTTPè¯·æ±‚å‡ºå‘åˆæ­¥äº†è§£åˆ°Tomcatæ•´ä½“çš„æ¶æ„è®¾è®¡ï¼Œä»¥åŠæ¥æ”¶è¯·æ±‚ã€è§£æè¯·æ±‚ï¼ŒåŠ è½½è¿è¡Œservlet, åˆ°ç”Ÿæˆå“åº”çš„å…¨æµç¨‹ï¼Œä½†æ˜¯tomcat ç»è¿‡äºŒåå¹´ä½™å¹´çš„å‘å±•ï¼Œæ‰€è¦å¤„ç†çš„ä¸šåŠ¡åœºæ™¯è¿œä¸æ­¢è¿™äº›ï¼Œæœ‰å¾ˆå¤šå…¶ä»–çš„è®¾è®¡å’Œå®ç°å€¼å¾—æˆ‘ä»¬å»è¿›ä¸€æ­¥æ¢ç´¢ï¼Œæ¯”å¦‚ï¼š</strong></p>
<ul>
<li><strong>tomcatä¸­å…³äºé•¿é“¾æ¥çš„å¤„ç†</strong></li>
<li><strong>åˆ†å—ä¼ è¾“</strong></li>
<li><strong>tomcatæ˜¯å¦‚ä½•å¯¹å“åº”è¿›è¡Œå‹ç¼©çš„(ä¾‹å¦‚gzip)ï¼Ÿ</strong></li>
<li><strong>&hellip;</strong></li>
</ul>
<blockquote>
<p>è¿™å‡ ä¸ªé—®é¢˜æš‚æ—¶ä¸ä½œä¸ºè¿™æ¬¡çš„æ•…äº‹ä¸»çº¿ï¼Œå¯¹å“åº”å‹ç¼©å’Œåˆ†å—ä¼ è¾“æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡ï¼š<a class="link" href="https://woaihuangfan.github.io/posts/tomcat-http-%e5%8e%8b%e7%bc%a9%e4%b8%8e%e5%88%86%e5%9d%97%e4%bc%a0%e8%be%93/"  target="_blank" rel="noopener"
    >tomcat http å‹ç¼©ä¸åˆ†å—ä¼ è¾“åŸç†</a></p>
</blockquote>
<p>ä½†æ˜¯åœ¨æ­¤ä¹‹å‰ï¼Œç«™åœ¨å¼€å‘è€…çš„è§’åº¦è€ƒè™‘åˆ°æˆ‘ä»¬åŸºäºspringbootå¼€å‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¿˜æœ‰ä¸€ç‚¹æ²¡æœ‰ææ¸…æ¥šï¼Œtomcat æ˜¯å¦‚ä½•ä¸Springbootè”ç³»åœ¨ä¸€èµ·çš„å‘¢ï¼Ÿ</p>
<h2 id="tomcat-å’Œspringboot">Tomcat å’ŒSpringboot</h2>
<p>ä»¥è¿™ä¸ª<a class="link" href="https://github.com/woaihuangfan/how-tomcat-works/tree/main/springboot-on-tomcat"  target="_blank" rel="noopener"
    >ç®€å•çš„springbootåº”ç”¨</a>(Springboot <strong>3.2.3</strong>, æ³¨æ„è€ç‰ˆæœ¬ä¼šç•¥å¾®æœ‰æ‰€ä¸åŒï¼Œä½†å¤§åŒå°å¼‚)ä¸ºä¾‹,</p>
<p><strong>gradle</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="o">..</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="n">implementation</span><span class="p">(</span><span class="s2">&#34;org.springframework.boot:spring-boot-starter-web&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">..</span><span class="p">.</span>
</span></span></code></pre></div><p>è¿™ä¸ªä¾èµ–é‡Œå¼•å…¥äº†<code>spring-boot-starter-tomcat</code>ä¾èµ–,</p>
<blockquote>
<p>å› ä¸ºç”¨äº†<code>api</code> æ‰€ä»¥åœ¨æˆ‘ä»¬çš„springbootåº”ç”¨ä¸­å¯ä»¥è®¿é—®åˆ°<code>spring-boot-starter-tomcat</code>ä¾èµ–</p>
</blockquote>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240226113635234.png"
	width="3046"
	height="1886"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240226113635234_hu70ca8861426ffd5949f05e6d45ea0ae9_562428_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240226113635234_hu70ca8861426ffd5949f05e6d45ea0ae9_562428_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240226113635234"
	
	
		class="gallery-image" 
		data-flex-grow="161"
		data-flex-basis="387px"
	
></p>
<p><strong>spring-boot-starter-tomcat</strong></p>
<p>å¼•å…¥äº†<code>tomcat-embed-core</code> ä¾èµ–,</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240226114833240.png"
	width="3352"
	height="1358"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240226114833240_hu8351bde63d4de251afb7fac2bc05a7ed_430139_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240226114833240_hu8351bde63d4de251afb7fac2bc05a7ed_430139_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240226114833240"
	
	
		class="gallery-image" 
		data-flex-grow="246"
		data-flex-basis="592px"
	
></p>
<p>è€Œ<code>tomcat-embed-core</code>ä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€ç»ˆä¼šç”¨åˆ°çš„ä¸€ä¸ªæ ¸å¿ƒçš„tomcatçš„jarä¾èµ–ã€‚è€Œåœ¨è¿™ä¸ªjaråŒ…é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°tomcat çš„æºç ã€‚</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240226115159408.png"
	width="3714"
	height="1262"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240226115159408_hu0d123a5afcfc7a29c60aad6d9dc4d553_486385_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240226115159408_hu0d123a5afcfc7a29c60aad6d9dc4d553_486385_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240226115159408"
	
	
		class="gallery-image" 
		data-flex-grow="294"
		data-flex-basis="706px"
	
></p>
<p><strong>PingContoller</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@RestController</span>
</span></span><span class="line"><span class="cl"><span class="nd">@RequestMapping</span><span class="p">(</span><span class="s2">&#34;/ping&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PingController</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@GetMapping</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">ping</span><span class="p">():</span> <span class="n">String</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;Pong!&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Springbootåº”ç”¨å¯åŠ¨å…¥å£ä¹Ÿæ˜¯ä¸€ä¸ªMainæ–¹æ³•ï¼Œè¯¦ç»†çš„Springbootå¯åŠ¨è¿‡ç¨‹ä¸åœ¨æœ¬æ–‡çš„èŒƒå›´å†…ï¼Œæ­¤å¤„ç›´æ¥è·³åˆ°tomcatå¯åŠ¨çš„ä»£ç ã€‚</p>
<p><code>SpringApplication#run</code> â€”&gt; <code>SpringApplication#refreshContext</code>  â€”&gt; <code>ServletWebServerApplicationContext#onRefresh</code>  â€”&gt;  <code>ServletWebServerApplicationContext#createWebServer</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">createWebServer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">WebServer</span><span class="w"> </span><span class="n">webServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">webServer</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">ServletContext</span><span class="w"> </span><span class="n">servletContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServletContext</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">webServer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">servletContext</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">StartupStep</span><span class="w"> </span><span class="n">createWebServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getApplicationStartup</span><span class="p">().</span><span class="na">start</span><span class="p">(</span><span class="s">&#34;spring.boot.webserver.create&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">ServletWebServerFactory</span><span class="w"> </span><span class="n">factory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getWebServerFactory</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">createWebServer</span><span class="p">.</span><span class="na">tag</span><span class="p">(</span><span class="s">&#34;factory&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">factory</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="k">this</span><span class="p">.</span><span class="na">webServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factory</span><span class="p">.</span><span class="na">getWebServer</span><span class="p">(</span><span class="n">getSelfInitializer</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">servletContext</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">initPropertySources</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ä¸Šè¿°ä»£ç ç¬¬6è¡Œ<code>getWebServerFactory();</code> è¿”å›çš„æ˜¯<strong>TomcatServletWebServerFactory</strong></p>
<p><strong>ä¸ºä»€ä¹ˆæ˜¯Tomcatè€Œä¸æ˜¯Jettyï¼Ÿ</strong></p>
<p>å› ä¸ºåœ¨<code>ServletWebServerFactoryAutoConfiguration</code> è‡ªåŠ¨è£…é…ç±»ä¸­é€šè¿‡@Import å¯¼å…¥äº†ServletWebServerFactoryConfigurationç±»ä¸‹é¢çš„å‡ ä¸ªé…ç½®ï¼Œ</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227110015707.png"
	width="2028"
	height="858"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227110015707_hu1e0b65aaad25379021185aa1252c64df_292952_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227110015707_hu1e0b65aaad25379021185aa1252c64df_292952_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240227110015707"
	
	
		class="gallery-image" 
		data-flex-grow="236"
		data-flex-basis="567px"
	
></p>
<p>è€Œåœ¨ServletWebServerFactoryConfigurationä¸­ï¼Œé€šè¿‡<code>ConditionalOnClass</code> æ³¨è§£ä¼šé»˜è®¤åŠ è½½TomcatServletWebServerFactoryã€‚</p>
<blockquote>
<p>web starter é»˜è®¤é›†æˆtomcat, å¯ä»¥å‘ç°Jettyçš„ä¸¤ä¸ªç±»é»˜è®¤æƒ…å†µä¸‹æ‰¾ä¸åˆ°ã€‚</p>
</blockquote>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227112101127.png"
	width="2224"
	height="1742"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227112101127_hu07bb95c638b4109ce0398b5daa50364c_447352_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227112101127_hu07bb95c638b4109ce0398b5daa50364c_447352_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240227112101127"
	
	
		class="gallery-image" 
		data-flex-grow="127"
		data-flex-basis="306px"
	
></p>
<p>ä¸‹é¢å†çœ‹<code>factory#getWebServer</code>çš„å®ç°</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="kd">public</span><span class="w"> </span><span class="n">WebServer</span><span class="w"> </span><span class="nf">getWebServer</span><span class="p">(</span><span class="n">ServletContextInitializer</span><span class="p">...</span><span class="w"> </span><span class="n">initializers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">disableMBeanRegistry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">Registry</span><span class="p">.</span><span class="na">disableRegistry</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">Tomcat</span><span class="w"> </span><span class="n">tomcat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Tomcat</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">File</span><span class="w"> </span><span class="n">baseDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">baseDirectory</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">baseDirectory</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">createTempDir</span><span class="p">(</span><span class="s">&#34;tomcat&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">tomcat</span><span class="p">.</span><span class="na">setBaseDir</span><span class="p">(</span><span class="n">baseDir</span><span class="p">.</span><span class="na">getAbsolutePath</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">LifecycleListener</span><span class="w"> </span><span class="n">listener</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">serverLifecycleListeners</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">tomcat</span><span class="p">.</span><span class="na">getServer</span><span class="p">().</span><span class="na">addLifecycleListener</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">Connector</span><span class="w"> </span><span class="n">connector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Connector</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">protocol</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">connector</span><span class="p">.</span><span class="na">setThrowOnFailure</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">//åˆ›å»ºserver, service, å¹¶å®Œæˆconnector å’Œ serviceçš„ç»‘å®š</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">tomcat</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">addConnector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">customizeConnector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">tomcat</span><span class="p">.</span><span class="na">setConnector</span><span class="p">(</span><span class="n">connector</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">tomcat</span><span class="p">.</span><span class="na">getHost</span><span class="p">().</span><span class="na">setAutoDeploy</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// è¿™ä¸€æ­¥ä¼šæ ¹æ®æˆ‘ä»¬application.yml é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®å¯¹tomcat serveråšå®šåˆ¶åŒ–çš„é…ç½®ã€‚</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">configureEngine</span><span class="p">(</span><span class="n">tomcat</span><span class="p">.</span><span class="na">getEngine</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Connector</span><span class="w"> </span><span class="n">additionalConnector</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">additionalTomcatConnectors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">			</span><span class="n">tomcat</span><span class="p">.</span><span class="na">getService</span><span class="p">().</span><span class="na">addConnector</span><span class="p">(</span><span class="n">additionalConnector</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">prepareContext</span><span class="p">(</span><span class="n">tomcat</span><span class="p">.</span><span class="na">getHost</span><span class="p">(),</span><span class="w"> </span><span class="n">initializers</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="n">getTomcatWebServer</span><span class="p">(</span><span class="n">tomcat</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™æ—¶é™¤äº†Tomcat ç±»å¤–ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°Connector, Service, Hostï¼ŒProtocolç­‰ç†Ÿæ‚‰çš„å­—çœ¼ã€‚</p>
<p><strong>Connectorçš„åˆ›å»º</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Connector</span><span class="w"> </span><span class="n">connector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Connector</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">protocol</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p><strong>Serverå’ŒServiceçš„åˆ›å»º</strong></p>
<p>åœ¨tomcat.getService()å®ç°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ–°å»ºäº†StandardServerå’ŒStandardServiceå¹¶å®ç°äº†åŒå‘ç»‘å®šã€‚</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="nf">getService</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">getServer</span><span class="p">().</span><span class="na">findServices</span><span class="p">()</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="nf">getServer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">server</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">server</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">setProperty</span><span class="p">(</span><span class="s">&#34;catalina.useNaming&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;false&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ç†Ÿæ‚‰çš„StandardServer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StandardServer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">initBaseDir</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// Set configuration source</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ConfigFileLoader</span><span class="p">.</span><span class="na">setSource</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">CatalinaBaseConfigurationSource</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="n">basedir</span><span class="p">),</span><span class="w"> </span><span class="kc">null</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">server</span><span class="p">.</span><span class="na">setPort</span><span class="p">(</span><span class="o">-</span><span class="n">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">// ç†Ÿæ‚‰çš„StandardService</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Service</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StandardService</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">service</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="s">&#34;Tomcat&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">server</span><span class="p">.</span><span class="na">addService</span><span class="p">(</span><span class="n">service</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">server</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><strong>Engineå’ŒHostçš„åˆ›å»º</strong></p>
<p>åœ¨tomcat.getHost()çš„å®ç°ä¸­ï¼Œåˆ›å»ºäº†StandardEngineå’ŒStandardHostï¼Œå¹¶å®Œæˆäº†Engine, Host, Service ä¹‹é—´çš„ç»‘å®š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="nf">getHost</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Engine</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getEngine</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">engine</span><span class="p">.</span><span class="na">findChildren</span><span class="p">().</span><span class="na">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">Host</span><span class="p">)</span><span class="w"> </span><span class="n">engine</span><span class="p">.</span><span class="na">findChildren</span><span class="p">()</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Host</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StandardHost</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">host</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="n">hostname</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">getEngine</span><span class="p">().</span><span class="na">addChild</span><span class="p">(</span><span class="n">host</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">host</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Engine</span><span class="w"> </span><span class="nf">getEngine</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Service</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getServer</span><span class="p">().</span><span class="na">findServices</span><span class="p">()</span><span class="o">[</span><span class="n">0</span><span class="o">]</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="na">getContainer</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="na">getContainer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Engine</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">StandardEngine</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">engine</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="s">&#34;Tomcat&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">engine</span><span class="p">.</span><span class="na">setDefaultHost</span><span class="p">(</span><span class="n">hostname</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">engine</span><span class="p">.</span><span class="na">setRealm</span><span class="p">(</span><span class="n">createDefaultRealm</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">service</span><span class="p">.</span><span class="na">setContainer</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">engine</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è‡³æ­¤, è¿˜å·®ä¸€ä¸ªWrapperå°±å®Œæˆäº†ä»¥<code>Tomcat</code>ä¸ºæ ¹èŠ‚ç‚¹çš„è¿™ä¸ªå±‚çº§å…³ç³»çš„æ„å»ºã€‚ Wrapper æ˜¯åœ¨</p>
<p><strong>Tomcatçš„å¯åŠ¨</strong></p>
<p>åœ¨getWebServeræœ€åä¸€æ­¥<code>getTomcatWebServer(tomcat)</code>ä¸­,</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">// TomcatServletWebServerFactory#getTomcatWebServer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">protected</span><span class="w"> </span><span class="n">TomcatWebServer</span><span class="w"> </span><span class="nf">getTomcatWebServer</span><span class="p">(</span><span class="n">Tomcat</span><span class="w"> </span><span class="n">tomcat</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TomcatWebServer</span><span class="p">(</span><span class="n">tomcat</span><span class="p">,</span><span class="w"> </span><span class="n">getPort</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">0</span><span class="p">,</span><span class="w"> </span><span class="n">getShutdown</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">//TomcatWebServer#TomcatWebServer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="nf">TomcatWebServer</span><span class="p">(</span><span class="n">Tomcat</span><span class="w"> </span><span class="n">tomcat</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">autoStart</span><span class="p">,</span><span class="w"> </span><span class="n">Shutdown</span><span class="w"> </span><span class="n">shutdown</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Assert</span><span class="p">.</span><span class="na">notNull</span><span class="p">(</span><span class="n">tomcat</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;Tomcat Server must not be null&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="na">tomcat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tomcat</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="na">autoStart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">autoStart</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="na">gracefulShutdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">shutdown</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shutdown</span><span class="p">.</span><span class="na">GRACEFUL</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">GracefulShutdown</span><span class="p">(</span><span class="n">tomcat</span><span class="p">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">initialize</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// TomcatWebServer#initialize</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initialize</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">WebServerException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">this</span><span class="p">.</span><span class="na">tomcat</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Tomcat#start</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">LifecycleException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">getServer</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">server</span><span class="p">.</span><span class="na">start</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>åœ¨<code>server.start()</code> è¿™ä¸€æ­¥å¼€å§‹ä¹‹åå°±æ˜¯æˆ‘ä»¬å‰é¢åˆ†æè¿‡çš„tomcatçš„å¯åŠ¨æµç¨‹ã€‚</p>
<p><strong>Servlet çš„åŠ è½½</strong></p>
<p>æˆ‘ä»¬çŸ¥é“Springboot æ¡†æ¶å°±åŒ…å«spring mvc, æ‰€æœ‰è¯·æ±‚åœ¨åˆ°è¾¾tomcatåï¼Œä¼šäº¤ç»™<code>DispathcerServlet</code> æ¥å¤„ç†ï¼ŒDispatcherServlet ä¼šå†è¿›ä¸€æ­¥å¯¹è¯·æ±‚è¿›è¡Œåˆ†å‘ï¼Œäº¤ç»™å„è‡ªhandler/controlleræ¥å¤„ç†ã€‚</p>
<p>![Tomcat and Spring](images/Tomcat and Spring.png)</p>
<p>é‚£è¿™ä¸ªDispatcherServletæ˜¯ä»€ä¹ˆæ—¶å€™åŠ è½½çš„ï¼Ÿ</p>
<p><strong>DispatcherServletçš„å®ä¾‹åŒ–</strong></p>
<p>åœ¨spring å®¹å™¨æ„å»ºDispatcherServletRegistrationBeançš„æ—¶å€™ä¼šå‘ç°å®ƒä¾èµ–DispatcherServletï¼Œ è¿™æ—¶å€™å°±ä¼šå»å®ä¾‹åŒ–DispatcherServletã€‚</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227132941675.png"
	width="2794"
	height="1164"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227132941675_hu10989bcb33843bc4a74f26076deedbde_378475_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227132941675_hu10989bcb33843bc4a74f26076deedbde_378475_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240227132941675"
	
	
		class="gallery-image" 
		data-flex-grow="240"
		data-flex-basis="576px"
	
></p>
<p><strong>Wrapper çš„åˆ›å»ºä»¥åŠServlet å’Œwrapper çš„ç»‘å®š</strong></p>
<p>åœ¨<code>StandaradContext#startInternal</code> ä¸­æœ‰ä¸€æ®µä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">ServletContainerInitializer</span><span class="p">,</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;&gt;</span><span class="w"> </span><span class="n">initializers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LinkedHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">ServletContainerInitializer</span><span class="p">,</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">Class</span><span class="o">&lt;?&gt;&gt;&gt;</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">initializers</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">entry</span><span class="p">.</span><span class="na">getKey</span><span class="p">().</span><span class="na">onStartup</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="na">getValue</span><span class="p">(),</span><span class="w"> </span><span class="n">getServletContext</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ServletException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">&#34;standardContext.sciFail&#34;</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">break</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ServletContainerInitializeræ˜¯Servlet 3.0 æ–°å¢çš„ä¸€ä¸ªæ¥å£ï¼Œä¸»è¦ç”¨äºåœ¨å®¹å™¨å¯åŠ¨é˜¶æ®µé€šè¿‡ç¼–ç¨‹é£æ ¼æ³¨å†Œ<code>Filter</code>, <code>Servlet</code>ä»¥åŠ<code>Listener</code>ï¼Œä»¥å–ä»£é€šè¿‡<code>web.xml</code>é…ç½®æ³¨å†Œã€‚å®¹å™¨å¯åŠ¨é˜¶æ®µä¾æ®java spiè·å–åˆ°æ‰€æœ‰<code>ServletContainerInitializer</code>çš„å®ç°ç±»ï¼Œç„¶åæ‰§è¡Œå…¶<code>onStartup</code>æ–¹æ³•.</p>
<p>å…¶ä¸­å°±æœ‰ä¸€ä¸ªspringå®ç°çš„TomcatStarter</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227133714818.png"
	width="3188"
	height="1608"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227133714818_hu41da102d367e6dac05e949baab01af66_553506_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227133714818_hu41da102d367e6dac05e949baab01af66_553506_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240227133714818"
	
	
		class="gallery-image" 
		data-flex-grow="198"
		data-flex-basis="475px"
	
></p>
<p>è€ŒTomcatStarter åˆä¼šæ‰§è¡Œå†…éƒ¨ç»´æŠ¤çš„initializersçš„onStartupæ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ServletContextInitializer</span><span class="w"> </span><span class="n">initializer</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">initializers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">initializer</span><span class="p">.</span><span class="na">onStartup</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è¿™ä¸ªå†…éƒ¨ç»´æŠ¤çš„initializersæ˜¯é€šè¿‡å¦‚ä¸‹æ–¹å¼æ·»åŠ ï¼š</p>
<p><code>this.webServer = factory.getWebServer(getSelfInitializer());</code> â€”&gt;<code>TomcatServletWebServerFactory#getWebServer</code> â€”&gt;<code>TomcatServletWebServerFactory#prepareContext</code> â€”&gt;<code>TomcatServletWebServerFactory#configureContext</code> â€”&gt;<code>new TomcatStarter(initializers)</code></p>
<p>å…¶ä¸­getSelfInitializerè¿”å›çš„æ˜¯ä¸€ä¸ªLambaè¡¨è¾¾å¼ï¼š</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">boot</span><span class="p">.</span><span class="na">web</span><span class="p">.</span><span class="na">servlet</span><span class="p">.</span><span class="na">ServletContextInitializer</span><span class="w"> </span><span class="nf">getSelfInitializer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">::</span><span class="n">selfInitialize</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">selfInitialize</span><span class="p">(</span><span class="n">ServletContext</span><span class="w"> </span><span class="n">servletContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">ServletException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">prepareWebApplicationContext</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">registerApplicationScope</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">WebApplicationContextUtils</span><span class="p">.</span><span class="na">registerEnvironmentBeans</span><span class="p">(</span><span class="n">getBeanFactory</span><span class="p">(),</span><span class="w"> </span><span class="n">servletContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ServletContextInitializer</span><span class="w"> </span><span class="n">beans</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">getServletContextInitializerBeans</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">beans</span><span class="p">.</span><span class="na">onStartup</span><span class="p">(</span><span class="n">servletContext</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>æ‰€ä»¥æœ€ç»ˆä¼šæ‰§è¡Œåˆ°<code>ServletContextInitializerBeans</code> çš„onStartupæ–¹æ³•ï¼Œ</p>
<p><img src="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227135328783.png"
	width="1824"
	height="492"
	srcset="/posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227135328783_hua0fad7641191686a212bef44f756433b_174545_480x0_resize_box_3.png 480w, /posts/tomcat%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/images/image-20240227135328783_hua0fad7641191686a212bef44f756433b_174545_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="image-20240227135328783"
	
	
		class="gallery-image" 
		data-flex-grow="370"
		data-flex-basis="889px"
	
></p>
<p>å…¶ä¸­å°±æœ‰ä¸€ä¸ª<code>DispatcherServletRegistrationBean</code>, ç„¶åé€šè¿‡ä»¥ä¸‹è°ƒç”¨é“¾</p>
<p><code>beans.onStartup(servletContext)</code> â€”&gt; <code>DispatcherServletRegistrationBean#onStartup</code> â€”&gt; <code>DynamicRegistrationBean#register</code> â€”&gt; <code>ServletRegistrationBean#addRegistration</code> â€”&gt; <code>ApplicationContextFacade#addServlet</code> â€”&gt; <code>ApplicationContext#addServlet</code> â€”&gt; <code>org.apache.catalina.core.ApplicationContext#addServlet</code></p>
<p>åœ¨<code>ApplicationContext#addServlet</code>ä¸­å¯ä»¥çœ‹åˆ°ä¼šåˆ›å»ºwrapper,å¹¶ç»‘å®šStandardContext å’Œwrapper ï¼Œè‹¥servlet ä¸ä¸ºç©ºåˆ™ä¼šé€šè¿‡<code>wrapper.setServlet(servlet);</code>æ¥ç»‘å®šservlet å’Œ wrapper.</p>
<blockquote>
<p>è‹¥servlet ä¸ºç©ºï¼Œåˆ™åªä¼šsetServletClassï¼Œä¸”loadClass , å®ä¾‹åŒ–äº¤ç»™åé¢çš„æ­¥éª¤è¿›è¡Œã€‚</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span><span class="w"> </span><span class="n">ServletRegistration</span><span class="p">.</span><span class="na">Dynamic</span><span class="w"> </span><span class="nf">addServlet</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">servletName</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">servletClass</span><span class="p">,</span><span class="w"> </span><span class="n">Servlet</span><span class="w"> </span><span class="n">servlet</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">initParams</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">Wrapper</span><span class="w"> </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Wrapper</span><span class="p">)</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">findChild</span><span class="p">(</span><span class="n">servletName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// Assume a &#39;complete&#39; ServletRegistration is one that has a class and</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="c1">// a name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wrapper</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">createWrapper</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">wrapper</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="n">servletName</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">context</span><span class="p">.</span><span class="na">addChild</span><span class="p">(</span><span class="n">wrapper</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wrapper</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">wrapper</span><span class="p">.</span><span class="na">getServletClass</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wrapper</span><span class="p">.</span><span class="na">isOverridable</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="n">wrapper</span><span class="p">.</span><span class="na">setOverridable</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ServletSecurity</span><span class="w"> </span><span class="n">annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">servlet</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">wrapper</span><span class="p">.</span><span class="na">setServletClass</span><span class="p">(</span><span class="n">servletClass</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Introspection</span><span class="p">.</span><span class="na">loadClass</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">servletClass</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">clazz</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clazz</span><span class="p">.</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">ServletSecurity</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">wrapper</span><span class="p">.</span><span class="na">setServletClass</span><span class="p">(</span><span class="n">servlet</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">wrapper</span><span class="p">.</span><span class="na">setServlet</span><span class="p">(</span><span class="n">servlet</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="na">wasCreatedDynamicServlet</span><span class="p">(</span><span class="n">servlet</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">annotation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">servlet</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getAnnotation</span><span class="p">(</span><span class="n">ServletSecurity</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">initParams</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">initParam</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">initParams</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="n">wrapper</span><span class="p">.</span><span class="na">addInitParameter</span><span class="p">(</span><span class="n">initParam</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">initParam</span><span class="p">.</span><span class="na">getValue</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">ServletRegistration</span><span class="p">.</span><span class="na">Dynamic</span><span class="w"> </span><span class="n">registration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ApplicationServletRegistration</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">annotation</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="n">registration</span><span class="p">.</span><span class="na">setServletSecurity</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ServletSecurityElement</span><span class="p">(</span><span class="n">annotation</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">registration</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>è‡³æ­¤ï¼Œwrapper ä¹Ÿå°±åˆ›å»ºå®Œæˆï¼Œå¹¶åœ¨tomcat å¯åŠ¨çš„æ—¶å€™å°±ä¼šå®ä¾‹åŒ–å‡ºäº†Servletã€‚å’Œå‰é¢åˆ†æçš„tomcat æ¶æ„å®Œç¾è¡”æ¥ï¼Œè‡³äºè¯·æ±‚åˆ°è¾¾DispatcherServletåæ€ä¹ˆåˆ†å‘äº¤ç»™controllerï¼Œé‚£å°±æ˜¯å¦ä¸€ä¸ªtopicäº†ã€‚</p>
<blockquote>
<p>å¤ä¹ å›é¡¾ï¼šè¿™é‡Œè¯´çš„wrapperæŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ</p>
</blockquote>
</section>


    <footer class="article-footer">
    

    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2024 æ¸…éœ²æ™¨æµ, æ–°æ¡åˆå¼•
    </section>
    










</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
